{"meta":{"title":"喵了个咪","subtitle":"喵了个咪的技术博客","description":"深圳十年","author":"Deeka Hwang","url":"https://hdj.me"},"pages":[{"title":"全部分类","date":"2014-12-22T12:39:04.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"categories/index.html","permalink":"https://hdj.me/categories/index.html","excerpt":"","text":""},{"title":"全部标签","date":"2014-12-22T12:39:04.000Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"tags/index.html","permalink":"https://hdj.me/tags/index.html","excerpt":"","text":""},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/package.json","permalink":"https://hdj.me/lib/pjax/package.json","excerpt":"","text":"{\"name\":\"pjax\",\"version\":\"0.2.8\",\"description\":\"Easily enable fast AJAX navigation on any website (using pushState + XHR)\",\"keywords\":[\"pjax\",\"pushstate\",\"ajax\",\"navigation\",\"transition\",\"animation\"],\"repository\":\"https://github.com/MoOx/pjax.git\",\"author\":\"Maxime Thirouin\",\"contributors\":[\"BehindTheMath\",\"Robin North (http://robinnorth.co.uk)\"],\"license\":\"MIT\",\"main\":\"index.js\",\"files\":[\"index.js\",\"lib\",\"pjax.js\",\"pjax.min.js\",\"index.d.ts\"],\"types\":\"index.d.ts\",\"devDependencies\":{\"browserify\":\"^15.0.0\",\"eslint\":\"^5.7.0\",\"eslint-config-i-am-meticulous\":\"^11.0.0\",\"husky\":\"^1.2.0\",\"jsdom\":\"^11.5.1\",\"jsdom-global\":\"^3.0.2\",\"lint-staged\":\"^8.1.0\",\"npmpub\":\"^3.1.0\",\"nyc\":\"^11.4.1\",\"opn-cli\":\"^3.1.0\",\"prettier\":\"^1.14.3\",\"serve\":\"^11.3.2\",\"tap-nyc\":\"^1.0.3\",\"tap-spec\":\"^4.1.1\",\"tape\":\"^4.8.0\",\"uglify-js\":\"^3.3.8\"},\"scripts\":{\"lint\":\"eslint .\",\"standalone\":\"browserify index.js --standalone Pjax > pjax.js\",\"build\":\"npm run standalone && uglifyjs pjax.js -o pjax.min.js\",\"build-debug\":\"browserify index.js --debug --standalone Pjax > pjax.js\",\"tests\":\"tape -r ./tests/setup.js \\\"./tests/**/*.js\\\"\",\"test\":\"npm run lint && npm run tests | tap-spec\",\"coverage-tests\":\"npm run tests | tap-nyc\",\"coverage\":\"nyc -x \\\"tests/**\\\" npm run coverage-tests\",\"example\":\"opn http://localhost:3000/example/ && serve -p 3000 .\",\"prepublish\":\"npm run build\",\"release\":\"npmpub\"},\"husky\":{\"hooks\":{\"pre-commit\":\"npm test && lint-staged\"}},\"lint-staged\":{\"*.js\":[\"eslint --fix\",\"prettier --write\",\"git add\"]}}"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/index.js","permalink":"https://hdj.me/lib/pjax/index.js","excerpt":"","text":"// var executeScripts = require(\"./lib/execute-scripts\"); // unused-var var forEachEls = require(\"./lib/foreach-els\"); var parseOptions = require(\"./lib/parse-options\"); var switches = require(\"./lib/switches\"); var newUid = require(\"./lib/uniqueid\"); var on = require(\"./lib/events/on\"); var trigger = require(\"./lib/events/trigger\"); var clone = require(\"./lib/util/clone\"); var contains = require(\"./lib/util/contains\"); var extend = require(\"./lib/util/extend\"); var noop = require(\"./lib/util/noop\"); var Pjax = function(options) { this.state = { numPendingSwitches: 0, href: null, options: null }; this.options = parseOptions(options); this.log(\"Pjax options\", this.options); if (this.options.scrollRestoration && \"scrollRestoration\" in history) { history.scrollRestoration = \"manual\"; } this.maxUid = this.lastUid = newUid(); this.parseDOM(document); on( window, \"popstate\", function(st) { if (st.state) { var opt = clone(this.options); opt.url = st.state.url; opt.title = st.state.title; // Since state already exists, prevent it from being pushed again opt.history = false; opt.scrollPos = st.state.scrollPos; if (st.state.uid < this.lastUid) { opt.backward = true; } else { opt.forward = true; } this.lastUid = st.state.uid; // @todo implement history cache here, based on uid this.loadUrl(st.state.url, opt); } }.bind(this) ); }; Pjax.switches = switches; Pjax.prototype = { log: require(\"./lib/proto/log\"), getElements: function(el) { return el.querySelectorAll(this.options.elements); }, parseDOM: function(el) { var parseElement = require(\"./lib/proto/parse-element\"); forEachEls(this.getElements(el), parseElement, this); }, refresh: function(el) { this.parseDOM(el || document); }, reload: function() { window.location.reload(); }, attachLink: require(\"./lib/proto/attach-link\"), attachForm: require(\"./lib/proto/attach-form\"), forEachSelectors: function(cb, context, DOMcontext) { return require(\"./lib/foreach-selectors\").bind(this)( this.options.selectors, cb, context, DOMcontext ); }, switchSelectors: function(selectors, fromEl, toEl, options) { return require(\"./lib/switches-selectors\").bind(this)( this.options.switches, this.options.switchesOptions, selectors, fromEl, toEl, options ); }, latestChance: function(href) { window.location = href; }, onSwitch: function() { trigger(window, \"resize scroll\"); this.state.numPendingSwitches--; // debounce calls, so we only run this once after all switches are finished. if (this.state.numPendingSwitches === 0) { this.afterAllSwitches(); } }, loadContent: function(html, options) { if (typeof html !== \"string\") { trigger(document, \"pjax:complete pjax:error\", options); return; } var tmpEl = document.implementation.createHTMLDocument(\"pjax\"); // parse HTML attributes to copy them // since we are forced to use documentElement.innerHTML (outerHTML can't be used for ) var htmlRegex = /]+>/gi; var htmlAttribsRegex = /\\s?[a-z:]+(?:=['\"][^'\">]+['\"])*/gi; var matches = html.match(htmlRegex); if (matches && matches.length) { matches = matches[0].match(htmlAttribsRegex); if (matches.length) { matches.shift(); matches.forEach(function(htmlAttrib) { var attr = htmlAttrib.trim().split(\"=\"); if (attr.length === 1) { tmpEl.documentElement.setAttribute(attr[0], true); } else { tmpEl.documentElement.setAttribute(attr[0], attr[1].slice(1, -1)); } }); } } tmpEl.documentElement.innerHTML = html; this.log( \"load content\", tmpEl.documentElement.attributes, tmpEl.documentElement.innerHTML.length ); // Clear out any focused controls before inserting new page contents. if ( document.activeElement && contains(document, this.options.selectors, document.activeElement) ) { try { document.activeElement.blur(); } catch (e) {} // eslint-disable-line no-empty } this.switchSelectors(this.options.selectors, tmpEl, document, options); }, abortRequest: require(\"./lib/abort-request\"), doRequest: require(\"./lib/send-request\"), handleResponse: require(\"./lib/proto/handle-response\"), loadUrl: function(href, options) { options = typeof options === \"object\" ? extend({}, this.options, options) : clone(this.options); this.log(\"load href\", href, options); // Abort any previous request this.abortRequest(this.request); trigger(document, \"pjax:send\", options); // Do the request this.request = this.doRequest( href, options, this.handleResponse.bind(this) ); }, afterAllSwitches: function() { // FF bug: Won’t autofocus fields that are inserted via JS. // This behavior is incorrect. So if theres no current focus, autofocus // the last field. // // http://www.w3.org/html/wg/drafts/html/master/forms.html var autofocusEl = Array.prototype.slice .call(document.querySelectorAll(\"[autofocus]\")) .pop(); if (autofocusEl && document.activeElement !== autofocusEl) { autofocusEl.focus(); } // execute scripts when DOM have been completely updated this.options.selectors.forEach(function(selector) { forEachEls(document.querySelectorAll(selector), function(el) { // executeScripts(el); if (el === 0) ; // intentially left blank! }); }); var state = this.state; if (state.options.history) { if (!window.history.state) { this.lastUid = this.maxUid = newUid(); window.history.replaceState( { url: window.location.href, title: document.title, uid: this.maxUid, scrollPos: [0, 0] }, document.title ); } // Update browser history this.lastUid = this.maxUid = newUid(); window.history.pushState( { url: state.href, title: state.options.title, uid: this.maxUid, scrollPos: [0, 0] }, state.options.title, state.href ); } this.forEachSelectors(function(el) { this.parseDOM(el); }, this); // Fire Events trigger(document, \"pjax:complete pjax:success\", state.options); if (typeof state.options.analytics === \"function\") { state.options.analytics(); } if (state.options.history) { // First parse url and check for hash to override scroll var a = document.createElement(\"a\"); a.href = this.state.href; if (a.hash) { var name = a.hash.slice(1); name = decodeURIComponent(name); var curtop = 0; var target = document.getElementById(name) || document.getElementsByName(name)[0]; if (target) { // http://stackoverflow.com/questions/8111094/cross-browser-javascript-function-to-find-actual-position-of-an-element-in-page if (target.offsetParent) { do { curtop += target.offsetTop; target = target.offsetParent; } while (target); } } window.scrollTo(0, curtop); } else if (state.options.scrollTo !== false) { // Scroll page to top on new page load if (state.options.scrollTo.length > 1) { window.scrollTo(state.options.scrollTo[0], state.options.scrollTo[1]); } else { window.scrollTo(0, state.options.scrollTo); } } } else if (state.options.scrollRestoration && state.options.scrollPos) { window.scrollTo(state.options.scrollPos[0], state.options.scrollPos[1]); } this.state = { numPendingSwitches: 0, href: null, options: null }; } }; Pjax.isSupported = require(\"./lib/is-supported\"); // arguably could do `if( require(\"./lib/is-supported\")()) {` but that might be a little to simple if (Pjax.isSupported()) { module.exports = Pjax; } // if there isn’t required browser functions, returning stupid api else { var stupidPjax = noop; for (var key in Pjax.prototype) { if ( Pjax.prototype.hasOwnProperty(key) && typeof Pjax.prototype[key] === \"function\" ) { stupidPjax[key] = noop; } } module.exports = stupidPjax; }"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/CHANGELOG.html","permalink":"https://hdj.me/lib/pjax/CHANGELOG.html","excerpt":"","text":"0.2.8 - 2019-03-09 Fixed: Edge form support.(#178 - @robinnorth) Fixed: Removed keyup event listener for forms.(#184 - @BehindTheMath) Fixed: Bugs in evalScripts().(#186 - @BehindTheMath) Fixed: Handle non-string HTML passed to loadContent().(#200 - @BehindTheMath) Tooling: Switch linting to ESLint and Prettier.(#191 - @BehindTheMath) 0.2.7 - 2018-08-15 Fixed: Parsing values of option elements in forms.(#162 - @BehindTheMath) Fixed: Added index.d.ts to package.json so it will be installed by npm.(c589ab9 - @BehindTheMath) Fixed: options.history to correctly parse being set to false.(#165 - @BehindTheMath). Fixed: Pass the current options object to loadContent().(#171 - @BehindTheMath) Fixed: Ensure correct XHR encoding for multipart/form-data forms(#174 - @BehindTheMath) Added: More documentation.(#160, #171 - @robinnorth, @BehindTheMath) 0.2.6 - 2018-04-30 Fixed: Form submission for GET requests.(#129 - @robinnorth) Fixed: Refactor loadUrl() to make manually calling simpler.(#134 - @robinnorth) Fixed: Support multiple select fields in form submissions.(#147 - @robinnorth) Fixed: Use the same options object in handle-response as in send-request. This way, pjax.state.options will also have the request options.(#148 - @BehindTheMath) Added: Move the XHR callback to a separate method, and trigger an error event if the response cannot be parsed.(#137 - @BehindTheMath) Added: TypeScript definitions.(#138 - @BehindTheMath) Added: replaceNode switch, as an alternative to the outerHTML switch.(#141 - @BehindTheMath) Added: X-PJAX-Selectors HTTP header. This is a serialized JSON array of selectors, taken from options.selectors. You can use this to send back only the elements that Pjax will use to switch, instead of sending the whole page.(#144 - @BehindTheMath) Added: An option to use FormData to submit forms.(#153 - @BehindTheMath) Added: Tests.(f98f2dd, #145 - @robinnorth, @BehindTheMath) 0.2.5 - 2018-02-02 Fixed: Async switch functions now work correctly, because the DOM is now parsed after all the switches finish.(#79, #110 - @oskarrough, @BehindTheMath, @robinnorth) Fixed: Bug on IE11 preventing AJAX page refresh.(#81 - @CPTechnikVX) Fixed: Default switches are now available as Pjax.switches.(#92 - @BehindTheMath) Fixed: An error that was caused by a missing switchElementsAlt.(#93, #104 - @BehindTheMath, @robinnorth) Fixed: Incorrect main field in npm package(#105 - @robinnorth) Fixed: A pending XHR is now aborted if the user navigates somewhere else before the request is finished.(#114 - @robinnorth) Fixed: When rendering new content, focus will now be removed only from elements within one of the containers manipulated by Pjax.(#116 - @BehindTheMath) Fixed: Stop dispatching extraneous pjax:complete events when external scripts load(#118 - @robinnorth) Added: Send the X-PJAX header with XHR requests.(#80 - @bram1028) Added: Direct download link for script tags. (@MoOx) Added: Pass the element that triggered Pjax to the pjax:send event.(#94 - @BehindTheMath) Added: An option to set a timeout for XHR requests.(#95 - @BehindTheMath) Added: Checks for XHR redirects(#101 - @BehindTheMath) Added: Save scroll position with history, and restore when navigating backwards or forwards.(#110, #119 - @BehindTheMath, @robinnorth) Added: Scroll to element position when URL contains a hash(#110 - @BehindTheMath) Added: Minified version of the Pjax bundle.(#115 - @BehindTheMath) Changed: Miscellaneous code and tests cleanup.(#96, #98, #99, #100, #107, #113, #120 - @BehindTheMath, @MoOx, @robinnorth) 0.2.4 - 2016-06-28 Fixed: refresh should now work (use this.parseDOM for refresh)(#67 - @compressed) Fixed: Some attributes, such as itemscope have no corresponding value.This change allows them to still be set.(#67 - @compressed) Added: cacheBust option(#71 - @tremby) 0.2.3 - 2016-03-24 Fixed: currentUrlFullReload option now works Fixed: this.reload is now a Function(#65) 0.2.2 - 2016-03-12 Fixed: added back standalone version in ./pjax.js(#57 Fixed: error when using pjax with google analytics (options was undefined)(#59) Fixed: HierarchyRequestError error(#49) Fixed: TypeError: Pjax.forEachEls is not a function(#52) Fixed: TypeError: Pjax.executeScripts is not a function(#52) Fixed: TypeError: Pjax.clone is not a function(#52) Added: Ignore events with prevented defaults(#50) 0.2.1 - 2015-02-04 Fixed: it’s better when a release have actual files. 0.2.0 - 2015-02-04 Fixed: prevent scrollTo from being converted from false to 0 (#33) Changed: code exploded in commonjs style Added: lots of tests Added: refresh method to force update a DOM element (#36) 0.1.4 - 2014-10-14 Fixed: allow to load pages without any attributes on &lt;html&gt; element (fix #6) Fixed: make Pjax.switches.sideBySide method usable (fix #13) 0.1.3 - 2014-09-16 Fixed: clicking on the current url somewhere does not produce a full reload by default (see option currentUrlFullReload) Fixed: document.implementation.createHTMLDocument error (in IE10, ref #16) 0.1.2 - 2014-04-03 Changed: pjax.js relocated in src/ Fixed: &lt;html&gt; attributes of pjaxified document are now available 0.1.1 - 2014-04-02 Fixed: safer UMD wrapper (fix concat issue) 0.1.0 - 2014-03-24✨ Initial release"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/pjax.min.js","permalink":"https://hdj.me/lib/pjax/pjax.min.js","excerpt":"","text":"(function(f){if(typeof exports===\"object\"&&typeof module!==\"undefined\"){module.exports=f()}else if(typeof define===\"function\"&&define.amd){define([],f)}else{var g;if(typeof window!==\"undefined\"){g=window}else if(typeof global!==\"undefined\"){g=global}else if(typeof self!==\"undefined\"){g=self}else{g=this}g.Pjax=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/example/index.html","permalink":"https://hdj.me/lib/pjax/example/index.html","excerpt":"","text":"Hello Index Hello. Go to Page 2 or Page 3 and view your console to see Pjax events. Clicking on this page will do nothing. Manual URL loading You can use Pjax's loadUrl method to manually load a URL. Click the buttons below to try it out! loadUrl with current options loadUrl with overridden options (no cache busting) Forms You can submit GET or POST forms with Pjax! Go to the form examples to try it out."},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/example/page2.html","permalink":"https://hdj.me/lib/pjax/example/page2.html","excerpt":"","text":"Page 2 Page 2 Hello. Go to Index."},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/example/example.js","permalink":"https://hdj.me/lib/pjax/example/example.js","excerpt":"","text":"/* global Pjax */ var pjax; var initButtons = function() { var buttons = document.querySelectorAll(\"button[data-manual-trigger]\"); if (!buttons) { return; } // jshint -W083 for (var i = 0; i < buttons.length; i++) { buttons[i].addEventListener(\"click\", function(e) { var el = e.currentTarget; if (el.getAttribute(\"data-manual-trigger-override\") === \"true\") { // Manually load URL with overridden Pjax instance options pjax.loadUrl(\"/example/page2.html\", { cacheBust: false }); } else { // Manually load URL with current Pjax instance options pjax.loadUrl(\"/example/page2.html\"); } }); } // jshint +W083 }; console.log(\"Document initialized:\", window.location.href); document.addEventListener(\"pjax:send\", function() { console.log(\"Event: pjax:send\", arguments); }); document.addEventListener(\"pjax:complete\", function() { console.log(\"Event: pjax:complete\", arguments); }); document.addEventListener(\"pjax:error\", function() { console.log(\"Event: pjax:error\", arguments); }); document.addEventListener(\"pjax:success\", function() { console.log(\"Event: pjax:success\", arguments); // Init page content initButtons(); }); document.addEventListener(\"DOMContentLoaded\", function() { // Init Pjax instance pjax = new Pjax({ elements: [\".js-Pjax\"], selectors: [\".body\", \"title\"], cacheBust: true }); console.log(\"Pjax initialized.\", pjax); // Init page content initButtons(); });"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/example/page3.html","permalink":"https://hdj.me/lib/pjax/example/page3.html","excerpt":"","text":"Page 3 Page 3 Hello. Go to Index."},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/example/forms.html","permalink":"https://hdj.me/lib/pjax/example/forms.html","excerpt":"","text":"Forms Forms Hello. Try out the examples below and inspect the results in your browser's developer tools, or go to the Index. GET form Text input: Number input: Email input: Textarea: This is some text Radio input: Radio input alt: Checkbox input: Select list: Option 1 Option 2 POST form Text input: Number input: Email input: Textarea: This is some text Radio input: Radio input alt: Checkbox input: Select list: Option 1 Option 2"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/abort-request.js","permalink":"https://hdj.me/lib/pjax/lib/abort-request.js","excerpt":"","text":"var noop = require(\"./util/noop\"); module.exports = function(request) { if (request && request.readyState < 4) { request.onreadystatechange = noop; request.abort(); } };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/eval-script.js","permalink":"https://hdj.me/lib/pjax/lib/eval-script.js","excerpt":"","text":"module.exports = function(el) { var code = el.text || el.textContent || el.innerHTML || \"\"; var src = el.src || \"\"; var parent = el.parentNode || document.querySelector(\"head\") || document.documentElement; var script = document.createElement(\"script\"); if (code.match(\"document.write\")) { if (console && console.log) { console.log( \"Script contains document.write. Can’t be executed correctly. Code skipped \", el ); } return false; } script.type = \"text/javascript\"; script.id = el.id; /* istanbul ignore if */ if (src !== \"\") { script.src = src; script.async = false; // force synchronous loading of peripheral JS } if (code !== \"\") { try { script.appendChild(document.createTextNode(code)); } catch (e) { /* istanbul ignore next */ // old IEs have funky script nodes script.text = code; } } // execute parent.appendChild(script); // avoid pollution only in head or body tags if ( (parent instanceof HTMLHeadElement || parent instanceof HTMLBodyElement) && parent.contains(script) ) { parent.removeChild(script); } return true; };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/execute-scripts.js","permalink":"https://hdj.me/lib/pjax/lib/execute-scripts.js","excerpt":"","text":"var forEachEls = require(\"./foreach-els\"); var evalScript = require(\"./eval-script\"); // Finds and executes scripts (used for newly added elements) // Needed since innerHTML does not run scripts module.exports = function(el) { if (el.tagName.toLowerCase() === \"script\") { evalScript(el); } forEachEls(el.querySelectorAll(\"script\"), function(script) { if (!script.type || script.type.toLowerCase() === \"text/javascript\") { if (script.parentNode) { script.parentNode.removeChild(script); } evalScript(script); } }); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/foreach-selectors.js","permalink":"https://hdj.me/lib/pjax/lib/foreach-selectors.js","excerpt":"","text":"var forEachEls = require(\"./foreach-els\"); module.exports = function(selectors, cb, context, DOMcontext) { DOMcontext = DOMcontext || document; selectors.forEach(function(selector) { forEachEls(DOMcontext.querySelectorAll(selector), cb, context); }); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/foreach-els.js","permalink":"https://hdj.me/lib/pjax/lib/foreach-els.js","excerpt":"","text":"/* global HTMLCollection: true */ module.exports = function(els, fn, context) { if ( els instanceof HTMLCollection || els instanceof NodeList || els instanceof Array ) { return Array.prototype.forEach.call(els, fn, context); } // assume simple DOM element return fn.call(context, els); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/is-supported.js","permalink":"https://hdj.me/lib/pjax/lib/is-supported.js","excerpt":"","text":"module.exports = function() { // Borrowed wholesale from https://github.com/defunkt/jquery-pjax return ( window.history && window.history.pushState && window.history.replaceState && // pushState isn’t reliable on iOS until 5. !navigator.userAgent.match( /((iPod|iPhone|iPad).+\\bOS\\s+[1-4]\\D|WebApps\\/.+CFNetwork)/ ) ); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/parse-options.js","permalink":"https://hdj.me/lib/pjax/lib/parse-options.js","excerpt":"","text":"/* global _gaq: true, ga: true */ var defaultSwitches = require(\"./switches\"); module.exports = function(options) { options = options || {}; options.elements = options.elements || \"a[href], form[action]\"; options.selectors = options.selectors || [\"title\", \".js-Pjax\"]; options.switches = options.switches || {}; options.switchesOptions = options.switchesOptions || {}; options.history = typeof options.history === \"undefined\" ? true : options.history; options.analytics = typeof options.analytics === \"function\" || options.analytics === false ? options.analytics : defaultAnalytics; options.scrollTo = typeof options.scrollTo === \"undefined\" ? 0 : options.scrollTo; options.scrollRestoration = typeof options.scrollRestoration !== \"undefined\" ? options.scrollRestoration : true; options.cacheBust = typeof options.cacheBust === \"undefined\" ? true : options.cacheBust; options.debug = options.debug || false; options.timeout = options.timeout || 0; options.currentUrlFullReload = typeof options.currentUrlFullReload === \"undefined\" ? false : options.currentUrlFullReload; // We can’t replace body.outerHTML or head.outerHTML. // It creates a bug where a new body or head are created in the DOM. // If you set head.outerHTML, a new body tag is appended, so the DOM has 2 body nodes, and vice versa if (!options.switches.head) { options.switches.head = defaultSwitches.switchElementsAlt; } if (!options.switches.body) { options.switches.body = defaultSwitches.switchElementsAlt; } return options; }; /* istanbul ignore next */ function defaultAnalytics() { if (window._gaq) { _gaq.push([\"_trackPageview\"]); } if (window.ga) { ga(\"send\", \"pageview\", { page: location.pathname, title: document.title }); } }"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/send-request.js","permalink":"https://hdj.me/lib/pjax/lib/send-request.js","excerpt":"","text":"var updateQueryString = require(\"./util/update-query-string\"); module.exports = function(location, options, callback) { options = options || {}; var queryString; var requestOptions = options.requestOptions || {}; var requestMethod = (requestOptions.requestMethod || \"GET\").toUpperCase(); var requestParams = requestOptions.requestParams || null; var formData = requestOptions.formData || null; var requestPayload = null; var request = new XMLHttpRequest(); var timeout = options.timeout || 0; request.onreadystatechange = function() { if (request.readyState === 4) { if (request.status === 200) { callback(request.responseText, request, location, options); } else if (request.status !== 0) { callback(null, request, location, options); } } }; request.onerror = function(e) { console.log(e); callback(null, request, location, options); }; request.ontimeout = function() { callback(null, request, location, options); }; // Prepare the request payload for forms, if available if (requestParams && requestParams.length) { // Build query string queryString = requestParams .map(function(param) { return param.name + \"=\" + param.value; }) .join(\"&\"); switch (requestMethod) { case \"GET\": // Reset query string to avoid an issue with repeat submissions where checkboxes that were // previously checked are incorrectly preserved location = location.split(\"?\")[0]; // Append new query string location += \"?\" + queryString; break; case \"POST\": // Send query string as request payload requestPayload = queryString; break; } } else if (formData) { requestPayload = formData; } // Add a timestamp as part of the query string if cache busting is enabled if (options.cacheBust) { location = updateQueryString(location, \"t\", Date.now()); } request.open(requestMethod, location, true); request.timeout = timeout; request.setRequestHeader(\"X-Requested-With\", \"XMLHttpRequest\"); request.setRequestHeader(\"X-PJAX\", \"true\"); request.setRequestHeader( \"X-PJAX-Selectors\", JSON.stringify(options.selectors) ); // Send the proper header information for POST forms if (requestPayload && requestMethod === \"POST\" && !formData) { request.setRequestHeader( \"Content-Type\", \"application/x-www-form-urlencoded\" ); } request.send(requestPayload); return request; };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/switches-selectors.js","permalink":"https://hdj.me/lib/pjax/lib/switches-selectors.js","excerpt":"","text":"var forEachEls = require(\"./foreach-els\"); var defaultSwitches = require(\"./switches\"); module.exports = function( switches, switchesOptions, selectors, fromEl, toEl, options ) { var switchesQueue = []; selectors.forEach(function(selector) { var newEls = fromEl.querySelectorAll(selector); var oldEls = toEl.querySelectorAll(selector); if (this.log) { this.log(\"Pjax switch\", selector, newEls, oldEls); } if (newEls.length !== oldEls.length) { throw \"DOM doesn’t look the same on new loaded page: ’\" + selector + \"’ - new \" + newEls.length + \", old \" + oldEls.length; } forEachEls( newEls, function(newEl, i) { var oldEl = oldEls[i]; if (this.log) { this.log(\"newEl\", newEl, \"oldEl\", oldEl); } var callback = switches[selector] ? switches[selector].bind( this, oldEl, newEl, options, switchesOptions[selector] ) : defaultSwitches.outerHTML.bind(this, oldEl, newEl, options); switchesQueue.push(callback); }, this ); }, this); this.state.numPendingSwitches = switchesQueue.length; switchesQueue.forEach(function(queuedSwitch) { queuedSwitch(); }); };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/uniqueid.js","permalink":"https://hdj.me/lib/pjax/lib/uniqueid.js","excerpt":"","text":"module.exports = (function() { var counter = 0; return function() { var id = \"pjax\" + new Date().getTime() + \"_\" + counter; counter++; return id; }; })();"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/switches.js","permalink":"https://hdj.me/lib/pjax/lib/switches.js","excerpt":"","text":"var on = require(\"./events/on\"); module.exports = { outerHTML: function(oldEl, newEl) { oldEl.outerHTML = newEl.outerHTML; this.onSwitch(); }, innerHTML: function(oldEl, newEl) { oldEl.innerHTML = newEl.innerHTML; if (newEl.className === \"\") { oldEl.removeAttribute(\"class\"); } else { //oldEl.className = newEl.className; } this.onSwitch(); }, switchElementsAlt: function(oldEl, newEl) { oldEl.innerHTML = newEl.innerHTML; // Copy attributes from the new element to the old one if (newEl.hasAttributes()) { var attrs = newEl.attributes; for (var i = 0; i < attrs.length; i++) { oldEl.attributes.setNamedItem(attrs[i].cloneNode()); } } this.onSwitch(); }, // Equivalent to outerHTML(), but doesn't require switchElementsAlt() for and replaceNode: function(oldEl, newEl) { oldEl.parentNode.replaceChild(newEl, oldEl); this.onSwitch(); }, sideBySide: function(oldEl, newEl, options, switchOptions) { var forEach = Array.prototype.forEach; var elsToRemove = []; var elsToAdd = []; var fragToAppend = document.createDocumentFragment(); var animationEventNames = \"animationend webkitAnimationEnd MSAnimationEnd oanimationend\"; var animatedElsNumber = 0; var sexyAnimationEnd = function(e) { if (e.target !== e.currentTarget) { // end triggered by an animation on a child return; } animatedElsNumber--; if (animatedElsNumber"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/setup.js","permalink":"https://hdj.me/lib/pjax/tests/setup.js","excerpt":"","text":"var jsdomOptions = { url: \"https://example.org/\", runScripts: \"dangerously\" }; require(\"jsdom-global\")(\"\", jsdomOptions);"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/pjax.js","permalink":"https://hdj.me/lib/pjax/pjax.js","excerpt":"","text":"(function(f){if(typeof exports===\"object\"&&typeof module!==\"undefined\"){module.exports=f()}else if(typeof define===\"function\"&&define.amd){define([],f)}else{var g;if(typeof window!==\"undefined\"){g=window}else if(typeof global!==\"undefined\"){g=global}else if(typeof self!==\"undefined\"){g=self}else{g=this}g.Pjax = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i 1 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey ) { return \"modifier\"; } // we do test on href now to prevent unexpected behavior if for some reason // user have href that can be dynamically updated // Ignore external links. if ( el.protocol !== window.location.protocol || el.host !== window.location.host ) { return \"external\"; } // Ignore anchors on the same page (keep native behavior) if ( el.hash && el.href.replace(el.hash, \"\") === window.location.href.replace(location.hash, \"\") ) { return \"anchor\"; } // Ignore empty anchor \"foo.html#\" if (el.href === window.location.href.split(\"#\")[0] + \"#\") { return \"anchor-empty\"; } } var isDefaultPrevented = function(event) { return event.defaultPrevented || event.returnValue === false; }; module.exports = function(el) { var that = this; el.setAttribute(attrState, \"\"); on(el, \"click\", function(event) { linkAction.call(that, el, event); }); on( el, \"keyup\", function(event) { if (event.keyCode === 13) { linkAction.call(that, el, event); } }.bind(this) ); }; },{\"../events/on\":4,\"../util/clone\":20}],13:[function(require,module,exports){ var clone = require(\"../util/clone\"); var newUid = require(\"../uniqueid\"); var trigger = require(\"../events/trigger\"); module.exports = function(responseText, request, href, options) { options = clone(options || this.options); options.request = request; // Fail if unable to load HTML via AJAX if (responseText === false) { trigger(document, \"pjax:complete pjax:error\", options); return; } // push scroll position to history var currentState = window.history.state || {}; window.history.replaceState( { url: currentState.url || window.location.href, title: currentState.title || document.title, uid: currentState.uid || newUid(), scrollPos: [ document.documentElement.scrollLeft || document.body.scrollLeft, document.documentElement.scrollTop || document.body.scrollTop ] }, document.title, window.location.href ); // Check for redirects var oldHref = href; if (request.responseURL) { if (href !== request.responseURL) { href = request.responseURL; } } else if (request.getResponseHeader(\"X-PJAX-URL\")) { href = request.getResponseHeader(\"X-PJAX-URL\"); } else if (request.getResponseHeader(\"X-XHR-Redirected-To\")) { href = request.getResponseHeader(\"X-XHR-Redirected-To\"); } // Add back the hash if it was removed var a = document.createElement(\"a\"); a.href = oldHref; var oldHash = a.hash; a.href = href; if (oldHash && !a.hash) { a.hash = oldHash; href = a.href; } this.state.href = href; this.state.options = options; try { this.loadContent(responseText, options); } catch (e) { trigger(document, \"pjax:error\", options); if (!this.options.debug) { if (console && console.error) { console.error(\"Pjax switch fail: \", e); } return this.latestChance(href); } else { throw e; } } }; },{\"../events/trigger\":5,\"../uniqueid\":19,\"../util/clone\":20}],14:[function(require,module,exports){ module.exports = function() { if (this.options.debug && console) { if (typeof console.log === \"function\") { console.log.apply(console, arguments); } // IE is weird else if (console.log) { console.log(arguments); } } }; },{}],15:[function(require,module,exports){ var attrState = \"data-pjax-state\"; module.exports = function(el) { switch (el.tagName.toLowerCase()) { case \"a\": // only attach link if el does not already have link attached if (!el.hasAttribute(attrState)) { this.attachLink(el); } break; case \"form\": // only attach link if el does not already have link attached if (!el.hasAttribute(attrState)) { this.attachForm(el); } break; default: throw \"Pjax can only be applied on or submit\"; } }; },{}],16:[function(require,module,exports){ var updateQueryString = require(\"./util/update-query-string\"); module.exports = function(location, options, callback) { options = options || {}; var queryString; var requestOptions = options.requestOptions || {}; var requestMethod = (requestOptions.requestMethod || \"GET\").toUpperCase(); var requestParams = requestOptions.requestParams || null; var formData = requestOptions.formData || null; var requestPayload = null; var request = new XMLHttpRequest(); var timeout = options.timeout || 0; request.onreadystatechange = function() { if (request.readyState === 4) { if (request.status === 200) { callback(request.responseText, request, location, options); } else if (request.status !== 0) { callback(null, request, location, options); } } }; request.onerror = function(e) { console.log(e); callback(null, request, location, options); }; request.ontimeout = function() { callback(null, request, location, options); }; // Prepare the request payload for forms, if available if (requestParams && requestParams.length) { // Build query string queryString = requestParams .map(function(param) { return param.name + \"=\" + param.value; }) .join(\"&\"); switch (requestMethod) { case \"GET\": // Reset query string to avoid an issue with repeat submissions where checkboxes that were // previously checked are incorrectly preserved location = location.split(\"?\")[0]; // Append new query string location += \"?\" + queryString; break; case \"POST\": // Send query string as request payload requestPayload = queryString; break; } } else if (formData) { requestPayload = formData; } // Add a timestamp as part of the query string if cache busting is enabled if (options.cacheBust) { location = updateQueryString(location, \"t\", Date.now()); } request.open(requestMethod, location, true); request.timeout = timeout; request.setRequestHeader(\"X-Requested-With\", \"XMLHttpRequest\"); request.setRequestHeader(\"X-PJAX\", \"true\"); request.setRequestHeader( \"X-PJAX-Selectors\", JSON.stringify(options.selectors) ); // Send the proper header information for POST forms if (requestPayload && requestMethod === \"POST\" && !formData) { request.setRequestHeader( \"Content-Type\", \"application/x-www-form-urlencoded\" ); } request.send(requestPayload); return request; }; },{\"./util/update-query-string\":24}],17:[function(require,module,exports){ var forEachEls = require(\"./foreach-els\"); var defaultSwitches = require(\"./switches\"); module.exports = function( switches, switchesOptions, selectors, fromEl, toEl, options ) { var switchesQueue = []; selectors.forEach(function(selector) { var newEls = fromEl.querySelectorAll(selector); var oldEls = toEl.querySelectorAll(selector); if (this.log) { this.log(\"Pjax switch\", selector, newEls, oldEls); } if (newEls.length !== oldEls.length) { throw \"DOM doesn’t look the same on new loaded page: ’\" + selector + \"’ - new \" + newEls.length + \", old \" + oldEls.length; } forEachEls( newEls, function(newEl, i) { var oldEl = oldEls[i]; if (this.log) { this.log(\"newEl\", newEl, \"oldEl\", oldEl); } var callback = switches[selector] ? switches[selector].bind( this, oldEl, newEl, options, switchesOptions[selector] ) : defaultSwitches.outerHTML.bind(this, oldEl, newEl, options); switchesQueue.push(callback); }, this ); }, this); this.state.numPendingSwitches = switchesQueue.length; switchesQueue.forEach(function(queuedSwitch) { queuedSwitch(); }); }; },{\"./foreach-els\":7,\"./switches\":18}],18:[function(require,module,exports){ var on = require(\"./events/on\"); module.exports = { outerHTML: function(oldEl, newEl) { oldEl.outerHTML = newEl.outerHTML; this.onSwitch(); }, innerHTML: function(oldEl, newEl) { oldEl.innerHTML = newEl.innerHTML; if (newEl.className === \"\") { oldEl.removeAttribute(\"class\"); } else { //oldEl.className = newEl.className; } this.onSwitch(); }, switchElementsAlt: function(oldEl, newEl) { oldEl.innerHTML = newEl.innerHTML; // Copy attributes from the new element to the old one if (newEl.hasAttributes()) { var attrs = newEl.attributes; for (var i = 0; i < attrs.length; i++) { oldEl.attributes.setNamedItem(attrs[i].cloneNode()); } } this.onSwitch(); }, // Equivalent to outerHTML(), but doesn't require switchElementsAlt() for and replaceNode: function(oldEl, newEl) { oldEl.parentNode.replaceChild(newEl, oldEl); this.onSwitch(); }, sideBySide: function(oldEl, newEl, options, switchOptions) { var forEach = Array.prototype.forEach; var elsToRemove = []; var elsToAdd = []; var fragToAppend = document.createDocumentFragment(); var animationEventNames = \"animationend webkitAnimationEnd MSAnimationEnd oanimationend\"; var animatedElsNumber = 0; var sexyAnimationEnd = function(e) { if (e.target !== e.currentTarget) { // end triggered by an animation on a child return; } animatedElsNumber--; if (animatedElsNumber"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/events/on.js","permalink":"https://hdj.me/lib/pjax/lib/events/on.js","excerpt":"","text":"var forEachEls = require(\"../foreach-els\"); module.exports = function(els, events, listener, useCapture) { events = typeof events === \"string\" ? events.split(\" \") : events; events.forEach(function(e) { forEachEls(els, function(el) { el.addEventListener(e, listener, useCapture); }); }); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/events/off.js","permalink":"https://hdj.me/lib/pjax/lib/events/off.js","excerpt":"","text":"var forEachEls = require(\"../foreach-els\"); module.exports = function(els, events, listener, useCapture) { events = typeof events === \"string\" ? events.split(\" \") : events; events.forEach(function(e) { forEachEls(els, function(el) { el.removeEventListener(e, listener, useCapture); }); }); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/events/trigger.js","permalink":"https://hdj.me/lib/pjax/lib/events/trigger.js","excerpt":"","text":"var forEachEls = require(\"../foreach-els\"); module.exports = function(els, events, opts) { events = typeof events === \"string\" ? events.split(\" \") : events; events.forEach(function(e) { var event; event = document.createEvent(\"HTMLEvents\"); event.initEvent(e, true, true); event.eventName = e; if (opts) { Object.keys(opts).forEach(function(key) { event[key] = opts[key]; }); } forEachEls(els, function(el) { var domFix = false; if (!el.parentNode && el !== document && el !== window) { // THANK YOU IE (9/10/11) // dispatchEvent doesn't work if the element is not in the DOM domFix = true; document.body.appendChild(el); } el.dispatchEvent(event); if (domFix) { el.parentNode.removeChild(el); } }); }); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/proto/attach-form.js","permalink":"https://hdj.me/lib/pjax/lib/proto/attach-form.js","excerpt":"","text":"var on = require(\"../events/on\"); var clone = require(\"../util/clone\"); var attrState = \"data-pjax-state\"; var formAction = function(el, event) { if (isDefaultPrevented(event)) { return; } // Since loadUrl modifies options and we may add our own modifications below, // clone it so the changes don't persist var options = clone(this.options); // Initialize requestOptions options.requestOptions = { requestUrl: el.getAttribute(\"action\") || window.location.href, requestMethod: el.getAttribute(\"method\") || \"GET\" }; // create a testable virtual link of the form action var virtLinkElement = document.createElement(\"a\"); virtLinkElement.setAttribute(\"href\", options.requestOptions.requestUrl); var attrValue = checkIfShouldAbort(virtLinkElement, options); if (attrValue) { el.setAttribute(attrState, attrValue); return; } event.preventDefault(); if (el.enctype === \"multipart/form-data\") { options.requestOptions.formData = new FormData(el); } else { options.requestOptions.requestParams = parseFormElements(el); } el.setAttribute(attrState, \"submit\"); options.triggerElement = el; this.loadUrl(virtLinkElement.href, options); }; function parseFormElements(el) { var requestParams = []; var formElements = el.elements; for (var i = 0; i < formElements.length; i++) { var element = formElements[i]; var tagName = element.tagName.toLowerCase(); // jscs:disable disallowImplicitTypeConversion if ( !!element.name && element.attributes !== undefined && tagName !== \"button\" ) { // jscs:enable disallowImplicitTypeConversion var type = element.attributes.type; if ( !type || (type.value !== \"checkbox\" && type.value !== \"radio\") || element.checked ) { // Build array of values to submit var values = []; if (tagName === \"select\") { var opt; for (var j = 0; j < element.options.length; j++) { opt = element.options[j]; if (opt.selected && !opt.disabled) { values.push(opt.hasAttribute(\"value\") ? opt.value : opt.text); } } } else { values.push(element.value); } for (var k = 0; k < values.length; k++) { requestParams.push({ name: encodeURIComponent(element.name), value: encodeURIComponent(values[k]) }); } } } } return requestParams; } function checkIfShouldAbort(virtLinkElement, options) { // Ignore external links. if ( virtLinkElement.protocol !== window.location.protocol || virtLinkElement.host !== window.location.host ) { return \"external\"; } // Ignore click if we are on an anchor on the same page if ( virtLinkElement.hash && virtLinkElement.href.replace(virtLinkElement.hash, \"\") === window.location.href.replace(location.hash, \"\") ) { return \"anchor\"; } // Ignore empty anchor \"foo.html#\" if (virtLinkElement.href === window.location.href.split(\"#\")[0] + \"#\") { return \"anchor-empty\"; } // if declared as a full reload, just normally submit the form if ( options.currentUrlFullReload && virtLinkElement.href === window.location.href.split(\"#\")[0] ) { return \"reload\"; } } var isDefaultPrevented = function(event) { return event.defaultPrevented || event.returnValue === false; }; module.exports = function(el) { var that = this; el.setAttribute(attrState, \"\"); on(el, \"submit\", function(event) { formAction.call(that, el, event); }); };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/proto/handle-response.js","permalink":"https://hdj.me/lib/pjax/lib/proto/handle-response.js","excerpt":"","text":"var clone = require(\"../util/clone\"); var newUid = require(\"../uniqueid\"); var trigger = require(\"../events/trigger\"); module.exports = function(responseText, request, href, options) { options = clone(options || this.options); options.request = request; // Fail if unable to load HTML via AJAX if (responseText === false) { trigger(document, \"pjax:complete pjax:error\", options); return; } // push scroll position to history var currentState = window.history.state || {}; window.history.replaceState( { url: currentState.url || window.location.href, title: currentState.title || document.title, uid: currentState.uid || newUid(), scrollPos: [ document.documentElement.scrollLeft || document.body.scrollLeft, document.documentElement.scrollTop || document.body.scrollTop ] }, document.title, window.location.href ); // Check for redirects var oldHref = href; if (request.responseURL) { if (href !== request.responseURL) { href = request.responseURL; } } else if (request.getResponseHeader(\"X-PJAX-URL\")) { href = request.getResponseHeader(\"X-PJAX-URL\"); } else if (request.getResponseHeader(\"X-XHR-Redirected-To\")) { href = request.getResponseHeader(\"X-XHR-Redirected-To\"); } // Add back the hash if it was removed var a = document.createElement(\"a\"); a.href = oldHref; var oldHash = a.hash; a.href = href; if (oldHash && !a.hash) { a.hash = oldHash; href = a.href; } this.state.href = href; this.state.options = options; try { this.loadContent(responseText, options); } catch (e) { trigger(document, \"pjax:error\", options); if (!this.options.debug) { if (console && console.error) { console.error(\"Pjax switch fail: \", e); } return this.latestChance(href); } else { throw e; } } };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/proto/log.js","permalink":"https://hdj.me/lib/pjax/lib/proto/log.js","excerpt":"","text":"module.exports = function() { if (this.options.debug && console) { if (typeof console.log === \"function\") { console.log.apply(console, arguments); } // IE is weird else if (console.log) { console.log(arguments); } } };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/proto/attach-link.js","permalink":"https://hdj.me/lib/pjax/lib/proto/attach-link.js","excerpt":"","text":"var on = require(\"../events/on\"); var clone = require(\"../util/clone\"); var attrState = \"data-pjax-state\"; var linkAction = function(el, event) { if (isDefaultPrevented(event)) { return; } // Since loadUrl modifies options and we may add our own modifications below, // clone it so the changes don't persist var options = clone(this.options); var attrValue = checkIfShouldAbort(el, event); if (attrValue) { el.setAttribute(attrState, attrValue); return; } event.preventDefault(); // don’t do \"nothing\" if user try to reload the page by clicking the same link twice if ( this.options.currentUrlFullReload && el.href === window.location.href.split(\"#\")[0] ) { el.setAttribute(attrState, \"reload\"); this.reload(); return; } el.setAttribute(attrState, \"load\"); options.triggerElement = el; this.loadUrl(el.href, options); }; function checkIfShouldAbort(el, event) { // Don’t break browser special behavior on links (like page in new window) if ( event.which > 1 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey ) { return \"modifier\"; } // we do test on href now to prevent unexpected behavior if for some reason // user have href that can be dynamically updated // Ignore external links. if ( el.protocol !== window.location.protocol || el.host !== window.location.host ) { return \"external\"; } // Ignore anchors on the same page (keep native behavior) if ( el.hash && el.href.replace(el.hash, \"\") === window.location.href.replace(location.hash, \"\") ) { return \"anchor\"; } // Ignore empty anchor \"foo.html#\" if (el.href === window.location.href.split(\"#\")[0] + \"#\") { return \"anchor-empty\"; } } var isDefaultPrevented = function(event) { return event.defaultPrevented || event.returnValue === false; }; module.exports = function(el) { var that = this; el.setAttribute(attrState, \"\"); on(el, \"click\", function(event) { linkAction.call(that, el, event); }); on( el, \"keyup\", function(event) { if (event.keyCode === 13) { linkAction.call(that, el, event); } }.bind(this) ); };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/util/clone.js","permalink":"https://hdj.me/lib/pjax/lib/util/clone.js","excerpt":"","text":"module.exports = function(obj) { /* istanbul ignore if */ if (null === obj || \"object\" !== typeof obj) { return obj; } var copy = obj.constructor(); for (var attr in obj) { if (obj.hasOwnProperty(attr)) { copy[attr] = obj[attr]; } } return copy; };"},{"title":"","date":"2024-12-03T10:58:04.736Z","updated":"2024-12-03T10:58:04.736Z","comments":true,"path":"lib/pjax/lib/proto/parse-element.js","permalink":"https://hdj.me/lib/pjax/lib/proto/parse-element.js","excerpt":"","text":"var attrState = \"data-pjax-state\"; module.exports = function(el) { switch (el.tagName.toLowerCase()) { case \"a\": // only attach link if el does not already have link attached if (!el.hasAttribute(attrState)) { this.attachLink(el); } break; case \"form\": // only attach link if el does not already have link attached if (!el.hasAttribute(attrState)) { this.attachForm(el); } break; default: throw \"Pjax can only be applied on or submit\"; } };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/util/extend.js","permalink":"https://hdj.me/lib/pjax/lib/util/extend.js","excerpt":"","text":"module.exports = function(target) { if (target == null) { return null; } var to = Object(target); for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; if (source != null) { for (var key in source) { // Avoid bugs when hasOwnProperty is shadowed if (Object.prototype.hasOwnProperty.call(source, key)) { to[key] = source[key]; } } } } return to; };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/util/contains.js","permalink":"https://hdj.me/lib/pjax/lib/util/contains.js","excerpt":"","text":"module.exports = function contains(doc, selectors, el) { for (var i = 0; i < selectors.length; i++) { var selectedEls = doc.querySelectorAll(selectors[i]); for (var j = 0; j < selectedEls.length; j++) { if (selectedEls[j].contains(el)) { return true; } } } return false; };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/util/noop.js","permalink":"https://hdj.me/lib/pjax/lib/util/noop.js","excerpt":"","text":"module.exports = function() {};"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/lib/util/update-query-string.js","permalink":"https://hdj.me/lib/pjax/lib/util/update-query-string.js","excerpt":"","text":"module.exports = function(uri, key, value) { var re = new RegExp(\"([?&])\" + key + \"=.*?(&|$)\", \"i\"); var separator = uri.indexOf(\"?\") !== -1 ? \"&\" : \"?\"; if (uri.match(re)) { return uri.replace(re, \"$1\" + key + \"=\" + value + \"$2\"); } else { return uri + separator + key + \"=\" + value; } };"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/eval-scripts.js","permalink":"https://hdj.me/lib/pjax/tests/lib/eval-scripts.js","excerpt":"","text":"var tape = require(\"tape\"); var evalScript = require(\"../../lib/eval-script\"); tape(\"test evalScript method\", function(t) { document.body.className = \"\"; var script = document.createElement(\"script\"); script.innerHTML = \"document.body.className = 'executed'\"; t.equal(document.body.className, \"\", \"script hasn't been executed yet\"); evalScript(script); t.equal( document.body.className, \"executed\", \"script has been properly executed\" ); script.innerHTML = \"document.write('failure')\"; var bodyText = \"document.write hasn't been executed\"; document.body.text = bodyText; evalScript(script); t.equal(document.body.text, bodyText, \"document.write hasn't been executed\"); t.end(); }); tape( \"evalScript should not throw an error if the script removed itself\", function(t) { var script = document.createElement(\"script\"); script.id = \"myScript\"; script.innerHTML = \"const script = document.querySelector('#myScript');\" + \"script.parentNode.removeChild(script);\"; try { evalScript(script); t.pass(\"Missing script tested successfully\"); } catch (e) { console.error(e); t.fail(\"Attempted to remove missing script\"); } t.end(); } );"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/abort-request.js","permalink":"https://hdj.me/lib/pjax/tests/lib/abort-request.js","excerpt":"","text":"var tape = require(\"tape\"); var abortRequest = require(\"../../lib/abort-request.js\"); var sendRequest = require(\"../../lib/send-request.js\"); // Polyfill responseURL property into XMLHttpRequest if it doesn't exist, // just for the purposes of this test // This polyfill is not complete; it won't show the updated location if a // redirection occurred, but it's fine for our purposes. if (!(\"responseURL\" in XMLHttpRequest.prototype)) { var nativeOpen = XMLHttpRequest.prototype.open; XMLHttpRequest.prototype.open = function(method, url) { this.responseURL = url; return nativeOpen.apply(this, arguments); }; } tape(\"test aborting xhr request\", function(t) { var requestCacheBust = sendRequest.bind({ options: { cacheBust: true } }); t.test(\"- pending request is aborted\", function(t) { var r = requestCacheBust(\"https://httpbin.org/delay/10\", {}, function() { t.fail(\"xhr was not aborted\"); }); t.equal(r.readyState, 1, \"xhr readyState is '1' (SENT)\"); abortRequest(r); t.equal(r.readyState, 0, \"xhr readyState is '0' (ABORTED)\"); t.equal(r.status, 0, \"xhr HTTP status is '0' (ABORTED)\"); t.equal(r.responseText, \"\", \"xhr response is empty\"); t.end(); }); t.test(\"- request is not aborted if it has already completed\", function(t) { var r = requestCacheBust(\"https://httpbin.org/get\", {}, function() { abortRequest(r); t.equal(r.readyState, 4, \"xhr readyState is '4' (DONE)\"); t.equal(r.status, 200, \"xhr HTTP status is '200' (OK)\"); t.end(); }); }); t.test(\"- request is not aborted if it is undefined\", function(t) { var r; try { abortRequest(r); } catch (e) { t.fail(\"aborting an undefined request threw an error\"); } t.equal(typeof r, \"undefined\", \"undefined xhr was ignored\"); t.end(); }); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/execute-scripts.js","permalink":"https://hdj.me/lib/pjax/tests/lib/execute-scripts.js","excerpt":"","text":"var tape = require(\"tape\"); var executeScripts = require(\"../../lib/execute-scripts\"); tape( \"test executeScripts method when the script tag is inside a container\", function(t) { document.body.className = \"\"; var container = document.createElement(\"div\"); container.innerHTML = \"document.body.className = 'executed';\"; t.equal(document.body.className, \"\", \"script hasn't been executed yet\"); executeScripts(container); t.equal( document.body.className, \"executed correctly\", \"script has been properly executed\" ); t.end(); } ); tape(\"test executeScripts method with just a script tag\", function(t) { document.body.className = \"\"; var script = document.createElement(\"script\"); script.innerHTML = \"document.body.className = 'executed correctly';\"; t.equal(document.body.className, \"\", \"script hasn't been executed yet\"); executeScripts(script); t.equal( document.body.className, \"executed correctly\", \"script has been properly executed\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/foreach-els.js","permalink":"https://hdj.me/lib/pjax/tests/lib/foreach-els.js","excerpt":"","text":"var tape = require(\"tape\"); var forEachEls = require(\"../../lib/foreach-els.js\"); var div = document.createElement(\"div\"); var span = document.createElement(\"span\"); var cb = function(el) { el.innerHTML = \"boom\"; }; tape(\"test forEachEls on one element\", function(t) { div.innerHTML = \"div tag\"; forEachEls(div, cb); t.equal(div.innerHTML, \"boom\", \"works correctly on one element\"); t.end(); }); tape(\"test forEachEls on an array\", function(t) { div.innerHTML = \"div tag\"; span.innerHTML = \"span tag\"; forEachEls([div, span], cb); t.equal( div.innerHTML, \"boom\", \"works correctly on the first element of the array\" ); t.equal( span.innerHTML, \"boom\", \"works correctly on the last element of the array\" ); t.end(); }); tape(\"test forEachEls on a NodeList\", function(t) { div.innerHTML = \"div tag\"; span.innerHTML = \"span tag\"; var frag = document.createDocumentFragment(); frag.appendChild(div); frag.appendChild(span); forEachEls(frag.childNodes, cb); t.equal( div.innerHTML, \"boom\", \"works correctly on the first element of the document fragment\" ); t.equal( span.innerHTML, \"boom\", \"works correctly on the last element of the document fragment\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/is-supported.js","permalink":"https://hdj.me/lib/pjax/tests/lib/is-supported.js","excerpt":"","text":"var tape = require(\"tape\"); var isSupported = require(\"../../lib/is-supported.js\"); tape(\"test isSupported method\", function(t) { t.true( isSupported(), \"well, we run test on supported browser, so it should be ok here\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/events.js","permalink":"https://hdj.me/lib/pjax/tests/lib/events.js","excerpt":"","text":"var tape = require(\"tape\"); var on = require(\"../../lib/events/on\"); var off = require(\"../../lib/events/off\"); var trigger = require(\"../../lib/events/trigger\"); var el = document.createElement(\"div\"); var el2 = document.createElement(\"span\"); var els = [el, el2]; var classCb = function() { this.className += \"on\"; }; var attrCb = function() { this.setAttribute(\"data-state\", this.getAttribute(\"data-state\") + \"ON\"); }; tape(\"test events on/off/trigger for one element, one event\", function(t) { el.className = \"\"; on(el, \"click\", classCb); trigger(el, \"click\"); t.equal(el.className, \"on\", \"attached callback has been fired properly\"); el.className = \"off\"; off(el, \"click\", classCb); trigger(el, \"click\"); t.equal(el.className, \"off\", \"triggered event didn't fire detached callback\"); t.end(); }); tape(\"test events on/off/trigger for multiple elements, one event\", function( t ) { el.className = \"\"; el2.className = \"\"; on(els, \"click\", classCb); trigger(els, \"click\"); t.equal( el.className, \"on\", \"attached callback has been fired properly on the first element\" ); t.equal( el2.className, \"on\", \"attached callback has been fired properly on the second element\" ); el.className = \"off\"; el2.className = \"off\"; off(els, \"click\", classCb); trigger(els, \"click\"); t.equal( el.className, \"off\", \"triggered event didn't fire detached callback on the first element\" ); t.equal( el2.className, \"off\", \"triggered event didn't fire detached callback on the second element\" ); t.end(); }); tape(\"test events on/off/trigger for one element, multiple events\", function( t ) { el.className = \"\"; on(el, \"click mouseover\", classCb); trigger(el, \"click mouseover\"); t.equal(el.className, \"onon\", \"attached callbacks have been fired properly\"); el.className = \"off\"; off(el, \"click mouseover\", classCb); trigger(el, \"click mouseover\"); t.equal( el.className, \"off\", \"triggered events didn't fire detached callback\" ); t.end(); }); tape( \"test events on/off/trigger for multiple elements, multiple events\", function(t) { el.className = \"\"; el2.className = \"\"; el.setAttribute(\"data-state\", \"\"); el2.setAttribute(\"data-state\", \"\"); on(els, \"click mouseover\", classCb); on(els, \"resize scroll\", attrCb); trigger(els, \"click mouseover resize scroll\"); t.equal( el.className, \"onon\", \"attached callbacks has been fired properly on the first element\" ); t.equal( el.getAttribute(\"data-state\"), \"ONON\", \"attached callbacks has been fired properly on the first element\" ); t.equal( el2.className, \"onon\", \"attached callbacks has been fired properly on the second element\" ); t.equal( el2.getAttribute(\"data-state\"), \"ONON\", \"attached callbacks has been fired properly on the second element\" ); el.className = \"off\"; el2.className = \"off\"; el.setAttribute(\"data-state\", \"off\"); el2.setAttribute(\"data-state\", \"off\"); off(els, \"click mouseover\", classCb); off(els, \"resize scroll\", attrCb); trigger(els, \"click mouseover resize scroll\"); t.equal( el.className, \"off\", \"triggered events didn't fire detached callbacks on the first element\" ); t.equal( el.getAttribute(\"data-state\"), \"off\", \"triggered events didn't fire detached callbacks on the first element\" ); t.equal( el2.className, \"off\", \"triggered events didn't fire detached callbacks on the first element\" ); t.equal( el2.getAttribute(\"data-state\"), \"off\", \"triggered events didn't fire detached callbacks on the first element\" ); t.end(); } ); tape(\"test events on top level elements\", function(t) { var el = document; el.className = \"\"; on(el, \"click\", classCb); trigger(el, \"click\"); t.equal( el.className, \"on\", \"attached callback has been fired properly on document\" ); el = window; el.className = \"\"; // With jsdom, the default this is global, not window, so we need to explicitly bind to window. on(el, \"click\", classCb.bind(window)); trigger(el, \"click\"); t.equal( el.className, \"on\", \"attached callback has been fired properly on window\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/foreach-selectors.js","permalink":"https://hdj.me/lib/pjax/tests/lib/foreach-selectors.js","excerpt":"","text":"var tape = require(\"tape\"); var forEachEls = require(\"../../lib/foreach-selectors.js\"); var cb = function(el) { el.className = \"modified\"; }; tape(\"test forEachSelector\", function(t) { forEachEls([\"html\", \"body\"], cb); t.equal( document.documentElement.className, \"modified\", \"callback has been executed on first selector\" ); t.equal( document.body.className, \"modified\", \"callback has been executed on first selector\" ); document.documentElement.className = \"\"; document.body.className = \"\"; forEachEls([\"html\", \"body\"], cb, null, document.documentElement); t.equal( document.documentElement.className, \"\", \"callback has not been executed on first selector when context is used\" ); t.equal( document.body.className, \"modified\", \"callback has been executed on first selector when context is used\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/send-request.js","permalink":"https://hdj.me/lib/pjax/tests/lib/send-request.js","excerpt":"","text":"var tape = require(\"tape\"); var sendRequest = require(\"../../lib/send-request.js\"); // Polyfill responseURL property into XMLHttpRequest if it doesn't exist, // just for the purposes of this test // This polyfill is not complete; it won't show the updated location if a // redirection occurred, but it's fine for our purposes. if (!(\"responseURL\" in XMLHttpRequest.prototype)) { var nativeOpen = XMLHttpRequest.prototype.open; XMLHttpRequest.prototype.open = function(method, url) { this.responseURL = url; return nativeOpen.apply(this, arguments); }; } tape(\"test xhr request\", function(t) { var url = \"https://httpbin.org/get\"; t.test(\"- request is made, gets a result, and is cache-busted\", function(t) { var r = sendRequest(url, { cacheBust: true }, function(result) { t.equal( r.responseURL.indexOf(\"?\"), url.length, \"XHR URL is cache-busted when configured to be\" ); try { result = JSON.parse(result); } catch (e) { t.fail(\"xhr doesn't get a JSON response\"); } t.same(typeof result, \"object\", \"xhr request get a result\"); t.end(); }); }); t.test(\"- request is not cache-busted when configured not to be\", function( t ) { var r = sendRequest(url, {}, function() { t.equal(r.responseURL, url, \"XHR URL is left untouched\"); t.end(); }); }); t.end(); }); tape(\"request headers are sent properly\", function(t) { var url = \"https://httpbin.org/headers\"; var options = { selectors: [\"div.pjax\", \"div.container\"] }; sendRequest(url, options, function(responseText) { var headers = JSON.parse(responseText).headers; t.equals( headers[\"X-Requested-With\"], \"XMLHttpRequest\", \"X-Requested-With header is set correctly\" ); // Httpbin.org changes the case to 'X-Pjax' t.equals(headers[\"X-Pjax\"], \"true\", \"X-PJAX header is set correctly\"); t.equals( headers[\"X-Pjax-Selectors\"], '[\"div.pjax\",\"div.container\"]', \"X-PJAX-Selectors header is set correctly\" ); t.end(); }); }); tape(\"HTTP status codes other than 200 are handled properly\", function(t) { var url = \"https://httpbin.org/status/400\"; sendRequest(url, {}, function(responseText, request) { t.equals(responseText, null, \"responseText is null\"); t.equals(request.status, 400, \"HTTP status code is correct\"); t.end(); }); }); tape.skip(\"XHR error is handled properly\", function(t) { var url = \"https://encrypted.google.com/foobar\"; sendRequest(url, {}, function(responseText) { t.equals(responseText, null, \"responseText is null\"); t.end(); }); }); tape(\"POST body data is sent properly\", function(t) { var url = \"https://httpbin.org/post\"; var params = [ { name: \"test\", value: \"1\" } ]; var options = { requestOptions: { requestMethod: \"POST\", requestParams: params } }; sendRequest(url, options, function(responseText) { var response = JSON.parse(responseText); t.same( response.form[params[0].name], params[0].value, \"requestParams were sent properly\" ); t.equals( response.headers[\"Content-Type\"], \"application/x-www-form-urlencoded\", \"Content-Type header was set properly\" ); t.end(); }); }); tape(\"GET query data is sent properly\", function(t) { var url = \"https://httpbin.org/get\"; var params = [ { name: \"test\", value: \"1\" } ]; var options = { requestOptions: { requestParams: params } }; sendRequest(url, options, function(responseText) { var response = JSON.parse(responseText); t.same( response.args[params[0].name], params[0].value, \"requestParams were sent properly\" ); t.end(); }); }); tape(\"XHR timeout is handled properly\", function(t) { var url = \"https://httpbin.org/delay/5\"; var options = { timeout: 1000 }; sendRequest(url, options, function(responseText) { t.equals(responseText, null, \"responseText is null\"); t.end(); }); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/switches.js","permalink":"https://hdj.me/lib/pjax/tests/lib/switches.js","excerpt":"","text":"var tape = require(\"tape\"); var switches = require(\"../../lib/switches\"); var noop = require(\"../../lib/util/noop\"); tape(\"test outerHTML switch\", function(t) { var outerHTML = switches.outerHTML; var doc = document.implementation.createHTMLDocument(); var container = doc.createElement(\"div\"); container.innerHTML = \"Original Text\"; doc.body.appendChild(container); var p = doc.createElement(\"p\"); p.innerHTML = \"New Text\"; outerHTML.bind({ onSwitch: noop })(doc.querySelector(\"p\"), p); t.equals( doc.querySelector(\"p\").innerHTML, \"New Text\", \"Elements correctly switched\" ); t.notEquals( doc.querySelector(\"p\").id, \"p\", \"other attributes overwritten correctly\" ); t.end(); }); tape(\"test innerHTML switch\", function(t) { var innerHTML = switches.innerHTML; var doc = document.implementation.createHTMLDocument(); var container = doc.createElement(\"div\"); container.innerHTML = \"Original Text\"; doc.body.appendChild(container); var p = doc.createElement(\"p\"); p.innerHTML = \"New Text\"; p.className = \"p\"; innerHTML.bind({ onSwitch: noop })(doc.querySelector(\"p\"), p); t.equals( doc.querySelector(\"p\").innerHTML, \"New Text\", \"Elements correctly switched\" ); t.equals(doc.querySelector(\"p\").className, \"p\", \"classname set correctly\"); t.equals(doc.querySelector(\"p\").id, \"p\", \"other attributes set correctly\"); p.removeAttribute(\"class\"); innerHTML.bind({ onSwitch: noop })(doc.querySelector(\"p\"), p); t.equals(doc.querySelector(\"p\").className, \"\", \"classname set correctly\"); t.end(); }); tape(\"test replaceNode switch\", function(t) { var replaceNode = switches.replaceNode; var doc = document.implementation.createHTMLDocument(); var container = doc.createElement(\"div\"); container.innerHTML = \"Original Text\"; doc.body.appendChild(container); var p = doc.createElement(\"p\"); p.innerHTML = \"New Text\"; replaceNode.bind({ onSwitch: noop })(doc.querySelector(\"p\"), p); t.equals( doc.querySelector(\"div\").innerHTML, \"New Text\", \"Elements correctly switched\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/switch-selectors.js","permalink":"https://hdj.me/lib/pjax/tests/lib/switch-selectors.js","excerpt":"","text":"var tape = require(\"tape\"); var switchesSelectors = require(\"../../lib/switches-selectors.js\"); var noop = require(\"../../lib/util/noop\"); var pjax = { onSwitch: function() { console.log(\"Switched\"); }, state: {}, log: noop }; // @author darylteo tape(\"test switchesSelectors\", function(t) { // switchesSelectors relies on a higher level function callback // should really be passed in instead so I'll leave it here as a TODO: var tmpEl = document.implementation.createHTMLDocument(); // a div container is used because swapping the containers // will generate a new element, so things get weird // using \"body\" generates a lot of testling cruft that I don't // want so let's avoid that var container = document.createElement(\"div\"); container.innerHTML = \"Original TextNo Change\"; document.body.appendChild(container); var container2 = tmpEl.createElement(\"div\"); container2.innerHTML = \"New TextNew Span\"; tmpEl.body.appendChild(container2); switchesSelectors.bind(pjax)( {}, // switches {}, // switchesOptions [\"p\"], // selectors, tmpEl, // fromEl document, // toEl, {} // options ); t.equals( container.innerHTML, \"New TextNo Change\", \"Elements correctly switched\" ); t.end(); }); tape(\"test switchesSelectors when number of elements don't match\", function(t) { var newTempDoc = document.implementation.createHTMLDocument(); var originalTempDoc = document.implementation.createHTMLDocument(); // a div container is used because swapping the containers // will generate a new element, so things get weird // using \"body\" generates a lot of testling cruft that I don't // want so let's avoid that var container = originalTempDoc.createElement(\"div\"); container.innerHTML = \"Original textNo change\"; originalTempDoc.body.appendChild(container); var container2 = newTempDoc.createElement(\"div\"); container2.innerHTML = \"New textMore new textNew span\"; newTempDoc.body.appendChild(container2); var switchSelectorsFn = switchesSelectors.bind( pjax, {}, // switches {}, // switchesOptions [\"p\"], // selectors, newTempDoc, // fromEl originalTempDoc, // toEl, {} // options ); t.throws( switchSelectorsFn, null, \"error was thrown properly since number of elements don't match\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/parse-options.js","permalink":"https://hdj.me/lib/pjax/tests/lib/parse-options.js","excerpt":"","text":"var tape = require(\"tape\"); var parseOptions = require(\"../../lib/parse-options.js\"); tape(\"test parse initalization options function\", function(t) { t.test(\"- default options\", function(t) { var pjax = {}; pjax.options = parseOptions({}); t.equal(pjax.options.elements, \"a[href], form[action]\"); t.equal(pjax.options.selectors.length, 2, \"selectors length\"); t.equal(pjax.options.selectors[0], \"title\"); t.equal(pjax.options.selectors[1], \".js-Pjax\"); t.equal(typeof pjax.options.switches, \"object\"); t.equal(Object.keys(pjax.options.switches).length, 2); // head and body t.equal(typeof pjax.options.switchesOptions, \"object\"); t.equal(Object.keys(pjax.options.switchesOptions).length, 0); t.equal(pjax.options.history, true); t.equal(typeof pjax.options.analytics, \"function\"); t.equal(pjax.options.scrollTo, 0); t.equal(pjax.options.scrollRestoration, true); t.equal(pjax.options.cacheBust, true); t.equal(pjax.options.debug, false); t.equal(pjax.options.currentUrlFullReload, false); t.end(); }); // verify analytics always ends up as a function even when passed not a function t.test(\"- analytics is a function\", function(t) { var pjax = {}; pjax.options = parseOptions({ analytics: \"some string\" }); t.deepEqual(typeof pjax.options.analytics, \"function\"); t.end(); }); // verify that the value false for scrollTo is not squashed t.test(\"- scrollTo remains false\", function(t) { var pjax = {}; pjax.options = parseOptions({ scrollTo: false }); t.deepEqual(pjax.options.scrollTo, false); t.end(); }); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/uniqueid.js","permalink":"https://hdj.me/lib/pjax/tests/lib/uniqueid.js","excerpt":"","text":"var tape = require(\"tape\"); var uniqueid = require(\"../../lib/uniqueid.js\"); tape(\"test uniqueid\", function(t) { var a = uniqueid(); var b = uniqueid(); t.notEqual(a, b, \"Two calls to uniqueid produce different values\"); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/proto/attach-form.js","permalink":"https://hdj.me/lib/pjax/tests/lib/proto/attach-form.js","excerpt":"","text":"var tape = require(\"tape\"); var on = require(\"../../../lib/events/on\"); var trigger = require(\"../../../lib/events/trigger\"); var attachForm = require(\"../../../lib/proto/attach-form\"); var attr = \"data-pjax-state\"; tape(\"test attach form prototype method\", function(t) { var form = document.createElement(\"form\"); var loadUrlCalled = false; attachForm.call( { options: { currentUrlFullReload: true }, loadUrl: function() { loadUrlCalled = true; } }, form ); var internalUri = window.location.protocol + \"//\" + window.location.host + window.location.pathname + window.location.search; form.action = \"http://external.com/\"; trigger(form, \"submit\"); t.equal(form.getAttribute(attr), \"external\", \"external url stop behavior\"); form.action = internalUri + \"#anchor\"; trigger(form, \"submit\"); t.equal(form.getAttribute(attr), \"anchor\", \"internal anchor stop behavior\"); window.location.hash = \"#anchor\"; form.action = internalUri + \"#another-anchor\"; trigger(form, \"submit\"); t.equal(form.getAttribute(attr), \"anchor\", \"different anchors stop behavior\"); window.location.hash = \"\"; form.action = internalUri + \"#\"; trigger(form, \"submit\"); t.equal( form.getAttribute(attr), \"anchor-empty\", \"empty anchor stop behavior\" ); form.action = window.location.href; trigger(form, \"submit\"); t.equal( form.getAttribute(attr), \"reload\", \"submitting when currentUrlFullReload is true will submit normally, without XHR\" ); t.equal(loadUrlCalled, false, \"loadUrl() not called\"); form.action = window.location.protocol + \"//\" + window.location.host + \"/internal\"; form.method = \"POST\"; trigger(form, \"submit\"); t.equal( form.getAttribute(attr), \"submit\", \"triggering a POST request to the next page\" ); t.equal(loadUrlCalled, true, \"loadUrl() called correctly\"); loadUrlCalled = false; form.setAttribute(attr, \"\"); form.action = window.location.protocol + \"//\" + window.location.host + \"/internal\"; form.method = \"GET\"; trigger(form, \"submit\"); t.equal( form.getAttribute(attr), \"submit\", \"triggering a GET request to the next page\" ); t.equal(loadUrlCalled, true, \"loadUrl() called correctly\"); t.end(); }); tape(\"test attach form preventDefaulted events\", function(t) { var loadUrlCalled = false; var form = document.createElement(\"form\"); // This needs to be before the call to attachForm() on(form, \"submit\", function(event) { event.preventDefault(); }); attachForm.call( { options: {}, loadUrl: function() { loadUrlCalled = true; } }, form ); form.action = \"#\"; trigger(form, \"submit\"); t.equal( loadUrlCalled, false, \"events that are preventDefaulted should not fire callback\" ); t.end(); }); tape(\"test options are not modified by attachForm\", function(t) { var form = document.createElement(\"form\"); var options = { foo: \"bar\" }; var loadUrl = function() {}; attachForm.call({ options: options, loadUrl: loadUrl }, form); form.action = window.location.protocol + \"//\" + window.location.host + window.location.pathname + window.location.search; form.method = \"GET\"; trigger(form, \"submit\"); t.equal( 1, Object.keys(options).length, \"options object that is passed in should not be modified\" ); t.equal( \"bar\", options.foo, \"options object that is passed in should not be modified\" ); t.end(); }); tape(\"test form elements parsed correctly\", function(t) { t.plan(1); var form = document.createElement(\"form\"); var input = document.createElement(\"input\"); input.name = \"input\"; input.value = \"value\"; form.appendChild(input); var params = [ { name: \"input\", value: \"value\" } ]; var pjax = { options: {}, loadUrl: function(href, options) { t.same( options.requestOptions.requestParams, params, \"form elements parsed correctly\" ); } }; attachForm.call(pjax, form); form.action = window.location.protocol + \"//\" + window.location.host + \"/internal\"; trigger(form, \"submit\"); // see loadUrl defined above t.end(); }); tape('test form.enctype=\"multipart/form-data\"', function(t) { t.plan(4); var form = document.createElement(\"form\"); form.enctype = \"multipart/form-data\"; var input = document.createElement(\"input\"); input.name = \"input\"; input.value = \"value\"; form.appendChild(input); var pjax = { options: {}, loadUrl: function(href, options) { t.equals( options.requestOptions.requestParams, undefined, \"form elements not parsed manually\" ); t.true( options.requestOptions.formData instanceof FormData, \"requestOptions.formData is a FormData\" ); t.equals( Array.from(options.requestOptions.formData.entries()).length, 1, \"correct number of FormData elements\" ); t.equals( options.requestOptions.formData.get(\"input\"), \"value\", \"FormData element value set correctly\" ); } }; attachForm.call(pjax, form); form.action = window.location.protocol + \"//\" + window.location.host + \"/internal\"; trigger(form, \"submit\"); // see loadUrl defined above t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/proto/parse-element.js","permalink":"https://hdj.me/lib/pjax/tests/lib/proto/parse-element.js","excerpt":"","text":"var tape = require(\"tape\"); var parseElement = require(\"../../../lib/proto/parse-element\"); var pjax = { attachLink: function() { return true; }, attachForm: function() { return true; } }; tape(\"test parse element prototype method\", function(t) { t.doesNotThrow(function() { var a = document.createElement(\"a\"); parseElement.call(pjax, a); }, \" element can be parsed\"); t.doesNotThrow(function() { var form = document.createElement(\"form\"); parseElement.call(pjax, form); }, \" element can be parsed\"); t.throws(function() { var el = document.createElement(\"div\"); parseElement.call(pjax, el); }, \" element cannot be parsed\"); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/proto/attach-link.js","permalink":"https://hdj.me/lib/pjax/tests/lib/proto/attach-link.js","excerpt":"","text":"var tape = require(\"tape\"); var on = require(\"../../../lib/events/on\"); var trigger = require(\"../../../lib/events/trigger\"); var attachLink = require(\"../../../lib/proto/attach-link\"); var attr = \"data-pjax-state\"; tape(\"test attach link prototype method\", function(t) { var a = document.createElement(\"a\"); var loadUrlCalled = false; attachLink.call( { options: {}, loadUrl: function() { loadUrlCalled = true; } }, a ); var internalUri = window.location.protocol + \"//\" + window.location.host + window.location.pathname + window.location.search; a.href = internalUri; trigger(a, \"click\", { metaKey: true }); t.equal(a.getAttribute(attr), \"modifier\", \"event key modifier stop behavior\"); a.href = \"http://external.com/\"; trigger(a, \"click\"); t.equal(a.getAttribute(attr), \"external\", \"external url stop behavior\"); window.location.hash = \"#anchor\"; a.href = internalUri + \"#anchor\"; trigger(a, \"click\"); t.equal(a.getAttribute(attr), \"anchor\", \"internal anchor stop behavior\"); a.href = internalUri + \"#another-anchor\"; trigger(a, \"click\"); t.equal(a.getAttribute(attr), \"anchor\", \"different anchors stop behavior\"); window.location.hash = \"\"; a.href = internalUri + \"#\"; trigger(a, \"click\"); t.equal(a.getAttribute(attr), \"anchor-empty\", \"empty anchor stop behavior\"); a.href = window.location.protocol + \"//\" + window.location.host + \"/internal\"; trigger(a, \"click\"); t.equals( a.getAttribute(attr), \"load\", \"triggering an internal link sets the state attribute to 'load'\" ); t.equals( loadUrlCalled, true, \"triggering an internal link actually loads the page\" ); t.end(); }); tape(\"test attach link preventDefaulted events\", function(t) { var loadUrlCalled = false; var a = document.createElement(\"a\"); // This needs to be before the call to attachLink() on(a, \"click\", function(event) { event.preventDefault(); }); attachLink.call( { options: {}, loadUrl: function() { loadUrlCalled = true; } }, a ); a.href = \"#\"; trigger(a, \"click\"); t.equal( loadUrlCalled, false, \"events that are preventDefaulted should not fire callback\" ); t.end(); }); tape(\"test options are not modified by attachLink\", function(t) { var a = document.createElement(\"a\"); var options = { foo: \"bar\" }; var loadUrl = function() {}; attachLink.call({ options: options, loadUrl: loadUrl }, a); a.href = window.location.protocol + \"//\" + window.location.host + window.location.pathname + window.location.search; trigger(a, \"click\"); t.equal( 1, Object.keys(options).length, \"options object that is passed in should not be modified\" ); t.equal( \"bar\", options.foo, \"options object that is passed in should not be modified\" ); t.end(); }); tape(\"test link triggered by keyboard\", function(t) { var a = document.createElement(\"a\"); var pjax = { options: {}, loadUrl: function() { t.equal( a.getAttribute(attr), \"load\", \"triggering a internal link actually loads the page\" ); } }; t.plan(3); attachLink.call(pjax, a); a.href = window.location.protocol + \"//\" + window.location.host + \"/internal\"; trigger(a, \"keyup\", { keyCode: 14 }); t.equal( a.getAttribute(attr), \"\", \"keycode other than 13 doesn't trigger anything\" ); trigger(a, \"keyup\", { keyCode: 13, metaKey: true }); t.equal(a.getAttribute(attr), \"modifier\", \"event key modifier stop behavior\"); trigger(a, \"keyup\", { keyCode: 13 }); // see loadUrl defined above t.end(); }); tape( \"test link with the same URL as the current one, when currentUrlFullReload set to true\", function(t) { var a = document.createElement(\"a\"); var pjax = { options: { currentUrlFullReload: true }, reload: function() { t.pass(\"this.reload() was called correctly\"); }, loadUrl: function() { t.fail(\"loadUrl() was called wrongly\"); } }; t.plan(2); attachLink.call(pjax, a); a.href = window.location.href; trigger(a, \"click\"); t.equal(a.getAttribute(attr), \"reload\", \"reload stop behavior\"); t.end(); } );"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/proto/handle-response.js","permalink":"https://hdj.me/lib/pjax/tests/lib/proto/handle-response.js","excerpt":"","text":"var tape = require(\"tape\"); var handleResponse = require(\"../../../lib/proto/handle-response\"); var noop = require(\"../../../lib/util/noop\"); var loadContent = require(\"../../../index\").prototype.loadContent; var href = \"https://example.org/\"; var storeEventHandler; var pjaxErrorEventTriggerTest; tape(\"test events triggered when handleResponse(false) is called\", function(t) { t.plan(3); var pjax = { options: { test: 1 } }; var events = []; storeEventHandler = function(e) { events.push(e.type); t.equal(e.test, 1); }; document.addEventListener(\"pjax:complete\", storeEventHandler); document.addEventListener(\"pjax:error\", storeEventHandler); handleResponse.bind(pjax)(false, null); t.same( events, [\"pjax:complete\", \"pjax:error\"], \"calling handleResponse(false) triggers 'pjax:complete' and 'pjax:error'\" ); document.removeEventListener(\"pjax:complete\", storeEventHandler); document.removeEventListener(\"pjax:error\", storeEventHandler); t.end(); }); tape(\"test when handleResponse() is called normally\", function(t) { var pjax = { options: { test: 1 }, loadContent: noop, state: {} }; var request = { getResponseHeader: noop }; handleResponse.bind(pjax)(\"\", request, \"href\"); delete window.history.state.uid; t.same( window.history.state, { url: href, title: \"\", scrollPos: [0, 0] }, \"window.history.state is set correctly\" ); t.equals(pjax.state.href, \"href\", \"this.state.href is set correctly\"); t.equals( Object.keys(pjax.state.options).length, 2, \"this.state.options is set correctly\" ); t.same( pjax.state.options.request, request, \"this.state.options is set correctly\" ); t.equals(pjax.state.options.test, 1, \"this.state.options is set correctly\"); t.end(); }); tape( \"test when handleResponse() is called normally with request.responseURL\", function(t) { var pjax = { options: {}, loadContent: noop, state: {} }; var request = { responseURL: href + \"1\", getResponseHeader: noop }; handleResponse.bind(pjax)(\"\", request, \"\"); t.equals( pjax.state.href, request.responseURL, \"this.state.href is set correctly\" ); t.end(); } ); tape(\"test when handleResponse() is called normally with X-PJAX-URL\", function( t ) { var pjax = { options: {}, loadContent: noop, state: {} }; var request = { getResponseHeader: function(header) { if (header === \"X-PJAX-URL\") { return href + \"2\"; } } }; handleResponse.bind(pjax)(\"\", request, \"\"); t.equals(pjax.state.href, href + \"2\", \"this.state.href is set correctly\"); t.end(); }); tape( \"test when handleResponse() is called normally with X-XHR-Redirected-To\", function(t) { var pjax = { options: {}, loadContent: noop, state: {} }; var request = { getResponseHeader: function(header) { if (header === \"X-XHR-Redirected-To\") { return href + \"3\"; } } }; handleResponse.bind(pjax)(\"\", request, \"\"); t.equals(pjax.state.href, href + \"3\", \"this.state.href is set correctly\"); t.end(); } ); tape(\"test when handleResponse() is called normally with a hash\", function(t) { var pjax = { options: {}, loadContent: noop, state: {} }; var request = { responseURL: href + \"2\", getResponseHeader: noop }; handleResponse.bind(pjax)(\"\", request, href + \"1#test\"); t.equals( pjax.state.href, href + \"2#test\", \"this.state.href is set correctly\" ); t.end(); }); tape(\"test try...catch for loadContent() when options.debug is true\", function( t ) { t.plan(2); var pjax = { options: {}, loadContent: noop, state: {} }; var request = { getResponseHeader: noop }; pjax.loadContent = function() { throw new Error(); }; pjax.options.debug = true; document.removeEventListener(\"pjax:error\", storeEventHandler); pjaxErrorEventTriggerTest = function() { t.pass(\"pjax:error event triggered\"); }; document.addEventListener(\"pjax:error\", pjaxErrorEventTriggerTest); t.throws( function() { handleResponse.bind(pjax)(\"\", request, \"\"); }, Error, \"error is rethrown\" ); t.end(); }); tape(\"test try...catch for loadContent()\", function(t) { t.plan(2); var pjax = { options: {}, loadContent: noop, state: {} }; var request = { getResponseHeader: noop }; pjax.loadContent = function() { throw new Error(); }; pjax.latestChance = function() { return true; }; pjax.options.debug = false; document.removeEventListener(\"pjax:error\", pjaxErrorEventTriggerTest); t.doesNotThrow( function() { t.equals( handleResponse.bind(pjax)(\"\", request, \"\"), true, \"this.latestChance() is called\" ); }, Error, \"error is not thrown\" ); t.end(); }); tape( \"test events triggered when loadContent() is called with a non-string html argument\", function(t) { t.plan(3); var options = { test: 1 }; var events = []; storeEventHandler = function(e) { events.push(e.type); t.equal(e.test, 1); }; document.addEventListener(\"pjax:complete\", storeEventHandler); document.addEventListener(\"pjax:error\", storeEventHandler); loadContent(null, options); t.same( events, [\"pjax:complete\", \"pjax:error\"], \"calling loadContent() with a non-string html argument triggers 'pjax:complete' and 'pjax:error'\" ); document.removeEventListener(\"pjax:complete\", storeEventHandler); document.removeEventListener(\"pjax:error\", storeEventHandler); t.end(); } );"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/util/clone.js","permalink":"https://hdj.me/lib/pjax/tests/lib/util/clone.js","excerpt":"","text":"var tape = require(\"tape\"); var clone = require(\"../../../lib/util/clone\"); tape(\"test clone method\", function(t) { var obj = { one: 1, two: 2 }; var cloned = clone(obj); t.notEqual(obj, cloned, \"cloned object isn't the original object\"); t.same(obj, cloned, \"cloned object has the same values as original object\"); cloned.three = 3; t.notSame( obj, cloned, \"modified cloned object doesn't have the same values as original object\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/util/contains.js","permalink":"https://hdj.me/lib/pjax/tests/lib/util/contains.js","excerpt":"","text":"var tape = require(\"tape\"); var contains = require(\"../../../lib/util/contains.js\"); tape(\"test contains function\", function(t) { var tempDoc = document.implementation.createHTMLDocument(); tempDoc.body.innerHTML = \"\"; var selectors = [\"div\"]; var el = tempDoc.body.querySelector(\"#el\"); t.equal( contains(tempDoc, selectors, el), true, \"contains() returns true when a selector contains the element\" ); selectors = [\"span\"]; t.equal( contains(tempDoc, selectors, el), false, \"contains() returns false when the selectors do not contain the element\" ); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/util/extend.js","permalink":"https://hdj.me/lib/pjax/tests/lib/util/extend.js","excerpt":"","text":"var tape = require(\"tape\"); var extend = require(\"../../../lib/util/extend\"); tape(\"test extend method\", function(t) { var obj = { one: 1, two: 2 }; var extended = extend({}, obj, { two: \"two\", three: 3 }); t.notEqual(obj, extended, \"extended object isn't the original object\"); t.notSame( obj, extended, \"extended object doesn't have the same values as original object\" ); t.notSame( obj.two, extended.two, \"extended object value overwrites value from original object\" ); extended = extend(null); t.equals(extended, null, \"passing null returns null\"); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/util/noop.js","permalink":"https://hdj.me/lib/pjax/tests/lib/util/noop.js","excerpt":"","text":"var tape = require(\"tape\"); var noop = require(\"../../../lib/util/noop\"); tape(\"test noop function\", function(t) { t.equal(typeof noop, \"function\", \"noop is a function\"); t.equal(noop(), undefined, \"noop() returns nothing\"); t.end(); });"},{"title":"","date":"2024-12-03T10:58:04.740Z","updated":"2024-12-03T10:58:04.740Z","comments":true,"path":"lib/pjax/tests/lib/util/update-query-string.js","permalink":"https://hdj.me/lib/pjax/tests/lib/util/update-query-string.js","excerpt":"","text":"var tape = require(\"tape\"); var updateQueryString = require(\"../../../lib/util/update-query-string\"); tape(\"test update query string method\", function(t) { var url = \"http://example.com\"; var updatedUrl = updateQueryString(url, \"foo\", \"bar\"); t.notEqual(url, updatedUrl, \"update query string modifies URL\"); t.equal( updatedUrl, url + \"?foo=bar\", \"update query string creates new query string when no query string params are set\" ); updatedUrl = updateQueryString(updatedUrl, \"foo\", \"baz\"); t.equal( updatedUrl, url + \"?foo=baz\", \"update query string updates existing query string param\" ); updatedUrl = updateQueryString(updatedUrl, \"bar\", \"\"); t.equal( updatedUrl, url + \"?foo=baz&bar=\", \"update query string appends to existing query string\" ); t.end(); });"}],"posts":[{"title":"多 PHP 开发环境","slug":"multi-php","date":"2024-07-11T09:12:40.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"multi-php/","link":"","permalink":"https://hdj.me/multi-php/","excerpt":"本文适用于 M1 或更新版本 macOS 系统，Linux 可参考思路。 一、安装 homebrew1/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\" 二、安装 PHPs 添加仓库源 1brew tap shivammathur/php 安装指定版本 PHP，以 7.4 为例 1brew install shivammathur/php/php@7.4","text":"本文适用于 M1 或更新版本 macOS 系统，Linux 可参考思路。 一、安装 homebrew1/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\" 二、安装 PHPs 添加仓库源 1brew tap shivammathur/php 安装指定版本 PHP，以 7.4 为例 1brew install shivammathur/php/php@7.4 三、快速切换神器 脚本位置 ~/scripts/brew-php-switcher.sh，~/scripts可按个人喜好调整 12345678910111213141516171819202122232425262728293031323334#!/bin/shif [ -z \"$1\" ]; then echo \"Usage: brew-php-switcher &lt;version&gt;\" return 1fiversion=$1# 检测参数是否匹配 \\d\\.\\d 格式if [[ $&#123;version&#125; =~ ^[0-9]\\.[0-9]$ ]]; then echo \"\";else echo \"参数&lt;version&gt;必须符合 \\d\\.\\d 格式\" return 1fiformula=\"php@$version\"# 检测参数是否在给定的值列表中case $&#123;version&#125; in 7.4|8.0|8.1|8.2|8.4) ;; 8.3) # 默认版本 formula=\"php\" ;; *) echo \"参数&lt;version&gt;不在给定的值列表（7.4|8.0|8.1|8.2|8.3|8.4）中\" return 1 ;;esacbrew list --formula|grep -E \"php(\\d&#123;2&#125;|@\\d\\.\\d)?$\"|xargs brew unlink;brew link --overwrite --force $&#123;formula&#125; &amp;&amp; php -v ~/.bashrc 或 ~/.zshrc 添加以下脚本 1alias brew-php-switcher=\"sh ~/scripts/brew-php-switcher.sh\" 快速切换 1brew-php-switcher 7.4 四、自动切换 PHP 版本 同样在 ~/.bashrc 或 ~/.zshrc 添加以下脚本 1234567# auto dectectPROJECT_BASHRC=$(pwd)/.bashrc# echo $PROJECT_BASHRCif [ -f $PROJECT_BASHRC ]; then source $PROJECT_BASHRCfi .bashrc范本，以 PHP 7.4 项目为例 12345export PATH=\"/opt/homebrew/opt/php@7.4/bin:$PATH\"export PATH=\"/opt/homebrew/opt/php@7.4/sbin:$PATH\"alias artisan=\"php artisan\"alias tinker=\"artisan tinker\" 重启 IDE 即可，记得在项目中忽略 .bashrc 文件 五、Swoole 安装神器 脚本位置 ~/scripts/swoole.sh 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128#!/bin/sh# 获取包名function _get_package() &#123; local package=\"swoole\" if [ \"$1\" != \"\" ]; then package=\"swoole-$1\" fi echo $package&#125;# 修复 pcre2 路径问题function _fix_pcre() &#123; local php_home=$(php -i | grep -Eo \"\\-\\-prefix=([^']*)\" | awk -F '=' '&#123;print $2&#125;') local pcre_home=$(brew --prefix pcre2) local source=\"$&#123;pcre_home&#125;/include/pcre2.h\" local target=\"$&#123;php_home&#125;/include/php/ext/pcre/pcre2.h\" if [ ! -f $target ]; then ln -s $source $target fi&#125;# 安装function swoole_install() &#123; _fix_pcre local package=`_get_package $1` case $1 in 4.8.11) pecl install --configureoptions 'enable-sockets=\"no\" enable-openssl=\"yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1\" enable-http2=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-json=\"no\" enable-swoole-curl=\"yes\" enable-cares=\"no\"' $&#123;package&#125; ;; 4.8.*) pecl install --configureoptions 'enable-sockets=\"no\" enable-openssl=\"yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1\" enable-http2=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-json=\"no\" enable-swoole-curl=\"yes\"' $&#123;package&#125; ;; 5.0.0) pecl install --configureoptions 'enable-sockets=\"no\" enable-openssl=\"yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1\" enable-http2=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-json=\"no\" enable-swoole-curl=\"yes\" enable-cares=\"no\"' $&#123;package&#125; ;; 5.0.*) pecl install --configureoptions 'enable-sockets=\"no\" enable-openssl=\"yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1\" enable-http2=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-json=\"no\" enable-swoole-curl=\"yes\" enable-cares=\"no\" enable-brotli=\"no\"' $&#123;package&#125; ;; 5.1.*) pecl install --configureoptions 'enable-sockets=\"no\" enable-openssl=\"yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1\" enable-http2=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-json=\"no\" enable-swoole-curl=\"yes\" enable-cares=\"no\" enable-brotli=\"no\" enable-swoole-pgsql=\"no\" with-swoole-odbc=\"no\" with-swoole-oracle=\"no\" enable-swoole-sqlite=\"no\"' $&#123;package&#125; ;; 6.0.* | \"\") pecl install --configureoptions 'enable-sockets=\"no\" enable-openssl=\"yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1\" enable-http2=\"yes\" enable-mysqlnd=\"yes\" enable-swoole-json=\"no\" enable-swoole-curl=\"yes\" enable-cares=\"no\" enable-brotli=\"no\" enable-swoole-pgsql=\"no\" with-swoole-odbc=\"no\" with-swoole-oracle=\"no\" enable-swoole-sqlite=\"no\" enable-swoole-thread=\"no\" enable-iouring=\"no\"' $&#123;package&#125; ;; *) echo \"Unsupported version: $1\" exit 1 ;; esac swoole_info&#125;# 更新function swoole_upgrade() &#123; swoole_uninstall swoole_install $1&#125;# 重新安装function swoole_reinstall() &#123; swoole_uninstall swoole_install $1&#125;# 卸载function swoole_uninstall() &#123; local php_ini=$(php -i | grep \"/php.ini\" | awk -F ' =&gt; ' '&#123;print $2&#125;') pecl uninstall swoole sed -i '' '/^extension=\"swoole.so\"/d' $php_ini&#125;# 最新版本function swoole_latest() &#123; local version=`curl -s https://pecl.php.net/package/swoole |grep -E \"swoole-.*.tgz\" |head -1 |grep -Eo '\\d+\\.\\d+\\.\\d+' | head -1` echo $version&#125;# 信息function swoole_info() &#123; php --ri swoole&#125;# 版本function swoole_version() &#123; php -r \"echo swoole_version();\" &#125;# 安装别名function swoole_i() &#123; swoole_install $1&#125;# 更新别名function swoole_u() &#123; swoole_upgrade $1&#125;# 帮助function swoole_help() &#123; cat &lt;&lt; ENDUsage: $0 [help|i|install|reinstall|uninstall|u|upgrade|version|latest] [version]Examples $0 install $0 install 5.1.3 $0 upgrade $0 upgrade 5.1.3END&#125;# 入口function swoole_() &#123; swoole_help&#125;# 执行swoole_$1 $2 ~/.bashrc 或 ~/.zshrc 添加以下脚本 1alias swoole-tool=\"sh ~/scripts/swoole.sh\" 快速安装 Swoole 1swoole-tool install 6.0.0","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"homebrew","slug":"homebrew","permalink":"https://hdj.me/tags/homebrew/"}]},{"title":"Sponsors","slug":"sponsors","date":"2024-02-27T08:12:01.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"sponsors/","link":"","permalink":"https://hdj.me/sponsors/","excerpt":"","text":"IntroductionI’m Huangdijia, a software engineer with a passion for open source. Active in the Hyperf ecosystem. Member of @Hyperf, @FriendsOfHyperf hyperf-sentry - The sentry SDK for Hyperf hyperf-trigger - The MySQL Trigger for Hyperf laravel-horizon-restart - A Plugin for laravel-horzion laravel-trigger - MySQL event subscriber base on MySQLReplication pest-plugin-hyperf - The Pest plugin for Hyperf Your sponsorship means a lot to me. It will help me sustain my projects actively and make more of my ideas come true. Much appreciated! 💖 🙏 Sponsors","categories":[],"tags":[]},{"title":"如何迁移 homebrew 至 M1 Mac","slug":"How-to-migrate-to-native-Homebrew-on-an-M1-Mac","date":"2021-11-25T08:12:42.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"How-to-migrate-to-native-Homebrew-on-an-M1-Mac/","link":"","permalink":"https://hdj.me/How-to-migrate-to-native-Homebrew-on-an-M1-Mac/","excerpt":"旧 Mac 备份1/usr/local/bin/brew bundle dump 得到 Brewfile 文件。","text":"旧 Mac 备份1/usr/local/bin/brew bundle dump 得到 Brewfile 文件。 M1 Mac 安装 brew1/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)\" 安装过程中可能会遇到权限问题，可以使用 sudo 命令授权 1sudo chown -R $(whoami) /opt/homebrew 配置环境变量编辑 ~/.zshrc 文件，添加如下内容： 12# arm brew environmenteval \"$(/opt/homebrew/bin/brew shellenv)\" 导入 Brewfile1/opt/homebrew/bin/brew bundle --file path/to/Brewfile 有些软件不能完成安装，后面手动安装就好了。 卸载旧版本如果旧版跟谁 Mac 也迁移至了 M1 Mac，那么可以使用以下命令卸载 12arch -x86_64 $SHELL/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall.sh)\" 可能还会有一些残留目录，只要手动 rm -rf 删除即可 /usr/local/.com.apple.installer.keep/usr/local/Frameworks//usr/local/Homebrew//usr/local/bin//usr/local/etc//usr/local/iODBC.odbcmanager//usr/local/include//usr/local/lib//usr/local/opt//usr/local/packager//usr/local/remotedesktop//usr/local/sbin//usr/local/share//usr/local/var//usr/local/zlib/","categories":[],"tags":[{"name":"macos","slug":"macos","permalink":"https://hdj.me/tags/macos/"},{"name":"brew","slug":"brew","permalink":"https://hdj.me/tags/brew/"}]},{"title":"将 Apple Watch 身份验证添加到 sudo","slug":"add-apple-watch-authentication-to-sudo","date":"2021-10-14T13:33:41.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"add-apple-watch-authentication-to-sudo/","link":"","permalink":"https://hdj.me/add-apple-watch-authentication-to-sudo/","excerpt":"我最近看到一篇关于如何使 sudo 与 Touch ID 一起工作的文章，这很好，但我的 iMac Pro 没有 Touch ID。我继续搜索并找到了pam-watchid！ 这是一个用于使用 Watch 的 PAM模块 ——正是我想要的。","text":"我最近看到一篇关于如何使 sudo 与 Touch ID 一起工作的文章，这很好，但我的 iMac Pro 没有 Touch ID。我继续搜索并找到了pam-watchid！ 这是一个用于使用 Watch 的 PAM模块 ——正是我想要的。 它是开源的，因此您可以按照自述文件自行编译，因此请确保您已安装Xcode或Xcode 命令行工具： 下载最新的 ZIP 文件 解压缩，默认情况下会创建一个名为pam-watchid-main的文件夹 打开终端并安装它： 12$ cd ~/Downloads/pam-watchid-main$ sudo 安装 为sudo注册新的 PAM 模块： 编辑 /etc/pam.d/sudo， 在第 1 行（这是注释）下添加一个新行，其中包含： 1auth sufficient pam_watchid.so （保留此文件中的所有其他行。）就是这样。现在，无论何时使用sudo，您都可以选择使用 Watch 进行身份验证。","categories":[{"name":"MacOS","slug":"MacOS","permalink":"https://hdj.me/categories/MacOS/"}],"tags":[{"name":"MacOS","slug":"MacOS","permalink":"https://hdj.me/tags/MacOS/"},{"name":"Apple Watch","slug":"Apple-Watch","permalink":"https://hdj.me/tags/Apple-Watch/"},{"name":"Apple","slug":"Apple","permalink":"https://hdj.me/tags/Apple/"},{"name":"身份验证","slug":"身份验证","permalink":"https://hdj.me/tags/身份验证/"}]},{"title":"Laravel Eloquent 访问器的一个坑","slug":"pit-of-laravel-eloquent-accessor","date":"2020-05-29T09:09:10.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"pit-of-laravel-eloquent-accessor/","link":"","permalink":"https://hdj.me/pit-of-laravel-eloquent-accessor/","excerpt":"数据 ID first_name last_name 1 Jackie Chan 2 Bruce Lee","text":"数据 ID first_name last_name 1 Jackie Chan 2 Bruce Lee 模型12345678class Star extends Model&#123; public function getFullNameAttribute() &#123; return $this-&gt;first_name . ' ' . $this-&gt;last_name; &#125;&#125; 正常使用1Start::first()-&gt;full_name; // \"Jackie Chan\" 坑1Star::select(DB::raw(\"concat(first_name, ' ', last_name) as full_name\"))-&gt;first()-&gt;full_name; // \"\" 但是 1dump(Star::select(DB::raw(\"concat(first_name, ' ', last_name) as full_name\"))-&gt;first()); 结果能看到 full_name 有值 12345678// ... #attributes: array:1 [ \"full_name\" =&gt; \"Jackie Chan\" ] #original: array:1 [ \"full_name\" =&gt; \"Jackie Chan\" ]// ... 原因 Eloquent 访问器优先级高于属性 该例子中访问器依赖的属性因为未指定 select 为空 如何填坑12345678class Star extends Model&#123; public function getFullNameAttribute() &#123; // 优先 full_name 属性 return $this-&gt;attributes['full_name'] ?? ($this-&gt;attributes['first_name'] . ' ' . $this-&gt;attributes['last_name']); &#125;&#125;","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"Laravel","slug":"Laravel","permalink":"https://hdj.me/tags/Laravel/"},{"name":"Eloquent","slug":"Eloquent","permalink":"https://hdj.me/tags/Eloquent/"}]},{"title":"Laravel artisan 命令自动补全","slug":"auto-complete-for-laravel-artisan","date":"2020-04-13T13:32:16.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"auto-complete-for-laravel-artisan/","link":"","permalink":"https://hdj.me/auto-complete-for-laravel-artisan/","excerpt":"安装 bash-completion@21brew install bash-completion@2","text":"安装 bash-completion@21brew install bash-completion@2 配置 ~/.zshrc 或 ~/.bash_profile1234567891011121314# bash-completion@2autoload bashcompinitbashcompinit# auto-complete for php artisanARTISAN_COMMANDS=`php artisan --raw --no-ansi list | sed \"s/[[:space:]].*//g\"`_artisan()&#123; COMP_WORDBREAKS=$&#123;COMP_WORDBREAKS//:&#125; COMPREPLY=(`compgen -W \"$ARTISAN_COMMANDS\" -- \"$&#123;COMP_WORDS[COMP_CWORD]&#125;\"`) return 0&#125;complete -F _artisan artisanalias artisan='php artisan' 如果在 Windows 的 Git-Bash 上出现类似于 stdout is not a tty 的错误，只需要把 ARTISAN_COMMANDS= 这一行改成: 1ARTISAN_COMMANDS=`php.exe artisan --raw --no-ansi list | sed \"s/[[:space:]].*//g\"` 效果预览12345678&gt;&gt; php artisan make:[TAB][TAB]make:channel make:factory make:model make:rulemake:command make:import make:notification make:seedermake:controller make:job make:observer make:servicemake:event make:listener make:policy make:testmake:exception make:mail make:provider make:transformermake:export make:middleware make:requestmake:export-model make:migration make:resource 举一反三让 composer 也是支持相同的效果 123456789# auto-complete for composerCOMPOSER_COMMANDS=`composer --raw --no-ansi list | sed \"s/[[:space:]].*//g\"`_composer()&#123; COMP_WORDBREAKS=$&#123;COMP_WORDBREAKS//:&#125; COMPREPLY=(`compgen -W \"$COMPOSER_COMMANDS\" -- \"$&#123;COMP_WORDS[COMP_CWORD]&#125;\"`) return 0&#125;complete -F _composer composer 看看效果12345$ composer [TAB][TAB]about clear-cache create-project dumpautoload home install prohibits search status upgradearchive clearcache depends exec i licenses remove self-update suggests validatebrowse command diagnose global info list require selfupdate u whycheck-platform-reqs config dump-autoload help init outdated run-script show update why-not","categories":[],"tags":[{"name":"laravel","slug":"laravel","permalink":"https://hdj.me/tags/laravel/"},{"name":"artisan","slug":"artisan","permalink":"https://hdj.me/tags/artisan/"}]},{"title":"通过 JavaScript 监听暗黑模式变化","slug":"listening-darkmode-by-javascript","date":"2020-03-11T07:56:41.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"listening-darkmode-by-javascript/","link":"","permalink":"https://hdj.me/listening-darkmode-by-javascript/","excerpt":"苹果系统（macOS、iOS）都已经全面支持暗黑模式（也叫深色模式）了，在这里不做过多的介绍了。在众多的技术文章里都有介绍如何使用，最常见的是通过 CSS 中的 prefers-color-scheme: dark 来检测用户是否开启了 Dark Mode，在 CSS里定义不同的样式。","text":"苹果系统（macOS、iOS）都已经全面支持暗黑模式（也叫深色模式）了，在这里不做过多的介绍了。在众多的技术文章里都有介绍如何使用，最常见的是通过 CSS 中的 prefers-color-scheme: dark 来检测用户是否开启了 Dark Mode，在 CSS里定义不同的样式。 12345678910111213/* 操作系统及浏览器未支持或用户未开启 Dark Mode */body &#123; background-color: white; color: black;&#125;@media (prefers-color-scheme: dark) &#123; /* 操作系统及浏览器支持且用户开启了 Dark Mode */ body &#123; background-color: black; color: white; &#125;&#125; 从以上代码看，有点类似 if-else，兼容性和可读性都不是很好。 暗黑模式刚推出的时候，我首先想到的是跟博客的主题功能很像，细品之后发现区别在于主题做法更多的是是更换 CSS 文件，于是我想是不是可以通过 JavaScript 检测（监听）用户是否启用暗黑模式，从而加载不同的样式，实现实时更换主题功能。 接下来最关键的问题就是怎么实现这个“监听”功能，在谷歌上百度了一下，找到了一个关键词 matchMedia。 用过 matchMedia 方法可以直接判断浏览器当前是否倾向于使用深色模式： 1234let prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;if (prefersDarkMode) &#123; // 搞事情&#125; 通过监听 matchMedia 的 change 事件，可以在用户切换深色 / 浅色模式的时候，将浏览器中已打开的页面自动切换为系统对应的模式。 123456789101112let media = window.matchMedia('(prefers-color-scheme: dark)');let callback = (e) =&gt; &#123; let prefersDarkMode = e.matches; if (prefersDarkMode) &#123; // 搞事情 &#125;&#125;;if (typeof media.addEventListener === 'function') &#123; media.addEventListener('change', callback);&#125; else if (typeof media.addListener === 'function') &#123; media.addListener(callback);&#125;","categories":[{"name":"前端","slug":"frontend","permalink":"https://hdj.me/categories/frontend/"}],"tags":[{"name":"javascript","slug":"javascript","permalink":"https://hdj.me/tags/javascript/"},{"name":"dark-mode","slug":"dark-mode","permalink":"https://hdj.me/tags/dark-mode/"}]},{"title":"期待已久的 PHP preload","slug":"php74-preload","date":"2019-11-29T05:23:00.654Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"php74-preload/","link":"","permalink":"https://hdj.me/php74-preload/","excerpt":"期待已久的 PHP7.4 终于发布了，个人最期待的功能还是 Opcache Preloading。 为了预加载文件，您需要编写自定义PHP脚本 此脚本在服务器启动时执行一次 所有预加载的文件都可在内存中用于所有请求 在重新启动服务器之前，对源文件所做的更改不会产生任何影响","text":"期待已久的 PHP7.4 终于发布了，个人最期待的功能还是 Opcache Preloading。 为了预加载文件，您需要编写自定义PHP脚本 此脚本在服务器启动时执行一次 所有预加载的文件都可在内存中用于所有请求 在重新启动服务器之前，对源文件所做的更改不会产生任何影响 配置包含 2 配置参数： opcache.preload string 指定要在服务器启动时期进行编译和缓存的 PHP 脚本文件， 这些文件也可能通过 include 或者 opcache_compile_file() 函数 来预加载其他文件。 所有这些文件中包含的实体，包括函数、类等，在服务器启动的时候就被加载和缓存， 对于用户代码来讲是“开箱可用”的。 opcache.preload_user string 考虑到安全因素，禁止以 root 用户预加载代码。该指令方便以其他用户预加载。 php.ini 配置1opcache.preload=/path/to/project/preload.php 及时实现针对 composer，可以直接生成 vendor/preload.php 1234567&lt;?php$files = require __DIR__ . '/composer/autoload_classmap.php';foreach (array_unique($files) as $file) &#123; opcache_compile_file($file);&#125; 第三方包Github 上也有大神放出 composer 扩展包 Composer-Preload，可通过简单配置实现。 当前项目安装1composer require ayesh/composer-preload 全局安装1composer g require ayesh/composer-preload composer.json 配置123456789101112131415161718192021&#123; \"extra\": &#123; \"preload\": &#123; \"paths\": [ \"web\" ], \"exclude\": [ \"web/core/tests\", \"web/core/lib/Drupal/Component/Assertion\", \"web/core/modules/simpletest\", \"web/core/modules/editor/src/Tests\" ], \"extensions\": [\"php\", \"module\", \"inc\", \"install\"], \"exclude-regex\": \"/[A-Za-z0-9_]test\\\\.php$/i\", \"no-status-check\": false, \"files\": [ \"somefile.php\" ] &#125; &#125;&#125; vendor/preload.php 生成1composer preload 官方支持目前 composer 官方还没支持，已经有人向 composer 提交了Issue，据说 2.0 里程碑版本会增加支持，值得期待。 性能提升官方以 zend framework 测试 30~50 % 的性能提升。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"preload","slug":"preload","permalink":"https://hdj.me/tags/preload/"}]},{"title":"如何取消 failed_jobs","slug":"how-to-disable-write-laravel-failed-table","date":"2019-11-29T00:24:06.091Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"how-to-disable-write-laravel-failed-table/","link":"","permalink":"https://hdj.me/how-to-disable-write-laravel-failed-table/","excerpt":"烦恼从何而来用 Laravel 的小伙伴应该都会用到 Queue， 从手册 Job 失败后会将队列信息记录到 failed_jobs 表，可以通过 12php artisan queue:failed-tablephp artisan migrate 作用主要是为了方便分析失败原因和 Job 重试（本身支持 retry），这都很好理解。当 failed_jobs 没有被创建的时候，会报这样一个异常： 1SQLSTATE[42S02]: Base table or view not found: 1146 Table 'a8591.failed_jobs' doesn't exist 并且记录到 log 文件，如果你的项目中有异常通知，那是相当困扰。 但是有一个场景，也许我并不关心任务执行是否成功，或者说因为某种特定不可控因素允许任务存在执行失败的情况，而我又不希望被这类异常打扰要怎么办呢？","text":"烦恼从何而来用 Laravel 的小伙伴应该都会用到 Queue， 从手册 Job 失败后会将队列信息记录到 failed_jobs 表，可以通过 12php artisan queue:failed-tablephp artisan migrate 作用主要是为了方便分析失败原因和 Job 重试（本身支持 retry），这都很好理解。当 failed_jobs 没有被创建的时候，会报这样一个异常： 1SQLSTATE[42S02]: Base table or view not found: 1146 Table 'a8591.failed_jobs' doesn't exist 并且记录到 log 文件，如果你的项目中有异常通知，那是相当困扰。 但是有一个场景，也许我并不关心任务执行是否成功，或者说因为某种特定不可控因素允许任务存在执行失败的情况，而我又不希望被这类异常打扰要怎么办呢？ 方法一：重写 Job 类 fail 方法只要 IDE 强大些，跳跳跳，跳转一下代码，很容易找到 vendor/illuminate/queue/Jobs/Job.php 处理 Job 失败的逻辑位置： 1234567891011121314151617181920212223// ...public function fail($e = null)&#123; $this-&gt;markAsFailed(); if ($this-&gt;isDeleted()) &#123; return; &#125; try &#123; // If the job has failed, we will delete it, call the \"failed\" method and then call // an event indicating the job has failed so it can be logged if needed. This is // to allow every developer to better keep monitor of their failed queue jobs. $this-&gt;delete(); $this-&gt;failed($e); &#125; finally &#123; // 没错，就是这里处理失败任务 $this-&gt;resolve(Dispatcher::class)-&gt;dispatch(new JobFailed( $this-&gt;connectionName, $this, $e ?: new ManuallyFailedException )); &#125;&#125;// ... 最粗暴的方法就是在具体的 XXXJob 里重写这个方法。 这个方法有一个好处：可以针对某个 Job，而不是一刀切。 方法二：修改 queue 配置后来我再想，要么每个 Job 都要重写一遍，要么再项目中定义一个 Job 父类，然后再父类中重写，方法可行，但是感觉不太优雅，比较 Laravel 是一个这么优雅的框架，怎么可以就这么粗暴处理呢。 于是在 方法一 的基础上再深入研究，想要看看有没有开关，但是从 queue 的配置文件和手册中并没有明确的提到这个开关，只能继续跳跳跳，继续深入的了解 Job 的执行原理。 功夫不负有心人，终于让我找到了 vendor/illuminate/queue/QueueServiceProvider.php 1234567891011121314protected function registerFailedJobServices()&#123; $this-&gt;app-&gt;singleton('queue.failer', function () &#123; $config = $this-&gt;app['config']['queue.failed']; if (isset($config['driver']) &amp;&amp; $config['driver'] === 'dynamodb') &#123; return $this-&gt;dynamoFailedJobProvider($config); &#125; elseif (isset($config['table'])) &#123; return $this-&gt;databaseFailedJobProvider($config); &#125; else &#123; return new NullFailedJobProvider; &#125; &#125;);&#125; 问题变得清晰明朗了，不难看出： 当 queue.failed.driver 为 dynamodb 的时候使用 dynamoFailedJobProvider 处理 当存在 queue.failed.table 的时候，使用 databaseFailedJobProvider 处理 否则使用 NullFailedJobProvider 处理，也就是啥都不干的意思 最终发现原来开关是存在的，只是官方没有明确说明。 找到 config/queue.php, do it! 12345678910111213141516// .../*|--------------------------------------------------------------------------| Failed Queue Jobs|--------------------------------------------------------------------------|| These options configure the behavior of failed queue job logging so you| can control which database and table are used to store the jobs that| have failed. You may change them to any database / table you wish.|*/'failed' =&gt; [ // 'database' =&gt; env('DB_CONNECTION', 'mysql'), // 'table' =&gt; env('QUEUE_FAILED_TABLE', 'failed_jobs'),],","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"Laravel","slug":"Laravel","permalink":"https://hdj.me/tags/Laravel/"},{"name":"queue","slug":"queue","permalink":"https://hdj.me/tags/queue/"},{"name":"faild_jobs","slug":"faild-jobs","permalink":"https://hdj.me/tags/faild-jobs/"}]},{"title":"如何正确的在 Lumen 中启用 Notification","slug":"how-to-make-notifications-in-Lumen","date":"2019-11-15T18:30:27.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"how-to-make-notifications-in-Lumen/","link":"","permalink":"https://hdj.me/how-to-make-notifications-in-Lumen/","excerpt":"","text":"安装 illuminate/notifications1composer require illuminate/notifications bootstrap/app.php 注册服务1$app-&gt;register(Illuminate\\Notifications\\NotificationServiceProvider::class); ⚠️ 必须在 AppServiceProvider 注册之前，不然自定义 Channel 会无法找到，提升 InvalidArgumentException with message &#39;Driver [xxxx] not supported.&#39; 在 AppServiceProvider.php 注册 Channel123$this-&gt;app-&gt;make(Illuminate\\Notifications\\ChannelManager::class)-&gt;extend('your-channel', function() &#123; return $this-&gt;app-&gt;make(App\\Channels\\YourChannel::class);&#125;);","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"lumen","slug":"lumen","permalink":"https://hdj.me/tags/lumen/"},{"name":"notification","slug":"notification","permalink":"https://hdj.me/tags/notification/"}]},{"title":"PHP 的 __call 和 __callStatic","slug":"call-and-callstatic-in-php","date":"2019-10-15T08:28:35.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"call-and-callstatic-in-php/","link":"","permalink":"https://hdj.me/call-and-callstatic-in-php/","excerpt":"","text":"12345678910111213141516171819class Foo&#123; public function __call($name, $arguments) &#123; echo 1; &#125; public static function __callStatic($name, $arguments) &#123; echo 2; &#125; public function bar() &#123; Foo::abc(); &#125;&#125;(new Foo)-&gt;bar(); 结果是 1 还是 2？答案是 1 接下来解释一下： __call 方法关注方法能否被访问到，而不仅仅是关注是否存在 __callStatic 方法关注的是方法能否被静态的访问到，而不是关注方法是否存在，是否是静态方法。 具体执行 __call，__callStatic ，是根据调用的上下文。如","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://hdj.me/tags/PHP/"}]},{"title":"为 PHP7.x 安装 memcache 扩展","slug":"install-memcache-for-php7-x","date":"2019-10-11T16:46:58.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"install-memcache-for-php7-x/","link":"","permalink":"https://hdj.me/install-memcache-for-php7-x/","excerpt":"","text":"PHP Extension - Memcache module with support of newer PHP 7.0-7.3 Install 123456789101112# clone sourcegit clone https://github.com/websupport-sk/pecl-memcache.git# configure &amp; installcd pecl-memcache;phpize./configuremake -j$(nproc)make install# create php iniecho \"extension=memcache.so\" &gt;&gt; /usr/local/php/etc/conf.d/memcache.ini","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"https://hdj.me/tags/PHP/"},{"name":"Memcache","slug":"Memcache","permalink":"https://hdj.me/tags/Memcache/"}]},{"title":"如何正确的计算每 N 分钟记录数","slug":"count-for-every-n-minutes-in-mysql","date":"2019-09-29T11:15:57.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"count-for-every-n-minutes-in-mysql/","link":"","permalink":"https://hdj.me/count-for-every-n-minutes-in-mysql/","excerpt":"","text":"表结构 字段 数据类型 id int(11) created_at datetime 期望结果 时间段 数量 2019-09-29 12:00:00 ~ 2019-09-29 12:05:00 100 2019-09-29 12:05:00 ~ 2019-09-29 12:10:00 120 2019-09-29 12:10:00 ~ 2019-09-29 12:15:00 131 2019-09-29 12:15:00 ~ 2019-09-29 12:20:00 189 2019-09-29 12:20:00 ~ 2019-09-29 12:25:00 134 2019-09-29 12:25:00 ~ 2019-09-29 12:30:00 155 2019-09-29 12:30:00 ~ 2019-09-29 12:35:00 198 2019-09-29 12:35:00 ~ 2019-09-29 12:40:00 133 SQL语句123456-- 300 为 5 分钟select concat(from_unixtime(unix_timestamp(created_at) - unix_timestamp(created_at) % 300), &apos; ~ &apos;, from_unixtime(unix_timestamp(created_at) - unix_timestamp(created_at) % 300 + 300)) as per, count(1)from tablegroup by per; 如果 created_at 类型为 int，还可以减少一次转换 123456-- 300 为 5 分钟select concat(from_unixtime(created_at - created_at % 300), &apos; ~ &apos;, from_unixtime(created_at - created_at % 300 + 300)) as per, count(1)from tablegroup by per; 思路 时间分片 MySQL没有相关的时间分片函数，还好可以用取模（%）实现","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"https://hdj.me/tags/MySQL/"}]},{"title":"如何正确的使用 GitHub Actions 实现 Hexo 博客的 CICD","slug":"github-actions-hexo-cicd","date":"2019-09-27T12:42:48.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"github-actions-hexo-cicd/","link":"","permalink":"https://hdj.me/github-actions-hexo-cicd/","excerpt":"CI/CD (continuous integration and continuous deployment) 最近同事分享了 GitHub Actions ，发现除了我们常听到的自动部署（项目上线）外还可以做很多事情，比如说就可以自动生成 Hexo 博客，我擦！这不就是我想要的吗？以后就不用每次写完文章之后再执行 hexo clean &amp;&amp; hexo g -d 了。 回来各种百度，有几篇针对 HEXO 的文章，照着开始写脚本，发现怎么都不能成功，各种错误。折腾了 3 个小时，终于顺利通过了。","text":"CI/CD (continuous integration and continuous deployment) 最近同事分享了 GitHub Actions ，发现除了我们常听到的自动部署（项目上线）外还可以做很多事情，比如说就可以自动生成 Hexo 博客，我擦！这不就是我想要的吗？以后就不用每次写完文章之后再执行 hexo clean &amp;&amp; hexo g -d 了。 回来各种百度，有几篇针对 HEXO 的文章，照着开始写脚本，发现怎么都不能成功，各种错误。折腾了 3 个小时，终于顺利通过了。 项目背景我先介绍一下我的项目背景： 项目 说明 https://github.com/huangdijia/blog 用于存放 hexo 生成的项目，可以理解成源码 https://github.com/huangdijia/huangdijia.github.io 存放 hexo 编译后的静态文件，也是我的博客页面 以下说明都是以我的两个项目为例子 密钥生成因为 hexo 编译后需要 push 到 huangdijia.github.io 上，需要 GitHub 的账号密码（尝试过不行）或者密钥，我们需要用 ssh-keygen 命令生成一组私钥（没有后缀名）和公钥（.pub结尾） 1ssh-keygen -f github-deploy-key # 三次回车即刻 会生成 github-deploy-key 和 github-deploy-key.pub 两个文件。 配置 GitHub 仓库配置 blog 仓库打开 https://github.com/huangdijia/blog/settings/secrets 点击 Add new secrets，分别在 Name 输入 HEXO_DEPLOY_PRI Value 输入前面生成的私有 KEY github-deploy-key 的内容 配置 huangdijia.github.io 仓库打开 https://github.com/huangdijia/huangdijia.github.io/settings/keys，点击 Add deploy key，分别在 Title 输入 HEXO_DEPLOY_PUB Key 输入前面生成的私有 KEY github-deploy-key.pub 的内容 编写 Action 脚本使用前先要申请，然后点击 Actions -&gt; Set up this workflow 或直接打开 https://github.com/huangdijia/huangdijia.github.io/actions/new 1234567891011121314151617181920212223242526272829303132333435363738name: HEXO CIon: [push]jobs: build: runs-on: ubuntu-latest strategy: matrix: node-version: [10.x] steps: - uses: actions/checkout@v1 - name: Use Node.js $&#123;&#123; matrix.node-version &#125;&#125; uses: actions/setup-node@v1 with: node-version: $&#123;&#123; matrix.node-version &#125;&#125; - name: Configuration environment env: HEXO_DEPLOY_PRI: $&#123;&#123;secrets.HEXO_DEPLOY_PRI&#125;&#125; run: | mkdir -p ~/.ssh/ echo \"$HEXO_DEPLOY_PRI\" &gt; ~/.ssh/id_rsa chmod 600 ~/.ssh/id_rsa ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts git config --global user.name \"yourname\" git config --global user.email \"your@email.com\" - name: Install dependencies run: | npm i -g hexo-cli npm i - name: Deploy hexo run: | hexo g -d 修改 _config.yml repo如果原来是 http 的，要改为 ssh 格式 如： 123deploy: # repo: https://github.com/huangdijia/huangdijia.github.io repo: git@github.com:huangdijia/huangdijia.github.io.git 享受成果在 blog 项目任意 push，在 https://github.com/huangdijia/blog/actions 都有响应的执行记录 注意 切记不要把账号密码写在脚本上!!!","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"Github","slug":"Github","permalink":"https://hdj.me/tags/Github/"},{"name":"actions","slug":"actions","permalink":"https://hdj.me/tags/actions/"}]},{"title":"博客迁移公告","slug":"blog-migrate","date":"2019-06-24T09:22:45.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"blog-migrate/","link":"","permalink":"https://hdj.me/blog-migrate/","excerpt":"","text":"很不幸，因为VPS忘记续费，博客的资料没有备份，导致博客资料丢失。经过深思熟虑，觉得将博客迁移至GitHub，丢失的文章和资料我尽量找回。","categories":[{"name":"其他","slug":"other","permalink":"https://hdj.me/categories/other/"}],"tags":[]},{"title":"crontab 几个特殊字符的含义","slug":"the-meaning-of-several-special-characters-for-crontab","date":"2019-05-06T08:12:02.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"the-meaning-of-several-special-characters-for-crontab/","link":"","permalink":"https://hdj.me/the-meaning-of-several-special-characters-for-crontab/","excerpt":"","text":"含义 字符 含义 *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 全部。意思是在该时间的任意点都应当执行 ? 不指定，任意。仅用于 日(月)和日(周)。0 0 5 * ? 代表每个月的第5天零点，不论星期几。 0 0 ? * 1 代表每周一，不论是当月的哪天。 , 多个值的分隔符，例如1,5,10 - 代表连续值，例如1-20 / 步长。例如 5/15，代表从5开始，以15为步长。因此，当5/15位于分钟的位置时，表示小时内的第5、20、35和50分钟 L 最后一天。可以是每月最后一天或者每周最后一天。如果用在 天(周)字段，并且前面加数字，则表示最后一个周N。例如5L，表示最后一个周五（5表示周五，L表示最后）。 W 工作日，指周一到周五的任意一天 # 表示第几个的意思，例如 6#3，表示当月第3个星期六（6表示周六，3表示第3个） 例子12* 0 9 5L 最后一个周五早上9点* 0 9 6#3 当月第3个星期六","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"macos","slug":"macos","permalink":"https://hdj.me/tags/macos/"},{"name":"linux","slug":"linux","permalink":"https://hdj.me/tags/linux/"},{"name":"crontab","slug":"crontab","permalink":"https://hdj.me/tags/crontab/"},{"name":"centos","slug":"centos","permalink":"https://hdj.me/tags/centos/"},{"name":"ubuntu","slug":"ubuntu","permalink":"https://hdj.me/tags/ubuntu/"},{"name":"debian","slug":"debian","permalink":"https://hdj.me/tags/debian/"}]},{"title":"台湾身份证字号产生器","slug":"taiwan-roc-id-generator","date":"2019-04-26T15:33:38.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"taiwan-roc-id-generator/","link":"","permalink":"https://hdj.me/taiwan-roc-id-generator/","excerpt":"参考 身份證字號產生器 写了一份PHP版本","text":"参考 身份證字號產生器 写了一份PHP版本 源码123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170/** * 台灣身份證字號生成 &amp; 驗證 * @example $id = (new TaiwanRocId)-&gt;generate(); * @example $ok = (new TaiwanRocId)-&gt;validate($id); */class TaiwanRocId&#123; const MALE = 1; // 男 const FEMALE = 2; // 女 private $cityMaps = [ 'A' =&gt; 10, // 台北市 'B' =&gt; 11, // 台中市 'C' =&gt; 12, // 基隆市 'D' =&gt; 13, // 台南市 'E' =&gt; 14, // 高雄市 'F' =&gt; 15, // 台北縣 'G' =&gt; 16, // 宜蘭縣 'H' =&gt; 17, // 桃園縣 'J' =&gt; 18, // 新竹縣 'K' =&gt; 19, // 苗栗縣 'L' =&gt; 20, // 台中縣 'M' =&gt; 21, // 南投縣 'N' =&gt; 22, // 彰化縣 'P' =&gt; 23, // 雲林縣 'Q' =&gt; 24, // 嘉義縣 'R' =&gt; 25, // 台南縣 'S' =&gt; 26, // 高雄縣 'T' =&gt; 27, // 屏東縣 'U' =&gt; 28, // 花蓮縣 'V' =&gt; 29, // 台東縣 'X' =&gt; 30, // 澎湖縣 'Y' =&gt; 31, // 陽明山 'W' =&gt; 32, // 金門縣 'Z' =&gt; 33, // 連江縣 'O' =&gt; 35, // 新竹市 'I' =&gt; 34, // 嘉義市 ]; /** * 生成身份證字號 * * @param string $city 城市 * @param integer $sex 性別 * @param string $mid 流水號 * @return void */ public function generate(string $city = null, int $sex = null, string $mid = null) &#123; $cities = array_keys($this-&gt;cityMaps); if (is_null($city)) &#123; $index = array_rand($cities); $city = $cities[$index]; $cityCode = $this-&gt;cityMaps[$city]; &#125; else &#123; $city = strtoupper($city); $cityCode = $this-&gt;cityMaps[$city] ?? ''; &#125; if (is_null($sex)) &#123; $sex = rand(0, 1); &#125; if (is_null($mid)) &#123; $mid = $this-&gt;midRand(); &#125; // 驗證城市 if (!in_array($city, $cities)) &#123; throw new \\Exception(\"Invalid city\", 1); &#125; // 驗證性別 if (!in_array($sex, [self::MALE, self::FEMALE])) &#123; throw new \\Exception(\"Invalid sex\", 1); &#125; $verifyCode = $this-&gt;calAll($cityCode, $sex, $mid); return sprintf('%s%s%s%s', $city, $sex, $mid, $verifyCode); &#125; /** * 驗證身份證字號 * * @param string $id 身份證字號 * @return bool */ public function validate(string $id = '') &#123; [$city, $sex, $mid, $verifyCode] = [ substr($id, 0, 1), substr($id, 1, 1), substr($id, 2, -1), substr($id, -1, 1), ]; return $verifyCode == $this-&gt;calAll($this-&gt;cityMaps[$city], $sex, $mid); &#125; /** * 隨機流水號 * * @return string */ private function midRand() &#123; return str_pad(rand(0, 9999999), 7, '0', STR_PAD_LEFT); &#125; /** * 計算驗證碼 * * @param int $city * @param int $sex * @param string|int $mid * @return int */ private function calAll($city, $sex, $mid) &#123; $ret = 0; $ret = $this-&gt;calCity($city) + $this-&gt;calSex($sex) + $this-&gt;calMid($mid); $ret = $ret % 10; $ret = 10 - $ret; $ret = $ret % 10; return $ret; &#125; /** * 計算城市驗證碼 * * @param int $city * @return int */ private function calCity(int $city) &#123; return substr($city, 0, 1) + substr($city, 1, 1) * 9; &#125; /** * 計算性別驗證碼 * * @param integer $sex * @return int */ private function calSex(int $sex) &#123; return $sex * 8; &#125; /** * 計算流水驗證碼 * * @param string|int $mid * @return int */ private function calMid($mid) &#123; $ret = 0; $len = strlen($mid); for ($i = 0; $i &lt; $len; $i++) &#123; $ret = $ret + (7 - $i) * substr($mid, $i, 1); &#125; return $ret; &#125;&#125; 例子生成身份证字号1234567$Roc = new TaiwanRocId;// 随机生成$id = $Roc-&gt;generate();// 指定城市、性别$id = $Roc-&gt;generate('A', 1); 验证合法性1$ok = (new TaiwanRocId)-&gt;validate(\"A197651254\"); // true","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"}]},{"title":"MacOS 上安装多版本 PHP","slug":"install-multi-php-version-on-macos","date":"2019-04-10T11:48:47.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"install-multi-php-version-on-macos/","link":"","permalink":"https://hdj.me/install-multi-php-version-on-macos/","excerpt":"安装 brew 源12brew tap shivammathur/phpbrew search php |grep -E \"php@\\d\\.\\d$\" 可以看到结果： 12345678shivammathur/php/php@5.6shivammathur/php/php@7.0shivammathur/php/php@7.1shivammathur/php/php@7.2shivammathur/php/php@7.3shivammathur/php/php@7.4shivammathur/php/php@8.1shivammathur/php/php@8.2","text":"安装 brew 源12brew tap shivammathur/phpbrew search php |grep -E \"php@\\d\\.\\d$\" 可以看到结果： 12345678shivammathur/php/php@5.6shivammathur/php/php@7.0shivammathur/php/php@7.1shivammathur/php/php@7.2shivammathur/php/php@7.3shivammathur/php/php@7.4shivammathur/php/php@8.1shivammathur/php/php@8.2 安装多版本跟进需要安装 12345678brew install shivammathur/php/php@5.6brew install shivammathur/php/php@7.0brew install shivammathur/php/php@7.1brew install shivammathur/php/php@7.2brew install shivammathur/php/php@7.3brew install shivammathur/php/php@7.4brew install shivammathur/php/php@8.1brew install shivammathur/php/php@8.2 命令别名1vim ~/.zshrc 或 1vim ~/.bash_profile 加入以下内容 123456789101112131415161718192021222324252627282930313233343536373839# 解除所有关联alias unlink-php='brew list|grep -E \"php(\\d&#123;2&#125;|@\\d\\.\\d)$\"|xargs brew unlink; brew unlink php'# 命令别名alias php53='/usr/local/opt/php@5.3/bin/php'alias php54='/usr/local/opt/php@5.4/bin/php'alias php55='/usr/local/opt/php@5.5/bin/php'alias php56='/usr/local/opt/php@5.6/bin/php'alias php70='/usr/local/opt/php@7.0/bin/php'alias php71='/usr/local/opt/php@7.1/bin/php'alias php72='/usr/local/opt/php@7.2/bin/php'alias php73='/usr/local/opt/php@7.3/bin/php'alias php74='/usr/local/opt/php@7.4/bin/php'alias php80='/usr/local/opt/php/bin/php'# pecl aliasalias pecl53='/usr/local/php5/bin/pecl'alias pecl71='/usr/local/opt/php@7.1/bin/pecl'alias pecl72='/usr/local/opt/php@7.2/bin/pecl'alias pecl73='/usr/local/opt/php@7.3/bin/pecl'alias pecl74='/usr/local/opt/php@7.4/bin/pecl'alias pecl80='/usr/local/opt/php/bin/pecl'# composer aliasalias composer53='php53 /usr/local/bin/composer'alias composer70='php70 /usr/local/bin/composer'alias composer71='php71 /usr/local/bin/composer'alias composer72='php72 /usr/local/bin/composer'alias composer73='php73 /usr/local/bin/composer'alias composer74='php74 /usr/local/bin/composer'alias composer80='php80 /usr/local/bin/composer'# 切换版本alias use-php53='unlink-php; brew link --overwrite --force php@5.3 &amp;&amp; php -v'alias use-php54='unlink-php; brew link --overwrite --force php@5.4 &amp;&amp; php -v'alias use-php55='unlink-php; brew link --overwrite --force php@5.5 &amp;&amp; php -v'alias use-php56='unlink-php; brew link --overwrite --force php@5.6 &amp;&amp; php -v'alias use-php70='unlink-php; brew link --overwrite --force php@7.0 &amp;&amp; php -v'alias use-php71='unlink-php; brew link --overwrite --force php@7.1 &amp;&amp; php -v'alias use-php72='unlink-php; brew link --overwrite --force php@7.2 &amp;&amp; php -v'alias use-php73='unlink-php; brew link --overwrite --force php@7.3 &amp;&amp; php -v'alias use-php74='unlink-php; brew link --overwrite --force php@7.4 &amp;&amp; php -v'alias use-php80='unlink-php; brew link --overwrite --force php &amp;&amp; php -v' 后面可以通过 use-php[version] 随意切换版本，或者直接用 php[version] 执行。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"macos","slug":"macos","permalink":"https://hdj.me/tags/macos/"},{"name":"brew","slug":"brew","permalink":"https://hdj.me/tags/brew/"},{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"}]},{"title":"2019如何更新packagist github-hook","slug":"update-packagist-github-hook-2019","date":"2019-01-04T16:38:58.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"update-packagist-github-hook-2019/","link":"","permalink":"https://hdj.me/update-packagist-github-hook-2019/","excerpt":"","text":"去年（2018）Packagist 就有提醒： This package is using the legacy GitHub service and will stop being auto-updated in early 2019. Please set up the new GitHub Hook for Packagist so that it keeps working in the future. 大概意思是旧的 GitHub WebHook 被放弃了，请大家更新最新版，目前网上没有比较详细的说明，自己摸索了一下： 打开 https://packagist.org/profile/edit ，看是否绑定了 GitHub Account ，如果没有直接绑定。如果绑定过，解除重新绑定（因为要重新授权）。 打开 https://github.com/your-github-account/your-project/settings/hooks ，删除旧的 WebHook（Don’t ask why，just do it）。 回到 https://packagist.org/profile/ ，点击 retry hook sync 重新同步 WebHook。 再次查看 GitHub WebHook 的时候发现已经自动配置好了，packagist 对应的项目页面也没有 WebHook 相关提示了。 发布新的 package 也只需要点击 retry hook sync 就可以自动绑定了，不需要手动添加。","categories":[],"tags":[]},{"title":"10个常见的Redis面试\"刁难\"问题","slug":"ten-questions-of-redis","date":"2018-07-25T07:31:07.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"ten-questions-of-redis/","link":"","permalink":"https://hdj.me/ten-questions-of-redis/","excerpt":"导读：在程序员面试过程中Redis相关的知识是常被问到的话题。作为一名在互联网技术行业打击过成百上千名的资深技术面试官，本文作者总结了面试过程中经常问到的问题。十分值得一读。 作者简介：钱文品（老钱），互联网分布式高并发技术十年老兵，目前任掌阅科技资深后端工程师。熟练使用 Java、Python、Golang 等多种计算机语言，开发过游戏，制作过网站，写过消息推送系统和MySQL 中间件，实现过开源的 ORM 框架、Web 框架、RPC 框架等 Redis在互联网技术存储方面使用如此广泛，几乎所有的后端技术面试官都要在Redis的使用和原理方面对小伙伴们进行各种刁难。作为一名在互联网技术行业打击过成百上千名【请允许我夸张一下】的资深技术面试官，看过了无数落寞的身影失望的离开，略感愧疚，故献上此文，希望各位读者以后面试势如破竹，永无失败！","text":"导读：在程序员面试过程中Redis相关的知识是常被问到的话题。作为一名在互联网技术行业打击过成百上千名的资深技术面试官，本文作者总结了面试过程中经常问到的问题。十分值得一读。 作者简介：钱文品（老钱），互联网分布式高并发技术十年老兵，目前任掌阅科技资深后端工程师。熟练使用 Java、Python、Golang 等多种计算机语言，开发过游戏，制作过网站，写过消息推送系统和MySQL 中间件，实现过开源的 ORM 框架、Web 框架、RPC 框架等 Redis在互联网技术存储方面使用如此广泛，几乎所有的后端技术面试官都要在Redis的使用和原理方面对小伙伴们进行各种刁难。作为一名在互联网技术行业打击过成百上千名【请允许我夸张一下】的资深技术面试官，看过了无数落寞的身影失望的离开，略感愧疚，故献上此文，希望各位读者以后面试势如破竹，永无失败！ Redis有哪些数据结构？字符串String、字典Hash、列表List、集合Set、有序集合SortedSet。 如果你是Redis中高级用户，还需要加上下面几种数据结构HyperLogLog、Geo、Pub/Sub。 如果你说还玩过Redis Module，像BloomFilter，RedisSearch，Redis-ML，面试官得眼睛就开始发亮了。 使用过Redis分布式锁么，它是什么回事？先拿setnx来争抢锁，抢到之后，再用expire给锁加一个过期时间防止锁忘记了释放。 这时候对方会告诉你说你回答得不错，然后接着问如果在setnx之后执行expire之前进程意外crash或者要重启维护了，那会怎么样？ 这时候你要给予惊讶的反馈：唉，是喔，这个锁就永远得不到释放了。紧接着你需要抓一抓自己得脑袋，故作思考片刻，好像接下来的结果是你主动思考出来的，然后回答：我记得set指令有非常复杂的参数，这个应该是可以同时把setnx和expire合成一条指令来用的！对方这时会显露笑容，心里开始默念：摁，这小子还不错。 假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？使用keys指令可以扫出指定模式的key列表。 对方接着追问：如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？ 这个时候你要回答redis关键的一个特性：redis的单线程的。keys指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用scan指令，scan指令可以无阻塞的提取出指定模式的key列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用keys指令长。 使用过Redis做异步队列么，你是怎么用的？一般使用list结构作为队列，rpush生产消息，lpop消费消息。当lpop没有消息的时候，要适当sleep一会再重试。 如果对方追问可不可以不用sleep呢？list还有个指令叫blpop，在没有消息的时候，它会阻塞住直到消息到来。 如果对方追问能不能生产一次消费多次呢？使用pub/sub主题订阅者模式，可以实现1:N的消息队列。 如果对方追问pub/sub有什么缺点？在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如rabbitmq等。 如果对方追问redis如何实现延时队列？我估计现在你很想把面试官一棒打死如果你手上有一根棒球棍的话，怎么问的这么详细。但是你很克制，然后神态自若的回答道：使用sortedset，拿时间戳作为score，消息内容作为key调用zadd来生产消息，消费者用zrangebyscore指令获取N秒之前的数据轮询进行处理。 到这里，面试官暗地里已经对你竖起了大拇指。但是他不知道的是此刻你却竖起了中指，在椅子背后。 如果有大量的key需要设置同一时间过期，一般需要注意什么？如果大量的key过期时间设置的过于集中，到过期的那个时间点，redis可能会出现短暂的卡顿现象。一般需要在时间上加一个随机值，使得过期时间分散一些。 Redis如何做持久化的？bgsave做镜像全量持久化，aof做增量持久化。因为bgsave会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要aof来配合使用。在redis实例重启时，优先使用aof来恢复内存的状态，如果没有aof日志，就会使用rdb文件来恢复。 如果再问aof文件过大恢复时间过长怎么办？你告诉面试官，Redis会定期做aof重写，压缩aof文件日志大小。如果面试官不够满意，再拿出杀手锏答案，Redis4.0之后有了混合持久化的功能，将bgsave的全量和aof的增量做了融合处理，这样既保证了恢复的效率又兼顾了数据的安全性。这个功能甚至很多面试官都不知道，他们肯定会对你刮目相看。 如果对方追问那如果突然机器掉电会怎样？取决于aof日志sync属性的配置，如果不要求性能，在每条写指令时都sync一下磁盘，就不会丢失数据。但是在高性能的要求下每次都sync是不现实的，一般都使用定时sync，比如1s1次，这个时候最多就会丢失1s的数据。 Pipeline有什么好处，为什么要用pipeline？可以将多次IO往返的时间缩减为一次，前提是pipeline执行的指令之间没有因果相关性。使用redis-benchmark进行压测的时候可以发现影响redis的QPS峰值的一个重要因素是pipeline批次指令的数目。 Redis的同步机制了解么？Redis可以使用主从同步，从从同步。第一次同步时，主节点做一次bgsave，并同时将后续修改操作记录到内存buffer，待完成后将rdb文件全量同步到复制节点，复制节点接受完成后将rdb镜像加载到内存。加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。 是否使用过Redis集群，集群的原理是什么？Redis Sentinal着眼于高可用，在master宕机时会自动将slave提升为master，继续提供服务。 Redis Cluster着眼于扩展性，在单个redis内存不足时，使用Cluster进行分片存储。 原文：10个常见的Redis面试”刁难”问题","categories":[{"name":"其他","slug":"other","permalink":"https://hdj.me/categories/other/"}],"tags":[{"name":"redis","slug":"redis","permalink":"https://hdj.me/tags/redis/"},{"name":"面试","slug":"面试","permalink":"https://hdj.me/tags/面试/"},{"name":"问题","slug":"问题","permalink":"https://hdj.me/tags/问题/"}]},{"title":"Swoole实现即时聊天服务","slug":"im-server-by-swoole","date":"2018-07-18T09:12:14.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"im-server-by-swoole/","link":"","permalink":"https://hdj.me/im-server-by-swoole/","excerpt":"需求背景就技术面而言，即时通讯对很多人或公司来说已经没有什么门槛，技术方案有如雨后春笋，也各有千秋，也有不少专业提供第三方服务的公司，如云信、融云等等，几个大厂（阿里云、腾讯云）也有提供云服务。","text":"需求背景就技术面而言，即时通讯对很多人或公司来说已经没有什么门槛，技术方案有如雨后春笋，也各有千秋，也有不少专业提供第三方服务的公司，如云信、融云等等，几个大厂（阿里云、腾讯云）也有提供云服务。 这里要讲一下的是第三方功能非常强大，也兼容各个平台，但是灵活性不够个性需求无法定制。 刚提到技术上已经没有门槛，开源的项目也有不少，基本都是基于长连接+轮询或websocket，长连接的代表有iComet，而websocket的代表有Swoole。 花了半天写了个demo，先看看需求： 支持点对点聊天 同一账号支持多端，能同时受到信息 TODO 支持消息广播 支持离线消息 服务端123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140&lt;?phpclass FdMapping&#123; private $redis; const MAP_UID_FD_PREFIX = 'chat_map_uid_fd:'; const MAP_FD_UID_PREFIX = 'chat_map_fd_uid:'; public function __construct($redis_host = '127.0.0.1', $redis_port = 6379) &#123; $this-&gt;redis = new Redis(); $this-&gt;redis-&gt;connect($redis_host, $redis_port); &#125; // uid与fd对应，支持多端/多页面 public function uidBindFd($uid, $fd) &#123; return $this-&gt;redis-&gt;sadd( self::MAP_UID_FD_PREFIX . $uid, $fd ); &#125; // fd与uid对应 public function fdBindUid($fd, $uid) &#123; return $this-&gt;redis-&gt;setex( self::MAP_FD_UID_PREFIX . $fd, 24 * 3600, $uid ); &#125; // 获取fd对应的uid public function getUidByFd($fd) &#123; return $this-&gt;redis-&gt;get(self::MAP_FD_UID_PREFIX . $fd); &#125; // 获取uid全部fd，确保多端都能收到信息 public function getFdsByUid($uid) &#123; return $this-&gt;redis-&gt;sMembers(self::MAP_UID_FD_PREFIX . $uid); &#125; // 删除uid的某个fd public function delFd($fd, $uid = null) &#123; if (is_null($uid)) &#123; $uid = $this-&gt;getUidByFd($fd); &#125; if (!$uid) &#123; return false; &#125; $this-&gt;redis-&gt;srem(self::MAP_UID_FD_PREFIX . $uid, $fd); $this-&gt;redis-&gt;del(self::MAP_FD_UID_PREFIX . $fd); return true; &#125;&#125;$FdMapping = new FdMapping('127.0.0.1');$server = new swoole_websocket_server(\"127.0.0.1\", 9502);$server-&gt;on('open', function($server, $req) &#123; echo \"新连接: #&#123;$req-&gt;fd&#125;\\n\";&#125;);$server-&gt;on('message', function($server, $frame) use ($FdMapping) &#123; echo \"接收到: \" . json_encode($frame-&gt;data) . \"\\n\"; // 解析json为array $data = json_decode($frame-&gt;data, true); // 处理不同的消息类型 switch ($data['type']) &#123; case 'sign': // 设置uid与fd对应关系 $FdMapping-&gt;uidBindFd($data['uid'], $frame-&gt;fd); $FdMapping-&gt;fdBindUid($frame-&gt;fd, $data['uid']); // 清理过期/已断开的连接 $fds = $FdMapping-&gt;getFdsByUid($data['uid']); foreach ((array)$fds as $fd) &#123; !$server-&gt;exist($fd) &amp;&amp; $FdMapping-&gt;delFd($fd, $data['uid']); &#125; // 返回注册成功信息，token未验证 $server-&gt;push( $frame-&gt;fd, json_encode([ 'status' =&gt; 1, 'msg' =&gt; '注册成功', 'token' =&gt; md5(time()), // 可用于连接合法性验证 ]) ); break; case 'msg': $data['from'] = $FdMapping-&gt;getUidByFd($frame-&gt;fd); // 验证是否已经注册 if (!$data['from']) &#123; $server-&gt;push( $frame-&gt;fd, json_encode([ 'status' =&gt; 0, 'msg' =&gt; '发送失败，未登入', ]) ); return; &#125; // 将消息推送到uid各端 $fds = $FdMapping-&gt;getFdsByUid($data['to']); foreach ((array) $fds as $fd) &#123; $server-&gt;exist($fd) &amp;&amp; $server-&gt;push( $fd, json_encode([ 'body' =&gt; $data['body'], 'from' =&gt; $data['from'], ]) ); echo \"#&#123;$fd&#125; 推送成功\\n\"; &#125; // 告知推送成功 $server-&gt;push($frame-&gt;fd, json_encode(['status' =&gt; 1, 'msg' =&gt; 'sended'])); break; default: // 非法请求 $server-&gt;push( $frame-&gt;fd, json_encode([ 'status' =&gt; 0, 'msg' =&gt; '非法请求', 'disconnect' =&gt; 1, // 告知终端请断开 ]) ); break; &#125;&#125;);$server-&gt;on('close', function($server, $fd) use ($FdMapping) &#123; echo \"连接断开: #&#123;$fd&#125;\\n\"; $FdMapping-&gt;delFd($fd);&#125;);$server-&gt;start(); 客户端123456789101112131415var ws = new WebSocket(\"ws://127.0.0.1:9502\");ws.onopen = function (evt) &#123; console.log(\"Connection open ...\"); ws.send('&#123;\"type\":\"sign\", \"uid\":\"1001\"&#125;');&#125;;ws.onmessage = function (evt) &#123; console.log(\"Received Message: \" + evt.data); // ws.close();&#125;;ws.onclose = function (evt) &#123; console.log(\"Connection closed.\");&#125;;","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"swoole","slug":"swoole","permalink":"https://hdj.me/tags/swoole/"},{"name":"chat","slug":"chat","permalink":"https://hdj.me/tags/chat/"}]},{"title":"第三方应用共享Laravel项目Session","slug":"share-laravel-session-on-third-party-application","date":"2018-07-17T12:59:00.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"share-laravel-session-on-third-party-application/","link":"","permalink":"https://hdj.me/share-laravel-session-on-third-party-application/","excerpt":"Laravel 框架越来越被PHP开发者青睐，被应用得越来越广泛，大家都恨不得全部用它来重构项目，boss们当然不会同意，但是我们作为工程师也是不会放弃的，那要怎么办呢？ 没错，按模块拆分重构，比如注册、登入等小模块先重构。","text":"Laravel 框架越来越被PHP开发者青睐，被应用得越来越广泛，大家都恨不得全部用它来重构项目，boss们当然不会同意，但是我们作为工程师也是不会放弃的，那要怎么办呢？ 没错，按模块拆分重构，比如注册、登入等小模块先重构。 一鼓作气，写完了发现Session不兼容，去Google百度了一下，也没找到什么好方案，没办法自己分析一下。 先看一下Laravel写的Session是什么1s:207:\"a:4:&#123;s:3:\"abc\";i:1531800464;s:6:\"_token\";s:40:\"SPhvkWipry9tCxLrU431ueWE8iHBaMkOMU0acQV6\";s:9:\"_previous\";a:1:&#123;s:3:\"url\";s:26:\"http://yourdomain.com/\";&#125;s:6:\"_flash\";a:2:&#123;s:3:\"old\";a:0:&#123;&#125;s:3:\"new\";a:0:&#123;&#125;&#125;&#125;\"; 是不是很眼熟？没错，是PHP的序列化，要注意的是2次序列化。我们来验证一下： 12345678910111213141516171819202122232425$sessData = &lt;&lt;&lt;DATAs:207:\"a:4:&#123;s:3:\"abc\";i:1531800464;s:6:\"_token\";s:40:\"SPhvkWipry9tCxLrU431ueWE8iHBaMkOMU0acQV6\";s:9:\"_previous\";a:1:&#123;s:3:\"url\";s:26:\"http://yourdomain.com/\";&#125;s:6:\"_flash\";a:2:&#123;s:3:\"old\";a:0:&#123;&#125;s:3:\"new\";a:0:&#123;&#125;&#125;&#125;\";DATA;$sessData = unserialize(unserialize($sessData));var_dump($sessData);/**array ( 'abc' =&gt; 1531800527, '_token' =&gt; 'SPhvkWipry9tCxLrU431ueWE8iHBaMkOMU0acQV6', '_previous' =&gt; array ( 'url' =&gt; 'http://yourdomain.com/', ), '_flash' =&gt; array ( 'old' =&gt; array ( ), 'new' =&gt; array ( ), ),) */ 设置Laravel Session配置，为共享\b\b准备1234// config/session.php'encrypt' =&gt; false,'cookie' =&gt; 'PHPSESSID','domain' =&gt; 'yourdomain.com', 明文 Cookie很多时候 Cookie 是需要被前端童鞋使用的，但是默认情况下 Laravel 在响应头中添加的 Cookie 信息是加密过的，类似 eyJpdiI6IjRwOFMyTkl2aGs2TGt4OUcxYXRNXC9BPT0iLCJ2YWx1ZSI6IkpHN0Fqb0ZSaDFxVHE0OHdFRXdXMHc9PSIsIm1hYyI6Ijc2MTljZDVmZDI1Mjg5MTk3NTBlZGM0MzUxMjUyZjQ5MzcxOGE1MWU4Y2ViZTBlYTY5YWRjZjNkZjUwNzNkMDEifQ%3D%3D，这种时候就得将那些需要 明文 传输的 Cookie 加入到 白名单 中去： 在 /app/Http/Middleware/EncryptCookies.php 中的 $except 数组中将其加入 123protected $except = [ 'PHPSESSID',]; 第三方应用\b兼容 Laravel思路如下： 读取 Redis取出（Laravel\b\b序列化数据，字符串）-&gt;unserialize * 2（得到数组）-&gt;\bSessionSerializer::encode()（得到序列化数据，字符串）-&gt;交给PHP内核处理 写入 PHP系列化数据-&gt;\bSessionSerializer::decode()（得到数组）-&gt;serialize() * 2-&gt;写入Redis 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189// PHP SESSION 序列化器class SessionSerializer&#123; public static function encode($array, $safe = true, $method = '') &#123; $method = empty($method) ? ini_get(\"session.serialize_handler\") : $method; switch ($method) &#123; case \"php\": return self::serializePhp($array, $safe); break; case \"php_binary\": return self::serializePhpbinary($array, $safe); break; default: throw new Exception(\"Unsupported session.serialize_handler: \" . $method . \". Supported: php, php_binary\"); &#125; &#125; public static function serializePhp($array, $safe = true) &#123; if ($safe) &#123; $array = unserialize(serialize($array)); &#125; $raw = ''; $line = 0; $keys = array_keys($array); foreach ($keys as $key) &#123; $value = $array[$key]; $line++; $raw .= $key . '|'; if (is_array($value) &amp;&amp; isset($value['huge_recursion_blocker_we_hope'])) &#123; $raw .= 'R:' . $value['huge_recursion_blocker_we_hope'] . ';'; &#125; else &#123; $raw .= serialize($value); &#125; $array[$key] = ['huge_recursion_blocker_we_hope' =&gt; $line]; &#125; return $raw; &#125; private static function serializePhpbinary($array, $safe = true) &#123; return ''; &#125; public static function decode($session_data, $method = '') &#123; $method = empty($method) ? ini_get(\"session.serialize_handler\") : $method; switch ($method) &#123; case \"php\": return self::unserializePhp($session_data); break; case \"php_binary\": return self::unserializePhpbinary($session_data); break; default: throw new Exception(\"Unsupported session.serialize_handler: \" . $method . \". Supported: php, php_binary\"); &#125; &#125; private static function unserializePhp($session_data) &#123; $return_data = []; $offset = 0; while ($offset &lt; strlen($session_data)) &#123; if (!strstr(substr($session_data, $offset), \"|\")) &#123; throw new Exception(\"Invalid data, remaining: \" . substr($session_data, $offset)); &#125; $pos = strpos($session_data, \"|\", $offset); $num = $pos - $offset; $varname = substr($session_data, $offset, $num); $offset += $num + 1; $data = unserialize(substr($session_data, $offset)); $return_data[$varname] = $data; $offset += strlen(serialize($data)); &#125; return $return_data; &#125; private static function unserializePhpbinary($session_data) &#123; $return_data = []; $offset = 0; while ($offset &lt; strlen($session_data)) &#123; $num = ord($session_data[$offset]); $offset += 1; $varname = substr($session_data, $offset, $num); $offset += $num; $data = unserialize(substr($session_data, $offset)); $return_data[$varname] = $data; $offset += strlen(serialize($data)); &#125; return $return_data; &#125;&#125;// Redis Session 驱动class SessionRedis&#123; protected $lifeTime = 900; // Laravel项目中Session存储要求 protected $sessionName = 'your_laravel_app_name:'; // 共享cookie需要 protected $cookieDomain = 'yourdomain.com'; protected $handle = null; public function open($savePath, $sessName) &#123; $this-&gt;handle = new Redis; $this-&gt;handle-&gt;connect('127.0.0.1', 6379); return true; &#125; public function close() &#123; $this-&gt;gc(ini_get('session.gc_maxlifetime')); $this-&gt;handle-&gt;close(); $this-&gt;handle = null; return true; &#125; public function read($sessID) &#123; if (empty($sessID)) &#123; return; &#125; // 从Redis读取 $sessData = $this-&gt;handle-&gt;get($this-&gt;sessionName . $sessID); // 按Laravel格式反序列化 $sessData = unserialize(unserialize($sessData)); // 处理非法格式 $sessData = is_array($sessData) ? $sessData : []; // 按PHP内核需要格式序列化 $sessData = SessionSerializer::encode($sessData); // 注意这里需要返回的是序列化后的字符串 return $sessData; &#125; public function write($sessID, $sessData) &#123; if (empty($sessID)) &#123; return; &#125; // 反序列化为数组 $sessData = SessionSerializer::decode($sessData); // 按Laravel需要的格式序列化 $sessData = serialize(serialize($sessData)); // 存入Redis return $this-&gt;handle-&gt;setex($this-&gt;sessionName . $sessID, $this-&gt;lifeTime, $sessData); &#125; public function destroy($sessID) &#123; if (empty($sessID)) &#123; return; &#125; return $this-&gt;handle-&gt;delete($this-&gt;sessionName . $sessID); &#125; public function gc($sessMaxLifeTime) &#123; return true; &#125; public function start() &#123; ini_set('session.cookie_domain', isset($m[0]) ? $m[0] : $this-&gt;cookieDomain); ini_set('session.auto_start', 0); ini_set('session.use_trans_sid', 0); ini_set('session.gc_probability', 1); ini_set('session.gc_divisor', 1000); ini_set('session.gc_maxlifetime', $this-&gt;lifeTime); ini_set('session.use_cookies', 1); ini_set('session.cookie_path', '/'); session_module_name('user'); session_set_save_handler( array(&amp;$this, 'open'), array(&amp;$this, 'close'), array(&amp;$this, 'read'), array(&amp;$this, 'write'), array(&amp;$this, 'destroy'), array(&amp;$this, 'gc') ); session_start(); &#125;&#125;(new SessionRedis())-&gt;start(); Laravel 兼容第三方应用以 Memcache 为例 服务器记得编译 memcache 扩展 增加 session 驱动123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186&lt;?phpnamespace App\\Extensions;use Exception;use Memcache;class MemcacheSessionHandler implements \\SessionHandlerInterface&#123; protected $handle = null; protected $sessionName = ''; protected $lifeTime; public function __construct() &#123; $this-&gt;sessionName = ''; $this-&gt;lifeTime = config('session.lifetime'); $this-&gt;handle = new Memcache; collect(config('cache.stores.memcached.servers'))-&gt;each(function ($server) &#123; $this-&gt;handle-&gt;addServer($server['host'], $server['port'], true); &#125;); &#125; public function open($savePath, $sessionName) &#123; return true; &#125; public function close() &#123; $this-&gt;handle-&gt;close(); $this-&gt;handle = null; return true; &#125; public function read($sessionId) &#123; if (empty($sessionId)) &#123; return; &#125; $data = $this-&gt;handle-&gt;get($this-&gt;sessionName . $sessionId); // info($data, ['format' =&gt; 'php']); // php -&gt; laravel $data = self::decode($data); $data = serialize($data); // info($data, ['format' =&gt; 'laravel']); return $data; &#125; public function write($sessionId, $data) &#123; if (empty($sessionId)) &#123; return; &#125; // info($data, ['format' =&gt; 'laravel']); // laravel-&gt;php $data = unserialize($data); $data = self::encode($data); // info($data, ['format' =&gt; 'php']); return $this-&gt;handle-&gt;set($this-&gt;sessionName . $sessionId, $data, 0, $this-&gt;lifeTime); &#125; public function destroy($sessionId) &#123; if (empty($sessionId)) &#123; return; &#125; return $this-&gt;handle-&gt;delete($this-&gt;sessionName . $sessionId); &#125; public function gc($lifetime) &#123; return true; &#125; public static function encode($array, $safe = true, $method = '') &#123; $method = empty($method) ? ini_get(\"session.serialize_handler\") : $method; switch ($method) &#123; case \"php\": return self::serializePhp($array, $safe); break; case \"php_binary\": return self::serializePhpbinary($array, $safe); break; default: throw new Exception(\"Unsupported session.serialize_handler: \" . $method . \". Supported: php, php_binary\"); &#125; &#125; public static function serializePhp($array, $safe = true) &#123; if ($safe) &#123; $array = unserialize(serialize($array)); &#125; $raw = ''; $line = 0; $keys = array_keys($array); foreach ($keys as $key) &#123; $value = $array[$key]; $line++; $raw .= $key . '|'; if (is_array($value) &amp;&amp; isset($value['huge_recursion_blocker_we_hope'])) &#123; $raw .= 'R:' . $value['huge_recursion_blocker_we_hope'] . ';'; &#125; else &#123; $raw .= serialize($value); &#125; $array[$key] = ['huge_recursion_blocker_we_hope' =&gt; $line]; &#125; return $raw; &#125; private static function serializePhpbinary($array, $safe = true) &#123; return ''; &#125; public static function decode($session_data, $method = '') &#123; $method = empty($method) ? ini_get(\"session.serialize_handler\") : $method; switch ($method) &#123; case \"php\": return self::unserializePhp($session_data); break; case \"php_binary\": return self::unserializePhpbinary($session_data); break; default: throw new Exception(\"Unsupported session.serialize_handler: \" . $method . \". Supported: php, php_binary\"); &#125; &#125; private static function unserializePhp($session_data) &#123; $return_data = []; $offset = 0; while ($offset &lt; strlen($session_data)) &#123; if (!strstr(substr($session_data, $offset), \"|\")) &#123; throw new Exception(\"Invalid data, remaining: \" . substr($session_data, $offset)); &#125; $pos = strpos($session_data, \"|\", $offset); $num = $pos - $offset; $varname = substr($session_data, $offset, $num); $offset += $num + 1; $data = unserialize(substr($session_data, $offset)); $return_data[$varname] = $data; $offset += strlen(serialize($data)); &#125; return $return_data; &#125; private static function unserializePhpbinary($session_data) &#123; $return_data = []; $offset = 0; while ($offset &lt; strlen($session_data)) &#123; $num = ord($session_data[$offset]); $offset += 1; $varname = substr($session_data, $offset, $num); $offset += $num; $data = unserialize(substr($session_data, $offset)); $return_data[$varname] = $data; $offset += strlen(serialize($data)); &#125; return $return_data; &#125;&#125; 扩展驱动编辑 app\\AppServiceProvider.php，在 boot() 方法增加以下代码 12345public function boot() &#123; Session::extend('memcache', function ($app) &#123; return new \\App\\Extensions\\MemcacheSessionHandler; &#125;);&#125; 修改驱动编辑或增加 .env 123SESSION_DRIVER=memcacheSESSION_LIFETIME=120SESSION_DOMAIN=.a.com 特别注意 !!!!如果第三方应用 PHP 版本低于 7.0，需要设置 session_id 长度与 Laravel 项目（session_id 长度为 40）的一致 123// PHP_VERSION &lt; 7.0ini_set('session.hash_function', 1);ini_set('session.hash_bits_per_character', 4); Laravel 设置认证信息也需注意，auth()-&gt;login($user) 会更新 session_id，可以改用 auth()-&gt;setUser($user) 最后，如果你有更好的方案，请留言给我，一起交流共同进步。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"laravel","slug":"laravel","permalink":"https://hdj.me/tags/laravel/"},{"name":"session","slug":"session","permalink":"https://hdj.me/tags/session/"}]},{"title":"修复MacOS Mojave dev beta1无法正常显示checkbox问题","slug":"mojave-checkbox-fix","date":"2018-07-06T16:07:02.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"mojave-checkbox-fix/","link":"","permalink":"https://hdj.me/mojave-checkbox-fix/","excerpt":"","text":"mojave-checkbox-fix just installed this, easy fix. Just need to remember to uninstall it once it’s working correctly.","categories":[{"name":"其他","slug":"other","permalink":"https://hdj.me/categories/other/"}],"tags":[{"name":"chrome","slug":"chrome","permalink":"https://hdj.me/tags/chrome/"},{"name":"mojave","slug":"mojave","permalink":"https://hdj.me/tags/mojave/"}]},{"title":"ES报错Result window is too large问题处理","slug":"elasticsearch-result-window-is-too-large","date":"2018-06-26T12:31:46.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"elasticsearch-result-window-is-too-large/","link":"","permalink":"https://hdj.me/elasticsearch-result-window-is-too-large/","excerpt":"我在使用Elasticsearch进行search查询的过程中，出现了Result window is too large问题。 Result window is too large, from + size must be less than or equal to: [10000] but was [43155]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.","text":"我在使用Elasticsearch进行search查询的过程中，出现了Result window is too large问题。 Result window is too large, from + size must be less than or equal to: [10000] but was [43155]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting. 从上面的报错信息，可以看到ES提示我结果窗口太大了，目前最大值为10000，而我却要求给我43155。并且在后面也提到了要求我修改index.max_result_window参数来增大结果窗口大小。 修改方法，命令如下： 1curl -XPUT -H \"Content-Type: application/json\" http://192.168.8.82:9200/indexName/_settings -d '&#123;\"index\" : &#123;\"max_result_window\" : 100000000&#125;&#125;'","categories":[{"name":"数据库","slug":"db","permalink":"https://hdj.me/categories/db/"}],"tags":[{"name":"es","slug":"es","permalink":"https://hdj.me/tags/es/"},{"name":"elasticsearch","slug":"elasticsearch","permalink":"https://hdj.me/tags/elasticsearch/"}]},{"title":"让Lumen支持请求控制","slug":"lumen-support-throttle-requests","date":"2018-06-11T14:47:57.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"lumen-support-throttle-requests/","link":"","permalink":"https://hdj.me/lumen-support-throttle-requests/","excerpt":"Lumen 是你构建微服务架构和 API 应用的完美解决方案，事实上，她是全宇宙最快的框架之一，甚至要快过以速度著称的 Silex 和 Slim，现在，为你的 Laravel 应用程序编写微服务架构变得再简单不过了。 但是你在使用的过程中，你会发现很多 Laravel 中好用的功能都被精简了，比如说请求控制中间件 Throttle。这个中间件能简单的实现请求控制。那么接下来跟我一起为 Lumen 重新添加这么好用的功能吧。","text":"Lumen 是你构建微服务架构和 API 应用的完美解决方案，事实上，她是全宇宙最快的框架之一，甚至要快过以速度著称的 Silex 和 Slim，现在，为你的 Laravel 应用程序编写微服务架构变得再简单不过了。 但是你在使用的过程中，你会发现很多 Laravel 中好用的功能都被精简了，比如说请求控制中间件 Throttle。这个中间件能简单的实现请求控制。那么接下来跟我一起为 Lumen 重新添加这么好用的功能吧。 从 Laravel 移植GitHub地址 保存为 app/Http/Middleware/ThrottleRequests.php，别忘了修改 namespace 为 App\\Http\\Middleware，完整代码如下： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134&lt;?phpnamespace App\\Http\\Middleware;use Closure;use Illuminate\\Cache\\RateLimiter;use Symfony\\Component\\HttpFoundation\\Response;class ThrottleRequests&#123; /** * The rate limiter instance. * * @var \\Illuminate\\Cache\\RateLimiter */ protected $limiter; /** * Create a new request throttler. * * @param \\Illuminate\\Cache\\RateLimiter $limiter * @return void */ public function __construct(RateLimiter $limiter) &#123; $this-&gt;limiter = $limiter; &#125; /** * Handle an incoming request. * * @param \\Illuminate\\Http\\Request $request * @param \\Closure $next * @param int $maxAttempts * @param int $decayMinutes * @return mixed */ public function handle($request, Closure $next, $maxAttempts = 60, $decayMinutes = 1) &#123; $key = $this-&gt;resolveRequestSignature($request); if ($this-&gt;limiter-&gt;tooManyAttempts($key, $maxAttempts, $decayMinutes)) &#123; return $this-&gt;buildResponse($key, $maxAttempts); &#125; $this-&gt;limiter-&gt;hit($key, $decayMinutes); $response = $next($request); return $this-&gt;addHeaders( $response, $maxAttempts, $this-&gt;calculateRemainingAttempts($key, $maxAttempts) ); &#125; /** * Resolve request signature. * * @param \\Illuminate\\Http\\Request $request * @return string */ protected function resolveRequestSignature($request) &#123; // return $request-&gt;fingerprint(); // Lumen 版本缺少 Request::fingerprint 方法 return sha1( $request-&gt;method() . '|' . $request-&gt;server('SERVER_NAME') . '|' . $request-&gt;path() . '|' . $request-&gt;ip() ); &#125; /** * Create a 'too many attempts' response. * * @param string $key * @param int $maxAttempts * @return \\Illuminate\\Http\\Response */ protected function buildResponse($key, $maxAttempts) &#123; $response = new Response('Too Many Attempts.', 429); $retryAfter = $this-&gt;limiter-&gt;availableIn($key); return $this-&gt;addHeaders( $response, $maxAttempts, $this-&gt;calculateRemainingAttempts($key, $maxAttempts, $retryAfter), $retryAfter ); &#125; /** * Add the limit header information to the given response. * * @param \\Symfony\\Component\\HttpFoundation\\Response $response * @param int $maxAttempts * @param int $remainingAttempts * @param int|null $retryAfter * @return \\Illuminate\\Http\\Response */ protected function addHeaders(Response $response, $maxAttempts, $remainingAttempts, $retryAfter = null) &#123; $headers = [ 'X-RateLimit-Limit' =&gt; $maxAttempts, 'X-RateLimit-Remaining' =&gt; $remainingAttempts, ]; if (!is_null($retryAfter)) &#123; $headers['Retry-After'] = $retryAfter; &#125; $response-&gt;headers-&gt;add($headers); return $response; &#125; /** * Calculate the number of remaining attempts. * * @param string $key * @param int $maxAttempts * @param int|null $retryAfter * @return int */ protected function calculateRemainingAttempts($key, $maxAttempts, $retryAfter = null) &#123; if (!is_null($retryAfter)) &#123; return 0; &#125; return $this-&gt;limiter-&gt;retriesLeft($key, $maxAttempts); &#125;&#125; 注册中间件找到 bootstrap/app.php 文件，添加： 123$app-&gt;routeMiddleware([ 'throttle' =&gt; App\\Http\\Middleware\\ThrottleRequests::class,]); 更新 composer1composer dump-autoload 测试找到 routes/web.php，修改 or 添加 123456789101112// 默认速率是60请求/分钟$router-&gt;group(['prefix' =&gt; 'api', 'middleware'=&gt;'throttle'], function () use ($router) &#123; $router-&gt;get('/', function () &#123; return $router-&gt;app-&gt;version(); &#125;);&#125;);// 自定义速率是2请求/分钟$router-&gt;group(['prefix' =&gt; 'home', 'middleware'=&gt;'throttle:2,1'], function () use ($router) &#123; $router-&gt;get('/', function () &#123; return $router-&gt;app-&gt;version(); &#125;);&#125;);","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"lumen","slug":"lumen","permalink":"https://hdj.me/tags/lumen/"},{"name":"throttle","slug":"throttle","permalink":"https://hdj.me/tags/throttle/"}]},{"title":"让Lumen支持Session","slug":"lumen-support-session","date":"2018-06-08T12:39:36.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"lumen-support-session/","link":"","permalink":"https://hdj.me/lumen-support-session/","excerpt":"官方介绍 Lumen 虽然与 Laravel 使用了相同的底层类库实现，但是因 Lumen 面向的是无状态 API 的开发，不支持 session，所以默认的配置不同。Lumen 必须使用无状态的机制来实现，如 API 令牌（Token）。 也就是说Lumen内核已经剥离了Cookie、Session，如果需要使用到，需要增加安装，经过一阵折腾，终于整好了，顺便记录下来。","text":"官方介绍 Lumen 虽然与 Laravel 使用了相同的底层类库实现，但是因 Lumen 面向的是无状态 API 的开发，不支持 session，所以默认的配置不同。Lumen 必须使用无状态的机制来实现，如 API 令牌（Token）。 也就是说Lumen内核已经剥离了Cookie、Session，如果需要使用到，需要增加安装，经过一阵折腾，终于整好了，顺便记录下来。 增加session配置12345678910111213141516return [ 'driver' =&gt; 'file', 'lifetime' =&gt; 120, 'expire_on_close' =&gt; false, 'encrypt' =&gt; false, 'files' =&gt; storage_path('framework/sessions'), 'connection' =&gt; 'session', 'table' =&gt; 'sessions_laravel', 'store' =&gt; null, 'lottery' =&gt; [2, 100], 'cookie' =&gt; 'PHPSESSID', 'path' =&gt; '/', 'domain' =&gt; env('SESSION_DOMAIN', null), 'secure' =&gt; false, 'http_only' =&gt; true,]; 注册Session中间件及服务提供者 修改bootstrap/app.php，增加以下内容 12345678910// 注册Session中间件$app-&gt;middleware([ \\Illuminate\\Session\\Middleware\\StartSession::class,]);// 注册Session服务提供者$app-&gt;register(Illuminate\\Session\\SessionServiceProvider::class);// 加载Session配置$app-&gt;configure('session');// 注册容器（Lumen取消默认支持）$app-&gt;bind('Illuminate\\Session\\SessionManager', 'session'); 测试编辑routes/web.php 12345678$router-&gt;get('/', function () &#123; $key = 'key'; if (app('session')-&gt;has($key)) &#123; return app('session')-&gt;get($key); &#125; app('session')-&gt;put($key, 'value'); return 'set session success';&#125;); 生命的意义在于折腾！","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"lumen","slug":"lumen","permalink":"https://hdj.me/tags/lumen/"},{"name":"session","slug":"session","permalink":"https://hdj.me/tags/session/"}]},{"title":"让Lumen支持Cookie","slug":"lumen-support-cookie","date":"2018-06-08T09:32:59.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"lumen-support-cookie/","link":"","permalink":"https://hdj.me/lumen-support-cookie/","excerpt":"官方介绍 Lumen 虽然与 Laravel 使用了相同的底层类库实现，但是因 Lumen 面向的是无状态 API 的开发，不支持 session，所以默认的配置不同。Lumen 必须使用无状态的机制来实现，如 API 令牌（Token）。 也就是说Lumen内核已经剥离了Cookie、Session，如果需要使用到，需要增加安装，经过一阵折腾，终于整好了，顺便记录下来。","text":"官方介绍 Lumen 虽然与 Laravel 使用了相同的底层类库实现，但是因 Lumen 面向的是无状态 API 的开发，不支持 session，所以默认的配置不同。Lumen 必须使用无状态的机制来实现，如 API 令牌（Token）。 也就是说Lumen内核已经剥离了Cookie、Session，如果需要使用到，需要增加安装，经过一阵折腾，终于整好了，顺便记录下来。 安装Cookie服务提供者1composer require illuminate/cookie 增加session配置12345678910111213141516return [ 'driver' =&gt; 'file', 'lifetime' =&gt; 120, 'expire_on_close' =&gt; false, 'encrypt' =&gt; false, 'files' =&gt; storage_path('framework/sessions'), 'connection' =&gt; 'session', 'table' =&gt; 'sessions_laravel', 'store' =&gt; null, 'lottery' =&gt; [2, 100], 'cookie' =&gt; 'PHPSESSID', 'path' =&gt; '/', 'domain' =&gt; env('SESSION_DOMAIN', null), 'secure' =&gt; false, 'http_only' =&gt; true,]; 注册Cookie服务提供者 修改bootstrap/app.php，增加以下内容 1234// 注册Cookie服务提供者$app-&gt;register(Illuminate\\Cookie\\CookieServiceProvider::class);// 加载session配置$app-&gt;configure('session'); 测试编辑routes/web.php 123456use Illuminate\\Support\\Facades\\Cookie;$router-&gt;get('/', function () use ($router) &#123; return response($router-&gt;app-&gt;version()) -&gt;withCookie(Cookie::make('cookie_key', 'cookie_value'));&#125;); 生命的意义在于折腾！","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"lumen","slug":"lumen","permalink":"https://hdj.me/tags/lumen/"},{"name":"cookie","slug":"cookie","permalink":"https://hdj.me/tags/cookie/"},{"name":"composer","slug":"composer","permalink":"https://hdj.me/tags/composer/"}]},{"title":"Sphinx Ranking Mode(排序模式)","slug":"sphinx-ranking-mode","date":"2018-05-31T10:59:11.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"sphinx-ranking-mode/","link":"","permalink":"https://hdj.me/sphinx-ranking-mode/","excerpt":"Ranking overview(概览) Ranking (aka weighting) of the search results can be defined as a process of computing a so-called relevance (aka weight) for every given matched document with regards to a given query that matched it. So relevance is in the end just a number attached to every document that estimates how relevant the document is to the query. Search results can then be sorted based on this number and/or some additional parameters, so that the most sought after results would come up higher on the results page. 排序(又名加权)，是基于请求匹配到的结果，计算所谓的相关性(又名权重)的一个程序。 相关性是请求结束后被附加在文档结果中的一个估算出来的数值,表示匹配的文档于请求的关键词相关的程度，然后搜索的结果就能基于这个数值和其他的一些附加的参数进行排序，这样大多数相关的结果就能排在前面。","text":"Ranking overview(概览) Ranking (aka weighting) of the search results can be defined as a process of computing a so-called relevance (aka weight) for every given matched document with regards to a given query that matched it. So relevance is in the end just a number attached to every document that estimates how relevant the document is to the query. Search results can then be sorted based on this number and/or some additional parameters, so that the most sought after results would come up higher on the results page. 排序(又名加权)，是基于请求匹配到的结果，计算所谓的相关性(又名权重)的一个程序。 相关性是请求结束后被附加在文档结果中的一个估算出来的数值,表示匹配的文档于请求的关键词相关的程度，然后搜索的结果就能基于这个数值和其他的一些附加的参数进行排序，这样大多数相关的结果就能排在前面。 There is no single standard one-size-fits-all way to rank any document in any scenario. Moreover, there can not ever be such a way, because relevance is subjective. As in, what seems relevant to you might not seem relevant to me. Hence, in general case it’s not just hard to compute, it’s theoretically impossible. 对排序来说，在任何场景中都没有适应所有的情况的标准，甚至可以说不可能有这种标准，因为相关性是一种很主观的东西，比如，对你来说相关性很强，对我来说却没有。因而一般很难去计算，理论上是不可能的。 So ranking in Sphinx is configurable. It has a of a so-called . A ranker can formally be defined as a function that takes document and query as its input and produces a relevance value as output. In layman’s terms, a ranker controls exactly how (using which specific algorithm) will Sphinx assign weights to the document. 在sphinx中， 排序其实是可配置的， 他有一个叫ranker(这里我翻译成排序器)的概念， 根据定义的方法， 把匹配的文档和请求作为输入，输出来一个相关性的值。 简而言之， 一个ranker可以精确的给每个文档计算出相关性的值。 Previously, this ranking function was rigidly bound to the matching So in the legacy matching modes (that is, SPH_MATCH_ALL, SPH_MATCH_ANY, SPH_MATCH_PHRASE, and SPH_MATCH_BOOLEAN) you can not choose the ranker. You can only do that in the SPH_MATCH_EXTENDED (Which is the only mode in SphinxQL and the suggested mode in SphinxAPI anyway.) To choose a non-default ranker you can either use SetRankingMode() with SphinxAPI, or OPTION ranker clause in SELECTstatement when using SphinxQL. 以前，相排序方法被硬性的于匹配模式绑定在一起， 所以在一些老的匹配模式中(比如 SPH_MATCH_ALL, SPH_MATCH_ANY, SPH_MATCH_PHRASE, and SPH_MATCH_BOOLEAN)， 你不能选择ranker(排序器)。你只能在SPH_MATCH_EXTENDED(这也是在sphinxsql和sphinxApi中被建议使用的唯一的一种模式)模式下选择。 如何选择一个非默认的ranker(排序器)，在SphinxApi中使用SetRankingMode()方法，在SphinxQL中设置ranker选项 As a sidenote, legacy matching modes are internally implemented via the unified syntax anyway. When you use one of those modes, Sphinx just internally adjusts the query and sets the associated ranker, then executes the query using the very same unified code path. 注意，老的匹配模式被内置了统一的语法，当你使用这些模式的时候，sphinx仅仅内部判断请求和设置相应的ranker,然后使用相同的代码路径去执行这些请求。 Available built-in rankers(内置的ranker) Sphinx ships with a number of built-in rankers suited for different A number of them uses two factors, phrase proximity (aka LCS) and BM25. Phrase proximity works on the keyword positions, while BM25 works on the keyword frequencies. Basically, the better the degree of the phrase match between the document body and the query, the higher is the phrase proximity (it maxes out when the document contains the entire query as a verbatim quote). And BM25 is higher when the document contains more rare words. We’ll save the detailed discussion for later. Sphinx 内置了一系列的ranker， 用于不同的目的。他们中都是基于两个因素， phrase proximity(又名LCS)和BM25， Phrase proximity用于表示关键字与关键字的位置有关， BM25于关键词的出现的频率有关。基本上， 请求与匹配的文档越接近， phrase proximity就越高(当文档完整的包含整个请求的关键字时最高)。当文档中包含的关键词越多，BM25就越高。我们稍候讨论这些细节 Currently implemented rankers are: 当前内置的ranker有： SPH_RANK_PROXIMITY_BM25, the default ranking mode that uses and combines both phrase proximity and BM25 ranking. SPH_RANK_PROXIMITY_BM25, 默认的ranker,基于hrase proximity and BM25 ranking两个因素 SPH_RANK_BM25, statistical ranking mode which uses BM25 ranking only (similar to most other full-text engines). This mode is faster but may result in worse quality on queries which contain more than 1 keyword. SPH_RANK_BM25， 当仅仅使用BM25这种排序因素的时候的模式(于大多数其他的全文引擎相似)，这种模式虽然快，但结果的质量不高，很多结果包含的关键词不止一个(即关键字越多，分值越高，但很多时候我们最想要的仅仅是一个完全命中的结果) SPH_RANK_NONE, no ranking mode. This mode is obviously the fastest. A weight of 1 is assigned to all matches. This is sometimes called boolean searching that just matches the documents but does not rank them. SPH_RANK_NONE 没有任何排序模式的模式，这种模式很明显最快， 所有匹配的文档的权重都是1， 有时候被成为布尔搜索，这种搜索仅仅搜索文档，但不会排序 SPH_RANK_WORDCOUNT, ranking by the keyword occurrences count. This computes the per-field keyword occurrence counts, then multiplies them by field weights, and sums the resulting values. SPH_RANK_WORDCOUNT 根据关键字出现的次数排序，这种排序方式的计算是基于每个字段的关键字出现的次数，然后整合这些字段的权重得出的结果。 SPH_RANK_PROXIMITY, added in version 0.9.9-rc1, returns raw phrase proximity value as a result. This mode is internally used to emulate SPH_MATCH_ALL queries. SPH_RANK_PROXIMITY， 这种排序返回的是每个文档于请求的相似程度，这种模式被内置用来在SPH_MATCH_ALL匹配模式的时候排序 SPH_RANK_MATCHANY, added in version 0.9.9-rc1, returns rank as it was computed in SPH_MATCH_ANY mode earlier, and is internally used to emulate SPH_MATCH_ANY queries. SPH_RANK_MATCHANY， 早期的时候在SPH_MATCH_ANY匹配模式中使用， 返回相关值，在SPH_MATCH_ANY模式中内置的就是这种排序模式 SPH_RANK_FIELDMASK, added in version 0.9.9-rc2, returns a 32-bit mask with N-th bit corresponding to N-th fulltext field, numbering from 0. The bit will only be set when the respective field has any keyword occurrences satisfying the query. SPH_RANK_FIELDMASK 返回一个32位的掩码， 每个位都对应一个相应的全文字段(不能应该要补零)， 从0开始， 只有当相应的字段有关键字出现的时候才会被置1 SPH_RANK_SPH04, added in version 1.10-beta, is generally based on the default SPH_RANK_PROXIMITY_BM25 ranker, but additionally boosts the matches when they occur in the very beginning or the very end of a text field. Thus, if a field equals the exact query, SPH04 should rank it higher than a field that contains the exact query but is not equal to it. (For instance, when the query is “Hyde Park”, a document entitled “Hyde Park” should be ranked higher than a one entitled “Hyde Park, London” or “The Hyde Park Cafe”.) SPH_RANK_SPH04， 基于默认的SPH_RANK_PROXIMITY_BM25模式， 但假如匹配的文档的开头或者结尾出现了，那么这个文档的相关值就会提升，所以，如果某个文档的一个字段完全于请求的关键字一致， 那么这种模式下的排序的位置就应该比文档中包含请求关键字的文档高。(比如，如果请求的关键字是”Hyde Park”, “Hyde Park”的文档就会比”Hyde Park, London”或者”The Hyde Park Cafe”的排序高) SPH_RANK_EXPR, added in version 2.0.2-beta, lets you specify the ranking formula in run time. It exposes a number of internal text factors and lets you define how the final weight should be computed from those factors. SPH_RANK_EXPR 这种模式让你能在运行的时候指定排序规则， 他暴露了一系列的内置的文本的因素， 让你能基于这些因素计算出最终的权重 You should specify the SPH_RANK_ prefix and use capital letters only when using the SetRankingMode() call from the SphinxAPI. The API ports expose these as global constants. Using SphinxQL syntax, the prefix should be omitted and the ranker name is case insensitive. 你可以指定一个SPH_RANK_为前缀的排序模式，要全部大写。在SphinxAPI中使用SetRankingMode()方法，这个API中定义了这些模式的全局常量。 在SphinxQL中， 这个前缀要被映射，且ranker的名称是大小写敏感的(就是要指定ranker模式的参数选项) Example （例子）12345// SphinxAPI$client-&gt;SetRankingMode ( SPH_RANK_SPH04 );// SphinxQLmysql_query ( \"SELECT ... OPTION ranker=sph04\" );","categories":[{"name":"数据库","slug":"db","permalink":"https://hdj.me/categories/db/"}],"tags":[{"name":"sphinx","slug":"sphinx","permalink":"https://hdj.me/tags/sphinx/"}]},{"title":"MySQL Connection using old authentication protocol refused","slug":"mysql-connect-connection-using-old-authentication-protocol-refused","date":"2018-05-17T18:24:40.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"mysql-connect-connection-using-old-authentication-protocol-refused/","link":"","permalink":"https://hdj.me/mysql-connect-connection-using-old-authentication-protocol-refused/","excerpt":"有一台mysql升级到5.6版本，结果连接一些低版本的mysql服务器报出如下异常： Warning: mysql_connect(): Connection using old (pre-4.1.1) authentication protocol refused (client option ‘secure_auth’ enabled) 异常原因在于服务器端的密码管理协议陈旧，使用的是旧有的用户密码格式存储；但是客户端升级之后采用了新的密码格式。mysql5.6版本遇到这种不一致的情况就会拒绝连接。","text":"有一台mysql升级到5.6版本，结果连接一些低版本的mysql服务器报出如下异常： Warning: mysql_connect(): Connection using old (pre-4.1.1) authentication protocol refused (client option ‘secure_auth’ enabled) 异常原因在于服务器端的密码管理协议陈旧，使用的是旧有的用户密码格式存储；但是客户端升级之后采用了新的密码格式。mysql5.6版本遇到这种不一致的情况就会拒绝连接。 详见mysql手册 Server Command Options 一节中 --secure-auth 选项的说明 解决方法有如下两种： 1、服务器端升级启用 secure_auth 选项；2、客户端连接时off掉 secure_auth ，即连接时加上 --secure_auth=off，如：mysql -p10.51.1.11 -P3308 -uroot --secure_auth=off对于方法二，使用在程序做相应 mysql 配置即可，以php为例，在 php.ini 中设置 secure_auth=off","categories":[{"name":"数据库","slug":"db","permalink":"https://hdj.me/categories/db/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://hdj.me/tags/mysql/"},{"name":"authentication","slug":"authentication","permalink":"https://hdj.me/tags/authentication/"}]},{"title":"使用 watch 帮你重复执行命令","slug":"repeat-the-command-using-watch","date":"2018-05-15T07:55:04.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"repeat-the-command-using-watch/","link":"","permalink":"https://hdj.me/repeat-the-command-using-watch/","excerpt":"有时候你需要不断的执行某个命令，追踪其输出产生的变化情况。你可能会写一个死循环来做这件事情：","text":"有时候你需要不断的执行某个命令，追踪其输出产生的变化情况。你可能会写一个死循环来做这件事情： 123456while :do clear commands sleep 1done 然而实际上linux中有一个 watch 命令能够帮你做这件事情。它会定期执行指定的程序并将结果全屏输出。 watch 的使用方法很简单，只需要 1watch 命令 就行了，这样 watch 命令会每隔两秒执行一次该该命令，并全屏输出执行结果。 从上图可以看出，第一行中的 Every 2.0s: 表示 watch 每隔2秒执行一次命令。后面的 date 为要执行的命令。再后面的 T520: Thu May 10 16:55:23 2018 是主机名以及执行命令的时间。 在下面，从第二行开始就是命令执行的时间了。 通过 -n INTERVAL 你也可以设置重复执行命令的间隔时间，比如我可以调整为每5秒中执行一次 date 命令 1watch -n 5 date 不仅如此,通过 -d 选项, watch 还能高亮显示两次输出中不同的部分，这个功能相当实用 1watch -d -n 1 date 除了高亮显示输出中改变的部分外，你也可以设置让 watch 发现结果有改变时退出循环执行，方法是使用 -g/--chgexit 选项 1watch -g free 默认情况下， watch 并不会关心命令的执行结果是否成功 但你可以让 watch 检测命令的返回值，当命令运行返回非0时发出蜂鸣(-b/–beep)或者直接退出(-e/–errexit)。 1watch -e wrong_commands 最后，若你希望 watch 只显示出命令的执行结果，而不要显示第一行的那些信息，那么可以使用 -t 选项关闭title的显示 1watch -t date","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://hdj.me/tags/linux/"},{"name":"watch","slug":"watch","permalink":"https://hdj.me/tags/watch/"}]},{"title":"PHP君子加密","slug":"php-code-protector","date":"2018-05-10T11:49:28.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"php-code-protector/","link":"","permalink":"https://hdj.me/php-code-protector/","excerpt":"因为Github Page没办法支持php代码运行，之前的PHP君子加密没办法直接运行了，把源码放出来，大家自己部署吧。","text":"因为Github Page没办法支持php代码运行，之前的PHP君子加密没办法直接运行了，把源码放出来，大家自己部署吧。 index.php源码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100&lt;?phpif($_SERVER['REQUEST_METHOD']=='POST')&#123; // 导入类 require 'PHPCodeProtector.class.php'; // 创建类 $pcp = new PHPCodeProtector; // 加载代码 $pcp-&gt;load($_POST['code']); // 设置版本信息 if($_POST['copyright_on'])&#123; $pcp-&gt;setCopyright($_POST['copyright']); &#125; // 设置过期时间 if($_POST['expire_on'])&#123; $pcp-&gt;setExpire(strtotime($_POST['expire']), $_POST['expire_msg']); &#125; // 设置允许IP if($_POST['allow_ip_on'])&#123; $pcp-&gt;setAllowIp($_POST['allow_ip'], $_POST['not_allow_ip_msg']); &#125; // 设置允许域名 if($_POST['allow_domain_on'])&#123; $pcp-&gt;setAllowDomain($_POST['allow_domain'], $_POST['not_allow_domain_msg']); &#125; // 保存至本地 if($_POST['render_on'])&#123; $pcp-&gt;render($_POST['render_name']); exit; &#125; // 输出加密后的代码 $code = $pcp-&gt;output();&#125;else&#123; $copyright = 'huangdijia@gmail.com'; $expire = date('Y-m-d', strtotime('+1 day')); $expire_msg = 'PHP代码已经过期'; $allow_ip = '127.0.0.1,192.168.1.1'; $not_allow_ip_msg = 'PHP代码不允许在此IP执行'; $allow_domain = 'localhost,www.hdj.me'; $not_allow_domain_msg = 'PHP代码不允许在此域名执行'; $render_name = 'pcp_'.time().'.php'; $code = &lt;&lt;&lt;CODE&lt;?php/* Class PHPCodeProtector *//* Version 1.0 *//* Author Deeka *//* Email huangdijia@gmail.com */echo phpinfo();?&gt;CODE;&#125;?&gt;&lt;!DOCTYPE HTML&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=\"utf-8\"&gt;&lt;title&gt;PHPCodeProtector&lt;/title&gt;&lt;style&gt;html,body, textarea&#123; font-size:13px;&#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;PHP代码保护&lt;/h1&gt;&lt;p&gt;版本：1.0&lt;/p&gt;&lt;div&gt;&lt;b&gt;已知BUG&lt;/b&gt;&lt;/div&gt;&lt;ul&gt; &lt;li&gt;常量会被转为字符串&lt;/li&gt;&lt;/ul&gt;&lt;form method=\"post\" action=\"?\"&gt; &lt;p&gt;请输入PHP代码：&lt;/p&gt; &lt;p&gt;&lt;textarea name=\"code\" style=\"width:590px;\" cols=\"30\" rows=\"20\"&gt;&lt;?php echo $code; ?&gt;&lt;/textarea&gt;&lt;/p&gt; &lt;p&gt; &lt;label&gt;&lt;input type=\"checkbox\" name=\"copyright_on\" &lt;?php echo $_POST['copyright_on']?'checked':''?&gt; /&gt; 版本信息：&lt;/label&gt; &lt;input type=\"text\" name=\"copyright\" value=\"&lt;?php echo $_POST['copyright']?$_POST['copyright']:$copyright; ?&gt;\" /&gt; &lt;/p&gt; &lt;p&gt; &lt;label&gt;&lt;input type=\"checkbox\" name=\"expire_on\" value=\"1\" &lt;?php echo $_POST['expire_on']?'checked':''?&gt; /&gt; 有 效 期：&lt;/label&gt; &lt;input type=\"text\" name=\"expire\" value=\"&lt;?php echo $_POST['expire']?$_POST['expire']:$expire;?&gt;\" /&gt; 提示：&lt;input type=\"text\" name=\"expire_msg\" size=\"40\" value=\"&lt;?php echo $_POST['expire_msg']?$_POST['expire_msg']:$expire_msg; ?&gt;\" /&gt; &lt;/p&gt; &lt;p&gt; &lt;label&gt;&lt;input type=\"checkbox\" name=\"allow_ip_on\" value=\"1\" &lt;?php echo $_POST['allow_ip_on']?'checked':''?&gt; /&gt; 允 许 IP：&lt;/label&gt; &lt;input type=\"text\" name=\"allow_ip\" value=\"&lt;?php echo $_POST['allow_ip']?$_POST['allow_ip']:$allow_ip;?&gt;\" /&gt; 提示：&lt;input type=\"text\" name=\"not_allow_ip_msg\" size=\"40\" value=\"&lt;?php echo $_POST['not_allow_ip_msg']?$_POST['not_allow_ip_msg']:$not_allow_ip_msg;?&gt;\" /&gt; &lt;/p&gt; &lt;p&gt; &lt;label&gt;&lt;input type=\"checkbox\" name=\"allow_domain_on\" value=\"1\" &lt;?php echo $_POST['allow_domain_on']?'checked':''?&gt; /&gt; 允许域名：&lt;/label&gt; &lt;input type=\"text\" name=\"allow_domain\" value=\"&lt;?php echo $_POST['allow_domain']?$_POST['allow_domain']:$allow_domain;?&gt;\" /&gt; 提示：&lt;input type=\"text\" name=\"not_allow_domain_msg\" size=\"40\" value=\"&lt;?php echo $_POST['not_allow_domain_msg']?$_POST['not_allow_domain_msg']:$not_allow_domain_msg;?&gt;\" /&gt; &lt;/p&gt; &lt;p&gt; &lt;label&gt;&lt;input type=\"checkbox\" name=\"render_on\" value=\"1\" /&gt; 保存为：&lt;/label&gt; &lt;input type=\"text\" name=\"render_name\" value=\"&lt;?php echo $_POST['render_name']?$_POST['render_name']:$render_name;?&gt;\" /&gt; &lt;/p&gt; &lt;p&gt; &lt;button type=\"submit\"&gt;提交&lt;/button&gt; &lt;/p&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt; PHPCodeProtector.class.php源码： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308&lt;?php// PHP源码加密类 v1.0class PHPCodeProtector&#123; private $expire = 0; private $expire_msg = 'PHPCode Expired!'; private $allow_ip; private $allow_domain; private $not_allow_ip_msg = 'PHPCode Not Allow Run On This Ip!'; private $not_allow_domain_msg = 'PHPCode Not Allow Run On This Domain!'; private $separator = ','; private $key = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'; private $comment; private $code; function __construct() &#123; // &#125; // 加载文件 public function load($code='', $isfile=0) &#123; if($isfile &amp;&amp; file_exists($code))&#123; $this-&gt;code = file_get_contents($code); &#125;else&#123; $this-&gt;code = $code; &#125; &#125; // 输出 public function output($highlight=0) &#123; $content = $this-&gt;_crypt($this-&gt;code); return $highlight ? highlight_string($content) : $content; &#125; // 另存为 public function render($filename='', $type=\"text/plain\", $expire=180) &#123; if(!$filename)&#123; $filename = 'pcp_'.time().'php'; &#125; // 加密后代码 $content = $this-&gt;output(); $length = strlen($content); //发送Http Header信息 开始下载 header(\"Pragma: public\"); header(\"Cache-control: max-age=\".$expire); //header('Cache-Control: no-store, no-cache, must-revalidate'); header(\"Expires: \" . gmdate(\"D, d M Y H:i:s\",time()+$expire) . \"GMT\"); header(\"Last-Modified: \" . gmdate(\"D, d M Y H:i:s\",time()) . \"GMT\"); header(\"Content-Disposition: attachment; filename=\".$filename); header(\"Content-Length: \".$length); header(\"Content-type: \".$type); header('Content-Encoding: none'); header(\"Content-Transfer-Encoding: binary\" ); echo $content; exit; &#125; // 保存 public function save($file='') &#123; $content = $this-&gt;output(); return file_put_contents($file, $content); &#125; // 版本注释 public function setCopyright($copyright='') &#123; if(!empty($copyright))&#123; $this-&gt;copyright = $copyright; &#125; &#125; // 设置超时 public function setExpire($expire=null, $expire_msg='PHPCode Expired!') &#123; if(!is_null($expire))&#123; $this-&gt;expire = $expire; &#125; if(!empty($expire_msg))&#123; $this-&gt;expire_msg = $expire_msg; &#125; &#125; // 设置允许IP public function setAllowIp($allow_ip='', $not_allow_ip_msg='PHPCode Not Allow Run On This Ip!') &#123; if(!empty($allow_ip))&#123; $this-&gt;allow_ip = $allow_ip; &#125; if(!empty($not_allow_ip_msg))&#123; $this-&gt;not_allow_ip_msg = $not_allow_ip_msg; &#125; &#125; // 设置允许域名 public function setAllowDomain($allow_domain='', $not_allow_domain_msg='PHPCode Not Allow Run On This Domain!') &#123; if(!empty($allow_domain))&#123; $this-&gt;allow_domain = $allow_domain; &#125; if(!empty($not_allow_domain_msg))&#123; $this-&gt;not_allow_domain_msg = $not_allow_domain_msg; &#125; &#125; // 设置密匙 public function setKey($key) &#123; $this-&gt;key = $key; &#125; // 获取随机密匙 private function _getRandKey() &#123; return str_shuffle($this-&gt;key); &#125; // 加密 private function _crypt($php_code='') &#123; // 随机密匙1 $rand_key1 = $this-&gt;_getRandKey(); // 随机密匙2 $rand_key2 = $this-&gt;_getRandKey(); // 加入时间限制 if($this-&gt;expire &gt; 0)&#123; $verify_code .= 'if(time() &gt; '.$this-&gt;expire.') die(\\''.$this-&gt;expire_msg.'\\');'; &#125; // 加入IP限制 $allow_ips = explode($this-&gt;separator, $this-&gt;allow_ip); $allow_ips = array_filter($allow_ips); if(is_array($allow_ips) &amp;&amp; !empty($allow_ips))&#123; $verify_code .= 'if(!in_array($_SERVER[\"SERVER_ADDR\"], '.str_replace(\"\\n\", '', var_export($allow_ips, true)).')) die(\\''.$this-&gt;not_allow_ip_msg.'\\');'; &#125; // 加入域名限制 $allow_domains = explode($this-&gt;separator, $this-&gt;allow_domain); $allow_domains = array_filter($allow_domains); if(is_array($allow_domains) &amp;&amp; !empty($allow_domains))&#123; $verify_code .= 'if(!in_array($_SERVER[\"HTTP_HOST\"], '.str_replace(\"\\n\", '', var_export($allow_domains, true)).')) die(\\''.$this-&gt;not_allow_domain_msg.'\\');'; &#125; // 验证信息 $verify_code = $verify_code ? '&lt;?php ' . $verify_code . '?&gt;' : ''; // PHP源码 $php_code = $verify_code.$php_code; // 代码压缩 $php_code = $this-&gt;_compressPhpSrc($php_code); // base64加密 $base64_str = base64_encode($php_code); // 根据密匙替换对应字符 $c = strtr($base64_str, $rand_key1, $rand_key2); $c = $rand_key1.$rand_key2.$c; $q1 = \"O00O0O\"; $q2 = \"O0O000\"; $q3 = \"O0OO00\"; $q4 = \"OO0O00\"; $q5 = \"OO0000\"; $q6 = \"O00OO0\"; $s = '$'.$q6.'=urldecode(\"%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A\");$' .$q1.'=$'.$q6.'&#123;3&#125;.$'.$q6.'&#123;6&#125;.$'.$q6.'&#123;33&#125;.$'.$q6.'&#123;30&#125;;$' .$q3.'=$'.$q6.'&#123;33&#125;.$'.$q6.'&#123;10&#125;.$'.$q6.'&#123;24&#125;.$'.$q6.'&#123;10&#125;.$'.$q6.'&#123;24&#125;;$' .$q4.'=$'.$q3.'&#123;0&#125;.$'.$q6.'&#123;18&#125;.$'.$q6.'&#123;3&#125;.$'.$q3.'&#123;0&#125;.$'.$q3.'&#123;1&#125;.$'.$q6.'&#123;24&#125;;$' .$q5.'=$'.$q6.'&#123;7&#125;.$'.$q6.'&#123;13&#125;;$' .$q1.'.=$'.$q6.'&#123;22&#125;.$'.$q6.'&#123;36&#125;.$'.$q6.'&#123;29&#125;.$'.$q6.'&#123;26&#125;.$'.$q6.'&#123;30&#125;.$'.$q6.'&#123;32&#125;.$'.$q6.'&#123;35&#125;.$'.$q6.'&#123;26&#125;.$'.$q6.'&#123;30&#125;;eval($' .$q1.'(\"'.base64_encode('$'.$q2.'=\"'.$c.'\";eval(\\'?&gt;\\'.$'.$q1.'($'.$q3.'($'.$q4.'($'.$q2.',$'.$q5.'*2),$'.$q4.'($'.$q2.',$'.$q5.',$'.$q5.'),$'.$q4.'($'.$q2.',0,$'.$q5.'))));').'\"));'; $code = '&lt;?php '; if(!empty($this-&gt;copyright))&#123; $code .= '/* '.$this-&gt;copyright.' */ '; &#125; $code .= $s; // 返回 return $code; &#125; // PHP代码压缩 function _compressPhpSrc($src) &#123; // Whitespaces left and right from this signs can be ignored static $IW = array( T_CONCAT_EQUAL, // .= T_DOUBLE_ARROW, // =&gt; T_BOOLEAN_AND, // &amp;&amp; T_BOOLEAN_OR, // || T_IS_EQUAL, // == T_IS_NOT_EQUAL, // != or &lt;&gt; T_IS_SMALLER_OR_EQUAL, // &lt;= T_IS_GREATER_OR_EQUAL, // &gt;= T_INC, // ++ T_DEC, // -- T_PLUS_EQUAL, // += T_MINUS_EQUAL, // -= T_MUL_EQUAL, // *= T_DIV_EQUAL, // /= T_IS_IDENTICAL, // === T_IS_NOT_IDENTICAL, // !== T_DOUBLE_COLON, // :: T_PAAMAYIM_NEKUDOTAYIM, // :: T_OBJECT_OPERATOR, // -&gt; T_DOLLAR_OPEN_CURLY_BRACES, // $&#123; T_AND_EQUAL, // &amp;= T_MOD_EQUAL, // %= T_XOR_EQUAL, // ^= T_OR_EQUAL, // |= T_SL, // &lt;&lt; T_SR, // &gt;&gt; T_SL_EQUAL, // &lt;&lt;= T_SR_EQUAL, // &gt;&gt;= ); $tokens = token_get_all($src); $new = \"\"; $c = sizeof($tokens); $iw = false; // ignore whitespace $ih = false; // in HEREDOC $ls = \"\"; // last sign $ot = null; // open tag for($i = 0; $i &lt; $c; $i++) &#123; $token = $tokens[$i]; if(is_array($token)) &#123; list($tn, $ts) = $token; // tokens: number, string, line $tname = token_name($tn); if($tn == T_INLINE_HTML) &#123; $new .= $ts; $iw = false; &#125; else &#123; if($tn == T_OPEN_TAG) &#123; if(strpos($ts, \" \") || strpos($ts, \"\\n\") || strpos($ts, \"\\t\") || strpos($ts, \"\\r\")) &#123; $ts = rtrim($ts); &#125; $ts .= \" \"; $new .= $ts; $ot = T_OPEN_TAG; $iw = true; &#125; elseif($tn == T_OPEN_TAG_WITH_ECHO) &#123; $new .= $ts; $ot = T_OPEN_TAG_WITH_ECHO; $iw = true; &#125; elseif($tn == T_CLOSE_TAG) &#123; if($ot == T_OPEN_TAG_WITH_ECHO) &#123; $new = rtrim($new, \"; \"); &#125; else &#123; $ts = \" \".$ts; &#125; $new .= $ts; $ot = null; $iw = false; &#125; elseif(in_array($tn, $IW)) &#123; $new .= $ts; $iw = true; &#125; elseif($tn == T_CONSTANT_ENCAPSED_STRING || $tn == T_ENCAPSED_AND_WHITESPACE) &#123; if($ts[0] == '\"') &#123; $ts = addcslashes($ts, \"\\n\\t\\r\"); &#125; $new .= $ts; $iw = true; &#125; elseif($tn == T_WHITESPACE) &#123; $nt = @$tokens[$i+1]; if(!$iw &amp;&amp; (!is_string($nt) || $nt == '$') &amp;&amp; !in_array($nt[0], $IW)) &#123; $new .= \" \"; &#125; $iw = false; &#125; elseif($tn == T_START_HEREDOC) &#123; $new .= \"&lt;&lt;&lt;S\\n\"; $iw = false; $ih = true; // in HEREDOC &#125; elseif($tn == T_END_HEREDOC) &#123; $new .= \"S;\"; $iw = true; $ih = false; // in HEREDOC for($j = $i+1; $j &lt; $c; $j++) &#123; if(is_string($tokens[$j]) &amp;&amp; $tokens[$j] == \";\") &#123; $i = $j; break; &#125; else if($tokens[$j][0] == T_CLOSE_TAG) &#123; break; &#125; &#125; &#125; elseif($tn == T_COMMENT || $tn == T_DOC_COMMENT) &#123; $iw = true; &#125; else &#123; if(!$ih) &#123; $ts = strtolower($ts); &#125; $new .= $ts; $iw = false; &#125; &#125; $ls = \"\"; &#125; else &#123; if(($token != \";\" &amp;&amp; $token != \":\") || $ls != $token) &#123; $new .= $token; $ls = $token; &#125; $iw = true; &#125; &#125; return $new; &#125;&#125;","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"加密","slug":"加密","permalink":"https://hdj.me/tags/加密/"}]},{"title":"身份证号码验证的几个实用函数","slug":"cn-idcard-validate-function-in-javascript","date":"2017-08-14T17:39:39.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"cn-idcard-validate-function-in-javascript/","link":"","permalink":"https://hdj.me/cn-idcard-validate-function-in-javascript/","excerpt":"最近需要对身份证合法性进行验证，实名验证是不指望了，不过原来的验证规则太过简单，只是简单的验证了身份证长度，现在业务需要加强下身份证验证规则，网上找到了不少资料，不过都不合偶的心意，无奈只好直接写一个，代码还是用自己的舒服哈。","text":"最近需要对身份证合法性进行验证，实名验证是不指望了，不过原来的验证规则太过简单，只是简单的验证了身份证长度，现在业务需要加强下身份证验证规则，网上找到了不少资料，不过都不合偶的心意，无奈只好直接写一个，代码还是用自己的舒服哈。 身份证号码有效性验证JavaScript 代码: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869function isIDCard(idcard) &#123; idcard = idcard.toUpperCase(); // 对身份证号码做处理 var ereg; var Y, JYM; var S, M; /*基本校验*/ //if (String.isNullOrEmpty(idcard)) return false; var idcard_array = new Array(); idcard_array = idcard.split(\"\"); /*身份号码位数及格式检验*/ switch (idcard.length) &#123; case 15: if ((parseInt(idcard.substr(6, 2)) + 1900) % 4 == 0 || ((parseInt(idcard.substr(6, 2)) + 1900) % 100 == 0 &amp;&amp; (parseInt(idcard.substr(6, 2)) + 1900) % 4 == 0)) &#123; ereg = /^[1-9][0-9]&#123;5&#125;[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))[0-9]&#123;3&#125;$/; //测试出生日期的合法性 &#125; else &#123; ereg = /^[1-9][0-9]&#123;5&#125;[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|1[0-9]|2[0-8]))[0-9]&#123;3&#125;$/; //测试出生日期的合法性 &#125; if (ereg.test(idcard)) &#123; return true; &#125; else &#123; return false; &#125; break; case 18: //18位身份号码检测 //出生日期的合法性检查 //闰年月日:((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9])) //平年月日:((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|1[0-9]|2[0-8])) if (parseInt(idcard.substr(6, 4)) % 4 == 0 || (parseInt(idcard.substr(6, 4)) % 100 == 0 &amp;&amp; parseInt(idcard.substr(6, 4)) % 4 == 0)) &#123; ereg = /^[1-9][0-9]&#123;5&#125;19[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))[0-9]&#123;3&#125;[0-9XxAa]$/; //闰年出生日期的合法性正则表达式 &#125; else &#123; ereg = /^[1-9][0-9]&#123;5&#125;19[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|1[0-9]|2[0-8]))[0-9]&#123;3&#125;[0-9XxAa]$/; //平年出生日期的合法性正则表达式 &#125; if (ereg.test(idcard)) &#123;//测试出生日期的合法性 //计算校验位 S = (parseInt(idcard_array[0]) + parseInt(idcard_array[10])) * 7 + (parseInt(idcard_array[1]) + parseInt(idcard_array[11])) * 9 + (parseInt(idcard_array[2]) + parseInt(idcard_array[12])) * 10 + (parseInt(idcard_array[3]) + parseInt(idcard_array[13])) * 5 + (parseInt(idcard_array[4]) + parseInt(idcard_array[14])) * 8 + (parseInt(idcard_array[5]) + parseInt(idcard_array[15])) * 4 + (parseInt(idcard_array[6]) + parseInt(idcard_array[16])) * 2 + parseInt(idcard_array[7]) * 1 + parseInt(idcard_array[8]) * 6 + parseInt(idcard_array[9]) * 3; Y = S % 11; M = \"F\"; JYM = \"10X98765432\"; M = JYM.substr(Y, 1); /*判断校验位*/ if (M == idcard_array[17]) &#123; /*检测ID的校验位false;*/ return true; &#125; else if (idcard_array[17] == 'A') &#123;//A结尾不校验规则 return true; /*检测ID的校验位false;*/ &#125; else &#123; return false; &#125; &#125; else &#123; return false; &#125; break; default: return false; &#125;&#125; 从身份证号码中获取相关信息，比如生日、省JavaScript 代码: 1234567891011121314151617181920212223function checkID(ID) &#123; if(typeof ID !== 'string') return '非法字符串'; var city = &#123;11:\"北京\",12:\"天津\",13:\"河北\",14:\"山西\",15:\"内蒙古\",21:\"辽宁\",22:\"吉林\",23:\"黑龙江 \",31:\"上海\",32:\"江苏\",33:\"浙江\",34:\"安徽\",35:\"福建\",36:\"江西\",37:\"山东\",41:\"河南\",42:\"湖北 \",43:\"湖南\",44:\"广东\",45:\"广西\",46:\"海南\",50:\"重庆\",51:\"四川\",52:\"贵州\",53:\"云南\",54:\"西藏 \",61:\"陕西\",62:\"甘肃\",63:\"青海\",64:\"宁夏\",65:\"新疆\",71:\"台湾\",81:\"香港\",82:\"澳门\",91:\"国外\"&#125;; var birthday = ID.substr(6, 4) + '/' + Number(ID.substr(10, 2)) + '/' + Number(ID.substr(12, 2)); var d = new Date(birthday); var newBirthday = d.getFullYear() + '/' + Number(d.getMonth() + 1) + '/' + Number(d.getDate()); var currentTime = new Date().getTime(); var time = d.getTime(); var arrInt = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2]; var arrCh = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2']; var sum = 0, i, residue; if(!/^\\d&#123;17&#125;(\\d|x)$/i.test(ID)) return '非法身份证'; if(city[ID.substr(0,2)] === undefined) return \"非法地区\"; if(time &gt;= currentTime || birthday !== newBirthday) return '非法生日'; for(i=0; i&lt;17; i++) &#123; sum += ID.substr(i, 1) * arrInt[i]; &#125; residue = arrCh[sum % 11]; if (residue !== ID.substr(17, 1)) return '非法身份证哦'; return city[ID.substr(0,2)]+\",\"+birthday+\",\"+(ID.substr(16,1)%2?\" 男\":\"女\")&#125; 验证香港身份证的格式或真实性JavaScript 代码: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647function IsHKID(str) &#123; var strValidChars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\" // basic check length if (str.length &lt; 8) return false; // handling bracket if (str.charAt(str.length-3) == '(' &amp;&amp; str.charAt(str.length-1) == ')') str = str.substring(0, str.length - 3) + str.charAt(str.length -2); // convert to upper case str = str.toUpperCase(); // regular expression to check pattern and split var hkidPat = /^([A-Z]&#123;1,2&#125;)([0-9]&#123;6&#125;)([A0-9])$/; var matchArray = str.match(hkidPat); // not match, return false if (matchArray == null) return false; // the character part, numeric part and check digit part var charPart = matchArray[1]; var numPart = matchArray[2]; var checkDigit = matchArray[3]; // calculate the checksum for character part var checkSum = 0; if (charPart.length == 2) &#123; checkSum += 9 * (10 + strValidChars.indexOf(charPart.charAt(0))); checkSum += 8 * (10 + strValidChars.indexOf(charPart.charAt(1))); &#125; else &#123; checkSum += 9 * 36; checkSum += 8 * (10 + strValidChars.indexOf(charPart)); &#125; // calculate the checksum for numeric part for (var i = 0, j = 7; i &lt; numPart.length; i++, j--) checkSum += j * numPart.charAt(i); // verify the check digit var remaining = checkSum % 11; var verify = remaining == 0 ? 0 : 11 - remaining; return verify == checkDigit || (verify == 10 &amp;&amp; checkDigit == 'A');&#125; 在网上找了很久都没合意的验证方式，最后通过Google找到一个国外写的js验证，发现可以使用。 上面那段验证的很精密，包含身份证真实性的校验，如果只是想验证输入的香港身份证格式，请使用下面的这段js。 JavaScript 代码: 1234567891011121314151617181920212223function IsHKID(str) &#123; var strValidChars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\" // basic check length if (str.length &lt; 8) return false; // handling bracket if (str.charAt(str.length-3) == '(' &amp;&amp; str.charAt(str.length-1) == ')') str = str.substring(0, str.length - 3) + str.charAt(str.length -2); // convert to upper case str = str.toUpperCase(); // regular expression to check pattern and split var hkidPat = /^([A-Z]&#123;1,2&#125;)([0-9]&#123;6&#125;)([A0-9])$/; var matchArray = str.match(hkidPat); // not match, return false if (matchArray == null) return false; return true; &#125; 港澳居民来往内地通行证号码目前好像没有好的办法验证，这里提供一个简单的正则： 1/^([A-Z]\\d&#123;6,10&#125;(\\(\\w&#123;1&#125;\\))?)$/ 最后这里提供一个验证中国，香港，台湾和韩国身份证的 JavaScript 库： 12Edditoria / valididA Javascript library to validate ID card numbers of China, Taiwan, Hong Kong and South Korea","categories":[{"name":"前端","slug":"frontend","permalink":"https://hdj.me/categories/frontend/"}],"tags":[{"name":"javascript","slug":"javascript","permalink":"https://hdj.me/tags/javascript/"},{"name":"idcard","slug":"idcard","permalink":"https://hdj.me/tags/idcard/"},{"name":"身份证","slug":"身份证","permalink":"https://hdj.me/tags/身份证/"}]},{"title":"解决PHP输出UTF-8编码的csv乱码问题","slug":"fix-utf8-in-csv","date":"2017-07-14T17:29:16.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"fix-utf8-in-csv/","link":"","permalink":"https://hdj.me/fix-utf8-in-csv/","excerpt":"众所周知，UTF-8已经一统天下了，但是微软office默认使用的还不是它，经常在使用程序生成CSV的时候总是看到的是乱码，其实office并非顽固分子，在早期版本已经增加了对UTF-8的支持，但是你要告诉他，你的数据是UTF-8。 怎么做呢？","text":"众所周知，UTF-8已经一统天下了，但是微软office默认使用的还不是它，经常在使用程序生成CSV的时候总是看到的是乱码，其实office并非顽固分子，在早期版本已经增加了对UTF-8的支持，但是你要告诉他，你的数据是UTF-8。 怎么做呢？ PHP处理方式123456// utf8$fp = fopen('./test_csv.csv', 'a');fwrite($fp,chr(0xEF).chr(0xBB).chr(0xBF));//输出BOM头fputcsv($fp, ['标题']);fputcsv($fp, ['解决乱码']);fclose($fp); 命令行处理方式123printf '\\xEF\\xBB\\xBF’ &gt; tmp.csvcat your.csv &gt;&gt; tmp.csvmv tmp.csv your.csv 你 get√ 到了吗？","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"utf-8","slug":"utf-8","permalink":"https://hdj.me/tags/utf-8/"},{"name":"csv","slug":"csv","permalink":"https://hdj.me/tags/csv/"}]},{"title":"实现自定义apk安装包","slug":"custom-apk-by-php-ziparchive","date":"2014-08-22T09:05:02.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"custom-apk-by-php-ziparchive/","link":"","permalink":"https://hdj.me/custom-apk-by-php-ziparchive/","excerpt":"需求： 突然收到老大的需求，要对产品进行一次推荐好友安装的活动，每个会员下载自己的专属安装包（里面记录会员的相关信息）。 思路： 经过了解，发现apk安装包原来只是zip的一个马甲，使用php的ZipArchive类可以对文件进行操作。","text":"需求： 突然收到老大的需求，要对产品进行一次推荐好友安装的活动，每个会员下载自己的专属安装包（里面记录会员的相关信息）。 思路： 经过了解，发现apk安装包原来只是zip的一个马甲，使用php的ZipArchive类可以对文件进行操作。 实现代码： 123456789101112131415161718192021222324// 源文件$apk = \"gb.apk\";// 生成临时文件$file = tempnam(\"tmp\", \"zip\");// 复制文件if(false===file_put_contents($file, file_get_contents($apk)))&#123; exit('copy faild!');&#125;// 打开临时文件$zip = new ZipArchive();$zip-&gt;open($file);// 添加文件// 由于apk限定只能修改此目录内的文件，否则会报无效apk包$zip-&gt;addFromString('META-INF/extends.json', json_encode(array('author'=&gt;'deeka')));// 关闭zip$zip-&gt;close();// 下载文件header(\"Content-Type: application/zip\");header(\"Content-Length: \" . filesize($file));header(\"Content-Disposition: attachment; filename=\\\"&#123;$apk&#125;\\\"\");// 输出二进制流readfile($file);// 删除临时文件unlink($file);","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"zip","slug":"zip","permalink":"https://hdj.me/tags/zip/"},{"name":"ziparchive","slug":"ziparchive","permalink":"https://hdj.me/tags/ziparchive/"},{"name":"apk","slug":"apk","permalink":"https://hdj.me/tags/apk/"}]},{"title":"防御性编程","slug":"defensive-programming","date":"2014-06-09T17:59:58.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"defensive-programming/","link":"","permalink":"https://hdj.me/defensive-programming/","excerpt":"在公司，我们碰到的很大一部分问题都是NullPointerException。我常常就想：这段程序明明在我电脑运行好好的，为什么会出现这种情况呢？因为，我们永远都无法预测用户使用时会发生的各种情况。所以防御性编程可以让我们减少很大一部分错误。","text":"在公司，我们碰到的很大一部分问题都是NullPointerException。我常常就想：这段程序明明在我电脑运行好好的，为什么会出现这种情况呢？因为，我们永远都无法预测用户使用时会发生的各种情况。所以防御性编程可以让我们减少很大一部分错误。 开始之前先看这段代码需求： 将字符串转换成一个数字，如”12345”(string)转为12345(int)。代码： 12345678function atoi($a)&#123; $len = strlen($a); $num = 0; for($i=$len-1; $i&gt;=0; $i--)&#123; $num += ($a&#123;$i&#125;-0) * pow(10, $len-$i-1); &#125; return $num;&#125; 问题： 如果传进来一个负数结果是什么？比如：”-123456”。 如果传进来一个null或false会怎么样？（php返回的结果都是0，貌似没错） 恍然大悟！！！太多东西没考虑！！！ 什么是防御性编程 顾名思义，防御性编程（Defensive programming）是一种细致、谨慎的编程方法。防御式编程主要用于可能被滥用，恶作剧或无意地造成灾难性影响的程序上。防御性编程是一种防卫方式，而不是一种补救形式。 如何写防御性代码呢看看这样会不会好一些？ 1234567891011function atoi($a)&#123; if(is_null($a)) throw new Exception('$a is null'); if(false===$a) throw new Exception('$a is false'); if(0==strlen($a)) throw new Exception('$a is empty string'); $len = strlen($a); $num = 0; for($i=$len-1; $i&gt;=0; $i--)&#123; $num += ($a&#123;$i&#125;-0) * pow(10, $len-$i-1); &#125; return $num;&#125; 重要的经验就是：当你写一个方法需要对传入的参数进行处理或者计算的时候，你必须要严格验证传入参数的正确性，如果不符合，就应当给出提示！防御性编程的最基本规则：保护程序免遭非法输入数据的破坏。 为什么要防御性编程 为了让你写的代码正确运行 提供参数错误的原因 可以快速找到 bug","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"编程","slug":"编程","permalink":"https://hdj.me/tags/编程/"}]},{"title":"nginx安全配置之白名单设置","slug":"nginx-config-white-list","date":"2014-01-06T13:16:46.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"nginx-config-white-list/","link":"","permalink":"https://hdj.me/nginx-config-white-list/","excerpt":"网站安全，防不胜防 你永远不知道黑客利用什么漏洞对你的网站进行攻击，最常见的手段是利用漏洞在你的网站留个后门，喜欢的时候来逛逛，比如玩你的服务器上传一个x.php，直接访问： 1http://www.example.com/a/b/c/d/a.php 然后就可以为所欲为了，那么有没有办法让黑客即使利用漏洞上传了php代码而没办法运行呢？答案是肯定的。 思路是从运行php的php-fpm着手，在nginx上做配置，客官请看配置。","text":"网站安全，防不胜防 你永远不知道黑客利用什么漏洞对你的网站进行攻击，最常见的手段是利用漏洞在你的网站留个后门，喜欢的时候来逛逛，比如玩你的服务器上传一个x.php，直接访问： 1http://www.example.com/a/b/c/d/a.php 然后就可以为所欲为了，那么有没有办法让黑客即使利用漏洞上传了php代码而没办法运行呢？答案是肯定的。 思路是从运行php的php-fpm着手，在nginx上做配置，客官请看配置。 123456789101112131415161718server &#123; listen 80; server_name www.example.com; root /home/htdocs/app/; index index.php; location / &#123; try_files $uri $uri/ /index.php?s=$uri; &#125; location ~ .*\\.php$ &#123; # 白名单配置，只允许/index.php、/api.php访问 if ($fastcgi_script_name !~* \"^/(index|api)\\.php$\") &#123; return 403; &#125; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; include fcgi.conf; &#125; &#125;","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"webserver","slug":"webserver","permalink":"https://hdj.me/tags/webserver/"}]},{"title":"修改配置nginx限制恶意爬虫频率","slug":"nginx-limit-req-to-limit-spider","date":"2013-05-14T13:25:18.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"nginx-limit-req-to-limit-spider/","link":"","permalink":"https://hdj.me/nginx-limit-req-to-limit-spider/","excerpt":"超过设置的限定频率，就会给spider一个503。上述配置详细解释请自行google下，具体的spider/bot名称请自定义。","text":"超过设置的限定频率，就会给spider一个503。上述配置详细解释请自行google下，具体的spider/bot名称请自定义。 1234567#全局配置limit_req_zone $anti_spider zone=anti_spider:10m rate=15r/m;#某个server中limit_req zone=anti_spider burst=30 nodelay;if ($http_user_agent ~* \"xxspider|xxbot\") &#123; set $anti_spider $http_user_agent;&#125;","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"爬虫","slug":"爬虫","permalink":"https://hdj.me/tags/爬虫/"},{"name":"robots","slug":"robots","permalink":"https://hdj.me/tags/robots/"}]},{"title":"利用反向代理批量实现https协议访问","slug":"use-nginx-proxy-for-muilt-https-setting","date":"2013-05-14T13:19:10.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"use-nginx-proxy-for-muilt-https-setting/","link":"","permalink":"https://hdj.me/use-nginx-proxy-for-muilt-https-setting/","excerpt":"最近有一个项目需求，需要为站点增加https访问。 开始只配置了www域名下的https，发现css和js都无法正常加载，原因是https页面，如果加载http协议的内容，会被认为页面不安全，尤其是IE，刷新一下页面就要弹出一次确认，相当烦人。 后来苦逼的把各个子域名都加入了https配置，nginx.conf里写各个子域名都写了一个443的server配置，每新增一个域名，还得copy一份，如果是修改一下站点的配置，还得改两次以上。","text":"最近有一个项目需求，需要为站点增加https访问。 开始只配置了www域名下的https，发现css和js都无法正常加载，原因是https页面，如果加载http协议的内容，会被认为页面不安全，尤其是IE，刷新一下页面就要弹出一次确认，相当烦人。 后来苦逼的把各个子域名都加入了https配置，nginx.conf里写各个子域名都写了一个443的server配置，每新增一个域名，还得copy一份，如果是修改一下站点的配置，还得改两次以上。 后来跟同事讨论，发现使用反向代理，可以快捷现实，配置如下： 123456789101112131415161718192021222324252627282930313233343536373839404142434445sever&#123; listen 80; sever_name www.hdj.me; root /home/webroot/www/; index index.php index.html; # ...&#125;sever&#123; listen 80; sever_name img.hdj.me; root /home/webroot/img/; index index.php index.html; # ...&#125;sever&#123; listen 80; sever_name static.hdj.me; root /home/webroot/static/; index index.php index.html; # ...&#125;sever&#123; listen 80; sever_name upload.hdj.me; root /home/webroot/upload/; index index.php index.html; # ...&#125;server &#123; listen 443; server_name www.hdj.me img.hdj.me static.hdj.me upload.hdj.me; ssl on; ssl_certificate /usr/local/nginx/conf/hdj.me.crt; ssl_certificate_key /usr/local/nginx/conf/hdj.me.key; location /&#123; proxy_pass http://127.0.0.1:80; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_set_header SSL '1'; proxy_redirect http:// https://; &#125;&#125; 这样配置好，访问： https://www.hdj.me/ https://img.hdj.me/ https://static.hdj.me/ https://upload.hdj.me/ 会被反向代理至： http://www.hdj.me/ http://img.hdj.me/ http://static.hdj.me/ http://upload.hdj.me/ 而不需要对各个域名都配置一个443的站点。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"https","slug":"https","permalink":"https://hdj.me/tags/https/"},{"name":"proxy","slug":"proxy","permalink":"https://hdj.me/tags/proxy/"}]},{"title":"nginx服务器防sql注入/溢出攻击/spam及禁User-agents","slug":"nginx-block-sqlinjections-and-deny-user-agents","date":"2013-05-04T13:27:10.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"nginx-block-sqlinjections-and-deny-user-agents/","link":"","permalink":"https://hdj.me/nginx-block-sqlinjections-and-deny-user-agents/","excerpt":"废话不说，直接上配置，客官请看","text":"废话不说，直接上配置，客官请看 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116server &#123; ## 禁SQL注入 Block SQL injections set $block_sql_injections 0; if ($query_string ~ \"union.*select.*\\(\") &#123; set $block_sql_injections 1; &#125; if ($query_string ~ \"union.*all.*select.*\") &#123; set $block_sql_injections 1; &#125; if ($query_string ~ \"concat.*\\(\") &#123; set $block_sql_injections 1; &#125; if ($block_sql_injections = 1) &#123; return 444; &#125; ## 禁掉文件注入 set $block_file_injections 0; if ($query_string ~ \"[a-zA-Z0-9_]=http://\") &#123; set $block_file_injections 1; &#125; if ($query_string ~ \"[a-zA-Z0-9_]=(\\.\\.//?)+\") &#123; set $block_file_injections 1; &#125; if ($query_string ~ \"[a-zA-Z0-9_]=/([a-z0-9_.]//?)+\") &#123; set $block_file_injections 1; &#125; if ($block_file_injections = 1) &#123; return 444; &#125; ## 禁掉溢出攻击 set $block_common_exploits 0; if ($query_string ~ \"(&lt;|%3C).*script.*(&gt;|%3E)\") &#123; set $block_common_exploits 1; &#125; if ($query_string ~ \"GLOBALS(=|\\[|\\%[0-9A-Z]&#123;0,2&#125;)\") &#123; set $block_common_exploits 1; &#125; if ($query_string ~ \"_REQUEST(=|\\[|\\%[0-9A-Z]&#123;0,2&#125;)\") &#123; set $block_common_exploits 1; &#125; if ($query_string ~ \"proc/self/environ\") &#123; set $block_common_exploits 1; &#125; if ($query_string ~ \"mosConfig_[a-zA-Z_]&#123;1,21&#125;(=|\\%3D)\") &#123; set $block_common_exploits 1; &#125; if ($query_string ~ \"base64_(en|de)code\\(.*\\)\") &#123; set $block_common_exploits 1; &#125; if ($block_common_exploits = 1) &#123; return 444; &#125; ## 禁spam字段 set $block_spam 0; if ($query_string ~ \"\\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\\b\") &#123; set $block_spam 1; &#125; if ($query_string ~ \"\\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\\b\") &#123; set $block_spam 1; &#125; if ($query_string ~ \"\\b(ambien|blue\\spill|cialis|cocaine|ejaculation|erectile)\\b\") &#123; set $block_spam 1; &#125; if ($query_string ~ \"\\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\\b\") &#123; set $block_spam 1; &#125; if ($block_spam = 1) &#123; return 444; &#125; ## 禁掉user-agents set $block_user_agents 0; # Don’t disable wget if you need it to run cron jobs! # if ($http_user_agent ~ \"Wget\") &#123; # set $block_user_agents 1; # &#125; # Disable Akeeba Remote Control 2.5 and earlier if ($http_user_agent ~ \"Indy Library\") &#123; set $block_user_agents 1; &#125; # Common bandwidth hoggers and hacking tools. if ($http_user_agent ~ \"libwww-perl\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"GetRight\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"GetWeb!\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"Go!Zilla\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"Download Demon\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"Go-Ahead-Got-It\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"TurnitinBot\") &#123; set $block_user_agents 1; &#125; if ($http_user_agent ~ \"GrabNet\") &#123; set $block_user_agents 1; &#125; if ($block_user_agents = 1) &#123; return 444; &#125;&#125; 说明： 防sql注入/溢出攻击/spam采用禁掉URL中包含的字段实现，请根据需要合理添加返回444,是完全不回应客户端，比403更加非常节省系统资源","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"sql","slug":"sql","permalink":"https://hdj.me/tags/sql/"},{"name":"注入","slug":"注入","permalink":"https://hdj.me/tags/注入/"},{"name":"spam","slug":"spam","permalink":"https://hdj.me/tags/spam/"},{"name":"user-agent","slug":"user-agent","permalink":"https://hdj.me/tags/user-agent/"},{"name":"溢出攻击","slug":"溢出攻击","permalink":"https://hdj.me/tags/溢出攻击/"}]},{"title":"未知的恐惧——NULL","slug":"null-in-mysql","date":"2013-04-27T18:16:32.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"null-in-mysql/","link":"","permalink":"https://hdj.me/null-in-mysql/","excerpt":"12345678910111213SELECT NULL = 0, NULL = 12345, NULL &lt;&gt; 12345, NULL + 12345, NULL || 'abc', NULL = NULL , NULL &lt;&gt; NULL , NULL AND TRUE , NULL AND FALSE , NULL OR FALSE , NULL OR TRUE , NOT (NULL); 如果这是一道面试题，估计不知道有多少程序员甚至是DBA会阵亡。","text":"12345678910111213SELECT NULL = 0, NULL = 12345, NULL &lt;&gt; 12345, NULL + 12345, NULL || 'abc', NULL = NULL , NULL &lt;&gt; NULL , NULL AND TRUE , NULL AND FALSE , NULL OR FALSE , NULL OR TRUE , NOT (NULL); 如果这是一道面试题，估计不知道有多少程序员甚至是DBA会阵亡。 正确的答案是什么？（为了加深印象，建议复制SQL到mysql里去执行，看一下） 下面跟大家分析一下原因： 那么在应用中如何避免NULL带来的一些困扰呢？ 把NULL当成一个特殊值，不等于空、0、FALSE，使用IS NULL/IS NOT NULL去检测 声明NOT NULL列，给于默认值","categories":[{"name":"数据库","slug":"db","permalink":"https://hdj.me/categories/db/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://hdj.me/tags/mysql/"},{"name":"null","slug":"null","permalink":"https://hdj.me/tags/null/"}]},{"title":"Linux下查看nginx，apache，mysql，php的编译参数","slug":"linux-check-nginx-apache-mysql-php-configure","date":"2012-12-13T13:32:02.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"linux-check-nginx-apache-mysql-php-configure/","link":"","permalink":"https://hdj.me/linux-check-nginx-apache-mysql-php-configure/","excerpt":"在升级软件版本的时候，如果没有文档，那是相当痛苦的事情，编译参数是什么？","text":"在升级软件版本的时候，如果没有文档，那是相当痛苦的事情，编译参数是什么？ 1、nginx编译参数： 1/usr/local/nginx/sbin/nginx -V 2、apache编译参数： 1cat /usr/local/apache/build/config.nice 3、php编译参数： 1/usr/local/php/bin/php -i |grep configure 4、mysql编译参数： 1cat /usr/local/mysql/bin/mysqlbug|grep configure","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"mysql","slug":"mysql","permalink":"https://hdj.me/tags/mysql/"},{"name":"apache","slug":"apache","permalink":"https://hdj.me/tags/apache/"},{"name":"configure","slug":"configure","permalink":"https://hdj.me/tags/configure/"},{"name":"linux","slug":"linux","permalink":"https://hdj.me/tags/linux/"}]},{"title":"内网机器的获取公网IP的方法","slug":"intranet-computer-get-internet-ip-by-php","date":"2012-12-13T13:09:27.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"intranet-computer-get-internet-ip-by-php/","link":"","permalink":"https://hdj.me/intranet-computer-get-internet-ip-by-php/","excerpt":"","text":"1234567function getClientIp()&#123; $socket = socket_create(AF_INET, SOCK_STREAM, 6); $ret = socket_connect($socket,'ns1.dnspod.net',6666); $buf = socket_read($socket, 16); socket_close($socket); return $buf;&#125; 缺点：依赖第三方，效率与网络状况有关。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"getclientip","slug":"getclientip","permalink":"https://hdj.me/tags/getclientip/"}]},{"title":"Nginx upstream的5种权重分配方式","slug":"five-ways-of-nginx-upstream","date":"2012-09-12T13:35:42.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"five-ways-of-nginx-upstream/","link":"","permalink":"https://hdj.me/five-ways-of-nginx-upstream/","excerpt":"1、轮询（默认） 每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。 2、weight指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。","text":"1、轮询（默认） 每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。 2、weight指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。 例如： 1234upstream backend &#123; server 192.168.0.14 weight=10; server 192.168.0.15 weight=10;&#125; 3、ip_hash每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。例如： 12345upstream backend &#123; ip_hash; server 192.168.0.14:88; server 192.168.0.15:80;&#125; 4、fair（第三方）按后端服务器的响应时间来分配请求，响应时间短的优先分配。 12345upstream backend &#123; server server1.linuxany.com; server server2.linuxany.com; fair;&#125; 5、url_hash（第三方） 按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。 例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法 123456upstream backend &#123; server squid1:3128; server squid2:3128; hash $request_uri; hash_method crc32;&#125; 定义负载均衡设备的Ip及设备状态 1234567upstream backend&#123; ip_hash; server 127.0.0.1:9090 down; server 127.0.0.1:8080 weight=2; server 127.0.0.1:6060; server 127.0.0.1:7070 backup;&#125; 在需要使用负载均衡的server中增加 proxy_pass http://bakend/; 每个设备的状态设置为: down 表示单前的server暂时不参与负载 weight 默认为1.weight越大，负载的权重就越大。 max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误 fail_timeout:max_fails次失败后，暂停的时间。 backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。 nginx支持同时设置多组的负载均衡，用来给不用的server来使用。 client_body_in_file_only 设置为On 可以讲client post过来的数据记录到文件中用来做debugclient_body_temp_path 设置记录文件的目录 可以设置最多3层目录 location 对URL进行匹配.可以进行重定向或者进行新的代理负载均衡","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"upstream","slug":"upstream","permalink":"https://hdj.me/tags/upstream/"},{"name":"weight","slug":"weight","permalink":"https://hdj.me/tags/weight/"}]},{"title":"preg_match正则匹配的字符串长度问题","slug":"strlen-of-preg-match","date":"2012-07-17T13:11:42.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"strlen-of-preg-match/","link":"","permalink":"https://hdj.me/strlen-of-preg-match/","excerpt":"项目中，用preg_match正则提取目标内容，死活有问题，代码测得死去活来。后来发现pcre.backtrack_limit的值默认只设了100000。","text":"项目中，用preg_match正则提取目标内容，死活有问题，代码测得死去活来。后来发现pcre.backtrack_limit的值默认只设了100000。 解决办法： 1ini_set(‘pcre.backtrack_limit’, 999999999); 注：这个参数在php 5.2.0版本之后可用。另外说说关于：pcre.recursion_limitpcre.recursion_limit是PCRE的递归限制，这个项如果设很大的值，会消耗所有进程的可用堆栈，最后导致PHP崩溃。也可以通过修改配置来限制： 1ini_set(‘pcre.recursion_limit’, 99999); 实际项目应用中，最好也对内存进行限定设置： 1ini_set(‘memory_limit’, ’64M’); 这样就比较稳妥妥嘎。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"正则","slug":"正则","permalink":"https://hdj.me/tags/正则/"},{"name":"regex","slug":"regex","permalink":"https://hdj.me/tags/regex/"}]},{"title":"Linux下测试硬盘读写速度","slug":"test-for-disk-rw-in-linux","date":"2012-03-16T13:40:15.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"test-for-disk-rw-in-linux/","link":"","permalink":"https://hdj.me/test-for-disk-rw-in-linux/","excerpt":"time有计时作用dd用于复制，从if读出，写到ofif=/dev/zero不产生IO，因此可以用来测试纯写速度。同理of=/dev/null不产生IO，可以用来测试纯读速度。bs是每次读或写的大小，即一个块的大小，count是读写块的数量。","text":"time有计时作用dd用于复制，从if读出，写到ofif=/dev/zero不产生IO，因此可以用来测试纯写速度。同理of=/dev/null不产生IO，可以用来测试纯读速度。bs是每次读或写的大小，即一个块的大小，count是读写块的数量。 1.测/目录所在磁盘的纯写速度：1time dd if=/dev/zero bs=1024 count=1000000 of=/1Gb.file 2.测/目录所在磁盘的纯读速度：1dd if=/kvm/ftp/other/1Gb.file bs=64k |dd of=/dev/null 3.测读写速度(这是什么)：1dd if=/vat/test of=/oradata/test1 bs=64k 理论上复制量越大测试越准确。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://hdj.me/tags/linux/"},{"name":"dd","slug":"dd","permalink":"https://hdj.me/tags/dd/"}]},{"title":"作品","slug":"cases","date":"2012-02-23T10:07:06.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"cases/","link":"","permalink":"https://hdj.me/cases/","excerpt":"从事IT10余年，做过大大小小的项目挺多的，有些已经下线了，整理为了有一天能回顾一下。","text":"从事IT10余年，做过大大小小的项目挺多的，有些已经下线了，整理为了有一天能回顾一下。 网站 超级巡警 千云科技 超级巡警网页版 鸡毛信 大成天下 \b小白软件 \b小白软件宝库 茂名广视网 宝物交易网TW 宝物交易网HK 100室内设计 项目 超级巡警企业版 国家信息安全工程 上海计算机安全项目 超级巡警云查杀服务 小白软件管家 数睿即时通讯中台 参与开源项目 ThinkPHP Larave 扩展包 Laravel Trigger Laravel Youdu Laravel Ipip Laravel Ssdb Laravel Accessyou Laravel Mxtong Laravel Mitake Laravel Smspro Laravel Twsms Laravel Icomet Laravel Gateway Worker 其他 wnmp集成环境 PHP君子加密 PHP抓取视频缩略图类VedioUrlParser(支持优酷、土豆、酷六、56、乐视、搜狐) jQuery插件jsConfirm-1.0 基于jQuery的input提示信息插件inputDefault 基于jQuery的无刷新上传插件iframeupload","categories":[],"tags":[]},{"title":"神奇的fastcgi_finish_request","slug":"fastcgi-finish-request","date":"2011-05-14T10:17:11.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"fastcgi-finish-request/","link":"","permalink":"https://hdj.me/fastcgi-finish-request/","excerpt":"当PHP运行在FastCGI模式时，PHP FPM提供了一个名为fastcgi_finish_request的方法。按照文档上的说法，此方法可以提高请求的处理速度，如果有些处理可以在页面生成完后再进行，就可以使用这个方法。","text":"当PHP运行在FastCGI模式时，PHP FPM提供了一个名为fastcgi_finish_request的方法。按照文档上的说法，此方法可以提高请求的处理速度，如果有些处理可以在页面生成完后再进行，就可以使用这个方法。 听起来可能有些茫然，我们通过几个例子来说明一下： 1234567echo '例子：';fastcgi_finish_request();echo 'To be, or not to be, that is the question.';file_put_contents('log.txt', '生存还是毁灭，这是个问题。'); 通过浏览器（不是命令行！）运行此脚本，结果发现并没有输出相应的字符串，但却生成了相应的文件。由此说明在调用fastcgi_finish_request后，客户端响应就已经结束，但与此同时服务端脚本却继续运行！ 合理利用这个特性可以大大提升用户体验，趁热打铁再来一个例子： 1234567891011echo '例子：';file_put_contents('log.txt', date('Y-m-d H:i:s') . \" 上传视频\\n\", FILE_APPEND);fastcgi_finish_request();sleep(1);file_put_contents('log.txt', date('Y-m-d H:i:s') . \" 转换格式\\n\", FILE_APPEND);sleep(1);file_put_contents('log.txt', date('Y-m-d H:i:s') . \" 提取图片\\n\", FILE_APPEND); 代码里用sleep模拟一些耗时的操作，浏览时没有被堵塞，程序却都执行了，具体看日志。 末了给您提个醒，Yahoo 在 Best Practices for Speeding Up Your Web Site 中提到了 Flush the Buffer Early，也就是利用PHP中的flush方法把内容尽快发到客户端去，虽然表面上它和本文介绍的fastcgi_finish_request有些许的类似，但本质上完全不同，别混淆了。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"php","slug":"php","permalink":"https://hdj.me/tags/php/"},{"name":"nginx","slug":"nginx","permalink":"https://hdj.me/tags/nginx/"},{"name":"fastcgi","slug":"fastcgi","permalink":"https://hdj.me/tags/fastcgi/"},{"name":"request","slug":"request","permalink":"https://hdj.me/tags/request/"}]},{"title":"服务器返回状态码详解","slug":"http-status-codes-images-desc","date":"2011-05-10T13:44:26.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"http-status-codes-images-desc/","link":"","permalink":"https://hdj.me/http-status-codes-images-desc/","excerpt":"以前只是看的枯燥的文字版的服务器返回状态码.现在，看一张比较形象的图解,希望能增强记忆.点击图片看大图.","text":"以前只是看的枯燥的文字版的服务器返回状态码.现在，看一张比较形象的图解,希望能增强记忆.点击图片看大图. 状态码 说明 400 请求无效 401.1 未授权：登录失败 401.2 未授权：服务器配置问题导致登录失败 401.3 ACL 禁止访问资源 401.4 未授权：授权被筛选器拒绝 401.5 未授权：ISAPI 或 CGI 授权失败 403 禁止访问 403 对 Internet 服务管理器 (HTML) 的访问仅限于 Localhost 403.1 禁止访问：禁止可执行访问 403.2 禁止访问：禁止读访问 403.3 禁止访问：禁止写访问 403.4 禁止访问：要求 SSL 403.5 禁止访问：要求 SSL 128 403.6 禁止访问：IP 地址被拒绝 403.7 禁止访问：要求客户证书 403.8 禁止访问：禁止站点访问 403.9 禁止访问：连接的用户过多 403.10 禁止访问：配置无效 403.11 禁止访问：密码更改 403.12 禁止访问：映射器拒绝访问 403.13 禁止访问：客户证书已被吊销 403.15 禁止访问：客户访问许可过多 403.16 禁止访问：客户证书不可信或者无效 403.17 禁止访问：客户证书已经到期或者尚未生效 404.1 无法找到 Web 站点 404 无法找到文件 405 资源被禁止 406 无法接受 407 要求代理身份验证 410 永远不可用 412 先决条件失败 414 请求-URI 太长 500 内部服务器错误 500.100 内部服务器错误-ASP 错误 500-11 服务器关闭 500-12 应用程序重新启动 500-13 服务器太忙 500-14 应用程序无效 500-15 不允许请求 global.asa 501 未实现 502 网关错误","categories":[{"name":"前端","slug":"frontend","permalink":"https://hdj.me/categories/frontend/"}],"tags":[{"name":"http","slug":"http","permalink":"https://hdj.me/tags/http/"},{"name":"status_code","slug":"status-code","permalink":"https://hdj.me/tags/status-code/"},{"name":"状态码","slug":"状态码","permalink":"https://hdj.me/tags/状态码/"},{"name":"服务器","slug":"服务器","permalink":"https://hdj.me/tags/服务器/"}]},{"title":"设置vim作为crontab -e的默认编辑器","slug":"set-vim-for-crontab-default-edito","date":"2011-03-15T13:52:47.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"set-vim-for-crontab-default-edito/","link":"","permalink":"https://hdj.me/set-vim-for-crontab-default-edito/","excerpt":"习惯了用vim修改crontab内容，可有些系统默认的是nano，用起来甚是痛苦，Google搜索了一下，找到下面方法：","text":"习惯了用vim修改crontab内容，可有些系统默认的是nano，用起来甚是痛苦，Google搜索了一下，找到下面方法： 1echo \"export EDITOR=/usr/bin/vim\" &gt;&gt; .bashrc 然后重新打开终端，输入 crontab -e，发现已经默认使用 vim 了。","categories":[{"name":"后端","slug":"backend","permalink":"https://hdj.me/categories/backend/"}],"tags":[{"name":"linux","slug":"linux","permalink":"https://hdj.me/tags/linux/"},{"name":"vim","slug":"vim","permalink":"https://hdj.me/tags/vim/"},{"name":"crontab","slug":"crontab","permalink":"https://hdj.me/tags/crontab/"}]},{"title":"关于","slug":"about","date":"2011-02-24T09:22:45.000Z","updated":"2024-12-03T10:58:04.732Z","comments":true,"path":"about/","link":"","permalink":"https://hdj.me/about/","excerpt":"网络ID 喵了个咪 游离不2 Deeka","text":"网络ID 喵了个咪 游离不2 Deeka 毕业院校 茂名学院（广东石油化工学院） 专业 计算机网络技术 技能语言 PHP Golang NodeJS Lua 数据库 MySQL NoSQL/MongoDB 缓存 Redis Memcached Ssdb 框架 Laravel/Lumen ThinkPHP JQuery/Vue 其他 服务器运维 K8S 关注我 GitHub Packages Twitter 联系我 Email：huangdijia@gmail.com","categories":[],"tags":[]}]}