<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>多 PHP 开发环境</title>
      <link href="/multi-php/"/>
      <url>/multi-php/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文适用于 M1 或更新版本 macOS 系统，Linux 可参考思路。</p></blockquote><h2 id="一、安装-homebrew"><a href="#一、安装-homebrew" class="headerlink" title="一、安装 homebrew"></a>一、安装 <code>homebrew</code></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"</span><br></pre></td></tr></table></figure><h2 id="二、安装-PHPs"><a href="#二、安装-PHPs" class="headerlink" title="二、安装 PHPs"></a>二、安装 PHPs</h2><ul><li>添加仓库源</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew tap shivammathur/php</span><br></pre></td></tr></table></figure><ul><li>安装指定版本 PHP，以 <code>7.4</code> 为例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install shivammathur/php/php@7.4</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="三、快速切换神器"><a href="#三、快速切换神器" class="headerlink" title="三、快速切换神器"></a>三、快速切换神器</h2><ul><li>脚本位置 <code>~/scripts/brew-php-switcher.sh</code>，<code>~/scripts</code>可按个人喜好调整</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">if [ -z "$1" ]; then</span><br><span class="line">    echo "Usage: brew-php-switcher &lt;version&gt;"</span><br><span class="line">    return 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">version=$1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测参数是否匹配 \d\.\d 格式</span></span><br><span class="line">if [[ $&#123;version&#125; =~ ^[0-9]\.[0-9]$ ]]; then</span><br><span class="line">    echo "";</span><br><span class="line">else</span><br><span class="line">    echo "参数&lt;version&gt;必须符合 \d\.\d 格式"</span><br><span class="line">    return 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">formula="php@$version"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检测参数是否在给定的值列表中</span></span><br><span class="line">case $&#123;version&#125; in</span><br><span class="line">    7.4|8.0|8.1|8.2|8.4)</span><br><span class="line">        ;;</span><br><span class="line">    8.3) # 默认版本</span><br><span class="line">        formula="php"</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo "参数&lt;version&gt;不在给定的值列表（7.4|8.0|8.1|8.2|8.3|8.4）中"</span><br><span class="line">        return 1</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">brew list --formula|grep -E "php(\d&#123;2&#125;|@\d\.\d)?$"|xargs brew unlink;</span><br><span class="line">brew link --overwrite --force $&#123;formula&#125; &amp;&amp; php -v</span><br></pre></td></tr></table></figure><ul><li><code>~/.bashrc</code> 或 <code>~/.zshrc</code> 添加以下脚本</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias brew-php-switcher="sh ~/scripts/brew-php-switcher.sh"</span><br></pre></td></tr></table></figure><ul><li>快速切换</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew-php-switcher 7.4</span><br></pre></td></tr></table></figure><h2 id="四、自动切换-PHP-版本"><a href="#四、自动切换-PHP-版本" class="headerlink" title="四、自动切换 PHP 版本"></a>四、自动切换 PHP 版本</h2><ul><li>同样在 <code>~/.bashrc</code> 或 <code>~/.zshrc</code> 添加以下脚本</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> auto dectect</span></span><br><span class="line">PROJECT_BASHRC=$(pwd)/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$PROJECT_BASHRC</span></span></span><br><span class="line">if [ -f $PROJECT_BASHRC ]; then</span><br><span class="line">    source $PROJECT_BASHRC</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><ul><li>.bashrc范本，以 PHP <code>7.4</code> 项目为例</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export PATH="/opt/homebrew/opt/php@7.4/bin:$PATH"</span><br><span class="line">export PATH="/opt/homebrew/opt/php@7.4/sbin:$PATH"</span><br><span class="line"></span><br><span class="line">alias artisan="php artisan"</span><br><span class="line">alias tinker="artisan tinker"</span><br></pre></td></tr></table></figure><blockquote><p>重启 IDE 即可，记得在项目中忽略 <code>.bashrc</code> 文件</p></blockquote><h2 id="五、Swoole-安装神器"><a href="#五、Swoole-安装神器" class="headerlink" title="五、Swoole 安装神器"></a>五、Swoole 安装神器</h2><ul><li>脚本位置 <code>~/scripts/swoole.sh</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取包名</span></span><br><span class="line">function _get_package() &#123;</span><br><span class="line">    local package="swoole"</span><br><span class="line"></span><br><span class="line">    if [ "$1" != "" ]; then</span><br><span class="line">        package="swoole-$1"</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo $package</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修复 pcre2 路径问题</span></span><br><span class="line">function _fix_pcre() &#123;</span><br><span class="line">    local php_home=$(php -i | grep -Eo "\-\-prefix=([^']*)" | awk -F '=' '&#123;print $2&#125;')</span><br><span class="line">    local pcre_home=$(brew --prefix pcre2)</span><br><span class="line"></span><br><span class="line">    local source="$&#123;pcre_home&#125;/include/pcre2.h"</span><br><span class="line">    local target="$&#123;php_home&#125;/include/php/ext/pcre/pcre2.h"</span><br><span class="line"></span><br><span class="line">    if [ ! -f $target ]; then</span><br><span class="line">        ln -s $source $target</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">function swoole_install() &#123;</span><br><span class="line"></span><br><span class="line">    _fix_pcre</span><br><span class="line"></span><br><span class="line">    local package=`_get_package $1`</span><br><span class="line"></span><br><span class="line">    case $1 in </span><br><span class="line">        4.8.11)</span><br><span class="line">            pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1" enable-http2="yes" enable-mysqlnd="yes" enable-swoole-json="no" enable-swoole-curl="yes" enable-cares="no"' $&#123;package&#125;</span><br><span class="line">            ;;</span><br><span class="line">        4.8.*)</span><br><span class="line">            pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1" enable-http2="yes" enable-mysqlnd="yes" enable-swoole-json="no" enable-swoole-curl="yes"' $&#123;package&#125;</span><br><span class="line">            ;;</span><br><span class="line">        5.0.0)</span><br><span class="line">            pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1" enable-http2="yes" enable-mysqlnd="yes" enable-swoole-json="no" enable-swoole-curl="yes" enable-cares="no"' $&#123;package&#125;</span><br><span class="line">            ;;</span><br><span class="line">        5.0.*)</span><br><span class="line">            pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1" enable-http2="yes" enable-mysqlnd="yes" enable-swoole-json="no" enable-swoole-curl="yes" enable-cares="no" enable-brotli="no"' $&#123;package&#125;</span><br><span class="line">            ;;</span><br><span class="line">        5.1.*)</span><br><span class="line">            pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1" enable-http2="yes" enable-mysqlnd="yes" enable-swoole-json="no" enable-swoole-curl="yes" enable-cares="no" enable-brotli="no" enable-swoole-pgsql="no" with-swoole-odbc="no" with-swoole-oracle="no" enable-swoole-sqlite="no"' $&#123;package&#125;</span><br><span class="line">            ;;</span><br><span class="line">        6.0.* | "")</span><br><span class="line">            pecl install --configureoptions 'enable-sockets="no" enable-openssl="yes --with-openssl-dir=/opt/homebrew/opt/openssl@1.1" enable-http2="yes" enable-mysqlnd="yes" enable-swoole-json="no" enable-swoole-curl="yes" enable-cares="no" enable-brotli="no" enable-swoole-pgsql="no" with-swoole-odbc="no" with-swoole-oracle="no" enable-swoole-sqlite="no" enable-swoole-thread="no" enable-iouring="no"' $&#123;package&#125;</span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            echo "Unsupported version: $1"</span><br><span class="line">            exit 1</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line"></span><br><span class="line">    swoole_info</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新</span></span><br><span class="line">function swoole_upgrade() &#123;</span><br><span class="line">    swoole_uninstall</span><br><span class="line">    swoole_install $1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新安装</span></span><br><span class="line">function swoole_reinstall() &#123;</span><br><span class="line">    swoole_uninstall</span><br><span class="line">    swoole_install $1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 卸载</span></span><br><span class="line">function swoole_uninstall() &#123;</span><br><span class="line">    local php_ini=$(php -i | grep "/php.ini" | awk -F ' =&gt; ' '&#123;print $2&#125;')</span><br><span class="line"></span><br><span class="line">    pecl uninstall swoole</span><br><span class="line">    sed -i '' '/^extension="swoole.so"/d' $php_ini</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最新版本</span></span><br><span class="line">function swoole_latest() &#123;</span><br><span class="line">    local version=`curl -s https://pecl.php.net/package/swoole |grep -E "swoole-.*.tgz" |head -1 |grep -Eo '\d+\.\d+\.\d+' | head -1`</span><br><span class="line">    echo $version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 信息</span></span><br><span class="line">function swoole_info() &#123;</span><br><span class="line">    php --ri swoole</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 版本</span></span><br><span class="line">function swoole_version() &#123;</span><br><span class="line">    php -r "echo swoole_version();" </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装别名</span></span><br><span class="line">function swoole_i() &#123;</span><br><span class="line">    swoole_install $1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新别名</span></span><br><span class="line">function swoole_u() &#123;</span><br><span class="line">    swoole_upgrade $1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 帮助</span></span><br><span class="line">function swoole_help() &#123;</span><br><span class="line">    cat &lt;&lt; END</span><br><span class="line">Usage:</span><br><span class="line">    $0 [help|i|install|reinstall|uninstall|u|upgrade|version|latest] [version]</span><br><span class="line"></span><br><span class="line">Examples</span><br><span class="line">    $0 install</span><br><span class="line">    $0 install 5.1.3</span><br><span class="line">    $0 upgrade</span><br><span class="line">    $0 upgrade 5.1.3</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 入口</span></span><br><span class="line">function swoole_() &#123;</span><br><span class="line">    swoole_help</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行</span></span><br><span class="line"><span class="meta">swoole_$</span><span class="bash">1 <span class="variable">$2</span></span></span><br></pre></td></tr></table></figure><ul><li><code>~/.bashrc</code> 或 <code>~/.zshrc</code> 添加以下脚本</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias swoole-tool="sh ~/scripts/swoole.sh"</span><br></pre></td></tr></table></figure><ul><li>快速安装 <code>Swoole</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swoole-tool install 6.0.0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> homebrew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sponsors</title>
      <link href="/sponsors/"/>
      <url>/sponsors/</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>I’m Huangdijia, a software engineer with a passion for open source. Active in the Hyperf ecosystem.</p><p>Member of <a href="https://github.com/hyperf" target="_blank" rel="noopener">@Hyperf</a>, <a href="https://github.com/friendsofhyperf" target="_blank" rel="noopener">@FriendsOfHyperf</a></p><ul><li><a href="https://github.com/friendsofhyperf/sentry" target="_blank" rel="noopener">hyperf-sentry</a> - The sentry SDK for Hyperf</li><li><a href="https://github.com/friendsofhyperf/trigger" target="_blank" rel="noopener">hyperf-trigger</a> - The MySQL Trigger for Hyperf</li><li><a href="https://github.com/huangdijia/laravel-horizon-restart" target="_blank" rel="noopener">laravel-horizon-restart</a> - A Plugin for laravel-horzion</li><li><a href="https://github.com/huangdijia/laravel-trigger" target="_blank" rel="noopener">laravel-trigger</a> - MySQL event subscriber base on MySQLReplication</li><li><a href="https://github.com/friendsofhyperf/pest-plugin-hyperf" target="_blank" rel="noopener">pest-plugin-hyperf</a> - The Pest plugin for Hyperf</li></ul><p>Your sponsorship means a lot to me. It will help me sustain my projects actively and make more of my ideas come true. Much appreciated! 💖 🙏</p><h2 id="Sponsors"><a href="#Sponsors" class="headerlink" title="Sponsors"></a>Sponsors</h2><p><img src="https://hdj.me/images/wechat-pay-min.jpg" alt="WeChatPay"><br><img src="https://hdj.me/images/alipay-min.jpg" alt="Alipay"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>如何迁移 homebrew 至 M1 Mac</title>
      <link href="/How-to-migrate-to-native-Homebrew-on-an-M1-Mac/"/>
      <url>/How-to-migrate-to-native-Homebrew-on-an-M1-Mac/</url>
      
        <content type="html"><![CDATA[<h2 id="旧-Mac-备份"><a href="#旧-Mac-备份" class="headerlink" title="旧 Mac 备份"></a>旧 Mac 备份</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/bin/brew bundle dump</span><br></pre></td></tr></table></figure><p>得到 <code>Brewfile</code> 文件。</p><a id="more"></a><h2 id="M1-Mac-安装-brew"><a href="#M1-Mac-安装-brew" class="headerlink" title="M1 Mac 安装 brew"></a>M1 Mac 安装 brew</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)</span>"</span></span><br></pre></td></tr></table></figure><p>安装过程中可能会遇到权限问题，可以使用 sudo 命令授权</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $(whoami) /opt/homebrew</span><br></pre></td></tr></table></figure><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p>编辑 <code>~/.zshrc</code> 文件，添加如下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># arm brew environment</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(/opt/homebrew/bin/brew shellenv)</span>"</span></span><br></pre></td></tr></table></figure><h2 id="导入-Brewfile"><a href="#导入-Brewfile" class="headerlink" title="导入 Brewfile"></a>导入 Brewfile</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/homebrew/bin/brew bundle --file path/to/Brewfile</span><br></pre></td></tr></table></figure><blockquote><p>有些软件不能完成安装，后面手动安装就好了。</p></blockquote><h2 id="卸载旧版本"><a href="#卸载旧版本" class="headerlink" title="卸载旧版本"></a>卸载旧版本</h2><p>如果旧版跟谁 Mac 也迁移至了 M1 Mac，那么可以使用以下命令卸载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arch -x86_64 <span class="variable">$SHELL</span></span><br><span class="line">/bin/bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall.sh)</span>"</span></span><br></pre></td></tr></table></figure><p>可能还会有一些残留目录，只要手动 <code>rm -rf</code> 删除即可</p><blockquote><p>/usr/local/.com.apple.installer.keep<br>/usr/local/Frameworks/<br>/usr/local/Homebrew/<br>/usr/local/bin/<br>/usr/local/etc/<br>/usr/local/iODBC.odbcmanager/<br>/usr/local/include/<br>/usr/local/lib/<br>/usr/local/opt/<br>/usr/local/packager/<br>/usr/local/remotedesktop/<br>/usr/local/sbin/<br>/usr/local/share/<br>/usr/local/var/<br>/usr/local/zlib/</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> macos </tag>
            
            <tag> brew </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>将 Apple Watch 身份验证添加到 sudo</title>
      <link href="/add-apple-watch-authentication-to-sudo/"/>
      <url>/add-apple-watch-authentication-to-sudo/</url>
      
        <content type="html"><![CDATA[<p>我最近看到一篇关于如何使 <code>sudo</code> 与 <code>Touch ID</code> 一起工作的文章，这很好，但我的 iMac Pro 没有 <code>Touch ID</code>。我继续搜索并找到了<code>pam-watchid</code>！</p><p>这是一个用于使用 <code>Watch</code> 的 <code>PAM模块</code> ——正是我想要的。</p><a id="more"></a><p>它是开源的，因此您可以按照自述文件自行编译，因此请确保您已安装<code>Xcode</code>或<code>Xcode 命令行工具</code>：</p><p>下载<a href="https://github.com/biscuitehh/pam-watchid/archive/main.zip" target="_blank" rel="noopener">最新的 ZIP 文件</a></p><p>解压缩，默认情况下会创建一个名为<code>pam-watchid-main</code>的文件夹</p><ul><li>打开终端并安装它：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/Downloads/pam-watchid-main</span><br><span class="line">$ sudo 安装</span><br></pre></td></tr></table></figure><ul><li>为sudo注册新的 PAM 模块：</li></ul><p>编辑 <code>/etc/pam.d/sudo</code>， 在第 1 行（这是注释）下添加一个新行，其中包含：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth       sufficient     pam_watchid.so</span><br></pre></td></tr></table></figure><p>（保留此文件中的所有其他行。）<br>就是这样。现在，无论何时使用sudo，您都可以选择使用 Watch 进行身份验证。</p><p><img src="https://akrabat.com/wp-content/uploads/2020/11/Screenshot-2020-11-22-at-14.17.47-3.png" alt="将 Apple Watch 身份验证添加到 sudo"></p>]]></content>
      
      
      <categories>
          
          <category> MacOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MacOS </tag>
            
            <tag> Apple Watch </tag>
            
            <tag> Apple </tag>
            
            <tag> 身份验证 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Laravel Eloquent 访问器的一个坑</title>
      <link href="/pit-of-laravel-eloquent-accessor/"/>
      <url>/pit-of-laravel-eloquent-accessor/</url>
      
        <content type="html"><![CDATA[<h2 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h2><table><thead><tr><th>ID</th><th>first_name</th><th>last_name</th></tr></thead><tbody><tr><td>1</td><td>Jackie</td><td>Chan</td></tr><tr><td>2</td><td>Bruce</td><td>Lee</td></tr></tbody></table><a id="more"></a><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Star</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullNameAttribute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;first_name . <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;last_name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="正常使用"><a href="#正常使用" class="headerlink" title="正常使用"></a>正常使用</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Start::first()-&gt;full_name; <span class="comment">// "Jackie Chan"</span></span><br></pre></td></tr></table></figure><h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Star::select(DB::raw(<span class="string">"concat(first_name, ' ', last_name) as full_name"</span>))-&gt;first()-&gt;full_name; <span class="comment">// ""</span></span><br></pre></td></tr></table></figure><p>但是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump(Star::select(DB::raw(<span class="string">"concat(first_name, ' ', last_name) as full_name"</span>))-&gt;first());</span><br></pre></td></tr></table></figure><p>结果能看到 <code>full_name</code> 有值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="comment">#attributes: array:1 [</span></span><br><span class="line">    <span class="string">"full_name"</span> =&gt; <span class="string">"Jackie Chan"</span></span><br><span class="line">  ]</span><br><span class="line">  <span class="comment">#original: array:1 [</span></span><br><span class="line">    <span class="string">"full_name"</span> =&gt; <span class="string">"Jackie Chan"</span></span><br><span class="line">  ]</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><blockquote><ol><li>Eloquent 访问器优先级高于属性</li><li>该例子中访问器依赖的属性因为未指定 <code>select</code> 为空</li></ol></blockquote><h2 id="如何填坑"><a href="#如何填坑" class="headerlink" title="如何填坑"></a>如何填坑</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Star</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullNameAttribute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 优先 full_name 属性</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[<span class="string">'full_name'</span>] ?? (<span class="keyword">$this</span>-&gt;attributes[<span class="string">'first_name'</span>] . <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;attributes[<span class="string">'last_name'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Laravel </tag>
            
            <tag> Eloquent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Laravel artisan 命令自动补全</title>
      <link href="/auto-complete-for-laravel-artisan/"/>
      <url>/auto-complete-for-laravel-artisan/</url>
      
        <content type="html"><![CDATA[<h2 id="安装-bash-completion-2"><a href="#安装-bash-completion-2" class="headerlink" title="安装 bash-completion@2"></a>安装 <code>bash-completion@2</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install bash-completion@2</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="配置-zshrc-或-bash-profile"><a href="#配置-zshrc-或-bash-profile" class="headerlink" title="配置 ~/.zshrc 或 ~/.bash_profile"></a>配置 <code>~/.zshrc</code> 或 <code>~/.bash_profile</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bash-completion@2</span></span><br><span class="line"><span class="built_in">autoload</span> bashcompinit</span><br><span class="line">bashcompinit</span><br><span class="line"></span><br><span class="line"><span class="comment"># auto-complete for php artisan</span></span><br><span class="line">ARTISAN_COMMANDS=`php artisan --raw --no-ansi list | sed <span class="string">"s/[[:space:]].*//g"</span>`</span><br><span class="line">_artisan()</span><br><span class="line">&#123;</span><br><span class="line">    COMP_WORDBREAKS=<span class="variable">$&#123;COMP_WORDBREAKS//:&#125;</span></span><br><span class="line">    COMPREPLY=(`compgen -W <span class="string">"<span class="variable">$ARTISAN_COMMANDS</span>"</span> -- <span class="string">"<span class="variable">$&#123;COMP_WORDS[COMP_CWORD]&#125;</span>"</span>`)</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line">complete -F _artisan artisan</span><br><span class="line"><span class="built_in">alias</span> artisan=<span class="string">'php artisan'</span></span><br></pre></td></tr></table></figure><p>如果在 Windows 的 Git-Bash 上出现类似于 <code>stdout is not a tty</code> 的错误，只需要把 <code>ARTISAN_COMMANDS=</code> 这一行改成:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARTISAN_COMMANDS=`php.exe artisan --raw --no-ansi list | sed <span class="string">"s/[[:space:]].*//g"</span>`</span><br></pre></td></tr></table></figure><h2 id="效果预览"><a href="#效果预览" class="headerlink" title="效果预览"></a>效果预览</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; php artisan make:[TAB][TAB]</span><br><span class="line">make:channel       make:factory       make:model         make:rule</span><br><span class="line">make:<span class="built_in">command</span>       make:import        make:notification  make:seeder</span><br><span class="line">make:controller    make:job           make:observer      make:service</span><br><span class="line">make:event         make:listener      make:policy        make:<span class="built_in">test</span></span><br><span class="line">make:exception     make:mail          make:provider      make:transformer</span><br><span class="line">make:<span class="built_in">export</span>        make:middleware    make:request</span><br><span class="line">make:<span class="built_in">export</span>-model  make:migration     make:resource</span><br></pre></td></tr></table></figure><h2 id="举一反三"><a href="#举一反三" class="headerlink" title="举一反三"></a>举一反三</h2><p>让 <code>composer</code> 也是支持相同的效果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># auto-complete for composer</span></span><br><span class="line">COMPOSER_COMMANDS=`composer --raw --no-ansi list | sed <span class="string">"s/[[:space:]].*//g"</span>`</span><br><span class="line">_composer()</span><br><span class="line">&#123;</span><br><span class="line">    COMP_WORDBREAKS=<span class="variable">$&#123;COMP_WORDBREAKS//:&#125;</span></span><br><span class="line">    COMPREPLY=(`compgen -W <span class="string">"<span class="variable">$COMPOSER_COMMANDS</span>"</span> -- <span class="string">"<span class="variable">$&#123;COMP_WORDS[COMP_CWORD]&#125;</span>"</span>`)</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line">complete -F _composer composer</span><br></pre></td></tr></table></figure><h3 id="看看效果"><a href="#看看效果" class="headerlink" title="看看效果"></a>看看效果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ composer [TAB][TAB]</span><br><span class="line">about                clear-cache          create-project       dumpautoload         home                 install              prohibits            search               status               upgrade</span><br><span class="line">archive              clearcache           depends              <span class="built_in">exec</span>                 i                    licenses             remove               self-update          suggests             validate</span><br><span class="line">browse               <span class="built_in">command</span>              diagnose             global               info                 list                 require              selfupdate           u                    why</span><br><span class="line">check-platform-reqs  config               dump-autoload        <span class="built_in">help</span>                 init                 outdated             run-script           show                 update               why-not</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> laravel </tag>
            
            <tag> artisan </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过 JavaScript 监听暗黑模式变化</title>
      <link href="/listening-darkmode-by-javascript/"/>
      <url>/listening-darkmode-by-javascript/</url>
      
        <content type="html"><![CDATA[<p>苹果系统（macOS、iOS）都已经全面支持暗黑模式（也叫深色模式）了，在这里不做过多的介绍了。在众多的技术文章里都有介绍如何使用，最常见的是通过 CSS 中的 prefers-color-scheme: dark 来检测用户是否开启了 Dark Mode，在 CSS里定义不同的样式。</p><a id="more"></a><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 操作系统及浏览器未支持或用户未开启 Dark Mode */</span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: white;</span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">prefers-color-scheme:</span> dark) &#123;</span><br><span class="line">    <span class="comment">/* 操作系统及浏览器支持且用户开启了 Dark Mode */</span></span><br><span class="line">    <span class="selector-tag">body</span> &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: black;</span><br><span class="line">        <span class="attribute">color</span>: white;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从以上代码看，有点类似 if-else，兼容性和可读性都不是很好。</p><p>暗黑模式刚推出的时候，我首先想到的是跟博客的主题功能很像，细品之后发现区别在于主题做法更多的是是更换 CSS 文件，于是我想是不是可以通过 JavaScript 检测（监听）用户是否启用暗黑模式，从而加载不同的样式，实现实时更换主题功能。</p><p>接下来最关键的问题就是怎么实现这个“监听”功能，在谷歌上百度了一下，找到了一个关键词 matchMedia。</p><p>用过 matchMedia 方法可以直接判断浏览器当前是否倾向于使用深色模式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> prefersDarkMode = <span class="built_in">window</span>.matchMedia(<span class="string">'(prefers-color-scheme: dark)'</span>).matches;</span><br><span class="line"><span class="keyword">if</span> (prefersDarkMode) &#123;</span><br><span class="line">    <span class="comment">// 搞事情</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过监听 matchMedia 的 change 事件，可以在用户切换深色 / 浅色模式的时候，将浏览器中已打开的页面自动切换为系统对应的模式。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> media = <span class="built_in">window</span>.matchMedia(<span class="string">'(prefers-color-scheme: dark)'</span>);</span><br><span class="line"><span class="keyword">let</span> callback = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> prefersDarkMode = e.matches;</span><br><span class="line">    <span class="keyword">if</span> (prefersDarkMode) &#123;</span><br><span class="line">        <span class="comment">// 搞事情</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> media.addEventListener === <span class="string">'function'</span>) &#123;</span><br><span class="line">    media.addEventListener(<span class="string">'change'</span>, callback);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> media.addListener === <span class="string">'function'</span>) &#123;</span><br><span class="line">    media.addListener(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> dark-mode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>期待已久的 PHP preload</title>
      <link href="/php74-preload/"/>
      <url>/php74-preload/</url>
      
        <content type="html"><![CDATA[<p>期待已久的 <a href="https://www.php.net/archive/2019.php#2019-11-28-1" target="_blank" rel="noopener">PHP7.4</a> 终于发布了，个人最期待的功能还是 <a href="https://www.php.net/manual/zh/opcache.configuration.php#ini.opcache.preload" target="_blank" rel="noopener">Opcache Preloading</a>。</p><ul><li>为了预加载文件，您需要编写自定义PHP脚本</li><li>此脚本在服务器启动时执行一次</li><li>所有预加载的文件都可在内存中用于所有请求</li><li>在重新启动服务器之前，对源文件所做的更改不会产生任何影响</li></ul><a id="more"></a><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>包含 2 配置参数：</p><ul><li>opcache.preload string</li></ul><blockquote><p>指定要在服务器启动时期进行编译和缓存的 PHP 脚本文件， 这些文件也可能通过 include 或者 opcache_compile_file() 函数 来预加载其他文件。 所有这些文件中包含的实体，包括函数、类等，在服务器启动的时候就被加载和缓存， 对于用户代码来讲是“开箱可用”的。</p></blockquote><ul><li>opcache.preload_user string</li></ul><blockquote><p>考虑到安全因素，禁止以 root 用户预加载代码。该指令方便以其他用户预加载。</p></blockquote><h3 id="php-ini-配置"><a href="#php-ini-配置" class="headerlink" title="php.ini 配置"></a><code>php.ini</code> 配置</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">opcache.preload</span>=/path/to/project/preload.php</span><br></pre></td></tr></table></figure><h3 id="及时实现"><a href="#及时实现" class="headerlink" title="及时实现"></a>及时实现</h3><p>针对 composer，可以直接生成 <code>vendor/preload.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$files = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/composer/autoload_classmap.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (array_unique($files) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">    opcache_compile_file($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="第三方包"><a href="#第三方包" class="headerlink" title="第三方包"></a>第三方包</h2><p>Github 上也有大神放出 composer 扩展包 <a href="https://github.com/Ayesh/Composer-Preload" target="_blank" rel="noopener">Composer-Preload</a>，可通过简单配置实现。</p><h3 id="当前项目安装"><a href="#当前项目安装" class="headerlink" title="当前项目安装"></a>当前项目安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require ayesh/composer-preload</span><br></pre></td></tr></table></figure><h3 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a>全局安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer g require ayesh/composer-preload</span><br></pre></td></tr></table></figure><h3 id="composer-json-配置"><a href="#composer-json-配置" class="headerlink" title="composer.json 配置"></a><code>composer.json</code> 配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"extra"</span>: &#123;</span><br><span class="line">        <span class="attr">"preload"</span>: &#123;</span><br><span class="line">            <span class="attr">"paths"</span>: [</span><br><span class="line">                <span class="string">"web"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"exclude"</span>: [</span><br><span class="line">                <span class="string">"web/core/tests"</span>,</span><br><span class="line">                <span class="string">"web/core/lib/Drupal/Component/Assertion"</span>,</span><br><span class="line">                <span class="string">"web/core/modules/simpletest"</span>,</span><br><span class="line">                <span class="string">"web/core/modules/editor/src/Tests"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"extensions"</span>: [<span class="string">"php"</span>, <span class="string">"module"</span>, <span class="string">"inc"</span>, <span class="string">"install"</span>],</span><br><span class="line">            <span class="attr">"exclude-regex"</span>: <span class="string">"/[A-Za-z0-9_]test\\.php$/i"</span>,</span><br><span class="line">            <span class="attr">"no-status-check"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"files"</span>: [</span><br><span class="line">                <span class="string">"somefile.php"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="vendor-preload-php-生成"><a href="#vendor-preload-php-生成" class="headerlink" title="vendor/preload.php 生成"></a><code>vendor/preload.php</code> 生成</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer preload</span><br></pre></td></tr></table></figure><h2 id="官方支持"><a href="#官方支持" class="headerlink" title="官方支持"></a>官方支持</h2><p>目前 composer 官方还没支持，已经有人向 composer 提交了<a href="https://github.com/composer/composer/issues/7777" target="_blank" rel="noopener">Issue</a>，据说 2.0 里程碑版本会增加支持，值得期待。</p><h2 id="性能提升"><a href="#性能提升" class="headerlink" title="性能提升"></a>性能提升</h2><p>官方以 zend framework 测试 <code>30~50 %</code> 的性能提升。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> preload </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何取消 failed_jobs</title>
      <link href="/how-to-disable-write-laravel-failed-table/"/>
      <url>/how-to-disable-write-laravel-failed-table/</url>
      
        <content type="html"><![CDATA[<h2 id="烦恼从何而来"><a href="#烦恼从何而来" class="headerlink" title="烦恼从何而来"></a>烦恼从何而来</h2><p>用 Laravel 的小伙伴应该都会用到 Queue， 从<a href="https://laravel.com/docs/6.x/queues#dealing-with-failed-jobs" target="_blank" rel="noopener">手册</a> Job 失败后会将队列信息记录到 <code>failed_jobs</code> 表，可以通过</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php artisan queue:failed-table</span><br><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure><p>作用主要是为了方便分析失败原因和 Job 重试（本身支持 retry），这都很好理解。当 <code>failed_jobs</code> 没有被创建的时候，会报这样一个异常：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQLSTATE[<span class="number">42</span>S02]: Base table <span class="keyword">or</span> view not found: <span class="number">1146</span> Table <span class="string">'a8591.failed_jobs'</span> doesn<span class="string">'t exist</span></span><br></pre></td></tr></table></figure><p>并且记录到 log 文件，如果你的项目中有异常通知，那是相当困扰。</p><p>但是有一个场景，也许我并不关心任务执行是否成功，或者说因为某种特定不可控因素允许任务存在执行失败的情况，而我又不希望被这类异常打扰要怎么办呢？</p><a id="more"></a><h2 id="方法一：重写-Job-类-fail-方法"><a href="#方法一：重写-Job-类-fail-方法" class="headerlink" title="方法一：重写 Job 类 fail 方法"></a>方法一：重写 Job 类 fail 方法</h2><p>只要 IDE 强大些，跳跳跳，跳转一下代码，很容易找到 <code>vendor/illuminate/queue/Jobs/Job.php</code> 处理 Job 失败的逻辑位置：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fail</span><span class="params">($e = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;markAsFailed();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isDeleted()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// If the job has failed, we will delete it, call the "failed" method and then call</span></span><br><span class="line">        <span class="comment">// an event indicating the job has failed so it can be logged if needed. This is</span></span><br><span class="line">        <span class="comment">// to allow every developer to better keep monitor of their failed queue jobs.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;delete();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;failed($e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123; <span class="comment">// 没错，就是这里处理失败任务</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;resolve(Dispatcher::class)-&gt;dispatch(<span class="keyword">new</span> JobFailed(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connectionName, <span class="keyword">$this</span>, $e ?: <span class="keyword">new</span> ManuallyFailedException</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>最粗暴的方法就是在具体的 XXXJob 里重写这个方法。</p><p>这个方法有一个好处：可以针对某个 Job，而不是一刀切。</p><h2 id="方法二：修改-queue-配置"><a href="#方法二：修改-queue-配置" class="headerlink" title="方法二：修改 queue 配置"></a>方法二：修改 queue 配置</h2><p>后来我再想，要么每个 Job 都要重写一遍，要么再项目中定义一个 Job 父类，然后再父类中重写，方法可行，但是感觉不太优雅，比较 Laravel 是一个这么优雅的框架，怎么可以就这么粗暴处理呢。</p><p>于是在 <code>方法一</code> 的基础上再深入研究，想要看看有没有<code>开关</code>，但是从 queue 的配置文件和手册中并没有明确的提到这个<code>开关</code>，只能继续<code>跳跳跳</code>，继续深入的了解 Job 的执行原理。</p><p>功夫不负有心人，终于让我找到了 <code>vendor/illuminate/queue/QueueServiceProvider.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerFailedJobServices</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'queue.failer'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        $config = <span class="keyword">$this</span>-&gt;app[<span class="string">'config'</span>][<span class="string">'queue.failed'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($config[<span class="string">'driver'</span>]) &amp;&amp; $config[<span class="string">'driver'</span>] === <span class="string">'dynamodb'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dynamoFailedJobProvider($config);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($config[<span class="string">'table'</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;databaseFailedJobProvider($config);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NullFailedJobProvider;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题变得清晰明朗了，不难看出：</p><ul><li>当 <code>queue.failed.driver</code> 为 <code>dynamodb</code> 的时候使用 <code>dynamoFailedJobProvider</code> 处理</li><li>当存在 <code>queue.failed.table</code> 的时候，使用 <code>databaseFailedJobProvider</code> 处理</li><li>否则使用 <code>NullFailedJobProvider</code> 处理，也就是啥都不干的意思</li></ul><p>最终发现原来<code>开关</code>是存在的，只是官方没有明确说明。</p><p>找到 <code>config/queue.php</code>, do it!</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Failed Queue Jobs</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| These options configure the behavior of failed queue job logging so you</span></span><br><span class="line"><span class="comment">| can control which database and table are used to store the jobs that</span></span><br><span class="line"><span class="comment">| have failed. You may change them to any database / table you wish.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="string">'failed'</span> =&gt; [</span><br><span class="line">    <span class="comment">// 'database' =&gt; env('DB_CONNECTION', 'mysql'),</span></span><br><span class="line">    <span class="comment">// 'table' =&gt; env('QUEUE_FAILED_TABLE', 'failed_jobs'),</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Laravel </tag>
            
            <tag> queue </tag>
            
            <tag> faild_jobs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何正确的在 Lumen 中启用 Notification</title>
      <link href="/how-to-make-notifications-in-Lumen/"/>
      <url>/how-to-make-notifications-in-Lumen/</url>
      
        <content type="html"><![CDATA[<h2 id="安装-illuminate-notifications"><a href="#安装-illuminate-notifications" class="headerlink" title="安装 illuminate/notifications"></a>安装 <code>illuminate/notifications</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require illuminate/notifications</span><br></pre></td></tr></table></figure><h2 id="bootstrap-app-php-注册服务"><a href="#bootstrap-app-php-注册服务" class="headerlink" title="bootstrap/app.php 注册服务"></a><code>bootstrap/app.php</code> 注册服务</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app-&gt;register(Illuminate\Notifications\NotificationServiceProvider::class);</span><br></pre></td></tr></table></figure><blockquote><p>⚠️ 必须在 AppServiceProvider 注册之前，不然自定义 <code>Channel</code> 会无法找到，提升 <code>InvalidArgumentException with message &#39;Driver [xxxx] not supported.&#39;</code></p></blockquote><h2 id="在-AppServiceProvider-php-注册-Channel"><a href="#在-AppServiceProvider-php-注册-Channel" class="headerlink" title="在 AppServiceProvider.php 注册 Channel"></a>在 <code>AppServiceProvider.php</code> 注册 <code>Channel</code></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;make(Illuminate\Notifications\ChannelManager::class)-&gt;extend(<span class="string">'your-channel'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;app-&gt;make(App\Channels\YourChannel::class);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lumen </tag>
            
            <tag> notification </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 的 __call 和 __callStatic</title>
      <link href="/call-and-callstatic-in-php/"/>
      <url>/call-and-callstatic-in-php/</url>
      
        <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Foo::abc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> Foo)-&gt;bar();</span><br></pre></td></tr></table></figure><p>结果是 <code>1</code> 还是 <code>2</code>？答案是 <code>1</code></p><p>接下来解释一下：</p><ol><li><code>__call</code> 方法关注方法能否被访问到，而不仅仅是关注是否存在</li><li><code>__callStatic</code> 方法关注的是方法能否被静态的访问到，而不是关注方法是否存在，是否是静态方法。</li><li>具体执行 <code>__call</code>，<code>__callStatic</code> ，是根据调用的上下文。如</li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为 PHP7.x 安装 memcache 扩展</title>
      <link href="/install-memcache-for-php7-x/"/>
      <url>/install-memcache-for-php7-x/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/websupport-sk/pecl-memcache" target="_blank" rel="noopener">PHP Extension - Memcache module with support of newer PHP 7.0-7.3</a></p><p>Install</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clone source</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/websupport-sk/pecl-memcache.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># configure &amp; install</span></span><br><span class="line"><span class="built_in">cd</span> pecl-memcache;</span><br><span class="line">phpize</span><br><span class="line">./configure</span><br><span class="line">make -j$(nproc)</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># create php ini</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"extension=memcache.so"</span> &gt;&gt; /usr/<span class="built_in">local</span>/php/etc/conf.d/memcache.ini</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> Memcache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何正确的计算每 N 分钟记录数</title>
      <link href="/count-for-every-n-minutes-in-mysql/"/>
      <url>/count-for-every-n-minutes-in-mysql/</url>
      
        <content type="html"><![CDATA[<h2 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h2><table><thead><tr><th>字段</th><th>数据类型</th></tr></thead><tbody><tr><td>id</td><td>int(11)</td></tr><tr><td>created_at</td><td>datetime</td></tr></tbody></table><h2 id="期望结果"><a href="#期望结果" class="headerlink" title="期望结果"></a>期望结果</h2><table><thead><tr><th>时间段</th><th>数量</th></tr></thead><tbody><tr><td>2019-09-29 12:00:00 ~ 2019-09-29 12:05:00</td><td>100</td></tr><tr><td>2019-09-29 12:05:00 ~ 2019-09-29 12:10:00</td><td>120</td></tr><tr><td>2019-09-29 12:10:00 ~ 2019-09-29 12:15:00</td><td>131</td></tr><tr><td>2019-09-29 12:15:00 ~ 2019-09-29 12:20:00</td><td>189</td></tr><tr><td>2019-09-29 12:20:00 ~ 2019-09-29 12:25:00</td><td>134</td></tr><tr><td>2019-09-29 12:25:00 ~ 2019-09-29 12:30:00</td><td>155</td></tr><tr><td>2019-09-29 12:30:00 ~ 2019-09-29 12:35:00</td><td>198</td></tr><tr><td>2019-09-29 12:35:00 ~ 2019-09-29 12:40:00</td><td>133</td></tr></tbody></table><h2 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 300 为 5 分钟</span><br><span class="line">select</span><br><span class="line">  concat(from_unixtime(unix_timestamp(created_at) - unix_timestamp(created_at) % 300), &apos; ~ &apos;, from_unixtime(unix_timestamp(created_at) - unix_timestamp(created_at) % 300 + 300)) as per,</span><br><span class="line">  count(1)</span><br><span class="line">from table</span><br><span class="line">group by per;</span><br></pre></td></tr></table></figure><p>如果 created_at 类型为 int，还可以减少一次转换</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 300 为 5 分钟</span><br><span class="line">select</span><br><span class="line">  concat(from_unixtime(created_at - created_at % 300), &apos; ~ &apos;, from_unixtime(created_at - created_at % 300 + 300)) as per,</span><br><span class="line">  count(1)</span><br><span class="line">from table</span><br><span class="line">group by per;</span><br></pre></td></tr></table></figure><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><blockquote><p>时间分片 <em>MySQL没有相关的时间分片函数，还好可以用取模（%）实现</em></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何正确的使用 GitHub Actions 实现 Hexo 博客的 CICD</title>
      <link href="/github-actions-hexo-cicd/"/>
      <url>/github-actions-hexo-cicd/</url>
      
        <content type="html"><![CDATA[<blockquote><p>CI/CD (continuous integration and continuous deployment)</p></blockquote><p>最近同事分享了 GitHub Actions ，发现除了我们常听到的自动部署（项目上线）外还可以做很多事情，比如说就可以自动生成 Hexo 博客，我擦！这不就是我想要的吗？以后就不用每次写完文章之后再执行 <code>hexo clean &amp;&amp; hexo g -d</code> 了。</p><p>回来各种百度，有几篇针对 HEXO 的文章，照着开始写脚本，发现怎么都不能成功，各种错误。折腾了 3 个小时，终于顺利通过了。</p><a id="more"></a><h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>我先介绍一下我的项目背景：</p><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><code>https://github.com/huangdijia/blog</code></td><td>用于存放 hexo 生成的项目，可以理解成源码</td></tr><tr><td><code>https://github.com/huangdijia/huangdijia.github.io</code></td><td>存放 hexo 编译后的静态文件，也是我的博客页面</td></tr></tbody></table><blockquote><p>以下说明都是以我的两个项目为例子</p></blockquote><h2 id="密钥生成"><a href="#密钥生成" class="headerlink" title="密钥生成"></a>密钥生成</h2><p>因为 hexo 编译后需要 push 到 huangdijia.github.io 上，需要 GitHub 的账号密码（尝试过不行）或者密钥，我们需要用 <code>ssh-keygen</code> 命令生成一组私钥（没有后缀名）和公钥（.pub结尾）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -f github-deploy-key <span class="comment"># 三次回车即刻</span></span><br></pre></td></tr></table></figure><p>会生成 <code>github-deploy-key</code> 和 <code>github-deploy-key.pub</code> 两个文件。</p><h2 id="配置-GitHub-仓库"><a href="#配置-GitHub-仓库" class="headerlink" title="配置 GitHub 仓库"></a>配置 GitHub 仓库</h2><h3 id="配置-blog-仓库"><a href="#配置-blog-仓库" class="headerlink" title="配置 blog 仓库"></a>配置 blog 仓库</h3><p>打开 <code>https://github.com/huangdijia/blog/settings/secrets</code> 点击 <code>Add new secrets</code>，分别在</p><ul><li><code>Name</code> 输入 <code>HEXO_DEPLOY_PRI</code></li><li><code>Value</code> 输入前面生成的私有 KEY <code>github-deploy-key</code> 的内容</li></ul><h3 id="配置-huangdijia-github-io-仓库"><a href="#配置-huangdijia-github-io-仓库" class="headerlink" title="配置 huangdijia.github.io 仓库"></a>配置 huangdijia.github.io 仓库</h3><p>打开 <code>https://github.com/huangdijia/huangdijia.github.io/settings/keys</code>，点击 <code>Add deploy key</code>，分别在</p><ul><li><code>Title</code> 输入 <code>HEXO_DEPLOY_PUB</code></li><li><code>Key</code> 输入前面生成的私有 KEY <code>github-deploy-key.pub</code> 的内容</li></ul><h2 id="编写-Action-脚本"><a href="#编写-Action-脚本" class="headerlink" title="编写 Action 脚本"></a>编写 Action 脚本</h2><p>使用前先要<a href="https://github.com/features/actions" target="_blank" rel="noopener">申请</a>，然后点击 <code>Actions</code> -&gt; <code>Set up this workflow</code> 或直接打开 <code>https://github.com/huangdijia/huangdijia.github.io/actions/new</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">HEXO</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> <span class="string">[push]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">node-version:</span> <span class="string">[10.x]</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node-version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node-version</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configuration</span> <span class="string">environment</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">HEXO_DEPLOY_PRI:</span> <span class="string">$&#123;&#123;secrets.HEXO_DEPLOY_PRI&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">~/.ssh/</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"$HEXO_DEPLOY_PRI"</span> <span class="string">&gt;</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">          <span class="string">chmod</span> <span class="number">600</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">          <span class="string">ssh-keyscan</span> <span class="string">github.com</span> <span class="string">&gt;&gt;</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">"yourname"</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">"your@email.com"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">i</span> <span class="string">-g</span> <span class="string">hexo-cli</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">i</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">hexo</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">hexo</span> <span class="string">g</span> <span class="string">-d</span></span><br></pre></td></tr></table></figure><h2 id="修改-config-yml-repo"><a href="#修改-config-yml-repo" class="headerlink" title="修改 _config.yml repo"></a>修改 _config.yml repo</h2><p>如果原来是 http 的，要改为 ssh 格式</p><p>如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="comment"># repo: https://github.com/huangdijia/huangdijia.github.io</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:huangdijia/huangdijia.github.io.git</span></span><br></pre></td></tr></table></figure><h2 id="享受成果"><a href="#享受成果" class="headerlink" title="享受成果"></a>享受成果</h2><p>在 <code>blog</code> 项目任意 push，在 <code>https://github.com/huangdijia/blog/actions</code> 都有响应的执行记录</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><blockquote><p>切记不要把账号密码写在脚本上!!!</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Github </tag>
            
            <tag> actions </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客迁移公告</title>
      <link href="/blog-migrate/"/>
      <url>/blog-migrate/</url>
      
        <content type="html"><![CDATA[<p>很不幸，因为VPS忘记续费，博客的资料没有备份，导致博客资料丢失。<br>经过深思熟虑，觉得将博客迁移至GitHub，丢失的文章和资料我尽量找回。</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>crontab 几个特殊字符的含义</title>
      <link href="/the-meaning-of-several-special-characters-for-crontab/"/>
      <url>/the-meaning-of-several-special-characters-for-crontab/</url>
      
        <content type="html"><![CDATA[<h2 id="含义"><a href="#含义" class="headerlink" title="含义"></a>含义</h2><table><thead><tr><th>字符</th><th>含义</th></tr></thead><tbody><tr><td><code>*</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td>全部。意思是在该时间的任意点都应当执行</td></tr><tr><td><code>?</code></td><td>不指定，任意。仅用于 日(月)和日(周)。<code>0 0 5 * ?</code> 代表每个月的第5天零点，不论星期几。</td></tr><tr><td><code>0</code></td><td><code>0 ? * 1</code> 代表每周一，不论是当月的哪天。</td></tr><tr><td><code>,</code></td><td>多个值的分隔符，例如<code>1,5,10</code> - 代表连续值，例如<code>1-20</code></td></tr><tr><td><code>/</code></td><td>步长。例如 <code>5/15</code>，代表从5开始，以15为步长。因此，当<code>5/15</code>位于分钟的位置时，表示小时内的第5、20、35和50分钟</td></tr><tr><td><code>L</code></td><td>最后一天。可以是每月最后一天或者每周最后一天。如果用在 天(周)字段，并且前面加数字，则表示最后一个周N。例如<code>5L</code>，表示最后一个周五（5表示周五，L表示最后）。</td></tr><tr><td><code>W</code></td><td>工作日，指周一到周五的任意一天</td></tr><tr><td><code>#</code></td><td>表示第几个的意思，例如 <code>6#3</code>，表示当月第3个星期六（6表示周六，3表示第3个）</td></tr></tbody></table><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* 0 9 5L 最后一个周五早上9点</span><br><span class="line">* 0 9 6<span class="comment">#3 当月第3个星期六</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> macos </tag>
            
            <tag> linux </tag>
            
            <tag> crontab </tag>
            
            <tag> centos </tag>
            
            <tag> ubuntu </tag>
            
            <tag> debian </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>台湾身份证字号产生器</title>
      <link href="/taiwan-roc-id-generator/"/>
      <url>/taiwan-roc-id-generator/</url>
      
        <content type="html"><![CDATA[<p>参考 <a href="https://people.debian.org/~paulliu/ROCid.html" target="_blank" rel="noopener">身份證字號產生器</a> 写了一份PHP版本</p><a id="more"></a><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 台灣身份證字號生成 &amp; 驗證</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span> $id = (new TaiwanRocId)-&gt;generate();</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span> $ok = (new TaiwanRocId)-&gt;validate($id);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaiwanRocId</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> MALE   = <span class="number">1</span>; <span class="comment">// 男</span></span><br><span class="line">    <span class="keyword">const</span> FEMALE = <span class="number">2</span>; <span class="comment">// 女</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $cityMaps = [</span><br><span class="line">        <span class="string">'A'</span> =&gt; <span class="number">10</span>, <span class="comment">// 台北市</span></span><br><span class="line">        <span class="string">'B'</span> =&gt; <span class="number">11</span>, <span class="comment">// 台中市</span></span><br><span class="line">        <span class="string">'C'</span> =&gt; <span class="number">12</span>, <span class="comment">// 基隆市</span></span><br><span class="line">        <span class="string">'D'</span> =&gt; <span class="number">13</span>, <span class="comment">// 台南市</span></span><br><span class="line">        <span class="string">'E'</span> =&gt; <span class="number">14</span>, <span class="comment">// 高雄市</span></span><br><span class="line">        <span class="string">'F'</span> =&gt; <span class="number">15</span>, <span class="comment">// 台北縣</span></span><br><span class="line">        <span class="string">'G'</span> =&gt; <span class="number">16</span>, <span class="comment">// 宜蘭縣</span></span><br><span class="line">        <span class="string">'H'</span> =&gt; <span class="number">17</span>, <span class="comment">// 桃園縣</span></span><br><span class="line">        <span class="string">'J'</span> =&gt; <span class="number">18</span>, <span class="comment">// 新竹縣</span></span><br><span class="line">        <span class="string">'K'</span> =&gt; <span class="number">19</span>, <span class="comment">// 苗栗縣</span></span><br><span class="line">        <span class="string">'L'</span> =&gt; <span class="number">20</span>, <span class="comment">// 台中縣</span></span><br><span class="line">        <span class="string">'M'</span> =&gt; <span class="number">21</span>, <span class="comment">// 南投縣</span></span><br><span class="line">        <span class="string">'N'</span> =&gt; <span class="number">22</span>, <span class="comment">// 彰化縣</span></span><br><span class="line">        <span class="string">'P'</span> =&gt; <span class="number">23</span>, <span class="comment">// 雲林縣</span></span><br><span class="line">        <span class="string">'Q'</span> =&gt; <span class="number">24</span>, <span class="comment">// 嘉義縣</span></span><br><span class="line">        <span class="string">'R'</span> =&gt; <span class="number">25</span>, <span class="comment">// 台南縣</span></span><br><span class="line">        <span class="string">'S'</span> =&gt; <span class="number">26</span>, <span class="comment">// 高雄縣</span></span><br><span class="line">        <span class="string">'T'</span> =&gt; <span class="number">27</span>, <span class="comment">// 屏東縣</span></span><br><span class="line">        <span class="string">'U'</span> =&gt; <span class="number">28</span>, <span class="comment">// 花蓮縣</span></span><br><span class="line">        <span class="string">'V'</span> =&gt; <span class="number">29</span>, <span class="comment">// 台東縣</span></span><br><span class="line">        <span class="string">'X'</span> =&gt; <span class="number">30</span>, <span class="comment">// 澎湖縣</span></span><br><span class="line">        <span class="string">'Y'</span> =&gt; <span class="number">31</span>, <span class="comment">// 陽明山</span></span><br><span class="line">        <span class="string">'W'</span> =&gt; <span class="number">32</span>, <span class="comment">// 金門縣</span></span><br><span class="line">        <span class="string">'Z'</span> =&gt; <span class="number">33</span>, <span class="comment">// 連江縣</span></span><br><span class="line">        <span class="string">'O'</span> =&gt; <span class="number">35</span>, <span class="comment">// 新竹市</span></span><br><span class="line">        <span class="string">'I'</span> =&gt; <span class="number">34</span>, <span class="comment">// 嘉義市</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成身份證字號</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $city 城市</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $sex 性別</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $mid 流水號</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span><span class="params">(string $city = null, int $sex = null, string $mid = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $cities = array_keys(<span class="keyword">$this</span>-&gt;cityMaps);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($city)) &#123;</span><br><span class="line">            $index    = array_rand($cities);</span><br><span class="line">            $city     = $cities[$index];</span><br><span class="line">            $cityCode = <span class="keyword">$this</span>-&gt;cityMaps[$city];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $city     = strtoupper($city);</span><br><span class="line">            $cityCode = <span class="keyword">$this</span>-&gt;cityMaps[$city] ?? <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($sex)) &#123;</span><br><span class="line">            $sex = rand(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($mid)) &#123;</span><br><span class="line">            $mid = <span class="keyword">$this</span>-&gt;midRand();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 驗證城市</span></span><br><span class="line">        <span class="keyword">if</span> (!in_array($city, $cities)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">"Invalid city"</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 驗證性別</span></span><br><span class="line">        <span class="keyword">if</span> (!in_array($sex, [<span class="keyword">self</span>::MALE, <span class="keyword">self</span>::FEMALE])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">"Invalid sex"</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $verifyCode = <span class="keyword">$this</span>-&gt;calAll($cityCode, $sex, $mid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sprintf(<span class="string">'%s%s%s%s'</span>, $city, $sex, $mid, $verifyCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 驗證身份證字號</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $id 身份證字號</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(string $id = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        [$city, $sex, $mid, $verifyCode] = [</span><br><span class="line">            substr($id, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">            substr($id, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">            substr($id, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">            substr($id, <span class="number">-1</span>, <span class="number">1</span>),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $verifyCode == <span class="keyword">$this</span>-&gt;calAll(<span class="keyword">$this</span>-&gt;cityMaps[$city], $sex, $mid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 隨機流水號</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">midRand</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_pad(rand(<span class="number">0</span>, <span class="number">9999999</span>), <span class="number">7</span>, <span class="string">'0'</span>, STR_PAD_LEFT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算驗證碼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $city</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $sex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|int $mid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">calAll</span><span class="params">($city, $sex, $mid)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ret = <span class="number">0</span>;</span><br><span class="line">        $ret = <span class="keyword">$this</span>-&gt;calCity($city) + <span class="keyword">$this</span>-&gt;calSex($sex) + <span class="keyword">$this</span>-&gt;calMid($mid);</span><br><span class="line">        $ret = $ret % <span class="number">10</span>;</span><br><span class="line">        $ret = <span class="number">10</span> - $ret;</span><br><span class="line">        $ret = $ret % <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算城市驗證碼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $city</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">calCity</span><span class="params">(int $city)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> substr($city, <span class="number">0</span>, <span class="number">1</span>) + substr($city, <span class="number">1</span>, <span class="number">1</span>) * <span class="number">9</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算性別驗證碼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer $sex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">calSex</span><span class="params">(int $sex)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $sex * <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 計算流水驗證碼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|int $mid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">calMid</span><span class="params">($mid)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ret = <span class="number">0</span>;</span><br><span class="line">        $len = strlen($mid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">            $ret = $ret + (<span class="number">7</span> - $i) * substr($mid, $i, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><h3 id="生成身份证字号"><a href="#生成身份证字号" class="headerlink" title="生成身份证字号"></a>生成身份证字号</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$Roc = <span class="keyword">new</span> TaiwanRocId;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 随机生成</span></span><br><span class="line">$id = $Roc-&gt;generate();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定城市、性别</span></span><br><span class="line">$id = $Roc-&gt;generate(<span class="string">'A'</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="验证合法性"><a href="#验证合法性" class="headerlink" title="验证合法性"></a>验证合法性</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ok = (<span class="keyword">new</span> TaiwanRocId)-&gt;validate(<span class="string">"A197651254"</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MacOS 上安装多版本 PHP</title>
      <link href="/install-multi-php-version-on-macos/"/>
      <url>/install-multi-php-version-on-macos/</url>
      
        <content type="html"><![CDATA[<h2 id="安装-brew-源"><a href="#安装-brew-源" class="headerlink" title="安装 brew 源"></a>安装 brew 源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap shivammathur/php</span><br><span class="line">brew search php |grep -E <span class="string">"php@\d\.\d$"</span></span><br></pre></td></tr></table></figure><p>可以看到结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shivammathur/php/php@5.6</span><br><span class="line">shivammathur/php/php@7.0</span><br><span class="line">shivammathur/php/php@7.1</span><br><span class="line">shivammathur/php/php@7.2</span><br><span class="line">shivammathur/php/php@7.3</span><br><span class="line">shivammathur/php/php@7.4</span><br><span class="line">shivammathur/php/php@8.1</span><br><span class="line">shivammathur/php/php@8.2</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="安装多版本"><a href="#安装多版本" class="headerlink" title="安装多版本"></a>安装多版本</h2><p>跟进需要安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">brew install shivammathur/php/php@5.6</span><br><span class="line">brew install shivammathur/php/php@7.0</span><br><span class="line">brew install shivammathur/php/php@7.1</span><br><span class="line">brew install shivammathur/php/php@7.2</span><br><span class="line">brew install shivammathur/php/php@7.3</span><br><span class="line">brew install shivammathur/php/php@7.4</span><br><span class="line">brew install shivammathur/php/php@8.1</span><br><span class="line">brew install shivammathur/php/php@8.2</span><br></pre></td></tr></table></figure><h2 id="命令别名"><a href="#命令别名" class="headerlink" title="命令别名"></a>命令别名</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.zshrc</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bash_profile</span><br></pre></td></tr></table></figure><p>加入以下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解除所有关联</span></span><br><span class="line"><span class="built_in">alias</span> unlink-php=<span class="string">'brew list|grep -E "php(\d&#123;2&#125;|@\d\.\d)$"|xargs brew unlink; brew unlink php'</span></span><br><span class="line"><span class="comment"># 命令别名</span></span><br><span class="line"><span class="built_in">alias</span> php53=<span class="string">'/usr/local/opt/php@5.3/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php54=<span class="string">'/usr/local/opt/php@5.4/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php55=<span class="string">'/usr/local/opt/php@5.5/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php56=<span class="string">'/usr/local/opt/php@5.6/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php70=<span class="string">'/usr/local/opt/php@7.0/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php71=<span class="string">'/usr/local/opt/php@7.1/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php72=<span class="string">'/usr/local/opt/php@7.2/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php73=<span class="string">'/usr/local/opt/php@7.3/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php74=<span class="string">'/usr/local/opt/php@7.4/bin/php'</span></span><br><span class="line"><span class="built_in">alias</span> php80=<span class="string">'/usr/local/opt/php/bin/php'</span></span><br><span class="line"><span class="comment"># pecl alias</span></span><br><span class="line"><span class="built_in">alias</span> pecl53=<span class="string">'/usr/local/php5/bin/pecl'</span></span><br><span class="line"><span class="built_in">alias</span> pecl71=<span class="string">'/usr/local/opt/php@7.1/bin/pecl'</span></span><br><span class="line"><span class="built_in">alias</span> pecl72=<span class="string">'/usr/local/opt/php@7.2/bin/pecl'</span></span><br><span class="line"><span class="built_in">alias</span> pecl73=<span class="string">'/usr/local/opt/php@7.3/bin/pecl'</span></span><br><span class="line"><span class="built_in">alias</span> pecl74=<span class="string">'/usr/local/opt/php@7.4/bin/pecl'</span></span><br><span class="line"><span class="built_in">alias</span> pecl80=<span class="string">'/usr/local/opt/php/bin/pecl'</span></span><br><span class="line"><span class="comment"># composer alias</span></span><br><span class="line"><span class="built_in">alias</span> composer53=<span class="string">'php53 /usr/local/bin/composer'</span></span><br><span class="line"><span class="built_in">alias</span> composer70=<span class="string">'php70 /usr/local/bin/composer'</span></span><br><span class="line"><span class="built_in">alias</span> composer71=<span class="string">'php71 /usr/local/bin/composer'</span></span><br><span class="line"><span class="built_in">alias</span> composer72=<span class="string">'php72 /usr/local/bin/composer'</span></span><br><span class="line"><span class="built_in">alias</span> composer73=<span class="string">'php73 /usr/local/bin/composer'</span></span><br><span class="line"><span class="built_in">alias</span> composer74=<span class="string">'php74 /usr/local/bin/composer'</span></span><br><span class="line"><span class="built_in">alias</span> composer80=<span class="string">'php80 /usr/local/bin/composer'</span></span><br><span class="line"><span class="comment"># 切换版本</span></span><br><span class="line"><span class="built_in">alias</span> use-php53=<span class="string">'unlink-php; brew link --overwrite --force php@5.3 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php54=<span class="string">'unlink-php; brew link --overwrite --force php@5.4 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php55=<span class="string">'unlink-php; brew link --overwrite --force php@5.5 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php56=<span class="string">'unlink-php; brew link --overwrite --force php@5.6 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php70=<span class="string">'unlink-php; brew link --overwrite --force php@7.0 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php71=<span class="string">'unlink-php; brew link --overwrite --force php@7.1 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php72=<span class="string">'unlink-php; brew link --overwrite --force php@7.2 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php73=<span class="string">'unlink-php; brew link --overwrite --force php@7.3 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php74=<span class="string">'unlink-php; brew link --overwrite --force php@7.4 &amp;&amp; php -v'</span></span><br><span class="line"><span class="built_in">alias</span> use-php80=<span class="string">'unlink-php; brew link --overwrite --force php &amp;&amp; php -v'</span></span><br></pre></td></tr></table></figure><p>后面可以通过 <code>use-php[version]</code> 随意切换版本，或者直接用 <code>php[version]</code> 执行。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> macos </tag>
            
            <tag> brew </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019如何更新packagist github-hook</title>
      <link href="/update-packagist-github-hook-2019/"/>
      <url>/update-packagist-github-hook-2019/</url>
      
        <content type="html"><![CDATA[<p>去年（2018）Packagist 就有提醒：</p><blockquote><p>This package is using the legacy GitHub service and will stop being auto-updated in early 2019. Please set up the new GitHub Hook for Packagist so that it keeps working in the future.</p></blockquote><p>大概意思是旧的 GitHub WebHook 被放弃了，请大家更新最新版，目前网上没有比较详细的说明，自己摸索了一下：</p><ol><li>打开 <a href="https://packagist.org/profile/edit" target="_blank" rel="noopener">https://packagist.org/profile/edit</a> ，看是否绑定了 GitHub Account ，如果没有直接绑定。如果绑定过，解除重新绑定（因为要重新授权）。</li><li>打开 <a href="https://github.com/your-github-account/your-project/settings/hooks" target="_blank" rel="noopener">https://github.com/your-github-account/your-project/settings/hooks</a> ，删除旧的 WebHook（Don’t ask why，just do it）。</li><li>回到 <a href="https://packagist.org/profile/" target="_blank" rel="noopener">https://packagist.org/profile/</a> ，点击 <code>retry hook sync</code> 重新同步 WebHook。</li><li>再次查看 GitHub WebHook 的时候发现已经自动配置好了，packagist 对应的项目页面也没有 <code>WebHook</code> 相关提示了。</li></ol><blockquote><p>发布新的 package 也只需要点击 <code>retry hook sync</code> 就可以自动绑定了，不需要手动添加。</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>10个常见的Redis面试&quot;刁难&quot;问题</title>
      <link href="/ten-questions-of-redis/"/>
      <url>/ten-questions-of-redis/</url>
      
        <content type="html"><![CDATA[<blockquote><p>导读：在程序员面试过程中Redis相关的知识是常被问到的话题。作为一名在互联网技术行业打击过成百上千名的资深技术面试官，本文作者总结了面试过程中经常问到的问题。十分值得一读。</p></blockquote><blockquote><p>作者简介：钱文品（老钱），互联网分布式高并发技术十年老兵，目前任掌阅科技资深后端工程师。熟练使用 Java、Python、Golang 等多种计算机语言，开发过游戏，制作过网站，写过消息推送系统和MySQL 中间件，实现过开源的 ORM 框架、Web 框架、RPC 框架等</p></blockquote><p><code>Redis</code>在互联网技术存储方面使用如此广泛，几乎所有的后端技术面试官都要在<code>Redis</code>的使用和原理方面对小伙伴们进行各种刁难。作为一名在互联网技术行业打击过成百上千名【请允许我夸张一下】的资深技术面试官，看过了无数落寞的身影失望的离开，略感愧疚，故献上此文，希望各位读者以后面试势如破竹，永无失败！</p><a id="more"></a><h1 id="Redis有哪些数据结构？"><a href="#Redis有哪些数据结构？" class="headerlink" title="Redis有哪些数据结构？"></a>Redis有哪些数据结构？</h1><p><code>字符串String</code>、<code>字典Hash</code>、<code>列表List</code>、<code>集合Set</code>、<code>有序集合SortedSet</code>。</p><p>如果你是Redis中高级用户，还需要加上下面几种数据结构<code>HyperLogLog</code>、<code>Geo</code>、<code>Pub/Sub</code>。</p><p>如果你说还玩过<code>Redis Module</code>，像<code>BloomFilter</code>，<code>RedisSearch</code>，<code>Redis-ML</code>，面试官得眼睛就开始发亮了。</p><h1 id="使用过Redis分布式锁么，它是什么回事？"><a href="#使用过Redis分布式锁么，它是什么回事？" class="headerlink" title="使用过Redis分布式锁么，它是什么回事？"></a>使用过Redis分布式锁么，它是什么回事？</h1><p>先拿<code>setnx</code>来争抢锁，抢到之后，再用<code>expire</code>给锁加一个过期时间防止锁忘记了释放。</p><p>这时候对方会告诉你说你回答得不错，然后接着问如果在<code>setnx</code>之后执行<code>expire</code>之前进程意外crash或者要重启维护了，那会怎么样？</p><p>这时候你要给予惊讶的反馈：唉，是喔，这个锁就永远得不到释放了。紧接着你需要抓一抓自己得脑袋，故作思考片刻，好像接下来的结果是你主动思考出来的，然后回答：我记得<code>set</code>指令有非常复杂的参数，这个应该是可以同时把<code>setnx</code>和<code>expire</code>合成一条指令来用的！对方这时会显露笑容，心里开始默念：摁，这小子还不错。</p><h1 id="假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？"><a href="#假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？" class="headerlink" title="假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？"></a>假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？</h1><p>使用keys指令可以扫出指定模式的key列表。</p><p>对方接着追问：如果这个<code>redis</code>正在给线上的业务提供服务，那使用keys指令会有什么问题？</p><p>这个时候你要回答<code>redis</code>关键的一个特性：<code>redis</code>的单线程的。keys指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用<code>scan</code>指令，<code>scan</code>指令可以无阻塞的提取出指定模式的key列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用<code>keys</code>指令长。</p><h1 id="使用过Redis做异步队列么，你是怎么用的？"><a href="#使用过Redis做异步队列么，你是怎么用的？" class="headerlink" title="使用过Redis做异步队列么，你是怎么用的？"></a>使用过Redis做异步队列么，你是怎么用的？</h1><p>一般使用<code>list</code>结构作为队列，<code>rpush</code>生产消息，<code>lpop</code>消费消息。当<code>lpop</code>没有消息的时候，要适当<code>sleep</code>一会再重试。</p><p>如果对方追问可不可以不用<code>sleep</code>呢？<code>list</code>还有个指令叫<code>blpop</code>，在没有消息的时候，它会阻塞住直到消息到来。</p><p>如果对方追问能不能生产一次消费多次呢？使用<code>pub</code>/<code>sub</code>主题订阅者模式，可以实现<code>1:N</code>的消息队列。</p><p>如果对方追问<code>pub</code>/<code>sub</code>有什么缺点？在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如<code>rabbitmq</code>等。</p><p>如果对方追问<code>redis</code>如何实现延时队列？我估计现在你很想把面试官一棒打死如果你手上有一根棒球棍的话，怎么问的这么详细。但是你很克制，然后神态自若的回答道：使用<code>sortedset</code>，拿时间戳作为<code>score</code>，消息内容作为<code>key</code>调用<code>zadd</code>来生产消息，消费者用<code>zrangebyscore</code>指令获取N秒之前的数据轮询进行处理。</p><p>到这里，面试官暗地里已经对你竖起了大拇指。但是他不知道的是此刻你却竖起了中指，在椅子背后。</p><h1 id="如果有大量的key需要设置同一时间过期，一般需要注意什么？"><a href="#如果有大量的key需要设置同一时间过期，一般需要注意什么？" class="headerlink" title="如果有大量的key需要设置同一时间过期，一般需要注意什么？"></a>如果有大量的key需要设置同一时间过期，一般需要注意什么？</h1><p>如果大量的<code>key</code>过期时间设置的过于集中，到过期的那个时间点，redis可能会出现短暂的卡顿现象。一般需要在时间上加一个随机值，使得过期时间分散一些。</p><h1 id="Redis如何做持久化的？"><a href="#Redis如何做持久化的？" class="headerlink" title="Redis如何做持久化的？"></a>Redis如何做持久化的？</h1><p><code>bgsave</code>做镜像全量持久化，<code>aof</code>做增量持久化。因为<code>bgsave</code>会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要<code>aof</code>来配合使用。在<code>redis</code>实例重启时，优先使用<code>aof</code>来恢复内存的状态，如果没有<code>aof</code>日志，就会使用<code>rdb</code>文件来恢复。</p><p>如果再问<code>aof</code>文件过大恢复时间过长怎么办？你告诉面试官，<code>Redis</code>会定期做<code>aof</code>重写，压缩<code>aof</code>文件日志大小。如果面试官不够满意，再拿出杀手锏答案，<code>Redis4.0</code>之后有了混合持久化的功能，将<code>bgsave</code>的全量和<code>aof</code>的增量做了融合处理，这样既保证了恢复的效率又兼顾了数据的安全性。这个功能甚至很多面试官都不知道，他们肯定会对你刮目相看。</p><p>如果对方追问那如果突然机器掉电会怎样？取决于<code>aof</code>日志<code>sync</code>属性的配置，如果不要求性能，在每条写指令时都<code>sync</code>一下磁盘，就不会丢失数据。但是在高性能的要求下每次都<code>sync</code>是不现实的，一般都使用定时<code>sync</code>，比如<code>1s1次</code>，这个时候最多就会丢失1s的数据。</p><h1 id="Pipeline有什么好处，为什么要用pipeline？"><a href="#Pipeline有什么好处，为什么要用pipeline？" class="headerlink" title="Pipeline有什么好处，为什么要用pipeline？"></a>Pipeline有什么好处，为什么要用pipeline？</h1><p>可以将多次IO往返的时间缩减为一次，前提是<code>pipeline</code>执行的指令之间没有因果相关性。使用<code>redis-benchmark</code>进行压测的时候可以发现影响<code>redis</code>的<code>QPS</code>峰值的一个重要因素是<code>pipeline</code>批次指令的数目。</p><h1 id="Redis的同步机制了解么？"><a href="#Redis的同步机制了解么？" class="headerlink" title="Redis的同步机制了解么？"></a>Redis的同步机制了解么？</h1><p><code>Redis</code>可以使用主从同步，从从同步。第一次同步时，主节点做一次<code>bgsave</code>，并同时将后续修改操作记录到内存<code>buffer</code>，待完成后将<code>rdb</code>文件全量同步到复制节点，复制节点接受完成后将<code>rdb</code>镜像加载到内存。加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。</p><h1 id="是否使用过Redis集群，集群的原理是什么？"><a href="#是否使用过Redis集群，集群的原理是什么？" class="headerlink" title="是否使用过Redis集群，集群的原理是什么？"></a>是否使用过Redis集群，集群的原理是什么？</h1><p><code>Redis Sentinal</code>着眼于高可用，在<code>master</code>宕机时会自动将<code>slave</code>提升为<code>master</code>，继续提供服务。</p><p><code>Redis Cluster</code>着眼于扩展性，在单个<code>redis</code>内存不足时，使用<code>Cluster</code>进行分片存储。</p><p>原文：<a href="https://mp.weixin.qq.com/s/Z4a8wbWvPDGFTkKJH0X9VQ" target="_blank" rel="noopener">10个常见的Redis面试”刁难”问题</a></p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> 面试 </tag>
            
            <tag> 问题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Swoole实现即时聊天服务</title>
      <link href="/im-server-by-swoole/"/>
      <url>/im-server-by-swoole/</url>
      
        <content type="html"><![CDATA[<h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>就技术面而言，即时通讯对很多人或公司来说已经没有什么门槛，技术方案有如雨后春笋，也各有千秋，也有不少专业提供第三方服务的公司，如<code>云信</code>、<code>融云</code>等等，几个大厂（<code>阿里云</code>、<code>腾讯云</code>）也有提供云服务。</p><a id="more"></a><p>这里要讲一下的是第三方功能非常强大，也兼容各个平台，但是灵活性不够个性需求无法定制。</p><p>刚提到技术上已经没有门槛，开源的项目也有不少，基本都是基于<code>长连接+轮询</code>或<code>websocket</code>，长连接的代表有<code>iComet</code>，而<code>websocket</code>的代表有<code>Swoole</code>。</p><p>花了半天写了个demo，先看看需求：</p><blockquote><ul><li>支持点对点聊天</li><li>同一账号支持多端，能同时受到信息</li></ul></blockquote><p>TODO</p><blockquote><ul><li>支持消息广播</li><li>支持离线消息</li></ul></blockquote><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FdMapping</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $redis;</span><br><span class="line">    <span class="keyword">const</span> MAP_UID_FD_PREFIX = <span class="string">'chat_map_uid_fd:'</span>;</span><br><span class="line">    <span class="keyword">const</span> MAP_FD_UID_PREFIX = <span class="string">'chat_map_fd_uid:'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($redis_host = <span class="string">'127.0.0.1'</span>, $redis_port = <span class="number">6379</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redis = <span class="keyword">new</span> Redis();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redis-&gt;connect($redis_host, $redis_port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uid与fd对应，支持多端/多页面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uidBindFd</span><span class="params">($uid, $fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redis-&gt;sadd(</span><br><span class="line">            <span class="keyword">self</span>::MAP_UID_FD_PREFIX . $uid,</span><br><span class="line">            $fd</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fd与uid对应</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fdBindUid</span><span class="params">($fd, $uid)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redis-&gt;setex(</span><br><span class="line">            <span class="keyword">self</span>::MAP_FD_UID_PREFIX . $fd,</span><br><span class="line">            <span class="number">24</span> * <span class="number">3600</span>,</span><br><span class="line">            $uid</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取fd对应的uid</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUidByFd</span><span class="params">($fd)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redis-&gt;get(<span class="keyword">self</span>::MAP_FD_UID_PREFIX . $fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取uid全部fd，确保多端都能收到信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFdsByUid</span><span class="params">($uid)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;redis-&gt;sMembers(<span class="keyword">self</span>::MAP_UID_FD_PREFIX . $uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除uid的某个fd</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delFd</span><span class="params">($fd, $uid = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($uid)) &#123;</span><br><span class="line">            $uid = <span class="keyword">$this</span>-&gt;getUidByFd($fd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redis-&gt;srem(<span class="keyword">self</span>::MAP_UID_FD_PREFIX . $uid, $fd);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redis-&gt;del(<span class="keyword">self</span>::MAP_FD_UID_PREFIX . $fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$FdMapping = <span class="keyword">new</span> FdMapping(<span class="string">'127.0.0.1'</span>);</span><br><span class="line">$server    = <span class="keyword">new</span> swoole_websocket_server(<span class="string">"127.0.0.1"</span>, <span class="number">9502</span>);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span><span class="params">($server, $req)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"新连接: #&#123;$req-&gt;fd&#125;\n"</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">($server, $frame)</span> <span class="title">use</span> <span class="params">($FdMapping)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"接收到: "</span> . json_encode($frame-&gt;data) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment">// 解析json为array</span></span><br><span class="line">    $data = json_decode($frame-&gt;data, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 处理不同的消息类型</span></span><br><span class="line">    <span class="keyword">switch</span> ($data[<span class="string">'type'</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'sign'</span>:</span><br><span class="line">            <span class="comment">// 设置uid与fd对应关系</span></span><br><span class="line">            $FdMapping-&gt;uidBindFd($data[<span class="string">'uid'</span>], $frame-&gt;fd);</span><br><span class="line">            $FdMapping-&gt;fdBindUid($frame-&gt;fd, $data[<span class="string">'uid'</span>]);</span><br><span class="line">            <span class="comment">// 清理过期/已断开的连接</span></span><br><span class="line">            $fds = $FdMapping-&gt;getFdsByUid($data[<span class="string">'uid'</span>]);</span><br><span class="line">            <span class="keyword">foreach</span> ((<span class="keyword">array</span>)$fds <span class="keyword">as</span> $fd) &#123;</span><br><span class="line">                !$server-&gt;exist($fd) &amp;&amp; $FdMapping-&gt;delFd($fd, $data[<span class="string">'uid'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回注册成功信息，token未验证</span></span><br><span class="line">            $server-&gt;push(</span><br><span class="line">                $frame-&gt;fd,</span><br><span class="line">                json_encode([</span><br><span class="line">                    <span class="string">'status'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                    <span class="string">'msg'</span>    =&gt; <span class="string">'注册成功'</span>,</span><br><span class="line">                    <span class="string">'token'</span>  =&gt; md5(time()), <span class="comment">// 可用于连接合法性验证</span></span><br><span class="line">                ])</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'msg'</span>:</span><br><span class="line">            $data[<span class="string">'from'</span>] = $FdMapping-&gt;getUidByFd($frame-&gt;fd);</span><br><span class="line">            <span class="comment">// 验证是否已经注册</span></span><br><span class="line">            <span class="keyword">if</span> (!$data[<span class="string">'from'</span>]) &#123;</span><br><span class="line">                $server-&gt;push(</span><br><span class="line">                    $frame-&gt;fd,</span><br><span class="line">                    json_encode([</span><br><span class="line">                        <span class="string">'status'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                        <span class="string">'msg'</span>    =&gt; <span class="string">'发送失败，未登入'</span>,</span><br><span class="line">                    ])</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将消息推送到uid各端</span></span><br><span class="line">            $fds = $FdMapping-&gt;getFdsByUid($data[<span class="string">'to'</span>]);</span><br><span class="line">            <span class="keyword">foreach</span> ((<span class="keyword">array</span>) $fds <span class="keyword">as</span> $fd) &#123;</span><br><span class="line">                $server-&gt;exist($fd) &amp;&amp; $server-&gt;push(</span><br><span class="line">                    $fd,</span><br><span class="line">                    json_encode([</span><br><span class="line">                        <span class="string">'body'</span> =&gt; $data[<span class="string">'body'</span>],</span><br><span class="line">                        <span class="string">'from'</span> =&gt; $data[<span class="string">'from'</span>],</span><br><span class="line">                    ])</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"#&#123;$fd&#125; 推送成功\n"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 告知推送成功</span></span><br><span class="line">            $server-&gt;push($frame-&gt;fd, json_encode([<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'msg'</span> =&gt; <span class="string">'sended'</span>]));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 非法请求</span></span><br><span class="line">            $server-&gt;push(</span><br><span class="line">                $frame-&gt;fd,</span><br><span class="line">                json_encode([</span><br><span class="line">                    <span class="string">'status'</span>     =&gt; <span class="number">0</span>,</span><br><span class="line">                    <span class="string">'msg'</span>        =&gt; <span class="string">'非法请求'</span>,</span><br><span class="line">                    <span class="string">'disconnect'</span> =&gt; <span class="number">1</span>, <span class="comment">// 告知终端请断开</span></span><br><span class="line">                ])</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">($server, $fd)</span> <span class="title">use</span> <span class="params">($FdMapping)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"连接断开: #&#123;$fd&#125;\n"</span>;</span><br><span class="line">    $FdMapping-&gt;delFd($fd);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:9502"</span>);</span><br><span class="line"></span><br><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Connection open ..."</span>);</span><br><span class="line">    ws.send(<span class="string">'&#123;"type":"sign", "uid":"1001"&#125;'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Received Message: "</span> + evt.data);</span><br><span class="line">    <span class="comment">// ws.close();</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ws.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Connection closed."</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swoole </tag>
            
            <tag> chat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>第三方应用共享Laravel项目Session</title>
      <link href="/share-laravel-session-on-third-party-application/"/>
      <url>/share-laravel-session-on-third-party-application/</url>
      
        <content type="html"><![CDATA[<p>Laravel 框架越来越被PHP开发者青睐，被应用得越来越广泛，大家都恨不得全部用它来重构项目，boss们当然不会同意，但是我们作为工程师也是不会放弃的，那要怎么办呢？</p><p>没错，按模块拆分重构，比如<code>注册</code>、<code>登入</code>等小模块先重构。</p><a id="more"></a><p><img src="http://www.315che.net/uploads/allimg/170329/225TQ495-0.jpg" alt="撸起袖子加油干"></p><p>一鼓作气，写完了发现<code>Session</code>不兼容，去Google百度了一下，也没找到什么好方案，没办法自己分析一下。</p><h2 id="先看一下Laravel写的Session是什么"><a href="#先看一下Laravel写的Session是什么" class="headerlink" title="先看一下Laravel写的Session是什么"></a>先看一下Laravel写的Session是什么</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:<span class="number">207</span>:<span class="string">"a:4:&#123;s:3:"</span>abc<span class="string">";i:1531800464;s:6:"</span>_token<span class="string">";s:40:"</span>SPhvkWipry9tCxLrU431ueWE8iHBaMkOMU0acQV6<span class="string">";s:9:"</span>_previous<span class="string">";a:1:&#123;s:3:"</span>url<span class="string">";s:26:"</span>http:<span class="comment">//yourdomain.com/";&#125;s:6:"_flash";a:2:&#123;s:3:"old";a:0:&#123;&#125;s:3:"new";a:0:&#123;&#125;&#125;&#125;";</span></span><br></pre></td></tr></table></figure><p>是不是很眼熟？没错，是PHP的序列化，要注意的是2次序列化。我们来验证一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$sessData = <span class="string">&lt;&lt;&lt;DATA</span></span><br><span class="line"><span class="string">s:207:"a:4:&#123;s:3:"abc";i:1531800464;s:6:"_token";s:40:"SPhvkWipry9tCxLrU431ueWE8iHBaMkOMU0acQV6";s:9:"_previous";a:1:&#123;s:3:"url";s:26:"http://yourdomain.com/";&#125;s:6:"_flash";a:2:&#123;s:3:"old";a:0:&#123;&#125;s:3:"new";a:0:&#123;&#125;&#125;&#125;";</span></span><br><span class="line"><span class="string">DATA;</span></span><br><span class="line"></span><br><span class="line">$sessData = unserialize(unserialize($sessData));</span><br><span class="line">var_dump($sessData);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">array (</span></span><br><span class="line"><span class="comment">  'abc' =&gt; 1531800527,</span></span><br><span class="line"><span class="comment">  '_token' =&gt; 'SPhvkWipry9tCxLrU431ueWE8iHBaMkOMU0acQV6',</span></span><br><span class="line"><span class="comment">  '_previous' =&gt;</span></span><br><span class="line"><span class="comment">  array (</span></span><br><span class="line"><span class="comment">    'url' =&gt; 'http://yourdomain.com/',</span></span><br><span class="line"><span class="comment">  ),</span></span><br><span class="line"><span class="comment">  '_flash' =&gt;</span></span><br><span class="line"><span class="comment">  array (</span></span><br><span class="line"><span class="comment">    'old' =&gt;</span></span><br><span class="line"><span class="comment">    array (</span></span><br><span class="line"><span class="comment">    ),</span></span><br><span class="line"><span class="comment">    'new' =&gt;</span></span><br><span class="line"><span class="comment">    array (</span></span><br><span class="line"><span class="comment">    ),</span></span><br><span class="line"><span class="comment">  ),</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h2 id="设置Laravel-Session配置，为共享准备"><a href="#设置Laravel-Session配置，为共享准备" class="headerlink" title="设置Laravel Session配置，为共享准备"></a>设置Laravel Session配置，为共享准备</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/session.php</span></span><br><span class="line"><span class="string">'encrypt'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line"><span class="string">'cookie'</span>  =&gt; <span class="string">'PHPSESSID'</span>,</span><br><span class="line"><span class="string">'domain'</span>  =&gt; <span class="string">'yourdomain.com'</span>,</span><br></pre></td></tr></table></figure><h2 id="明文-Cookie"><a href="#明文-Cookie" class="headerlink" title="明文 Cookie"></a>明文 Cookie</h2><p>很多时候 <code>Cookie</code> 是需要被前端童鞋使用的，但是默认情况下 <code>Laravel</code> 在响应头中添加的 <code>Cookie</code> 信息是加密过的，类似 <code>eyJpdiI6IjRwOFMyTkl2aGs2TGt4OUcxYXRNXC9BPT0iLCJ2YWx1ZSI6IkpHN0Fqb0ZSaDFxVHE0OHdFRXdXMHc9PSIsIm1hYyI6Ijc2MTljZDVmZDI1Mjg5MTk3NTBlZGM0MzUxMjUyZjQ5MzcxOGE1MWU4Y2ViZTBlYTY5YWRjZjNkZjUwNzNkMDEifQ%3D%3D</code>，这种时候就得将那些需要 明文 传输的 <code>Cookie</code> 加入到 白名单 中去：</p><p>在 <code>/app/Http/Middleware/EncryptCookies.php</code> 中的 <code>$except</code> 数组中将其加入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $except = [</span><br><span class="line">    <span class="string">'PHPSESSID'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><h2 id="第三方应用兼容-Laravel"><a href="#第三方应用兼容-Laravel" class="headerlink" title="第三方应用兼容 Laravel"></a>第三方应用兼容 Laravel</h2><p>思路如下：</p><p>读取</p><blockquote><p>Redis取出（Laravel序列化数据，字符串）-&gt;<code>unserialize</code> * 2（得到数组）-&gt;<code>SessionSerializer::encode()</code>（得到序列化数据，字符串）-&gt;交给PHP内核处理</p></blockquote><p>写入</p><blockquote><p>PHP系列化数据-&gt;<code>SessionSerializer::decode()</code>（得到数组）-&gt;<code>serialize()</code> * 2-&gt;写入Redis</p></blockquote><p><img src="https://i.imgflip.com/1issnv.jpg" alt="图片"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PHP SESSION 序列化器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionSerializer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($array, $safe = true, $method = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $method = <span class="keyword">empty</span>($method) ? ini_get(<span class="string">"session.serialize_handler"</span>) : $method;</span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::serializePhp($array, $safe);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php_binary"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::serializePhpbinary($array, $safe);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Unsupported session.serialize_handler: "</span> . $method . <span class="string">". Supported: php, php_binary"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">serializePhp</span><span class="params">($array, $safe = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($safe) &#123;</span><br><span class="line">            $array = unserialize(serialize($array));</span><br><span class="line">        &#125;</span><br><span class="line">        $raw  = <span class="string">''</span>;</span><br><span class="line">        $line = <span class="number">0</span>;</span><br><span class="line">        $keys = array_keys($array);</span><br><span class="line">        <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key) &#123;</span><br><span class="line">            $value = $array[$key];</span><br><span class="line">            $line++;</span><br><span class="line">            $raw .= $key . <span class="string">'|'</span>;</span><br><span class="line">            <span class="keyword">if</span> (is_array($value) &amp;&amp; <span class="keyword">isset</span>($value[<span class="string">'huge_recursion_blocker_we_hope'</span>])) &#123;</span><br><span class="line">                $raw .= <span class="string">'R:'</span> . $value[<span class="string">'huge_recursion_blocker_we_hope'</span>] . <span class="string">';'</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $raw .= serialize($value);</span><br><span class="line">            &#125;</span><br><span class="line">            $array[$key] = [<span class="string">'huge_recursion_blocker_we_hope'</span> =&gt; $line];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $raw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">serializePhpbinary</span><span class="params">($array, $safe = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($session_data, $method = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $method = <span class="keyword">empty</span>($method) ? ini_get(<span class="string">"session.serialize_handler"</span>) : $method;</span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::unserializePhp($session_data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php_binary"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::unserializePhpbinary($session_data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Unsupported session.serialize_handler: "</span> . $method . <span class="string">". Supported: php, php_binary"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unserializePhp</span><span class="params">($session_data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $return_data = [];</span><br><span class="line">        $offset      = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ($offset &lt; strlen($session_data)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strstr(substr($session_data, $offset), <span class="string">"|"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Invalid data, remaining: "</span> . substr($session_data, $offset));</span><br><span class="line">            &#125;</span><br><span class="line">            $pos     = strpos($session_data, <span class="string">"|"</span>, $offset);</span><br><span class="line">            $num     = $pos - $offset;</span><br><span class="line">            $varname = substr($session_data, $offset, $num);</span><br><span class="line">            $offset += $num + <span class="number">1</span>;</span><br><span class="line">            $data                  = unserialize(substr($session_data, $offset));</span><br><span class="line">            $return_data[$varname] = $data;</span><br><span class="line">            $offset += strlen(serialize($data));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $return_data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unserializePhpbinary</span><span class="params">($session_data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $return_data = [];</span><br><span class="line">        $offset      = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ($offset &lt; strlen($session_data)) &#123;</span><br><span class="line">            $num = ord($session_data[$offset]);</span><br><span class="line">            $offset += <span class="number">1</span>;</span><br><span class="line">            $varname = substr($session_data, $offset, $num);</span><br><span class="line">            $offset += $num;</span><br><span class="line">            $data   = unserialize(substr($session_data, $offset));</span><br><span class="line">            $return_data[$varname] = $data;</span><br><span class="line">            $offset += strlen(serialize($data));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $return_data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redis Session 驱动</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionRedis</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $lifeTime     = <span class="number">900</span>;</span><br><span class="line">    <span class="comment">// Laravel项目中Session存储要求</span></span><br><span class="line">    <span class="keyword">protected</span> $sessionName  = <span class="string">'your_laravel_app_name:'</span>;</span><br><span class="line">    <span class="comment">// 共享cookie需要</span></span><br><span class="line">    <span class="keyword">protected</span> $cookieDomain = <span class="string">'yourdomain.com'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $handle       = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($savePath, $sessName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Redis;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;gc(ini_get(<span class="string">'session.gc_maxlifetime'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;close();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($sessID)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($sessID)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从Redis读取</span></span><br><span class="line">        $sessData = <span class="keyword">$this</span>-&gt;handle-&gt;get(<span class="keyword">$this</span>-&gt;sessionName . $sessID);</span><br><span class="line">        <span class="comment">// 按Laravel格式反序列化</span></span><br><span class="line">        $sessData = unserialize(unserialize($sessData));</span><br><span class="line">        <span class="comment">// 处理非法格式</span></span><br><span class="line">        $sessData = is_array($sessData) ? $sessData : [];</span><br><span class="line">        <span class="comment">// 按PHP内核需要格式序列化</span></span><br><span class="line">        $sessData = SessionSerializer::encode($sessData);</span><br><span class="line">        <span class="comment">// 注意这里需要返回的是序列化后的字符串</span></span><br><span class="line">        <span class="keyword">return</span> $sessData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessID, $sessData)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($sessID)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 反序列化为数组</span></span><br><span class="line">        $sessData = SessionSerializer::decode($sessData);</span><br><span class="line">        <span class="comment">// 按Laravel需要的格式序列化</span></span><br><span class="line">        $sessData = serialize(serialize($sessData));</span><br><span class="line">        <span class="comment">// 存入Redis</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle-&gt;setex(<span class="keyword">$this</span>-&gt;sessionName . $sessID, <span class="keyword">$this</span>-&gt;lifeTime, $sessData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($sessID)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($sessID)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle-&gt;delete(<span class="keyword">$this</span>-&gt;sessionName . $sessID);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">($sessMaxLifeTime)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ini_set(<span class="string">'session.cookie_domain'</span>, <span class="keyword">isset</span>($m[<span class="number">0</span>]) ? $m[<span class="number">0</span>] : <span class="keyword">$this</span>-&gt;cookieDomain);</span><br><span class="line">        ini_set(<span class="string">'session.auto_start'</span>, <span class="number">0</span>);</span><br><span class="line">        ini_set(<span class="string">'session.use_trans_sid'</span>, <span class="number">0</span>);</span><br><span class="line">        ini_set(<span class="string">'session.gc_probability'</span>, <span class="number">1</span>);</span><br><span class="line">        ini_set(<span class="string">'session.gc_divisor'</span>, <span class="number">1000</span>);</span><br><span class="line">        ini_set(<span class="string">'session.gc_maxlifetime'</span>, <span class="keyword">$this</span>-&gt;lifeTime);</span><br><span class="line">        ini_set(<span class="string">'session.use_cookies'</span>, <span class="number">1</span>);</span><br><span class="line">        ini_set(<span class="string">'session.cookie_path'</span>, <span class="string">'/'</span>);</span><br><span class="line">        session_module_name(<span class="string">'user'</span>);</span><br><span class="line">        session_set_save_handler(</span><br><span class="line">            <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'open'</span>),</span><br><span class="line">            <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'close'</span>),</span><br><span class="line">            <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'read'</span>),</span><br><span class="line">            <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'write'</span>),</span><br><span class="line">            <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'destroy'</span>),</span><br><span class="line">            <span class="keyword">array</span>(&amp;<span class="keyword">$this</span>, <span class="string">'gc'</span>)</span><br><span class="line">        );</span><br><span class="line">        session_start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> SessionRedis())-&gt;start();</span><br></pre></td></tr></table></figure><h2 id="Laravel-兼容第三方应用"><a href="#Laravel-兼容第三方应用" class="headerlink" title="Laravel 兼容第三方应用"></a>Laravel 兼容第三方应用</h2><p>以 <code>Memcache</code> 为例</p><blockquote><p>服务器记得编译 <code>memcache</code> 扩展</p></blockquote><h3 id="增加-session-驱动"><a href="#增加-session-驱动" class="headerlink" title="增加 session 驱动"></a>增加 session 驱动</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Extensions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Memcache</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MemcacheSessionHandler</span> <span class="keyword">implements</span> \<span class="title">SessionHandlerInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $handle      = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> $sessionName = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">protected</span> $lifeTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sessionName = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lifeTime    = config(<span class="string">'session.lifetime'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle      = <span class="keyword">new</span> Memcache;</span><br><span class="line"></span><br><span class="line">        collect(config(<span class="string">'cache.stores.memcached.servers'</span>))-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($server)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle-&gt;addServer($server[<span class="string">'host'</span>], $server[<span class="string">'port'</span>], <span class="keyword">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($savePath, $sessionName)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle-&gt;close();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($sessionId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($sessionId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;handle-&gt;get(<span class="keyword">$this</span>-&gt;sessionName . $sessionId);</span><br><span class="line">        <span class="comment">// info($data, ['format' =&gt; 'php']);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// php -&gt; laravel</span></span><br><span class="line">        $data = <span class="keyword">self</span>::decode($data);</span><br><span class="line">        $data = serialize($data);</span><br><span class="line">        <span class="comment">// info($data, ['format' =&gt; 'laravel']);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessionId, $data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($sessionId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// info($data, ['format' =&gt; 'laravel']);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// laravel-&gt;php</span></span><br><span class="line">        $data = unserialize($data);</span><br><span class="line">        $data = <span class="keyword">self</span>::encode($data);</span><br><span class="line">        <span class="comment">// info($data, ['format' =&gt; 'php']);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle-&gt;set(<span class="keyword">$this</span>-&gt;sessionName . $sessionId, $data, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;lifeTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($sessionId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($sessionId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle-&gt;delete(<span class="keyword">$this</span>-&gt;sessionName . $sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">($lifetime)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">($array, $safe = true, $method = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $method = <span class="keyword">empty</span>($method) ? ini_get(<span class="string">"session.serialize_handler"</span>) : $method;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::serializePhp($array, $safe);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php_binary"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::serializePhpbinary($array, $safe);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Unsupported session.serialize_handler: "</span> . $method . <span class="string">". Supported: php, php_binary"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">serializePhp</span><span class="params">($array, $safe = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($safe) &#123;</span><br><span class="line">            $array = unserialize(serialize($array));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $raw  = <span class="string">''</span>;</span><br><span class="line">        $line = <span class="number">0</span>;</span><br><span class="line">        $keys = array_keys($array);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key) &#123;</span><br><span class="line">            $value = $array[$key];</span><br><span class="line">            $line++;</span><br><span class="line">            $raw .= $key . <span class="string">'|'</span>;</span><br><span class="line">            <span class="keyword">if</span> (is_array($value) &amp;&amp; <span class="keyword">isset</span>($value[<span class="string">'huge_recursion_blocker_we_hope'</span>])) &#123;</span><br><span class="line">                $raw .= <span class="string">'R:'</span> . $value[<span class="string">'huge_recursion_blocker_we_hope'</span>] . <span class="string">';'</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $raw .= serialize($value);</span><br><span class="line">            &#125;</span><br><span class="line">            $array[$key] = [<span class="string">'huge_recursion_blocker_we_hope'</span> =&gt; $line];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $raw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">serializePhpbinary</span><span class="params">($array, $safe = true)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($session_data, $method = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $method = <span class="keyword">empty</span>($method) ? ini_get(<span class="string">"session.serialize_handler"</span>) : $method;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::unserializePhp($session_data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"php_binary"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>::unserializePhpbinary($session_data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Unsupported session.serialize_handler: "</span> . $method . <span class="string">". Supported: php, php_binary"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unserializePhp</span><span class="params">($session_data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $return_data = [];</span><br><span class="line">        $offset      = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ($offset &lt; strlen($session_data)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strstr(substr($session_data, $offset), <span class="string">"|"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Invalid data, remaining: "</span> . substr($session_data, $offset));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $pos     = strpos($session_data, <span class="string">"|"</span>, $offset);</span><br><span class="line">            $num     = $pos - $offset;</span><br><span class="line">            $varname = substr($session_data, $offset, $num);</span><br><span class="line">            $offset += $num + <span class="number">1</span>;</span><br><span class="line">            $data                  = unserialize(substr($session_data, $offset));</span><br><span class="line">            $return_data[$varname] = $data;</span><br><span class="line">            $offset += strlen(serialize($data));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $return_data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unserializePhpbinary</span><span class="params">($session_data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $return_data = [];</span><br><span class="line">        $offset      = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ($offset &lt; strlen($session_data)) &#123;</span><br><span class="line">            $num = ord($session_data[$offset]);</span><br><span class="line">            $offset += <span class="number">1</span>;</span><br><span class="line">            $varname = substr($session_data, $offset, $num);</span><br><span class="line">            $offset += $num;</span><br><span class="line">            $data                  = unserialize(substr($session_data, $offset));</span><br><span class="line">            $return_data[$varname] = $data;</span><br><span class="line">            $offset += strlen(serialize($data));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $return_data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="扩展驱动"><a href="#扩展驱动" class="headerlink" title="扩展驱动"></a>扩展驱动</h3><p>编辑 app\AppServiceProvider.php，在 <code>boot()</code> 方法增加以下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Session::extend(<span class="string">'memcache'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> \App\Extensions\MemcacheSessionHandler;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改驱动"><a href="#修改驱动" class="headerlink" title="修改驱动"></a>修改驱动</h3><p>编辑或增加 <code>.env</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SESSION_DRIVER=memcache</span><br><span class="line">SESSION_LIFETIME=120</span><br><span class="line">SESSION_DOMAIN=.a.com</span><br></pre></td></tr></table></figure><h2 id="特别注意"><a href="#特别注意" class="headerlink" title="特别注意 !!!!"></a>特别注意 <code>!!!!</code></h2><p>如果第三方应用 PHP 版本低于 <code>7.0</code>，需要设置 session_id 长度与 Laravel 项目（session_id 长度为 40）的一致</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PHP_VERSION &lt; 7.0</span></span><br><span class="line">ini_set(<span class="string">'session.hash_function'</span>, <span class="number">1</span>);</span><br><span class="line">ini_set(<span class="string">'session.hash_bits_per_character'</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure><p>Laravel 设置认证信息也需注意，<code>auth()-&gt;login($user)</code> 会更新 session_id，可以改用 <code>auth()-&gt;setUser($user)</code></p><p>最后，如果你有更好的方案，请留言给我，一起交流共同进步。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> laravel </tag>
            
            <tag> session </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>修复MacOS Mojave dev beta1无法正常显示checkbox问题</title>
      <link href="/mojave-checkbox-fix/"/>
      <url>/mojave-checkbox-fix/</url>
      
        <content type="html"><![CDATA[<p><a href="https://chrome.google.com/webstore/detail/mojave-checkbox-fix/ihlgehdlkphgngjfagonbeoepadbdaae/reviews" target="_blank" rel="noopener">mojave-checkbox-fix</a></p><blockquote><p>just installed this, easy fix. Just need to remember to uninstall it once it’s working correctly.</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> chrome </tag>
            
            <tag> mojave </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ES报错Result window is too large问题处理</title>
      <link href="/elasticsearch-result-window-is-too-large/"/>
      <url>/elasticsearch-result-window-is-too-large/</url>
      
        <content type="html"><![CDATA[<p>我在使用Elasticsearch进行search查询的过程中，出现了Result window is too large问题。</p><blockquote><p>Result window is too large, from + size must be less than or equal to: [10000] but was [43155]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.</p></blockquote><a id="more"></a><p>从上面的报错信息，可以看到ES提示我结果窗口太大了，目前最大值为<code>10000</code>，而我却要求给我<code>43155</code>。并且在后面也提到了要求我修改<code>index.max_result_window</code>参数来增大结果窗口大小。</p><p>修改方法，命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -H <span class="string">"Content-Type: application/json"</span> http://192.168.8.82:9200/indexName/_settings -d <span class="string">'&#123;"index" : &#123;"max_result_window" : 100000000&#125;&#125;'</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> es </tag>
            
            <tag> elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让Lumen支持请求控制</title>
      <link href="/lumen-support-throttle-requests/"/>
      <url>/lumen-support-throttle-requests/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Lumen 是你构建微服务架构和 <code>API</code> 应用的完美解决方案，事实上，她是全宇宙最快的框架之一，甚至要快过以速度著称的 <code>Silex</code> 和 <code>Slim</code>，现在，为你的 <code>Laravel</code> 应用程序编写微服务架构变得再简单不过了。</p></blockquote><p>但是你在使用的过程中，你会发现很多 <code>Laravel</code> 中好用的功能都被精简了，比如说请求控制中间件 <code>Throttle</code>。这个中间件能简单的实现请求控制。那么接下来跟我一起为 <code>Lumen</code> 重新添加这么好用的功能吧。</p><a id="more"></a><h2 id="从-Laravel-移植"><a href="#从-Laravel-移植" class="headerlink" title="从 Laravel 移植"></a>从 Laravel 移植</h2><p><a href="https://github.com/laravel/framework/blob/5.2/src/Illuminate/Routing/Middleware/ThrottleRequests.php" target="_blank" rel="noopener">GitHub地址</a></p><p>保存为 <code>app/Http/Middleware/ThrottleRequests.php</code>，别忘了修改 <code>namespace</code> 为 <code>App\Http\Middleware</code>，完整代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Cache</span>\<span class="title">RateLimiter</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThrottleRequests</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The rate limiter instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Cache\RateLimiter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $limiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new request throttler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Cache\RateLimiter  $limiter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(RateLimiter $limiter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;limiter = $limiter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $decayMinutes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $maxAttempts = <span class="number">60</span>, $decayMinutes = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = <span class="keyword">$this</span>-&gt;resolveRequestSignature($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;limiter-&gt;tooManyAttempts($key, $maxAttempts, $decayMinutes)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildResponse($key, $maxAttempts);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;limiter-&gt;hit($key, $decayMinutes);</span><br><span class="line"></span><br><span class="line">        $response = $next($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addHeaders(</span><br><span class="line">            $response, $maxAttempts,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;calculateRemainingAttempts($key, $maxAttempts)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolve request signature.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveRequestSignature</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// return $request-&gt;fingerprint();</span></span><br><span class="line">        <span class="comment">// Lumen 版本缺少 Request::fingerprint 方法</span></span><br><span class="line">        <span class="keyword">return</span> sha1(</span><br><span class="line">            $request-&gt;method() .</span><br><span class="line">            <span class="string">'|'</span> . $request-&gt;server(<span class="string">'SERVER_NAME'</span>) .</span><br><span class="line">            <span class="string">'|'</span> . $request-&gt;path() .</span><br><span class="line">            <span class="string">'|'</span> . $request-&gt;ip()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a 'too many attempts' response.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildResponse</span><span class="params">($key, $maxAttempts)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = <span class="keyword">new</span> Response(<span class="string">'Too Many Attempts.'</span>, <span class="number">429</span>);</span><br><span class="line"></span><br><span class="line">        $retryAfter = <span class="keyword">$this</span>-&gt;limiter-&gt;availableIn($key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addHeaders(</span><br><span class="line">            $response, $maxAttempts,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;calculateRemainingAttempts($key, $maxAttempts, $retryAfter),</span><br><span class="line">            $retryAfter</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add the limit header information to the given response.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Symfony\Component\HttpFoundation\Response  $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $remainingAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|null  $retryAfter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Http\Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addHeaders</span><span class="params">(Response $response, $maxAttempts, $remainingAttempts, $retryAfter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $headers = [</span><br><span class="line">            <span class="string">'X-RateLimit-Limit'</span>     =&gt; $maxAttempts,</span><br><span class="line">            <span class="string">'X-RateLimit-Remaining'</span> =&gt; $remainingAttempts,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!is_null($retryAfter)) &#123;</span><br><span class="line">            $headers[<span class="string">'Retry-After'</span>] = $retryAfter;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $response-&gt;headers-&gt;add($headers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Calculate the number of remaining attempts.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|null  $retryAfter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateRemainingAttempts</span><span class="params">($key, $maxAttempts, $retryAfter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_null($retryAfter)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;limiter-&gt;retriesLeft($key, $maxAttempts);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注册中间件"><a href="#注册中间件" class="headerlink" title="注册中间件"></a>注册中间件</h2><p>找到 <code>bootstrap/app.php</code> 文件，添加：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$app-&gt;routeMiddleware([</span><br><span class="line">    <span class="string">'throttle'</span> =&gt; App\Http\Middleware\ThrottleRequests::class,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h2 id="更新-composer"><a href="#更新-composer" class="headerlink" title="更新 composer"></a>更新 composer</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer dump-autoload</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>找到 <code>routes/web.php</code>，修改 or 添加</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认速率是60请求/分钟</span></span><br><span class="line">$router-&gt;group([<span class="string">'prefix'</span> =&gt; <span class="string">'api'</span>, <span class="string">'middleware'</span>=&gt;<span class="string">'throttle'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($router)</span> </span>&#123;</span><br><span class="line">    $router-&gt;get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $router-&gt;app-&gt;version();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 自定义速率是2请求/分钟</span></span><br><span class="line">$router-&gt;group([<span class="string">'prefix'</span> =&gt; <span class="string">'home'</span>, <span class="string">'middleware'</span>=&gt;<span class="string">'throttle:2,1'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($router)</span> </span>&#123;</span><br><span class="line">    $router-&gt;get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $router-&gt;app-&gt;version();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> lumen </tag>
            
            <tag> throttle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让Lumen支持Session</title>
      <link href="/lumen-support-session/"/>
      <url>/lumen-support-session/</url>
      
        <content type="html"><![CDATA[<p><a href="https://lumen.laravel-china.org/docs/5.3/authentication" target="_blank" rel="noopener">官方介绍</a></p><blockquote><p>Lumen 虽然与 Laravel 使用了相同的底层类库实现，但是因 Lumen 面向的是无状态 API 的开发，不支持 session，所以默认的配置不同。Lumen 必须使用无状态的机制来实现，如 API 令牌（Token）。</p></blockquote><p>也就是说Lumen内核已经剥离了Cookie、Session，如果需要使用到，需要增加安装，经过一阵折腾，终于整好了，顺便记录下来。</p><a id="more"></a><h2 id="增加session配置"><a href="#增加session配置" class="headerlink" title="增加session配置"></a>增加session配置</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="string">'driver'</span>          =&gt; <span class="string">'file'</span>,</span><br><span class="line">    <span class="string">'lifetime'</span>        =&gt; <span class="number">120</span>,</span><br><span class="line">    <span class="string">'expire_on_close'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'encrypt'</span>         =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'files'</span>           =&gt; storage_path(<span class="string">'framework/sessions'</span>),</span><br><span class="line">    <span class="string">'connection'</span>      =&gt; <span class="string">'session'</span>,</span><br><span class="line">    <span class="string">'table'</span>           =&gt; <span class="string">'sessions_laravel'</span>,</span><br><span class="line">    <span class="string">'store'</span>           =&gt; <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">'lottery'</span>         =&gt; [<span class="number">2</span>, <span class="number">100</span>],</span><br><span class="line">    <span class="string">'cookie'</span>          =&gt; <span class="string">'PHPSESSID'</span>,</span><br><span class="line">    <span class="string">'path'</span>            =&gt; <span class="string">'/'</span>,</span><br><span class="line">    <span class="string">'domain'</span>          =&gt; env(<span class="string">'SESSION_DOMAIN'</span>, <span class="keyword">null</span>),</span><br><span class="line">    <span class="string">'secure'</span>          =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'http_only'</span>       =&gt; <span class="keyword">true</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><h2 id="注册Session中间件及服务提供者"><a href="#注册Session中间件及服务提供者" class="headerlink" title="注册Session中间件及服务提供者"></a>注册Session中间件及服务提供者</h2><blockquote><p>修改bootstrap/app.php，增加以下内容</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册Session中间件</span></span><br><span class="line">$app-&gt;middleware([</span><br><span class="line">    \Illuminate\Session\Middleware\StartSession::class,</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// 注册Session服务提供者</span></span><br><span class="line">$app-&gt;register(Illuminate\Session\SessionServiceProvider::class);</span><br><span class="line"><span class="comment">// 加载Session配置</span></span><br><span class="line">$app-&gt;configure(<span class="string">'session'</span>);</span><br><span class="line"><span class="comment">// 注册容器（Lumen取消默认支持）</span></span><br><span class="line">$app-&gt;bind(<span class="string">'Illuminate\Session\SessionManager'</span>, <span class="string">'session'</span>);</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>编辑routes/web.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$router-&gt;get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    $key = <span class="string">'key'</span>;</span><br><span class="line">    <span class="keyword">if</span> (app(<span class="string">'session'</span>)-&gt;has($key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> app(<span class="string">'session'</span>)-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line">    app(<span class="string">'session'</span>)-&gt;put($key, <span class="string">'value'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'set session success'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p>生命的意义在于折腾！</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> lumen </tag>
            
            <tag> session </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让Lumen支持Cookie</title>
      <link href="/lumen-support-cookie/"/>
      <url>/lumen-support-cookie/</url>
      
        <content type="html"><![CDATA[<p><a href="https://lumen.laravel-china.org/docs/5.3/authentication" target="_blank" rel="noopener">官方介绍</a></p><blockquote><p>Lumen 虽然与 Laravel 使用了相同的底层类库实现，但是因 Lumen 面向的是无状态 API 的开发，不支持 session，所以默认的配置不同。Lumen 必须使用无状态的机制来实现，如 API 令牌（Token）。</p></blockquote><p>也就是说Lumen内核已经剥离了Cookie、Session，如果需要使用到，需要增加安装，经过一阵折腾，终于整好了，顺便记录下来。</p><a id="more"></a><h2 id="安装Cookie服务提供者"><a href="#安装Cookie服务提供者" class="headerlink" title="安装Cookie服务提供者"></a>安装Cookie服务提供者</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require illuminate/cookie</span><br></pre></td></tr></table></figure><h2 id="增加session配置"><a href="#增加session配置" class="headerlink" title="增加session配置"></a>增加session配置</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="string">'driver'</span>          =&gt; <span class="string">'file'</span>,</span><br><span class="line">    <span class="string">'lifetime'</span>        =&gt; <span class="number">120</span>,</span><br><span class="line">    <span class="string">'expire_on_close'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'encrypt'</span>         =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'files'</span>           =&gt; storage_path(<span class="string">'framework/sessions'</span>),</span><br><span class="line">    <span class="string">'connection'</span>      =&gt; <span class="string">'session'</span>,</span><br><span class="line">    <span class="string">'table'</span>           =&gt; <span class="string">'sessions_laravel'</span>,</span><br><span class="line">    <span class="string">'store'</span>           =&gt; <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">'lottery'</span>         =&gt; [<span class="number">2</span>, <span class="number">100</span>],</span><br><span class="line">    <span class="string">'cookie'</span>          =&gt; <span class="string">'PHPSESSID'</span>,</span><br><span class="line">    <span class="string">'path'</span>            =&gt; <span class="string">'/'</span>,</span><br><span class="line">    <span class="string">'domain'</span>          =&gt; env(<span class="string">'SESSION_DOMAIN'</span>, <span class="keyword">null</span>),</span><br><span class="line">    <span class="string">'secure'</span>          =&gt; <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">'http_only'</span>       =&gt; <span class="keyword">true</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><h2 id="注册Cookie服务提供者"><a href="#注册Cookie服务提供者" class="headerlink" title="注册Cookie服务提供者"></a>注册Cookie服务提供者</h2><blockquote><p>修改bootstrap/app.php，增加以下内容</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册Cookie服务提供者</span></span><br><span class="line">$app-&gt;register(Illuminate\Cookie\CookieServiceProvider::class);</span><br><span class="line"><span class="comment">// 加载session配置</span></span><br><span class="line">$app-&gt;configure(<span class="string">'session'</span>);</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>编辑routes/web.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Cookie</span>;</span><br><span class="line"></span><br><span class="line">$router-&gt;get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($router)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response($router-&gt;app-&gt;version())</span><br><span class="line">        -&gt;withCookie(Cookie::make(<span class="string">'cookie_key'</span>, <span class="string">'cookie_value'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p>生命的意义在于折腾！</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> lumen </tag>
            
            <tag> cookie </tag>
            
            <tag> composer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sphinx Ranking Mode(排序模式)</title>
      <link href="/sphinx-ranking-mode/"/>
      <url>/sphinx-ranking-mode/</url>
      
        <content type="html"><![CDATA[<h1 id="Ranking-overview-概览"><a href="#Ranking-overview-概览" class="headerlink" title="Ranking overview(概览)"></a>Ranking overview(概览)</h1><blockquote><p>Ranking (aka weighting) of the search results can be defined as a process of computing a so-called relevance (aka weight) for every given matched document with regards to a given query that matched it. So relevance is in the end just a number attached to every document that estimates how relevant the document is to the query. Search results can then be sorted based on this number and/or some additional parameters, so that the most sought after results would come up higher on the results page.</p></blockquote><p>排序(又名加权)，是基于请求匹配到的结果，计算所谓的相关性(又名权重)的一个程序。 相关性是请求结束后被附加在文档结果中的一个估算出来的数值,表示匹配的文档于请求的关键词相关的程度，然后搜索的结果就能基于这个数值和其他的一些附加的参数进行排序，这样大多数相关的结果就能排在前面。</p><a id="more"></a><blockquote><p>There is no single standard one-size-fits-all way to rank any document in any scenario. Moreover, there can not ever be such a way, because relevance is subjective. As in, what seems relevant to you might not seem relevant to me. Hence, in general case it’s not just hard to compute, it’s theoretically impossible.</p></blockquote><p>对排序来说，在任何场景中都没有适应所有的情况的标准，甚至可以说不可能有这种标准，因为相关性是一种很主观的东西，比如，对你来说相关性很强，对我来说却没有。因而一般很难去计算，理论上是不可能的。</p><blockquote><p>So ranking in Sphinx is configurable. It has a of a so-called . A ranker can formally be defined as a function that takes document and query as its input and produces a relevance value as output. In layman’s terms, a ranker controls exactly how (using which specific algorithm) will Sphinx assign weights to the document.</p></blockquote><p>在sphinx中， 排序其实是可配置的， 他有一个叫ranker(这里我翻译成排序器)的概念， 根据定义的方法， 把匹配的文档和请求作为输入，输出来一个相关性的值。 简而言之， 一个ranker可以精确的给每个文档计算出相关性的值。</p><blockquote><p>Previously, this ranking function was rigidly bound to the matching</p><ol><li>So in the legacy matching modes (that is, SPH_MATCH_ALL, SPH_MATCH_ANY, SPH_MATCH_PHRASE, and SPH_MATCH_BOOLEAN) you can not</li></ol><p>choose the ranker. You can only do that in the SPH_MATCH_EXTENDED</p><ol><li>(Which is the only mode in SphinxQL and the suggested mode in SphinxAPI anyway.) To choose a non-default ranker you can either use</li></ol><p>SetRankingMode() with SphinxAPI, or OPTION ranker clause in SELECT<br>statement when using SphinxQL.</p></blockquote><p>以前，相排序方法被硬性的于匹配模式绑定在一起， 所以在一些老的匹配模式中(比如 SPH_MATCH_ALL, SPH_MATCH_ANY, SPH_MATCH_PHRASE, and SPH_MATCH_BOOLEAN)， 你不能选择ranker(排序器)。你只能在SPH_MATCH_EXTENDED(这也是在sphinxsql和sphinxApi中被建议使用的唯一的一种模式)模式下选择。 如何选择一个非默认的ranker(排序器)，在SphinxApi中使用SetRankingMode()方法，在SphinxQL中设置ranker选项</p><blockquote><p>As a sidenote, legacy matching modes are internally implemented via the unified syntax anyway. When you use one of those modes, Sphinx just internally adjusts the query and sets the associated ranker, then executes the query using the very same unified code path.</p></blockquote><p>注意，老的匹配模式被内置了统一的语法，当你使用这些模式的时候，sphinx仅仅内部判断请求和设置相应的ranker,然后使用相同的代码路径去执行这些请求。</p><h1 id="Available-built-in-rankers-内置的ranker"><a href="#Available-built-in-rankers-内置的ranker" class="headerlink" title="Available built-in rankers(内置的ranker)"></a>Available built-in rankers(内置的ranker)</h1><blockquote><p>Sphinx ships with a number of built-in rankers suited for different</p><ol><li>A number of them uses two factors, phrase proximity (aka LCS) and BM25. Phrase proximity works on the keyword positions, while</li></ol><p>BM25 works on the keyword frequencies. Basically, the better the degree of the phrase match between the document body and the query, the higher is the phrase proximity (it maxes out when the document contains the entire query as a verbatim quote). And BM25 is higher when the document contains more rare words. We’ll save the detailed discussion for later.</p></blockquote><p>Sphinx 内置了一系列的ranker， 用于不同的目的。他们中都是基于两个因素， phrase proximity(又名LCS)和BM25， Phrase proximity用于表示关键字与关键字的位置有关， BM25于关键词的出现的频率有关。基本上， 请求与匹配的文档越接近， phrase proximity就越高(当文档完整的包含整个请求的关键字时最高)。当文档中包含的关键词越多，BM25就越高。我们稍候讨论这些细节</p><blockquote><p>Currently implemented rankers are:</p></blockquote><p>当前内置的ranker有：</p><blockquote><ol><li>SPH_RANK_PROXIMITY_BM25, the default ranking mode that uses and combines both phrase proximity and BM25 ranking.</li></ol></blockquote><ol><li>SPH_RANK_PROXIMITY_BM25, 默认的ranker,基于hrase proximity and BM25 ranking两个因素</li></ol><blockquote><ol start="2"><li>SPH_RANK_BM25, statistical ranking mode which uses BM25 ranking only (similar to most other full-text engines). This mode is faster but may result in worse quality on queries which contain more than 1 keyword.</li></ol></blockquote><ol start="2"><li>SPH_RANK_BM25， 当仅仅使用BM25这种排序因素的时候的模式(于大多数其他的全文引擎相似)，这种模式虽然快，但结果的质量不高，很多结果包含的关键词不止一个(即关键字越多，分值越高，但很多时候我们最想要的仅仅是一个完全命中的结果)</li></ol><blockquote><ol start="3"><li>SPH_RANK_NONE, no ranking mode. This mode is obviously the fastest. A weight of 1 is assigned to all matches. This is sometimes called boolean searching that just matches the documents but does not rank them.</li></ol></blockquote><ol start="3"><li>SPH_RANK_NONE 没有任何排序模式的模式，这种模式很明显最快， 所有匹配的文档的权重都是1， 有时候被成为布尔搜索，这种搜索仅仅搜索文档，但不会排序</li></ol><blockquote><ol start="4"><li>SPH_RANK_WORDCOUNT, ranking by the keyword occurrences count. This computes the per-field keyword occurrence counts, then multiplies them by field weights, and sums the resulting values.</li></ol></blockquote><ol start="4"><li>SPH_RANK_WORDCOUNT 根据关键字出现的次数排序，这种排序方式的计算是基于每个字段的关键字出现的次数，然后整合这些字段的权重得出的结果。</li></ol><blockquote><ol start="5"><li>SPH_RANK_PROXIMITY, added in version 0.9.9-rc1, returns raw phrase proximity value as a result. This mode is internally used to emulate SPH_MATCH_ALL queries.</li></ol></blockquote><blockquote><ol start="5"><li>SPH_RANK_PROXIMITY， 这种排序返回的是每个文档于请求的相似程度，这种模式被内置用来在SPH_MATCH_ALL匹配模式的时候排序</li></ol></blockquote><blockquote><ol start="6"><li>SPH_RANK_MATCHANY, added in version 0.9.9-rc1, returns rank as it was computed in SPH_MATCH_ANY mode earlier, and is internally used to emulate SPH_MATCH_ANY queries.</li></ol></blockquote><ol start="6"><li>SPH_RANK_MATCHANY， 早期的时候在SPH_MATCH_ANY匹配模式中使用， 返回相关值，在SPH_MATCH_ANY模式中内置的就是这种排序模式</li></ol><blockquote><ol start="7"><li>SPH_RANK_FIELDMASK, added in version 0.9.9-rc2, returns a 32-bit mask with N-th bit corresponding to N-th fulltext field, numbering from 0. The bit will only be set when the respective field has any keyword occurrences satisfying the query.</li></ol></blockquote><ol start="7"><li>SPH_RANK_FIELDMASK 返回一个32位的掩码， 每个位都对应一个相应的全文字段(不能应该要补零)， 从0开始， 只有当相应的字段有关键字出现的时候才会被置1</li></ol><blockquote><ol start="8"><li>SPH_RANK_SPH04, added in version 1.10-beta, is generally based on the default SPH_RANK_PROXIMITY_BM25 ranker, but additionally boosts the matches when they occur in the very beginning or the very end of a text field. Thus, if a field equals the exact query, SPH04 should rank it higher than a field that contains the exact query but is not equal to it. (For instance, when the query is “Hyde Park”, a document entitled “Hyde Park” should be ranked higher than a one entitled “Hyde Park, London” or “The Hyde Park Cafe”.)</li></ol></blockquote><ol start="8"><li>SPH_RANK_SPH04， 基于默认的SPH_RANK_PROXIMITY_BM25模式， 但假如匹配的文档的开头或者结尾出现了，那么这个文档的相关值就会提升，所以，如果某个文档的一个字段完全于请求的关键字一致， 那么这种模式下的排序的位置就应该比文档中包含请求关键字的文档高。(比如，如果请求的关键字是”Hyde Park”, “Hyde Park”的文档就会比”Hyde Park, London”或者”The Hyde Park Cafe”的排序高)</li></ol><blockquote><ol start="9"><li>SPH_RANK_EXPR, added in version 2.0.2-beta, lets you specify the ranking formula in run time. It exposes a number of internal text factors and lets you define how the final weight should be computed from those factors.</li></ol></blockquote><ol start="9"><li>SPH_RANK_EXPR 这种模式让你能在运行的时候指定排序规则， 他暴露了一系列的内置的文本的因素， 让你能基于这些因素计算出最终的权重</li></ol><blockquote><p>You should specify the SPH_RANK_ prefix and use capital letters only when using the SetRankingMode() call from the SphinxAPI. The API ports expose these as global constants. Using SphinxQL syntax, the prefix should be omitted and the ranker name is case insensitive.</p></blockquote><p>你可以指定一个SPH_RANK_为前缀的排序模式，要全部大写。在SphinxAPI中使用SetRankingMode()方法，这个API中定义了这些模式的全局常量。 在SphinxQL中， 这个前缀要被映射，且ranker的名称是大小写敏感的(就是要指定ranker模式的参数选项)</p><h1 id="Example-（例子）"><a href="#Example-（例子）" class="headerlink" title="Example （例子）"></a>Example （例子）</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SphinxAPI</span></span><br><span class="line">$client-&gt;SetRankingMode ( SPH_RANK_SPH04 );</span><br><span class="line"></span><br><span class="line"><span class="comment">// SphinxQL</span></span><br><span class="line">mysql_query ( <span class="string">"SELECT ... OPTION ranker=sph04"</span> );</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sphinx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL Connection using old authentication protocol refused</title>
      <link href="/mysql-connect-connection-using-old-authentication-protocol-refused/"/>
      <url>/mysql-connect-connection-using-old-authentication-protocol-refused/</url>
      
        <content type="html"><![CDATA[<p>有一台mysql升级到5.6版本，结果连接一些低版本的mysql服务器报出如下异常：</p><blockquote><p>Warning: mysql_connect(): Connection using old (pre-4.1.1) authentication protocol refused (client option ‘secure_auth’ enabled)</p></blockquote><p>异常原因在于服务器端的密码管理协议陈旧，使用的是旧有的用户密码格式存储；但是客户端升级之后采用了新的密码格式。mysql5.6版本遇到这种不一致的情况就会拒绝连接。</p><a id="more"></a><p>详见mysql手册 <code>Server Command Options</code> 一节中 <code>--secure-auth</code> 选项的<a href="http://dev.mysql.com/doc/refman/5.6/en/server-options.html#option_mysqld_secure-auth" target="_blank" rel="noopener">说明</a></p><p>解决方法有如下两种：</p><blockquote><p>1、服务器端升级启用 <code>secure_auth</code> 选项；<br>2、客户端连接时off掉 <code>secure_auth</code> ，即连接时加上 <code>--secure_auth=off</code>，如：<code>mysql -p10.51.1.11 -P3308 -uroot --secure_auth=off</code><br>对于方法二，使用在程序做相应 mysql 配置即可，以php为例，在 <code>php.ini</code> 中设置 <code>secure_auth=off</code></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> authentication </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 watch 帮你重复执行命令</title>
      <link href="/repeat-the-command-using-watch/"/>
      <url>/repeat-the-command-using-watch/</url>
      
        <content type="html"><![CDATA[<p>有时候你需要不断的执行某个命令，追踪其输出产生的变化情况。你可能会写一个死循环来做这件事情：</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> :</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    clear</span><br><span class="line">    commands</span><br><span class="line">    sleep 1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>然而实际上<code>linux中</code>有一个 <code>watch</code> 命令能够帮你做这件事情。它会定期执行指定的程序并将结果全屏输出。</p><p>watch 的使用方法很简单，只需要</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch 命令</span><br></pre></td></tr></table></figure><p>就行了，这样 <code>watch</code> 命令会每隔两秒执行一次该该命令，并全屏输出执行结果。</p><p>从上图可以看出，第一行中的 <code>Every 2.0s</code>: 表示 <code>watch</code> 每隔2秒执行一次命令。后面的 <code>date</code> 为要执行的命令。再后面的 <code>T520: Thu May 10 16:55:23 2018</code> 是主机名以及执行命令的时间。</p><p>在下面，从第二行开始就是命令执行的时间了。</p><p>通过 <code>-n INTERVAL</code> 你也可以设置重复执行命令的间隔时间，比如我可以调整为每5秒中执行一次 <code>date</code> 命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n 5 date</span><br></pre></td></tr></table></figure><p>不仅如此,通过 <code>-d</code> 选项, <code>watch</code> 还能高亮显示两次输出中不同的部分，这个功能相当实用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -d -n 1 date</span><br></pre></td></tr></table></figure><p>除了高亮显示输出中改变的部分外，你也可以设置让 <code>watch</code> 发现结果有改变时退出循环执行，方法是使用 <code>-g/--chgexit</code> 选项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -g free</span><br></pre></td></tr></table></figure><p>默认情况下， <code>watch</code> 并不会关心命令的执行结果是否成功</p><p>但你可以让 watch 检测命令的返回值，当命令运行返回非0时发出蜂鸣(<code>-b/–beep</code>)或者直接退出(<code>-e/–errexit</code>)。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -e wrong_commands</span><br></pre></td></tr></table></figure><p>最后，若你希望 <code>watch</code> 只显示出命令的执行结果，而不要显示第一行的那些信息，那么可以使用 <code>-t</code> 选项关闭<code>title</code>的显示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -t date</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> watch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP君子加密</title>
      <link href="/php-code-protector/"/>
      <url>/php-code-protector/</url>
      
        <content type="html"><![CDATA[<p>因为Github Page没办法支持php代码运行，之前的<code>PHP君子加密</code>没办法直接运行了，把源码放出来，大家自己部署吧。</p><a id="more"></a><p>index.php源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REQUEST_METHOD'</span>]==<span class="string">'POST'</span>)&#123;</span><br><span class="line">    <span class="comment">// 导入类</span></span><br><span class="line">    <span class="keyword">require</span> <span class="string">'PHPCodeProtector.class.php'</span>;</span><br><span class="line">    <span class="comment">// 创建类</span></span><br><span class="line">    $pcp = <span class="keyword">new</span> PHPCodeProtector;</span><br><span class="line">    <span class="comment">// 加载代码</span></span><br><span class="line">    $pcp-&gt;load($_POST[<span class="string">'code'</span>]);</span><br><span class="line">    <span class="comment">// 设置版本信息</span></span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'copyright_on'</span>])&#123;</span><br><span class="line">        $pcp-&gt;setCopyright($_POST[<span class="string">'copyright'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置过期时间</span></span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'expire_on'</span>])&#123;</span><br><span class="line">        $pcp-&gt;setExpire(strtotime($_POST[<span class="string">'expire'</span>]), $_POST[<span class="string">'expire_msg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置允许IP</span></span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'allow_ip_on'</span>])&#123;</span><br><span class="line">        $pcp-&gt;setAllowIp($_POST[<span class="string">'allow_ip'</span>], $_POST[<span class="string">'not_allow_ip_msg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置允许域名</span></span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'allow_domain_on'</span>])&#123;</span><br><span class="line">        $pcp-&gt;setAllowDomain($_POST[<span class="string">'allow_domain'</span>], $_POST[<span class="string">'not_allow_domain_msg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 保存至本地</span></span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'render_on'</span>])&#123;</span><br><span class="line">        $pcp-&gt;render($_POST[<span class="string">'render_name'</span>]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出加密后的代码</span></span><br><span class="line">    $code = $pcp-&gt;output();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $copyright            = <span class="string">'huangdijia@gmail.com'</span>;</span><br><span class="line">    $expire               = date(<span class="string">'Y-m-d'</span>, strtotime(<span class="string">'+1 day'</span>));</span><br><span class="line">    $expire_msg           = <span class="string">'PHP代码已经过期'</span>;</span><br><span class="line">    $allow_ip             = <span class="string">'127.0.0.1,192.168.1.1'</span>;</span><br><span class="line">    $not_allow_ip_msg     = <span class="string">'PHP代码不允许在此IP执行'</span>;</span><br><span class="line">    $allow_domain         = <span class="string">'localhost,www.hdj.me'</span>;</span><br><span class="line">    $not_allow_domain_msg = <span class="string">'PHP代码不允许在此域名执行'</span>;</span><br><span class="line">    $render_name          = <span class="string">'pcp_'</span>.time().<span class="string">'.php'</span>;</span><br><span class="line">    $code                 = <span class="string">&lt;&lt;&lt;CODE</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">/* Class   PHPCodeProtector */</span></span><br><span class="line"><span class="string">/* Version 1.0 */</span></span><br><span class="line"><span class="string">/* Author  Deeka */</span></span><br><span class="line"><span class="string">/* Email   huangdijia@gmail.com */</span></span><br><span class="line"><span class="string">echo phpinfo();</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">CODE;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;title&gt;PHPCodeProtector&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html,body, textarea&#123; font-size:<span class="number">13</span>px;&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;PHP代码保护&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;版本：<span class="number">1.0</span>&lt;/p&gt;</span><br><span class="line">&lt;div&gt;&lt;b&gt;已知BUG&lt;/b&gt;&lt;/div&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">    &lt;li&gt;常量会被转为字符串&lt;/li&gt;</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&lt;form method=<span class="string">"post"</span> action=<span class="string">"?"</span>&gt;</span><br><span class="line">    &lt;p&gt;请输入PHP代码：&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;&lt;textarea name=<span class="string">"code"</span> style=<span class="string">"width:590px;"</span> cols=<span class="string">"30"</span> rows=<span class="string">"20"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $code; <span class="meta">?&gt;</span>&lt;/textarea&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;label&gt;&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"copyright_on"</span> <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">'copyright_on'</span>]?<span class="string">'checked'</span>:<span class="string">''</span><span class="meta">?&gt;</span> /&gt; 版本信息：&lt;/label&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"copyright"</span> value=<span class="string">"&lt;?php echo $_POST['copyright']?$_POST['copyright']:$copyright; ?&gt;"</span> /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;label&gt;&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"expire_on"</span> value=<span class="string">"1"</span> <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">'expire_on'</span>]?<span class="string">'checked'</span>:<span class="string">''</span><span class="meta">?&gt;</span> /&gt; 有 效 期：&lt;/label&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"expire"</span> value=<span class="string">"&lt;?php echo $_POST['expire']?$_POST['expire']:$expire;?&gt;"</span> /&gt;</span><br><span class="line">        提示：&lt;input type=<span class="string">"text"</span> name=<span class="string">"expire_msg"</span> size=<span class="string">"40"</span> value=<span class="string">"&lt;?php echo $_POST['expire_msg']?$_POST['expire_msg']:$expire_msg; ?&gt;"</span> /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;label&gt;&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"allow_ip_on"</span> value=<span class="string">"1"</span> <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">'allow_ip_on'</span>]?<span class="string">'checked'</span>:<span class="string">''</span><span class="meta">?&gt;</span> /&gt; 允 许 IP：&lt;/label&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"allow_ip"</span> value=<span class="string">"&lt;?php echo $_POST['allow_ip']?$_POST['allow_ip']:$allow_ip;?&gt;"</span> /&gt;</span><br><span class="line">        提示：&lt;input type=<span class="string">"text"</span> name=<span class="string">"not_allow_ip_msg"</span> size=<span class="string">"40"</span> value=<span class="string">"&lt;?php echo $_POST['not_allow_ip_msg']?$_POST['not_allow_ip_msg']:$not_allow_ip_msg;?&gt;"</span> /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;label&gt;&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"allow_domain_on"</span> value=<span class="string">"1"</span> <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">'allow_domain_on'</span>]?<span class="string">'checked'</span>:<span class="string">''</span><span class="meta">?&gt;</span> /&gt; 允许域名：&lt;/label&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"allow_domain"</span> value=<span class="string">"&lt;?php echo $_POST['allow_domain']?$_POST['allow_domain']:$allow_domain;?&gt;"</span> /&gt;</span><br><span class="line">        提示：&lt;input type=<span class="string">"text"</span> name=<span class="string">"not_allow_domain_msg"</span> size=<span class="string">"40"</span> value=<span class="string">"&lt;?php echo $_POST['not_allow_domain_msg']?$_POST['not_allow_domain_msg']:$not_allow_domain_msg;?&gt;"</span> /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;label&gt;&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"render_on"</span> value=<span class="string">"1"</span> /&gt; 保存为：&lt;/label&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"render_name"</span> value=<span class="string">"&lt;?php echo $_POST['render_name']?$_POST['render_name']:$render_name;?&gt;"</span> /&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;button type=<span class="string">"submit"</span>&gt;提交&lt;/button&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>PHPCodeProtector.class.php源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHP源码加密类 v1.0</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PHPCodeProtector</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $expire               = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> $expire_msg           = <span class="string">'PHPCode Expired!'</span>;</span><br><span class="line">    <span class="keyword">private</span> $allow_ip;</span><br><span class="line">    <span class="keyword">private</span> $allow_domain;</span><br><span class="line">    <span class="keyword">private</span> $not_allow_ip_msg     = <span class="string">'PHPCode Not Allow Run On This Ip!'</span>;</span><br><span class="line">    <span class="keyword">private</span> $not_allow_domain_msg = <span class="string">'PHPCode Not Allow Run On This Domain!'</span>;</span><br><span class="line">    <span class="keyword">private</span> $separator            = <span class="string">','</span>;</span><br><span class="line">    <span class="keyword">private</span> $key                  = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>;</span><br><span class="line">    <span class="keyword">private</span> $comment;</span><br><span class="line">    <span class="keyword">private</span> $code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载文件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">($code=<span class="string">''</span>, $isfile=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($isfile &amp;&amp; file_exists($code))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;code = file_get_contents($code);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;code = $code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($highlight=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;_crypt(<span class="keyword">$this</span>-&gt;code);</span><br><span class="line">        <span class="keyword">return</span> $highlight ? highlight_string($content) : $content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 另存为</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($filename=<span class="string">''</span>, $type=<span class="string">"text/plain"</span>, $expire=<span class="number">180</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!$filename)&#123;</span><br><span class="line">            $filename = <span class="string">'pcp_'</span>.time().<span class="string">'php'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加密后代码</span></span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;output();</span><br><span class="line">        $length = strlen($content);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送Http Header信息 开始下载</span></span><br><span class="line">        header(<span class="string">"Pragma: public"</span>);</span><br><span class="line">        header(<span class="string">"Cache-control: max-age="</span>.$expire);</span><br><span class="line">        <span class="comment">//header('Cache-Control: no-store, no-cache, must-revalidate');</span></span><br><span class="line">        header(<span class="string">"Expires: "</span> . gmdate(<span class="string">"D, d M Y H:i:s"</span>,time()+$expire) . <span class="string">"GMT"</span>);</span><br><span class="line">        header(<span class="string">"Last-Modified: "</span> . gmdate(<span class="string">"D, d M Y H:i:s"</span>,time()) . <span class="string">"GMT"</span>);</span><br><span class="line">        header(<span class="string">"Content-Disposition: attachment; filename="</span>.$filename);</span><br><span class="line">        header(<span class="string">"Content-Length: "</span>.$length);</span><br><span class="line">        header(<span class="string">"Content-type: "</span>.$type);</span><br><span class="line">        header(<span class="string">'Content-Encoding: none'</span>);</span><br><span class="line">        header(<span class="string">"Content-Transfer-Encoding: binary"</span> );</span><br><span class="line">        <span class="keyword">echo</span> $content;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">($file=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;output();</span><br><span class="line">        <span class="keyword">return</span> file_put_contents($file, $content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 版本注释</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setCopyright</span><span class="params">($copyright=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($copyright))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;copyright = $copyright;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置超时</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setExpire</span><span class="params">($expire=null, $expire_msg=<span class="string">'PHPCode Expired!'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_null($expire))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;expire = $expire;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($expire_msg))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;expire_msg = $expire_msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置允许IP</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAllowIp</span><span class="params">($allow_ip=<span class="string">''</span>, $not_allow_ip_msg=<span class="string">'PHPCode Not Allow Run On This Ip!'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($allow_ip))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;allow_ip = $allow_ip;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($not_allow_ip_msg))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;not_allow_ip_msg = $not_allow_ip_msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置允许域名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAllowDomain</span><span class="params">($allow_domain=<span class="string">''</span>, $not_allow_domain_msg=<span class="string">'PHPCode Not Allow Run On This Domain!'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($allow_domain))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;allow_domain = $allow_domain;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($not_allow_domain_msg))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;not_allow_domain_msg = $not_allow_domain_msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置密匙</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setKey</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取随机密匙</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_getRandKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_shuffle(<span class="keyword">$this</span>-&gt;key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_crypt</span><span class="params">($php_code=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 随机密匙1</span></span><br><span class="line">        $rand_key1 = <span class="keyword">$this</span>-&gt;_getRandKey();</span><br><span class="line">        <span class="comment">// 随机密匙2</span></span><br><span class="line">        $rand_key2 = <span class="keyword">$this</span>-&gt;_getRandKey();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加入时间限制</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;expire &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            $verify_code .= <span class="string">'if(time() &gt; '</span>.<span class="keyword">$this</span>-&gt;expire.<span class="string">') die(\''</span>.<span class="keyword">$this</span>-&gt;expire_msg.<span class="string">'\');'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加入IP限制</span></span><br><span class="line">        $allow_ips = explode(<span class="keyword">$this</span>-&gt;separator, <span class="keyword">$this</span>-&gt;allow_ip);</span><br><span class="line">        $allow_ips = array_filter($allow_ips);</span><br><span class="line">        <span class="keyword">if</span>(is_array($allow_ips) &amp;&amp; !<span class="keyword">empty</span>($allow_ips))&#123;</span><br><span class="line">            $verify_code .= <span class="string">'if(!in_array($_SERVER["SERVER_ADDR"], '</span>.str_replace(<span class="string">"\n"</span>, <span class="string">''</span>, var_export($allow_ips, <span class="keyword">true</span>)).<span class="string">')) die(\''</span>.<span class="keyword">$this</span>-&gt;not_allow_ip_msg.<span class="string">'\');'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加入域名限制</span></span><br><span class="line">        $allow_domains = explode(<span class="keyword">$this</span>-&gt;separator, <span class="keyword">$this</span>-&gt;allow_domain);</span><br><span class="line">        $allow_domains = array_filter($allow_domains);</span><br><span class="line">        <span class="keyword">if</span>(is_array($allow_domains) &amp;&amp; !<span class="keyword">empty</span>($allow_domains))&#123;</span><br><span class="line">            $verify_code .= <span class="string">'if(!in_array($_SERVER["HTTP_HOST"], '</span>.str_replace(<span class="string">"\n"</span>, <span class="string">''</span>, var_export($allow_domains, <span class="keyword">true</span>)).<span class="string">')) die(\''</span>.<span class="keyword">$this</span>-&gt;not_allow_domain_msg.<span class="string">'\');'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 验证信息</span></span><br><span class="line">        $verify_code = $verify_code ? <span class="string">'&lt;?php '</span> . $verify_code . <span class="string">'?&gt;'</span> : <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PHP源码</span></span><br><span class="line">        $php_code = $verify_code.$php_code;</span><br><span class="line">        <span class="comment">// 代码压缩</span></span><br><span class="line">        $php_code = <span class="keyword">$this</span>-&gt;_compressPhpSrc($php_code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// base64加密</span></span><br><span class="line">        $base64_str = base64_encode($php_code);</span><br><span class="line">        <span class="comment">// 根据密匙替换对应字符</span></span><br><span class="line">        $c = strtr($base64_str, $rand_key1, $rand_key2);</span><br><span class="line">        $c = $rand_key1.$rand_key2.$c;</span><br><span class="line">        $q1 = <span class="string">"O00O0O"</span>;</span><br><span class="line">        $q2 = <span class="string">"O0O000"</span>;</span><br><span class="line">        $q3 = <span class="string">"O0OO00"</span>;</span><br><span class="line">        $q4 = <span class="string">"OO0O00"</span>;</span><br><span class="line">        $q5 = <span class="string">"OO0000"</span>;</span><br><span class="line">        $q6 = <span class="string">"O00OO0"</span>;</span><br><span class="line">        $s = <span class="string">'$'</span>.$q6.<span class="string">'=urldecode("%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A");$'</span></span><br><span class="line">            .$q1.<span class="string">'=$'</span>.$q6.<span class="string">'&#123;3&#125;.$'</span>.$q6.<span class="string">'&#123;6&#125;.$'</span>.$q6.<span class="string">'&#123;33&#125;.$'</span>.$q6.<span class="string">'&#123;30&#125;;$'</span></span><br><span class="line">            .$q3.<span class="string">'=$'</span>.$q6.<span class="string">'&#123;33&#125;.$'</span>.$q6.<span class="string">'&#123;10&#125;.$'</span>.$q6.<span class="string">'&#123;24&#125;.$'</span>.$q6.<span class="string">'&#123;10&#125;.$'</span>.$q6.<span class="string">'&#123;24&#125;;$'</span></span><br><span class="line">            .$q4.<span class="string">'=$'</span>.$q3.<span class="string">'&#123;0&#125;.$'</span>.$q6.<span class="string">'&#123;18&#125;.$'</span>.$q6.<span class="string">'&#123;3&#125;.$'</span>.$q3.<span class="string">'&#123;0&#125;.$'</span>.$q3.<span class="string">'&#123;1&#125;.$'</span>.$q6.<span class="string">'&#123;24&#125;;$'</span></span><br><span class="line">            .$q5.<span class="string">'=$'</span>.$q6.<span class="string">'&#123;7&#125;.$'</span>.$q6.<span class="string">'&#123;13&#125;;$'</span></span><br><span class="line">            .$q1.<span class="string">'.=$'</span>.$q6.<span class="string">'&#123;22&#125;.$'</span>.$q6.<span class="string">'&#123;36&#125;.$'</span>.$q6.<span class="string">'&#123;29&#125;.$'</span>.$q6.<span class="string">'&#123;26&#125;.$'</span>.$q6.<span class="string">'&#123;30&#125;.$'</span>.$q6.<span class="string">'&#123;32&#125;.$'</span>.$q6.<span class="string">'&#123;35&#125;.$'</span>.$q6.<span class="string">'&#123;26&#125;.$'</span>.$q6.<span class="string">'&#123;30&#125;;eval($'</span></span><br><span class="line">            .$q1.<span class="string">'("'</span>.base64_encode(<span class="string">'$'</span>.$q2.<span class="string">'="'</span>.$c.<span class="string">'";eval(\'?&gt;\'.$'</span>.$q1.<span class="string">'($'</span>.$q3.<span class="string">'($'</span>.$q4.<span class="string">'($'</span>.$q2.<span class="string">',$'</span>.$q5.<span class="string">'*2),$'</span>.$q4.<span class="string">'($'</span>.$q2.<span class="string">',$'</span>.$q5.<span class="string">',$'</span>.$q5.<span class="string">'),$'</span>.$q4.<span class="string">'($'</span>.$q2.<span class="string">',0,$'</span>.$q5.<span class="string">'))));'</span>).<span class="string">'"));'</span>;</span><br><span class="line">        $code = <span class="string">'&lt;?php '</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;copyright))&#123;</span><br><span class="line">            $code .= <span class="string">'/* '</span>.<span class="keyword">$this</span>-&gt;copyright.<span class="string">' */ '</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $code .= $s;</span><br><span class="line">        <span class="comment">// 返回</span></span><br><span class="line">        <span class="keyword">return</span> $code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PHP代码压缩</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_compressPhpSrc</span><span class="params">($src)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Whitespaces left and right from this signs can be ignored</span></span><br><span class="line">        <span class="keyword">static</span> $IW = <span class="keyword">array</span>(</span><br><span class="line">            T_CONCAT_EQUAL,             <span class="comment">// .=</span></span><br><span class="line">            T_DOUBLE_ARROW,             <span class="comment">// =&gt;</span></span><br><span class="line">            T_BOOLEAN_AND,              <span class="comment">// &amp;&amp;</span></span><br><span class="line">            T_BOOLEAN_OR,               <span class="comment">// ||</span></span><br><span class="line">            T_IS_EQUAL,                 <span class="comment">// ==</span></span><br><span class="line">            T_IS_NOT_EQUAL,             <span class="comment">// != or &lt;&gt;</span></span><br><span class="line">            T_IS_SMALLER_OR_EQUAL,      <span class="comment">// &lt;=</span></span><br><span class="line">            T_IS_GREATER_OR_EQUAL,      <span class="comment">// &gt;=</span></span><br><span class="line">            T_INC,                      <span class="comment">// ++</span></span><br><span class="line">            T_DEC,                      <span class="comment">// --</span></span><br><span class="line">            T_PLUS_EQUAL,               <span class="comment">// +=</span></span><br><span class="line">            T_MINUS_EQUAL,              <span class="comment">// -=</span></span><br><span class="line">            T_MUL_EQUAL,                <span class="comment">// *=</span></span><br><span class="line">            T_DIV_EQUAL,                <span class="comment">// /=</span></span><br><span class="line">            T_IS_IDENTICAL,             <span class="comment">// ===</span></span><br><span class="line">            T_IS_NOT_IDENTICAL,         <span class="comment">// !==</span></span><br><span class="line">            T_DOUBLE_COLON,             <span class="comment">// ::</span></span><br><span class="line">            T_PAAMAYIM_NEKUDOTAYIM,     <span class="comment">// ::</span></span><br><span class="line">            T_OBJECT_OPERATOR,          <span class="comment">// -&gt;</span></span><br><span class="line">            T_DOLLAR_OPEN_CURLY_BRACES, <span class="comment">// $&#123;</span></span><br><span class="line">            T_AND_EQUAL,                <span class="comment">// &amp;=</span></span><br><span class="line">                T_MOD_EQUAL,                <span class="comment">// %=</span></span><br><span class="line">                T_XOR_EQUAL,                <span class="comment">// ^=</span></span><br><span class="line">                T_OR_EQUAL,                 <span class="comment">// |=</span></span><br><span class="line">                T_SL,                       <span class="comment">// &lt;&lt;</span></span><br><span class="line">                T_SR,                       <span class="comment">// &gt;&gt;</span></span><br><span class="line">                T_SL_EQUAL,                 <span class="comment">// &lt;&lt;=</span></span><br><span class="line">                T_SR_EQUAL,                 <span class="comment">// &gt;&gt;=</span></span><br><span class="line">            );</span><br><span class="line">            $tokens = token_get_all($src);</span><br><span class="line"></span><br><span class="line">            $new = <span class="string">""</span>;</span><br><span class="line">            $c = sizeof($tokens);</span><br><span class="line">            $iw = <span class="keyword">false</span>; <span class="comment">// ignore whitespace</span></span><br><span class="line">            $ih = <span class="keyword">false</span>; <span class="comment">// in HEREDOC</span></span><br><span class="line">            $ls = <span class="string">""</span>;    <span class="comment">// last sign</span></span><br><span class="line">            $ot = <span class="keyword">null</span>;  <span class="comment">// open tag</span></span><br><span class="line">            <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $c; $i++) &#123;</span><br><span class="line">                $token = $tokens[$i];</span><br><span class="line">                <span class="keyword">if</span>(is_array($token)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>($tn, $ts) = $token; <span class="comment">// tokens: number, string, line</span></span><br><span class="line">                    $tname = token_name($tn);</span><br><span class="line">                    <span class="keyword">if</span>($tn == T_INLINE_HTML) &#123;</span><br><span class="line">                        $new .= $ts;</span><br><span class="line">                        $iw = <span class="keyword">false</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span>($tn == T_OPEN_TAG) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(strpos($ts, <span class="string">" "</span>) || strpos($ts, <span class="string">"\n"</span>) || strpos($ts, <span class="string">"\t"</span>) || strpos($ts, <span class="string">"\r"</span>)) &#123;</span><br><span class="line">                                $ts = rtrim($ts);</span><br><span class="line">                            &#125;</span><br><span class="line">                            $ts .= <span class="string">" "</span>;</span><br><span class="line">                            $new .= $ts;</span><br><span class="line">                            $ot = T_OPEN_TAG;</span><br><span class="line">                            $iw = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_OPEN_TAG_WITH_ECHO) &#123;</span><br><span class="line">                            $new .= $ts;</span><br><span class="line">                            $ot = T_OPEN_TAG_WITH_ECHO;</span><br><span class="line">                            $iw = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_CLOSE_TAG) &#123;</span><br><span class="line">                            <span class="keyword">if</span>($ot == T_OPEN_TAG_WITH_ECHO) &#123;</span><br><span class="line">                                $new = rtrim($new, <span class="string">"; "</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                $ts = <span class="string">" "</span>.$ts;</span><br><span class="line">                            &#125;</span><br><span class="line">                            $new .= $ts;</span><br><span class="line">                            $ot = <span class="keyword">null</span>;</span><br><span class="line">                            $iw = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>(in_array($tn, $IW)) &#123;</span><br><span class="line">                            $new .= $ts;</span><br><span class="line">                            $iw = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_CONSTANT_ENCAPSED_STRING</span><br><span class="line">                            || $tn == T_ENCAPSED_AND_WHITESPACE)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span>($ts[<span class="number">0</span>] == <span class="string">'"'</span>) &#123;</span><br><span class="line">                                $ts = addcslashes($ts, <span class="string">"\n\t\r"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            $new .= $ts;</span><br><span class="line">                            $iw = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_WHITESPACE) &#123;</span><br><span class="line">                            $nt = @$tokens[$i+<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">if</span>(!$iw &amp;&amp; (!is_string($nt) || $nt == <span class="string">'$'</span>) &amp;&amp; !in_array($nt[<span class="number">0</span>], $IW)) &#123;</span><br><span class="line">                                $new .= <span class="string">" "</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            $iw = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_START_HEREDOC) &#123;</span><br><span class="line">                            $new .= <span class="string">"&lt;&lt;&lt;S\n"</span>;</span><br><span class="line">                            $iw = <span class="keyword">false</span>;</span><br><span class="line">                            $ih = <span class="keyword">true</span>; <span class="comment">// in HEREDOC</span></span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_END_HEREDOC) &#123;</span><br><span class="line">                            $new .= <span class="string">"S;"</span>;</span><br><span class="line">                            $iw = <span class="keyword">true</span>;</span><br><span class="line">                            $ih = <span class="keyword">false</span>; <span class="comment">// in HEREDOC</span></span><br><span class="line">                            <span class="keyword">for</span>($j = $i+<span class="number">1</span>; $j &lt; $c; $j++) &#123;</span><br><span class="line">                                <span class="keyword">if</span>(is_string($tokens[$j]) &amp;&amp; $tokens[$j] == <span class="string">";"</span>) &#123;</span><br><span class="line">                                    $i = $j;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span>($tokens[$j][<span class="number">0</span>] == T_CLOSE_TAG) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">elseif</span>($tn == T_COMMENT || $tn == T_DOC_COMMENT) &#123;</span><br><span class="line">                            $iw = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span>(!$ih) &#123;</span><br><span class="line">                                $ts = strtolower($ts);</span><br><span class="line">                            &#125;</span><br><span class="line">                            $new .= $ts;</span><br><span class="line">                            $iw = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $ls = <span class="string">""</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(($token != <span class="string">";"</span> &amp;&amp; $token != <span class="string">":"</span>) || $ls != $token) &#123;</span><br><span class="line">                        $new .= $token;</span><br><span class="line">                        $ls = $token;</span><br><span class="line">                    &#125;</span><br><span class="line">                    $iw = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $new;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>身份证号码验证的几个实用函数</title>
      <link href="/cn-idcard-validate-function-in-javascript/"/>
      <url>/cn-idcard-validate-function-in-javascript/</url>
      
        <content type="html"><![CDATA[<p>最近需要对身份证合法性进行验证，实名验证是不指望了，不过原来的验证规则太过简单，只是简单的验证了身份证长度，现在业务需要加强下身份证验证规则，网上找到了不少资料，不过都不合偶的心意，无奈只好直接写一个，代码还是用自己的舒服哈。</p><a id="more"></a><h2 id="身份证号码有效性验证"><a href="#身份证号码有效性验证" class="headerlink" title="身份证号码有效性验证"></a>身份证号码有效性验证</h2><p>JavaScript 代码:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIDCard</span>(<span class="params">idcard</span>) </span>&#123;</span><br><span class="line">    idcard = idcard.toUpperCase(); <span class="comment">// 对身份证号码做处理</span></span><br><span class="line">    <span class="keyword">var</span> ereg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> Y, JYM;</span><br><span class="line">    <span class="keyword">var</span> S, M;</span><br><span class="line">    <span class="comment">/*基本校验*/</span></span><br><span class="line">    <span class="comment">//if (String.isNullOrEmpty(idcard)) return false;</span></span><br><span class="line">    <span class="keyword">var</span> idcard_array = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    idcard_array = idcard.split(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*身份号码位数及格式检验*/</span></span><br><span class="line">    <span class="keyword">switch</span> (idcard.length) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">if</span> ((<span class="built_in">parseInt</span>(idcard.substr(<span class="number">6</span>, <span class="number">2</span>)) + <span class="number">1900</span>) % <span class="number">4</span> == <span class="number">0</span> || ((<span class="built_in">parseInt</span>(idcard.substr(<span class="number">6</span>, <span class="number">2</span>)) + <span class="number">1900</span>) % <span class="number">100</span> == <span class="number">0</span> &amp;&amp; (<span class="built_in">parseInt</span>(idcard.substr(<span class="number">6</span>, <span class="number">2</span>)) + <span class="number">1900</span>) % <span class="number">4</span> == <span class="number">0</span>)) &#123;</span><br><span class="line">                ereg = <span class="regexp">/^[1-9][0-9]&#123;5&#125;[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))[0-9]&#123;3&#125;$/</span>; <span class="comment">//测试出生日期的合法性</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ereg = <span class="regexp">/^[1-9][0-9]&#123;5&#125;[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|1[0-9]|2[0-8]))[0-9]&#123;3&#125;$/</span>; <span class="comment">//测试出生日期的合法性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ereg.test(idcard)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">            <span class="comment">//18位身份号码检测</span></span><br><span class="line">            <span class="comment">//出生日期的合法性检查</span></span><br><span class="line">            <span class="comment">//闰年月日:((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))</span></span><br><span class="line">            <span class="comment">//平年月日:((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|1[0-9]|2[0-8]))</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(idcard.substr(<span class="number">6</span>, <span class="number">4</span>)) % <span class="number">4</span> == <span class="number">0</span> || (<span class="built_in">parseInt</span>(idcard.substr(<span class="number">6</span>, <span class="number">4</span>)) % <span class="number">100</span> == <span class="number">0</span> &amp;&amp; <span class="built_in">parseInt</span>(idcard.substr(<span class="number">6</span>, <span class="number">4</span>)) % <span class="number">4</span> == <span class="number">0</span>)) &#123;</span><br><span class="line">                ereg = <span class="regexp">/^[1-9][0-9]&#123;5&#125;19[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))[0-9]&#123;3&#125;[0-9XxAa]$/</span>; <span class="comment">//闰年出生日期的合法性正则表达式</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ereg = <span class="regexp">/^[1-9][0-9]&#123;5&#125;19[0-9]&#123;2&#125;((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|1[0-9]|2[0-8]))[0-9]&#123;3&#125;[0-9XxAa]$/</span>; <span class="comment">//平年出生日期的合法性正则表达式</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ereg.test(idcard)) &#123;<span class="comment">//测试出生日期的合法性</span></span><br><span class="line">                <span class="comment">//计算校验位</span></span><br><span class="line">                S = (<span class="built_in">parseInt</span>(idcard_array[<span class="number">0</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">10</span>])) * <span class="number">7</span></span><br><span class="line">                    + (<span class="built_in">parseInt</span>(idcard_array[<span class="number">1</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">11</span>])) * <span class="number">9</span></span><br><span class="line">                    + (<span class="built_in">parseInt</span>(idcard_array[<span class="number">2</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">12</span>])) * <span class="number">10</span></span><br><span class="line">                    + (<span class="built_in">parseInt</span>(idcard_array[<span class="number">3</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">13</span>])) * <span class="number">5</span></span><br><span class="line">                    + (<span class="built_in">parseInt</span>(idcard_array[<span class="number">4</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">14</span>])) * <span class="number">8</span></span><br><span class="line">                    + (<span class="built_in">parseInt</span>(idcard_array[<span class="number">5</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">15</span>])) * <span class="number">4</span></span><br><span class="line">                    + (<span class="built_in">parseInt</span>(idcard_array[<span class="number">6</span>]) + <span class="built_in">parseInt</span>(idcard_array[<span class="number">16</span>])) * <span class="number">2</span></span><br><span class="line">                    + <span class="built_in">parseInt</span>(idcard_array[<span class="number">7</span>]) * <span class="number">1</span></span><br><span class="line">                    + <span class="built_in">parseInt</span>(idcard_array[<span class="number">8</span>]) * <span class="number">6</span></span><br><span class="line">                    + <span class="built_in">parseInt</span>(idcard_array[<span class="number">9</span>]) * <span class="number">3</span>;</span><br><span class="line">                Y = S % <span class="number">11</span>;</span><br><span class="line">                M = <span class="string">"F"</span>;</span><br><span class="line">                JYM = <span class="string">"10X98765432"</span>;</span><br><span class="line">                M = JYM.substr(Y, <span class="number">1</span>);</span><br><span class="line">                <span class="comment">/*判断校验位*/</span></span><br><span class="line">                <span class="keyword">if</span> (M == idcard_array[<span class="number">17</span>]) &#123;  <span class="comment">/*检测ID的校验位false;*/</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idcard_array[<span class="number">17</span>] == <span class="string">'A'</span>) &#123;<span class="comment">//A结尾不校验规则</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">/*检测ID的校验位false;*/</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="从身份证号码中获取相关信息，比如生日、省"><a href="#从身份证号码中获取相关信息，比如生日、省" class="headerlink" title="从身份证号码中获取相关信息，比如生日、省"></a>从身份证号码中获取相关信息，比如生日、省</h2><p>JavaScript 代码:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkID</span>(<span class="params">ID</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> ID !== <span class="string">'string'</span>) <span class="keyword">return</span> <span class="string">'非法字符串'</span>;</span><br><span class="line">    <span class="keyword">var</span> city = &#123;<span class="number">11</span>:<span class="string">"北京"</span>,<span class="number">12</span>:<span class="string">"天津"</span>,<span class="number">13</span>:<span class="string">"河北"</span>,<span class="number">14</span>:<span class="string">"山西"</span>,<span class="number">15</span>:<span class="string">"内蒙古"</span>,<span class="number">21</span>:<span class="string">"辽宁"</span>,<span class="number">22</span>:<span class="string">"吉林"</span>,<span class="number">23</span>:<span class="string">"黑龙江 "</span>,<span class="number">31</span>:<span class="string">"上海"</span>,<span class="number">32</span>:<span class="string">"江苏"</span>,<span class="number">33</span>:<span class="string">"浙江"</span>,<span class="number">34</span>:<span class="string">"安徽"</span>,<span class="number">35</span>:<span class="string">"福建"</span>,<span class="number">36</span>:<span class="string">"江西"</span>,<span class="number">37</span>:<span class="string">"山东"</span>,<span class="number">41</span>:<span class="string">"河南"</span>,<span class="number">42</span>:<span class="string">"湖北 "</span>,<span class="number">43</span>:<span class="string">"湖南"</span>,<span class="number">44</span>:<span class="string">"广东"</span>,<span class="number">45</span>:<span class="string">"广西"</span>,<span class="number">46</span>:<span class="string">"海南"</span>,<span class="number">50</span>:<span class="string">"重庆"</span>,<span class="number">51</span>:<span class="string">"四川"</span>,<span class="number">52</span>:<span class="string">"贵州"</span>,<span class="number">53</span>:<span class="string">"云南"</span>,<span class="number">54</span>:<span class="string">"西藏 "</span>,<span class="number">61</span>:<span class="string">"陕西"</span>,<span class="number">62</span>:<span class="string">"甘肃"</span>,<span class="number">63</span>:<span class="string">"青海"</span>,<span class="number">64</span>:<span class="string">"宁夏"</span>,<span class="number">65</span>:<span class="string">"新疆"</span>,<span class="number">71</span>:<span class="string">"台湾"</span>,<span class="number">81</span>:<span class="string">"香港"</span>,<span class="number">82</span>:<span class="string">"澳门"</span>,<span class="number">91</span>:<span class="string">"国外"</span>&#125;;</span><br><span class="line">    <span class="keyword">var</span> birthday = ID.substr(<span class="number">6</span>, <span class="number">4</span>) + <span class="string">'/'</span> + <span class="built_in">Number</span>(ID.substr(<span class="number">10</span>, <span class="number">2</span>)) + <span class="string">'/'</span> + <span class="built_in">Number</span>(ID.substr(<span class="number">12</span>, <span class="number">2</span>));</span><br><span class="line">    <span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(birthday);</span><br><span class="line">    <span class="keyword">var</span> newBirthday = d.getFullYear() + <span class="string">'/'</span> + <span class="built_in">Number</span>(d.getMonth() + <span class="number">1</span>) + <span class="string">'/'</span> + <span class="built_in">Number</span>(d.getDate());</span><br><span class="line">    <span class="keyword">var</span> currentTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">    <span class="keyword">var</span> time = d.getTime();</span><br><span class="line">    <span class="keyword">var</span> arrInt = [<span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">var</span> arrCh = [<span class="string">'1'</span>, <span class="string">'0'</span>, <span class="string">'X'</span>, <span class="string">'9'</span>, <span class="string">'8'</span>, <span class="string">'7'</span>, <span class="string">'6'</span>, <span class="string">'5'</span>, <span class="string">'4'</span>, <span class="string">'3'</span>, <span class="string">'2'</span>];</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>, i, residue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/^\d&#123;17&#125;(\d|x)$/i</span>.test(ID)) <span class="keyword">return</span> <span class="string">'非法身份证'</span>;</span><br><span class="line">    <span class="keyword">if</span>(city[ID.substr(<span class="number">0</span>,<span class="number">2</span>)] === <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="string">"非法地区"</span>;</span><br><span class="line">    <span class="keyword">if</span>(time &gt;= currentTime || birthday !== newBirthday) <span class="keyword">return</span> <span class="string">'非法生日'</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">17</span>; i++) &#123;</span><br><span class="line">      sum += ID.substr(i, <span class="number">1</span>) * arrInt[i];</span><br><span class="line">    &#125;</span><br><span class="line">    residue = arrCh[sum % <span class="number">11</span>];</span><br><span class="line">    <span class="keyword">if</span> (residue !== ID.substr(<span class="number">17</span>, <span class="number">1</span>)) <span class="keyword">return</span> <span class="string">'非法身份证哦'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> city[ID.substr(<span class="number">0</span>,<span class="number">2</span>)]+<span class="string">","</span>+birthday+<span class="string">","</span>+(ID.substr(<span class="number">16</span>,<span class="number">1</span>)%<span class="number">2</span>?<span class="string">" 男"</span>:<span class="string">"女"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="验证香港身份证的格式或真实性"><a href="#验证香港身份证的格式或真实性" class="headerlink" title="验证香港身份证的格式或真实性"></a>验证香港身份证的格式或真实性</h2><p>JavaScript 代码:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsHKID</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> strValidChars = <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// basic check length</span></span><br><span class="line">    <span class="keyword">if</span> (str.length &lt; <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handling bracket</span></span><br><span class="line">    <span class="keyword">if</span> (str.charAt(str.length<span class="number">-3</span>) == <span class="string">'('</span> &amp;&amp; str.charAt(str.length<span class="number">-1</span>) == <span class="string">')'</span>)</span><br><span class="line">        str = str.substring(<span class="number">0</span>, str.length - <span class="number">3</span>) + str.charAt(str.length <span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to upper case</span></span><br><span class="line">    str = str.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// regular expression to check pattern and split</span></span><br><span class="line">    <span class="keyword">var</span> hkidPat = <span class="regexp">/^([A-Z]&#123;1,2&#125;)([0-9]&#123;6&#125;)([A0-9])$/</span>;</span><br><span class="line">    <span class="keyword">var</span> matchArray = str.match(hkidPat);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// not match, return false</span></span><br><span class="line">    <span class="keyword">if</span> (matchArray == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the character part, numeric part and check digit part</span></span><br><span class="line">    <span class="keyword">var</span> charPart = matchArray[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">var</span> numPart = matchArray[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">var</span> checkDigit = matchArray[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate the checksum for character part</span></span><br><span class="line">    <span class="keyword">var</span> checkSum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (charPart.length == <span class="number">2</span>) &#123;</span><br><span class="line">        checkSum += <span class="number">9</span> * (<span class="number">10</span> + strValidChars.indexOf(charPart.charAt(<span class="number">0</span>)));</span><br><span class="line">        checkSum += <span class="number">8</span> * (<span class="number">10</span> + strValidChars.indexOf(charPart.charAt(<span class="number">1</span>)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        checkSum += <span class="number">9</span> * <span class="number">36</span>;</span><br><span class="line">        checkSum += <span class="number">8</span> * (<span class="number">10</span> + strValidChars.indexOf(charPart));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate the checksum for numeric part</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, j = <span class="number">7</span>; i &lt; numPart.length; i++, j--)</span><br><span class="line">        checkSum += j * numPart.charAt(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verify the check digit</span></span><br><span class="line">    <span class="keyword">var</span> remaining = checkSum % <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">var</span> verify = remaining == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">11</span> - remaining;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> verify == checkDigit || (verify == <span class="number">10</span> &amp;&amp; checkDigit == <span class="string">'A'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在网上找了很久都没合意的验证方式，最后通过Google找到一个国外写的js验证，发现可以使用。</p><p>上面那段验证的很精密，包含身份证真实性的校验，如果只是想验证输入的香港身份证格式，请使用下面的这段js。</p><p>JavaScript 代码:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsHKID</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> strValidChars = <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// basic check length</span></span><br><span class="line">    <span class="keyword">if</span> (str.length &lt; <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handling bracket</span></span><br><span class="line">    <span class="keyword">if</span> (str.charAt(str.length<span class="number">-3</span>) == <span class="string">'('</span> &amp;&amp; str.charAt(str.length<span class="number">-1</span>) == <span class="string">')'</span>)</span><br><span class="line">        str = str.substring(<span class="number">0</span>, str.length - <span class="number">3</span>) + str.charAt(str.length <span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to upper case</span></span><br><span class="line">    str = str.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// regular expression to check pattern and split</span></span><br><span class="line">    <span class="keyword">var</span> hkidPat = <span class="regexp">/^([A-Z]&#123;1,2&#125;)([0-9]&#123;6&#125;)([A0-9])$/</span>;</span><br><span class="line">    <span class="keyword">var</span> matchArray = str.match(hkidPat);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// not match, return false</span></span><br><span class="line">    <span class="keyword">if</span> (matchArray == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>港澳居民来往内地通行证号码目前好像没有好的办法验证，这里提供一个简单的正则：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^([A-Z]\d&#123;<span class="number">6</span>,<span class="number">10</span>&#125;(\(\w&#123;<span class="number">1</span>&#125;\))?)$/</span><br></pre></td></tr></table></figure><p>最后这里提供一个验证中国，香港，台湾和韩国身份证的 JavaScript 库：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Edditoria / validid</span><br><span class="line">A Javascript library to validate ID card numbers <span class="keyword">of</span> China, Taiwan, Hong Kong and South Korea</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> javascript </tag>
            
            <tag> idcard </tag>
            
            <tag> 身份证 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决PHP输出UTF-8编码的csv乱码问题</title>
      <link href="/fix-utf8-in-csv/"/>
      <url>/fix-utf8-in-csv/</url>
      
        <content type="html"><![CDATA[<p>众所周知，UTF-8已经一统天下了，但是微软office默认使用的还不是它，经常在使用程序生成CSV的时候总是看到的是乱码，其实office并非顽固分子，在早期版本已经增加了对UTF-8的支持，但是你要告诉他，你的数据是UTF-8。</p><p>怎么做呢？</p><a id="more"></a><h2 id="PHP处理方式"><a href="#PHP处理方式" class="headerlink" title="PHP处理方式"></a>PHP处理方式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utf8</span></span><br><span class="line">$fp = fopen(<span class="string">'./test_csv.csv'</span>, <span class="string">'a'</span>);</span><br><span class="line">fwrite($fp,chr(<span class="number">0xEF</span>).chr(<span class="number">0xBB</span>).chr(<span class="number">0xBF</span>));<span class="comment">//输出BOM头</span></span><br><span class="line">fputcsv($fp, [<span class="string">'标题'</span>]);</span><br><span class="line">fputcsv($fp, [<span class="string">'解决乱码'</span>]);</span><br><span class="line">fclose($fp);</span><br></pre></td></tr></table></figure><h2 id="命令行处理方式"><a href="#命令行处理方式" class="headerlink" title="命令行处理方式"></a>命令行处理方式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'\xEF\xBB\xBF’ &gt; tmp.csv</span></span><br><span class="line"><span class="string">cat your.csv &gt;&gt; tmp.csv</span></span><br><span class="line"><span class="string">mv tmp.csv your.csv</span></span><br></pre></td></tr></table></figure><p>你 <code>get√</code> 到了吗？</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> utf-8 </tag>
            
            <tag> csv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实现自定义apk安装包</title>
      <link href="/custom-apk-by-php-ziparchive/"/>
      <url>/custom-apk-by-php-ziparchive/</url>
      
        <content type="html"><![CDATA[<p>需求：</p><blockquote><p>突然收到老大的需求，要对产品进行一次推荐好友安装的活动，每个会员下载自己的专属安装包（里面记录会员的相关信息）。</p></blockquote><p>思路：</p><blockquote><p>经过了解，发现apk安装包原来只是zip的一个马甲，使用php的ZipArchive类可以对文件进行操作。</p></blockquote><a id="more"></a><p>实现代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源文件</span></span><br><span class="line">$apk    = <span class="string">"gb.apk"</span>;</span><br><span class="line"><span class="comment">// 生成临时文件</span></span><br><span class="line">$file   = tempnam(<span class="string">"tmp"</span>, <span class="string">"zip"</span>);</span><br><span class="line"><span class="comment">// 复制文件</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">false</span>===file_put_contents($file, file_get_contents($apk)))&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'copy faild!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 打开临时文件</span></span><br><span class="line">$zip    = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">$zip-&gt;open($file);</span><br><span class="line"><span class="comment">// 添加文件</span></span><br><span class="line"><span class="comment">// 由于apk限定只能修改此目录内的文件，否则会报无效apk包</span></span><br><span class="line">$zip-&gt;addFromString(<span class="string">'META-INF/extends.json'</span>, json_encode(<span class="keyword">array</span>(<span class="string">'author'</span>=&gt;<span class="string">'deeka'</span>)));</span><br><span class="line"><span class="comment">// 关闭zip</span></span><br><span class="line">$zip-&gt;close();</span><br><span class="line"><span class="comment">// 下载文件</span></span><br><span class="line">header(<span class="string">"Content-Type: application/zip"</span>);</span><br><span class="line">header(<span class="string">"Content-Length: "</span> . filesize($file));</span><br><span class="line">header(<span class="string">"Content-Disposition: attachment; filename=\"&#123;$apk&#125;\""</span>);</span><br><span class="line"><span class="comment">// 输出二进制流</span></span><br><span class="line">readfile($file);</span><br><span class="line"><span class="comment">// 删除临时文件</span></span><br><span class="line">unlink($file);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> zip </tag>
            
            <tag> ziparchive </tag>
            
            <tag> apk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>防御性编程</title>
      <link href="/defensive-programming/"/>
      <url>/defensive-programming/</url>
      
        <content type="html"><![CDATA[<p>在公司，我们碰到的很大一部分问题都是NullPointerException。我常常就想：这段程序明明在我电脑运行好好的，为什么会出现这种情况呢？<br>因为，我们永远都无法预测用户使用时会发生的各种情况。所以防御性编程可以让我们减少很大一部分错误。</p><a id="more"></a><h2 id="开始之前先看这段代码"><a href="#开始之前先看这段代码" class="headerlink" title="开始之前先看这段代码"></a>开始之前先看这段代码</h2><p>需求： 将字符串转换成一个数字，如”12345”(string)转为12345(int)。<br>代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">atoi</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">    $len    = strlen($a);</span><br><span class="line">    $num    = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=$len<span class="number">-1</span>; $i&gt;=<span class="number">0</span>; $i--)&#123;</span><br><span class="line">        $num    += ($a&#123;$i&#125;<span class="number">-0</span>) * pow(<span class="number">10</span>, $len-$i<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题：</p><ul><li>如果传进来一个负数结果是什么？比如：”-123456”。</li><li>如果传进来一个null或false会怎么样？（php返回的结果都是0，貌似没错）</li></ul><p>恍然大悟！！！太多东西没考虑！！！</p><h2 id="什么是防御性编程"><a href="#什么是防御性编程" class="headerlink" title="什么是防御性编程"></a>什么是防御性编程</h2><blockquote><p>顾名思义，防御性编程（Defensive programming）是一种细致、谨慎的编程方法。<br>防御式编程主要用于可能被滥用，恶作剧或无意地造成灾难性影响的程序上。<br>防御性编程是一种防卫方式，而不是一种补救形式。</p></blockquote><h2 id="如何写防御性代码呢"><a href="#如何写防御性代码呢" class="headerlink" title="如何写防御性代码呢"></a>如何写防御性代码呢</h2><p>看看这样会不会好一些？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">atoi</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_null($a)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'$a is null'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">false</span>===$a) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'$a is false'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span>==strlen($a)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'$a is empty string'</span>);</span><br><span class="line">    $len    = strlen($a);</span><br><span class="line">    $num    = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=$len<span class="number">-1</span>; $i&gt;=<span class="number">0</span>; $i--)&#123;</span><br><span class="line">        $num    += ($a&#123;$i&#125;<span class="number">-0</span>) * pow(<span class="number">10</span>, $len-$i<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重要的经验就是：<br>当你写一个方法需要对传入的参数进行处理或者计算的时候，你必须要严格验证传入参数的正确性，如果不符合，就应当给出提示！<br>防御性编程的最基本规则：<br>保护程序免遭非法输入数据的破坏。</p><h2 id="为什么要防御性编程"><a href="#为什么要防御性编程" class="headerlink" title="为什么要防御性编程"></a>为什么要防御性编程</h2><ul><li>为了让你写的代码正确运行</li><li>提供参数错误的原因</li><li>可以快速找到 bug</li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx安全配置之白名单设置</title>
      <link href="/nginx-config-white-list/"/>
      <url>/nginx-config-white-list/</url>
      
        <content type="html"><![CDATA[<blockquote><p>网站安全，防不胜防</p></blockquote><p>你永远不知道黑客利用什么漏洞对你的网站进行攻击，最常见的手段是利用漏洞在你的网站留个后门，喜欢的时候来逛逛，比如玩你的服务器上传一个x.php，直接访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.example.com/a/b/c/d/a.php</span><br></pre></td></tr></table></figure><p>然后就可以为所欲为了，那么有没有办法让黑客即使利用漏洞上传了php代码而没办法运行呢？答案是肯定的。</p><p>思路是从运行php的php-fpm着手，在nginx上做配置，客官请看配置。</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.example.com;</span><br><span class="line">    root         /home/htdocs/app/;</span><br><span class="line">    index        index.php;</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?s=<span class="variable">$uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ .*\.php$ &#123;</span><br><span class="line">        <span class="comment"># 白名单配置，只允许/index.php、/api.php访问</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> !~* <span class="string">"^/(index|api)\.php$"</span>) &#123;</span><br><span class="line">            <span class="built_in">return</span> 403;</span><br><span class="line">        &#125;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        include        fcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> nginx </tag>
            
            <tag> webserver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>修改配置nginx限制恶意爬虫频率</title>
      <link href="/nginx-limit-req-to-limit-spider/"/>
      <url>/nginx-limit-req-to-limit-spider/</url>
      
        <content type="html"><![CDATA[<p>超过设置的限定频率，就会给<code>spider</code>一个<code>503</code>。<br>上述配置详细解释请自行<code>google</code>下，具体的<code>spider/bot</code>名称请自定义。</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局配置</span></span><br><span class="line">limit_req_zone <span class="variable">$anti_spider</span> zone=anti_spider:10m rate=15r/m;</span><br><span class="line"><span class="comment">#某个server中</span></span><br><span class="line">limit_req zone=anti_spider burst=30 nodelay;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"xxspider|xxbot"</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$anti_spider</span> <span class="variable">$http_user_agent</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> 爬虫 </tag>
            
            <tag> robots </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用反向代理批量实现https协议访问</title>
      <link href="/use-nginx-proxy-for-muilt-https-setting/"/>
      <url>/use-nginx-proxy-for-muilt-https-setting/</url>
      
        <content type="html"><![CDATA[<p>最近有一个项目需求，需要为站点增加https访问。</p><p>开始只配置了www域名下的https，发现css和js都无法正常加载，原因是https页面，如果加载http协议的内容，会被认为页面不安全，尤其是IE，刷新一下页面就要弹出一次确认，相当烦人。</p><p>后来苦逼的把各个子域名都加入了https配置，nginx.conf里写各个子域名都写了一个443的server配置，每新增一个域名，还得copy一份，如果是修改一下站点的配置，还得改两次以上。</p><a id="more"></a><p>后来跟同事讨论，发现使用反向代理，可以快捷现实，配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">sever&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    sever_name www.hdj.me;</span><br><span class="line">    root /home/webroot/www/;</span><br><span class="line">    index index.php index.html;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br><span class="line">sever&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    sever_name img.hdj.me;</span><br><span class="line">    root /home/webroot/img/;</span><br><span class="line">    index index.php index.html;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br><span class="line">sever&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    sever_name static.hdj.me;</span><br><span class="line">    root /home/webroot/static/;</span><br><span class="line">    index index.php index.html;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br><span class="line">sever&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    sever_name upload.hdj.me;</span><br><span class="line">    root /home/webroot/upload/;</span><br><span class="line">    index index.php index.html;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name www.hdj.me img.hdj.me static.hdj.me upload.hdj.me;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /usr/<span class="built_in">local</span>/nginx/conf/hdj.me.crt;</span><br><span class="line">    ssl_certificate_key /usr/<span class="built_in">local</span>/nginx/conf/hdj.me.key;</span><br><span class="line"> </span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:80;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header SSL <span class="string">'1'</span>;</span><br><span class="line">        proxy_redirect http:// https://;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样配置好，访问：</p><ul><li><a href="https://www.hdj.me/" target="_blank" rel="noopener">https://www.hdj.me/</a></li><li><a href="https://img.hdj.me/" target="_blank" rel="noopener">https://img.hdj.me/</a></li><li><a href="https://static.hdj.me/" target="_blank" rel="noopener">https://static.hdj.me/</a></li><li><a href="https://upload.hdj.me/" target="_blank" rel="noopener">https://upload.hdj.me/</a></li></ul><p>会被反向代理至：</p><ul><li><a href="http://www.hdj.me/" target="_blank" rel="noopener">http://www.hdj.me/</a></li><li><a href="http://img.hdj.me/" target="_blank" rel="noopener">http://img.hdj.me/</a></li><li><a href="http://static.hdj.me/" target="_blank" rel="noopener">http://static.hdj.me/</a></li><li><a href="http://upload.hdj.me/" target="_blank" rel="noopener">http://upload.hdj.me/</a></li></ul><p>而不需要对各个域名都配置一个443的站点。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> https </tag>
            
            <tag> proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx服务器防sql注入/溢出攻击/spam及禁User-agents</title>
      <link href="/nginx-block-sqlinjections-and-deny-user-agents/"/>
      <url>/nginx-block-sqlinjections-and-deny-user-agents/</url>
      
        <content type="html"><![CDATA[<p>废话不说，直接上配置，客官请看</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    <span class="comment">## 禁SQL注入 Block SQL injections</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_sql_injections</span> 0;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"union.*select.*\("</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_sql_injections</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"union.*all.*select.*"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_sql_injections</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"concat.*\("</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_sql_injections</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$block_sql_injections</span> = 1) &#123;</span><br><span class="line">        <span class="built_in">return</span> 444;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 禁掉文件注入</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_file_injections</span> 0;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"[a-zA-Z0-9_]=http://"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_file_injections</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"[a-zA-Z0-9_]=(\.\.//?)+"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_file_injections</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"[a-zA-Z0-9_]=/([a-z0-9_.]//?)+"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_file_injections</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$block_file_injections</span> = 1) &#123;</span><br><span class="line">        <span class="built_in">return</span> 444;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 禁掉溢出攻击</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 0;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"(&lt;|%3C).*script.*(&gt;|%3E)"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"GLOBALS(=|\[|\%[0-9A-Z]&#123;0,2&#125;)"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"_REQUEST(=|\[|\%[0-9A-Z]&#123;0,2&#125;)"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"proc/self/environ"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"mosConfig_[a-zA-Z_]&#123;1,21&#125;(=|\%3D)"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"base64_(en|de)code\(.*\)"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$block_common_exploits</span> = 1) &#123;</span><br><span class="line">        <span class="built_in">return</span> 444;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 禁spam字段</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_spam</span> 0;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$block_spam</span> = 1) &#123;</span><br><span class="line">        <span class="built_in">return</span> 444;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 禁掉user-agents</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 0;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Don’t disable wget if you need it to run cron jobs!</span></span><br><span class="line">    <span class="comment"># if ($http_user_agent ~ "Wget") &#123;</span></span><br><span class="line">    <span class="comment">#     set $block_user_agents 1;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Disable Akeeba Remote Control 2.5 and earlier</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Indy Library"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Common bandwidth hoggers and hacking tools.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"libwww-perl"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"GetRight"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"GetWeb!"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Go!Zilla"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Download Demon"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Go-Ahead-Got-It"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"TurnitinBot"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"GrabNet"</span>) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$block_user_agents</span> = 1) &#123;</span><br><span class="line">        <span class="built_in">return</span> 444;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><blockquote><p>防sql注入/溢出攻击/spam采用禁掉URL中包含的字段实现，请根据需要合理添加返回444,是完全不回应客户端，比403更加非常节省系统资源</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> sql </tag>
            
            <tag> 注入 </tag>
            
            <tag> spam </tag>
            
            <tag> user-agent </tag>
            
            <tag> 溢出攻击 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>未知的恐惧——NULL</title>
      <link href="/null-in-mysql/"/>
      <url>/null-in-mysql/</url>
      
        <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="literal">NULL</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="literal">NULL</span> = <span class="number">12345</span>,</span><br><span class="line">    <span class="literal">NULL</span> &lt;&gt; <span class="number">12345</span>,</span><br><span class="line">    <span class="literal">NULL</span> + <span class="number">12345</span>,</span><br><span class="line">    <span class="literal">NULL</span> || <span class="string">'abc'</span>,</span><br><span class="line">    <span class="literal">NULL</span> = <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="literal">NULL</span> &lt;&gt; <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="literal">NULL</span> <span class="keyword">AND</span> <span class="literal">TRUE</span> ,</span><br><span class="line">    <span class="literal">NULL</span> <span class="keyword">AND</span> <span class="literal">FALSE</span> ,</span><br><span class="line">    <span class="literal">NULL</span> <span class="keyword">OR</span> <span class="literal">FALSE</span> ,</span><br><span class="line">    <span class="literal">NULL</span> <span class="keyword">OR</span> <span class="literal">TRUE</span> ,</span><br><span class="line">    <span class="keyword">NOT</span> (<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>如果这是一道面试题，估计不知道有多少程序员甚至是DBA会阵亡。</p><a id="more"></a><p>正确的答案是什么？（为了加深印象，建议复制SQL到mysql里去执行，看一下）</p><p>下面跟大家分析一下原因：</p><p><img src="/images/null-in-mysql.png" alt="图片"></p><p>那么在应用中如何避免NULL带来的一些困扰呢？</p><blockquote><ul><li>把NULL当成一个特殊值，不等于空、0、FALSE，使用IS NULL/IS NOT NULL去检测</li><li>声明NOT NULL列，给于默认值</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> null </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux下查看nginx，apache，mysql，php的编译参数</title>
      <link href="/linux-check-nginx-apache-mysql-php-configure/"/>
      <url>/linux-check-nginx-apache-mysql-php-configure/</url>
      
        <content type="html"><![CDATA[<p>在升级软件版本的时候，如果没有文档，那是相当痛苦的事情，编译参数是什么？</p><a id="more"></a><p>1、nginx编译参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure><p>2、apache编译参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/<span class="built_in">local</span>/apache/build/config.nice</span><br></pre></td></tr></table></figure><p>3、php编译参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/php/bin/php -i |grep configure</span><br></pre></td></tr></table></figure><p>4、mysql编译参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/<span class="built_in">local</span>/mysql/bin/mysqlbug|grep configure</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> nginx </tag>
            
            <tag> mysql </tag>
            
            <tag> apache </tag>
            
            <tag> configure </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内网机器的获取公网IP的方法</title>
      <link href="/intranet-computer-get-internet-ip-by-php/"/>
      <url>/intranet-computer-get-internet-ip-by-php/</url>
      
        <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getClientIp</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    $socket = socket_create(AF_INET, SOCK_STREAM, <span class="number">6</span>);  </span><br><span class="line">    $ret = socket_connect($socket,<span class="string">'ns1.dnspod.net'</span>,<span class="number">6666</span>);  </span><br><span class="line">    $buf = socket_read($socket, <span class="number">16</span>);  </span><br><span class="line">    socket_close($socket);  </span><br><span class="line">    <span class="keyword">return</span> $buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缺点：依赖第三方，效率与网络状况有关。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> getclientip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx upstream的5种权重分配方式</title>
      <link href="/five-ways-of-nginx-upstream/"/>
      <url>/five-ways-of-nginx-upstream/</url>
      
        <content type="html"><![CDATA[<p>1、轮询（默认）</p><blockquote><p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p></blockquote><p>2、weight<br>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</p><a id="more"></a><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 192.168.0.14 weight=10;</span><br><span class="line">    server 192.168.0.15 weight=10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、ip_hash<br>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。<br>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 192.168.0.14:88;</span><br><span class="line">    server 192.168.0.15:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、fair（第三方）<br>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server server1.linuxany.com;</span><br><span class="line">    server server2.linuxany.com;</span><br><span class="line">    fair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5、url_hash（第三方）</p><p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</p><p>例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server squid1:3128;</span><br><span class="line">    server squid2:3128;</span><br><span class="line">    <span class="built_in">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    hash_method crc32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>定义负载均衡设备的Ip及设备状态</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 127.0.0.1:9090 down;</span><br><span class="line">    server 127.0.0.1:8080 weight=2;</span><br><span class="line">    server 127.0.0.1:6060;</span><br><span class="line">    server 127.0.0.1:7070 backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在需要使用负载均衡的server中增加</p><blockquote><p>proxy_pass <code>http://bakend/</code>;</p></blockquote><p>每个设备的状态设置为:</p><ul><li>down 表示单前的server暂时不参与负载</li><li>weight 默认为1.weight越大，负载的权重就越大。</li><li>max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误</li><li>fail_timeout:max_fails次失败后，暂停的时间。</li><li>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</li></ul><p>nginx支持同时设置多组的负载均衡，用来给不用的server来使用。</p><blockquote><p><code>client_body_in_file_only</code> 设置为<code>On</code> 可以讲client post过来的数据记录到文件中用来做debug<br><code>client_body_temp_path</code> 设置记录文件的目录 可以设置最多3层目录</p></blockquote><p><code>location</code> 对URL进行匹配.可以进行重定向或者进行新的代理<code>负载均衡</code></p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> upstream </tag>
            
            <tag> weight </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>preg_match正则匹配的字符串长度问题</title>
      <link href="/strlen-of-preg-match/"/>
      <url>/strlen-of-preg-match/</url>
      
        <content type="html"><![CDATA[<p>项目中，用<code>preg_match</code>正则提取目标内容，死活有问题，代码测得死去活来。<br>后来发现<code>pcre.backtrack_limit</code>的值默认只设了<code>100000</code>。</p><a id="more"></a><p>解决办法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(‘pcre.backtrack_limit’, <span class="number">999999999</span>);</span><br></pre></td></tr></table></figure><p>注：这个参数在php 5.2.0版本之后可用。<br>另外说说关于：<code>pcre.recursion_limit</code><br><code>pcre.recursion_limit</code>是<code>PCRE</code>的递归限制，这个项如果设很大的值，会消耗所有进程的可用堆栈，最后导致PHP崩溃。<br>也可以通过修改配置来限制：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(‘pcre.recursion_limit’, <span class="number">99999</span>);</span><br></pre></td></tr></table></figure><p>实际项目应用中，最好也对内存进行限定设置：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(‘memory_limit’, ’<span class="number">64</span>M’);</span><br></pre></td></tr></table></figure><p>这样就比较稳妥妥嘎。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> 正则 </tag>
            
            <tag> regex </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux下测试硬盘读写速度</title>
      <link href="/test-for-disk-rw-in-linux/"/>
      <url>/test-for-disk-rw-in-linux/</url>
      
        <content type="html"><![CDATA[<p>time有计时作用<br>dd用于复制，从if读出，写到of<br><code>if=/dev/zero</code>不产生IO，因此可以用来测试纯写速度。<br>同理<code>of=/dev/null</code>不产生IO，可以用来测试纯读速度。<br>bs是每次读或写的大小，即一个块的大小，count是读写块的数量。</p><a id="more"></a><h3 id="1-测-目录所在磁盘的纯写速度："><a href="#1-测-目录所在磁盘的纯写速度：" class="headerlink" title="1.测/目录所在磁盘的纯写速度："></a>1.测/目录所在磁盘的纯写速度：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time dd <span class="keyword">if</span>=/dev/zero bs=1024 count=1000000 of=/1Gb.file</span><br></pre></td></tr></table></figure><h3 id="2-测-目录所在磁盘的纯读速度："><a href="#2-测-目录所在磁盘的纯读速度：" class="headerlink" title="2.测/目录所在磁盘的纯读速度："></a>2.测/目录所在磁盘的纯读速度：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/kvm/ftp/other/1Gb.file bs=64k |dd of=/dev/null</span><br></pre></td></tr></table></figure><h3 id="3-测读写速度-这是什么-："><a href="#3-测读写速度-这是什么-：" class="headerlink" title="3.测读写速度(这是什么)："></a>3.测读写速度(这是什么)：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/vat/<span class="built_in">test</span> of=/oradata/test1 bs=64k</span><br></pre></td></tr></table></figure><blockquote><p>理论上复制量越大测试越准确。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> dd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>作品</title>
      <link href="/cases/"/>
      <url>/cases/</url>
      
        <content type="html"><![CDATA[<blockquote><p>从事IT10余年，做过大大小小的项目挺多的，有些已经下线了，整理为了有一天能回顾一下。</p></blockquote><a id="more"></a><h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><ul><li><a href="http://www.sucop.com" target="_blank" rel="noopener">超级巡警</a></li><li><a href="http://www.qianyun.cn" target="_blank" rel="noopener">千云科技</a></li><li><a href="http://webscan.sucop.com" target="_blank" rel="noopener">超级巡警网页版</a></li><li><a href="http://jmx.unnoo.com" target="_blank" rel="noopener">鸡毛信</a></li><li><a href="http://www.unnoo.com" target="_blank" rel="noopener">大成天下</a></li><li><a href="http://www.xiaobai.com" target="_blank" rel="noopener">小白软件</a></li><li><a href="http://baoku.xiaobai.com" target="_blank" rel="noopener">小白软件宝库</a></li><li><a href="http://www.mmgsw.com" target="_blank" rel="noopener">茂名广视网</a></li><li><a href="http://www.8591.com.tw" target="_blank" rel="noopener">宝物交易网TW</a></li><li><a href="http://www.8591.com.hk" target="_blank" rel="noopener">宝物交易网HK</a></li><li><a href="http://www.100.com.tw" target="_blank" rel="noopener">100室内设计</a></li></ul><h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><ul><li>超级巡警企业版</li><li>国家信息安全工程</li><li>上海计算机安全项目</li><li>超级巡警云查杀服务</li><li>小白软件管家</li><li>数睿即时通讯中台</li></ul><h2 id="参与开源项目"><a href="#参与开源项目" class="headerlink" title="参与开源项目"></a>参与开源项目</h2><ul><li><a href="https://github.com/top-think/think" target="_blank" rel="noopener">ThinkPHP</a></li></ul><h2 id="Larave-扩展包"><a href="#Larave-扩展包" class="headerlink" title="Larave 扩展包"></a>Larave 扩展包</h2><ul><li><a href="https://github.com/huangdijia/laravel-trigger" target="_blank" rel="noopener">Laravel Trigger</a></li><li><a href="https://github.com/huangdijia/laravel-youdu" target="_blank" rel="noopener">Laravel Youdu</a></li><li><a href="https://github.com/huangdijia/laravel-ipip" target="_blank" rel="noopener">Laravel Ipip</a></li><li><a href="https://github.com/huangdijia/laravel-ssdb" target="_blank" rel="noopener">Laravel Ssdb</a></li><li><a href="https://github.com/huangdijia/laravel-accessyou" target="_blank" rel="noopener">Laravel Accessyou</a></li><li><a href="https://github.com/huangdijia/laravel-mxtong" target="_blank" rel="noopener">Laravel Mxtong</a></li><li><a href="https://github.com/huangdijia/laravel-mitake" target="_blank" rel="noopener">Laravel Mitake</a></li><li><a href="https://github.com/huangdijia/laravel-smspro" target="_blank" rel="noopener">Laravel Smspro</a></li><li><a href="https://github.com/huangdijia/laravel-twsms" target="_blank" rel="noopener">Laravel Twsms</a></li><li><a href="https://github.com/huangdijia/laravel-icomet" target="_blank" rel="noopener">Laravel Icomet</a></li><li><a href="https://github.com/huangdijia/laravel-gateway-worker" target="_blank" rel="noopener">Laravel Gateway Worker</a></li></ul><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li><del>wnmp集成环境</del></li><li><a href="/php-code-protector/">PHP君子加密</a></li><li><del>PHP抓取视频缩略图类VedioUrlParser(支持优酷、土豆、酷六、56、乐视、搜狐)</del></li><li><a href="https://gitee.com/deeka/jsComfirm" target="_blank" rel="noopener">jQuery插件jsConfirm-1.0</a></li><li><a href="https://gitee.com/deeka/inputDefault" target="_blank" rel="noopener">基于jQuery的input提示信息插件inputDefault</a></li><li><a href="https://gitee.com/deeka/iframeupload" target="_blank" rel="noopener">基于jQuery的无刷新上传插件iframeupload</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>神奇的fastcgi_finish_request</title>
      <link href="/fastcgi-finish-request/"/>
      <url>/fastcgi-finish-request/</url>
      
        <content type="html"><![CDATA[<p>当PHP运行在<code>FastCGI</code>模式时，<code>PHP FPM</code>提供了一个名为<code>fastcgi_finish_request</code>的方法。按照文档上的说法，此方法可以提高请求的处理速度，如果有些处理可以在页面生成完后再进行，就可以使用这个方法。</p><a id="more"></a><p>听起来可能有些茫然，我们通过几个例子来说明一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'例子：'</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_finish_request();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'To be, or not to be, that is the question.'</span>;</span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">'log.txt'</span>, <span class="string">'生存还是毁灭，这是个问题。'</span>);</span><br></pre></td></tr></table></figure><p>通过浏览器（不是命令行！）运行此脚本，结果发现并没有输出相应的字符串，但却生成了相应的文件。由此说明在调用<code>fastcgi_finish_request</code>后，客户端响应就已经结束，但与此同时服务端脚本却继续运行！</p><p>合理利用这个特性可以大大提升用户体验，趁热打铁再来一个例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'例子：'</span>;</span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">'log.txt'</span>, date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" 上传视频\n"</span>, FILE_APPEND);</span><br><span class="line"></span><br><span class="line">fastcgi_finish_request();</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">file_put_contents(<span class="string">'log.txt'</span>, date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" 转换格式\n"</span>, FILE_APPEND);</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">file_put_contents(<span class="string">'log.txt'</span>, date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">" 提取图片\n"</span>, FILE_APPEND);</span><br></pre></td></tr></table></figure><p>代码里用<code>sleep</code>模拟一些耗时的操作，浏览时没有被堵塞，程序却都执行了，具体看日志。</p><p>末了给您提个醒，<code>Yahoo</code> 在 <code>Best Practices for Speeding Up Your Web Site</code> 中提到了 <code>Flush the Buffer Early</code>，也就是利用PHP中的flush方法把内容尽快发到客户端去，虽然表面上它和本文介绍的fastcgi_finish_request有些许的类似，但本质上完全不同，别混淆了。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> nginx </tag>
            
            <tag> fastcgi </tag>
            
            <tag> request </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器返回状态码详解</title>
      <link href="/http-status-codes-images-desc/"/>
      <url>/http-status-codes-images-desc/</url>
      
        <content type="html"><![CDATA[<p>以前只是看的枯燥的文字版的服务器返回状态码.<br>现在，看一张比较形象的图解,希望能增强记忆.点击图片看大图.</p><a id="more"></a><table><thead><tr><th align="left">状态码</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">400</td><td align="left">请求无效</td></tr><tr><td align="left">401.1</td><td align="left">未授权：登录失败</td></tr><tr><td align="left">401.2</td><td align="left">未授权：服务器配置问题导致登录失败</td></tr><tr><td align="left">401.3</td><td align="left">ACL 禁止访问资源</td></tr><tr><td align="left">401.4</td><td align="left">未授权：授权被筛选器拒绝</td></tr><tr><td align="left">401.5</td><td align="left">未授权：ISAPI 或 CGI 授权失败</td></tr><tr><td align="left">403</td><td align="left">禁止访问</td></tr><tr><td align="left">403</td><td align="left">对 Internet 服务管理器 (HTML) 的访问仅限于 Localhost</td></tr><tr><td align="left">403.1</td><td align="left">禁止访问：禁止可执行访问</td></tr><tr><td align="left">403.2</td><td align="left">禁止访问：禁止读访问</td></tr><tr><td align="left">403.3</td><td align="left">禁止访问：禁止写访问</td></tr><tr><td align="left">403.4</td><td align="left">禁止访问：要求 SSL</td></tr><tr><td align="left">403.5</td><td align="left">禁止访问：要求 SSL 128</td></tr><tr><td align="left">403.6</td><td align="left">禁止访问：IP 地址被拒绝</td></tr><tr><td align="left">403.7</td><td align="left">禁止访问：要求客户证书</td></tr><tr><td align="left">403.8</td><td align="left">禁止访问：禁止站点访问</td></tr><tr><td align="left">403.9</td><td align="left">禁止访问：连接的用户过多</td></tr><tr><td align="left">403.10</td><td align="left">禁止访问：配置无效</td></tr><tr><td align="left">403.11</td><td align="left">禁止访问：密码更改</td></tr><tr><td align="left">403.12</td><td align="left">禁止访问：映射器拒绝访问</td></tr><tr><td align="left">403.13</td><td align="left">禁止访问：客户证书已被吊销</td></tr><tr><td align="left">403.15</td><td align="left">禁止访问：客户访问许可过多</td></tr><tr><td align="left">403.16</td><td align="left">禁止访问：客户证书不可信或者无效</td></tr><tr><td align="left">403.17</td><td align="left">禁止访问：客户证书已经到期或者尚未生效</td></tr><tr><td align="left">404.1</td><td align="left">无法找到 Web 站点</td></tr><tr><td align="left">404</td><td align="left">无法找到文件</td></tr><tr><td align="left">405</td><td align="left">资源被禁止</td></tr><tr><td align="left">406</td><td align="left">无法接受</td></tr><tr><td align="left">407</td><td align="left">要求代理身份验证</td></tr><tr><td align="left">410</td><td align="left">永远不可用</td></tr><tr><td align="left">412</td><td align="left">先决条件失败</td></tr><tr><td align="left">414</td><td align="left">请求-URI 太长</td></tr><tr><td align="left">500</td><td align="left">内部服务器错误</td></tr><tr><td align="left">500.100</td><td align="left">内部服务器错误-ASP 错误</td></tr><tr><td align="left">500-11</td><td align="left">服务器关闭</td></tr><tr><td align="left">500-12</td><td align="left">应用程序重新启动</td></tr><tr><td align="left">500-13</td><td align="left">服务器太忙</td></tr><tr><td align="left">500-14</td><td align="left">应用程序无效</td></tr><tr><td align="left">500-15</td><td align="left">不允许请求 global.asa</td></tr><tr><td align="left">501</td><td align="left">未实现</td></tr><tr><td align="left">502</td><td align="left">网关错误</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> http </tag>
            
            <tag> status_code </tag>
            
            <tag> 状态码 </tag>
            
            <tag> 服务器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设置vim作为crontab -e的默认编辑器</title>
      <link href="/set-vim-for-crontab-default-edito/"/>
      <url>/set-vim-for-crontab-default-edito/</url>
      
        <content type="html"><![CDATA[<p>习惯了用vim修改crontab内容，可有些系统默认的是nano，用起来甚是痛苦，Google搜索了一下，找到下面方法：</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"export EDITOR=/usr/bin/vim"</span> &gt;&gt; .bashrc</span><br></pre></td></tr></table></figure><p>然后重新打开终端，输入 <code>crontab -e</code>，发现已经默认使用 <code>vim</code> 了。</p>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> vim </tag>
            
            <tag> crontab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于</title>
      <link href="/about/"/>
      <url>/about/</url>
      
        <content type="html"><![CDATA[<h2 id="网络ID"><a href="#网络ID" class="headerlink" title="网络ID"></a>网络ID</h2><ul><li>喵了个咪</li><li>游离不2</li><li>Deeka<a id="more"></a></li></ul><h2 id="毕业院校"><a href="#毕业院校" class="headerlink" title="毕业院校"></a>毕业院校</h2><ul><li><a href="http://www.gdpa.edu.cn/" target="_blank" rel="noopener">茂名学院（广东石油化工学院）</a></li></ul><h2 id="专业"><a href="#专业" class="headerlink" title="专业"></a>专业</h2><ul><li>计算机网络技术</li></ul><h2 id="技能"><a href="#技能" class="headerlink" title="技能"></a>技能</h2><h3 id="语言"><a href="#语言" class="headerlink" title="语言"></a>语言</h3><ul><li>PHP</li><li>Golang</li><li>NodeJS</li><li>Lua</li></ul><h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><ul><li>MySQL</li><li>NoSQL/MongoDB</li></ul><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><ul><li>Redis</li><li>Memcached</li><li>Ssdb</li></ul><h3 id="框架"><a href="#框架" class="headerlink" title="框架"></a>框架</h3><ul><li>Laravel/Lumen</li><li>ThinkPHP</li><li>JQuery/Vue</li></ul><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li>服务器运维</li><li>K8S</li></ul><h2 id="关注我"><a href="#关注我" class="headerlink" title="关注我"></a>关注我</h2><ul><li><a href="https://github.com/huangdijia" target="_blank" rel="noopener">GitHub</a></li><li><a href="https://packagist.org/packages/huangdijia/" target="_blank" rel="noopener">Packages</a></li><li><a href="http://twitter.com/huangdijia" target="_blank" rel="noopener">Twitter</a></li></ul><h2 id="联系我"><a href="#联系我" class="headerlink" title="联系我"></a>联系我</h2><ul><li>Email：<a href="mailto:huangdijia@gmail.com" target="_blank" rel="noopener">huangdijia@gmail.com</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>全部分类</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>全部标签</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/package.json"/>
      <url>/lib/pjax/package.json</url>
      
        <content type="html"><![CDATA[{"name":"pjax","version":"0.2.8","description":"Easily enable fast AJAX navigation on any website (using pushState + XHR)","keywords":["pjax","pushstate","ajax","navigation","transition","animation"],"repository":"https://github.com/MoOx/pjax.git","author":"Maxime Thirouin","contributors":["BehindTheMath","Robin North (http://robinnorth.co.uk)"],"license":"MIT","main":"index.js","files":["index.js","lib","pjax.js","pjax.min.js","index.d.ts"],"types":"index.d.ts","devDependencies":{"browserify":"^15.0.0","eslint":"^5.7.0","eslint-config-i-am-meticulous":"^11.0.0","husky":"^1.2.0","jsdom":"^11.5.1","jsdom-global":"^3.0.2","lint-staged":"^8.1.0","npmpub":"^3.1.0","nyc":"^11.4.1","opn-cli":"^3.1.0","prettier":"^1.14.3","serve":"^11.3.2","tap-nyc":"^1.0.3","tap-spec":"^4.1.1","tape":"^4.8.0","uglify-js":"^3.3.8"},"scripts":{"lint":"eslint .","standalone":"browserify index.js --standalone Pjax > pjax.js","build":"npm run standalone && uglifyjs pjax.js -o pjax.min.js","build-debug":"browserify index.js --debug --standalone Pjax > pjax.js","tests":"tape -r ./tests/setup.js \"./tests/**/*.js\"","test":"npm run lint && npm run tests | tap-spec","coverage-tests":"npm run tests | tap-nyc","coverage":"nyc -x \"tests/**\" npm run coverage-tests","example":"opn http://localhost:3000/example/ && serve -p 3000 .","prepublish":"npm run build","release":"npmpub"},"husky":{"hooks":{"pre-commit":"npm test && lint-staged"}},"lint-staged":{"*.js":["eslint --fix","prettier --write","git add"]}}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/index.js"/>
      <url>/lib/pjax/index.js</url>
      
        <content type="html"><![CDATA[// var executeScripts = require("./lib/execute-scripts");  // unused-varvar forEachEls = require("./lib/foreach-els");var parseOptions = require("./lib/parse-options");var switches = require("./lib/switches");var newUid = require("./lib/uniqueid");var on = require("./lib/events/on");var trigger = require("./lib/events/trigger");var clone = require("./lib/util/clone");var contains = require("./lib/util/contains");var extend = require("./lib/util/extend");var noop = require("./lib/util/noop");var Pjax = function(options) {  this.state = {    numPendingSwitches: 0,    href: null,    options: null  };  this.options = parseOptions(options);  this.log("Pjax options", this.options);  if (this.options.scrollRestoration && "scrollRestoration" in history) {    history.scrollRestoration = "manual";  }  this.maxUid = this.lastUid = newUid();  this.parseDOM(document);  on(    window,    "popstate",    function(st) {      if (st.state) {        var opt = clone(this.options);        opt.url = st.state.url;        opt.title = st.state.title;        // Since state already exists, prevent it from being pushed again        opt.history = false;        opt.scrollPos = st.state.scrollPos;        if (st.state.uid < this.lastUid) {          opt.backward = true;        } else {          opt.forward = true;        }        this.lastUid = st.state.uid;        // @todo implement history cache here, based on uid        this.loadUrl(st.state.url, opt);      }    }.bind(this)  );};Pjax.switches = switches;Pjax.prototype = {  log: require("./lib/proto/log"),  getElements: function(el) {    return el.querySelectorAll(this.options.elements);  },  parseDOM: function(el) {    var parseElement = require("./lib/proto/parse-element");    forEachEls(this.getElements(el), parseElement, this);  },  refresh: function(el) {    this.parseDOM(el || document);  },  reload: function() {    window.location.reload();  },  attachLink: require("./lib/proto/attach-link"),  attachForm: require("./lib/proto/attach-form"),  forEachSelectors: function(cb, context, DOMcontext) {    return require("./lib/foreach-selectors").bind(this)(      this.options.selectors,      cb,      context,      DOMcontext    );  },  switchSelectors: function(selectors, fromEl, toEl, options) {    return require("./lib/switches-selectors").bind(this)(      this.options.switches,      this.options.switchesOptions,      selectors,      fromEl,      toEl,      options    );  },  latestChance: function(href) {    window.location = href;  },  onSwitch: function() {    trigger(window, "resize scroll");    this.state.numPendingSwitches--;    // debounce calls, so we only run this once after all switches are finished.    if (this.state.numPendingSwitches === 0) {      this.afterAllSwitches();    }  },  loadContent: function(html, options) {    if (typeof html !== "string") {      trigger(document, "pjax:complete pjax:error", options);      return;    }    var tmpEl = document.implementation.createHTMLDocument("pjax");    // parse HTML attributes to copy them    // since we are forced to use documentElement.innerHTML (outerHTML can't be used for <html>)    var htmlRegex = /<html[^>]+>/gi;    var htmlAttribsRegex = /\s?[a-z:]+(?:=['"][^'">]+['"])*/gi;    var matches = html.match(htmlRegex);    if (matches && matches.length) {      matches = matches[0].match(htmlAttribsRegex);      if (matches.length) {        matches.shift();        matches.forEach(function(htmlAttrib) {          var attr = htmlAttrib.trim().split("=");          if (attr.length === 1) {            tmpEl.documentElement.setAttribute(attr[0], true);          } else {            tmpEl.documentElement.setAttribute(attr[0], attr[1].slice(1, -1));          }        });      }    }    tmpEl.documentElement.innerHTML = html;    this.log(      "load content",      tmpEl.documentElement.attributes,      tmpEl.documentElement.innerHTML.length    );    // Clear out any focused controls before inserting new page contents.    if (      document.activeElement &&      contains(document, this.options.selectors, document.activeElement)    ) {      try {        document.activeElement.blur();      } catch (e) {} // eslint-disable-line no-empty    }    this.switchSelectors(this.options.selectors, tmpEl, document, options);  },  abortRequest: require("./lib/abort-request"),  doRequest: require("./lib/send-request"),  handleResponse: require("./lib/proto/handle-response"),  loadUrl: function(href, options) {    options =      typeof options === "object"        ? extend({}, this.options, options)        : clone(this.options);    this.log("load href", href, options);    // Abort any previous request    this.abortRequest(this.request);    trigger(document, "pjax:send", options);    // Do the request    this.request = this.doRequest(      href,      options,      this.handleResponse.bind(this)    );  },  afterAllSwitches: function() {    // FF bug: Won’t autofocus fields that are inserted via JS.    // This behavior is incorrect. So if theres no current focus, autofocus    // the last field.    //    // http://www.w3.org/html/wg/drafts/html/master/forms.html    var autofocusEl = Array.prototype.slice      .call(document.querySelectorAll("[autofocus]"))      .pop();    if (autofocusEl && document.activeElement !== autofocusEl) {      autofocusEl.focus();    }    // execute scripts when DOM have been completely updated    this.options.selectors.forEach(function(selector) {      forEachEls(document.querySelectorAll(selector), function(el) {        // executeScripts(el);        if (el === 0) ;  // intentially left blank!      });    });    var state = this.state;    if (state.options.history) {      if (!window.history.state) {        this.lastUid = this.maxUid = newUid();        window.history.replaceState(          {            url: window.location.href,            title: document.title,            uid: this.maxUid,            scrollPos: [0, 0]          },          document.title        );      }      // Update browser history      this.lastUid = this.maxUid = newUid();      window.history.pushState(        {          url: state.href,          title: state.options.title,          uid: this.maxUid,          scrollPos: [0, 0]        },        state.options.title,        state.href      );    }    this.forEachSelectors(function(el) {      this.parseDOM(el);    }, this);    // Fire Events    trigger(document, "pjax:complete pjax:success", state.options);    if (typeof state.options.analytics === "function") {      state.options.analytics();    }    if (state.options.history) {      // First parse url and check for hash to override scroll      var a = document.createElement("a");      a.href = this.state.href;      if (a.hash) {        var name = a.hash.slice(1);        name = decodeURIComponent(name);        var curtop = 0;        var target =          document.getElementById(name) || document.getElementsByName(name)[0];        if (target) {          // http://stackoverflow.com/questions/8111094/cross-browser-javascript-function-to-find-actual-position-of-an-element-in-page          if (target.offsetParent) {            do {              curtop += target.offsetTop;              target = target.offsetParent;            } while (target);          }        }        window.scrollTo(0, curtop);      } else if (state.options.scrollTo !== false) {        // Scroll page to top on new page load        if (state.options.scrollTo.length > 1) {          window.scrollTo(state.options.scrollTo[0], state.options.scrollTo[1]);        } else {          window.scrollTo(0, state.options.scrollTo);        }      }    } else if (state.options.scrollRestoration && state.options.scrollPos) {      window.scrollTo(state.options.scrollPos[0], state.options.scrollPos[1]);    }    this.state = {      numPendingSwitches: 0,      href: null,      options: null    };  }};Pjax.isSupported = require("./lib/is-supported");// arguably could do `if( require("./lib/is-supported")()) {` but that might be a little to simpleif (Pjax.isSupported()) {  module.exports = Pjax;}// if there isn’t required browser functions, returning stupid apielse {  var stupidPjax = noop;  for (var key in Pjax.prototype) {    if (      Pjax.prototype.hasOwnProperty(key) &&      typeof Pjax.prototype[key] === "function"    ) {      stupidPjax[key] = noop;    }  }  module.exports = stupidPjax;}</html[^></html>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/CHANGELOG.html"/>
      <url>/lib/pjax/CHANGELOG.html</url>
      
        <content type="html"><![CDATA[<h1 id="0-2-8-2019-03-09"><a href="#0-2-8-2019-03-09" class="headerlink" title="0.2.8 - 2019-03-09"></a>0.2.8 - 2019-03-09</h1><ul><li>Fixed: Edge form support.<br>(<a href="https://github.com/MoOx/pjax/pull/178" target="_blank" rel="noopener">#178</a> - @robinnorth)</li><li>Fixed: Removed keyup event listener for forms.<br>(<a href="https://github.com/MoOx/pjax/pull/184" target="_blank" rel="noopener">#184</a> - @BehindTheMath)</li><li>Fixed: Bugs in evalScripts().<br>(<a href="https://github.com/MoOx/pjax/pull/186" target="_blank" rel="noopener">#186</a> - @BehindTheMath)</li><li>Fixed: Handle non-string HTML passed to loadContent().<br>(<a href="https://github.com/MoOx/pjax/pull/200" target="_blank" rel="noopener">#200</a> - @BehindTheMath)</li><li>Tooling: Switch linting to ESLint and Prettier.<br>(<a href="https://github.com/MoOx/pjax/pull/191" target="_blank" rel="noopener">#191</a> - @BehindTheMath)</li></ul><h1 id="0-2-7-2018-08-15"><a href="#0-2-7-2018-08-15" class="headerlink" title="0.2.7 - 2018-08-15"></a>0.2.7 - 2018-08-15</h1><ul><li>Fixed: Parsing values of option elements in forms.<br>(<a href="https://github.com/MoOx/pjax/pull/162" target="_blank" rel="noopener">#162</a> - @BehindTheMath)</li><li>Fixed: Added index.d.ts to package.json so it will be installed by npm.<br>(<a href="https://github.com/MoOx/pjax/commit/c589ab9c25bee6161bf3e557eaca44e51c14fb89" target="_blank" rel="noopener">c589ab9</a> - @BehindTheMath)</li><li>Fixed: <code>options.history</code> to correctly parse being set to false.<br>(<a href="https://github.com/MoOx/pjax/pull/165" target="_blank" rel="noopener">#165</a> - @BehindTheMath).</li><li>Fixed: Pass the current <code>options</code> object to <code>loadContent()</code>.<br>(<a href="https://github.com/MoOx/pjax/pull/171" target="_blank" rel="noopener">#171</a> - @BehindTheMath)</li><li>Fixed: Ensure correct XHR encoding for multipart/form-data forms<br>(<a href="https://github.com/MoOx/pjax/pull/174" target="_blank" rel="noopener">#174</a> - @BehindTheMath)</li><li>Added: More documentation.<br>(<a href="https://github.com/MoOx/pjax/pull/160" target="_blank" rel="noopener">#160</a>, <a href="https://github.com/MoOx/pjax/pull/171" target="_blank" rel="noopener">#171</a> - @robinnorth, @BehindTheMath)</li></ul><h1 id="0-2-6-2018-04-30"><a href="#0-2-6-2018-04-30" class="headerlink" title="0.2.6 - 2018-04-30"></a>0.2.6 - 2018-04-30</h1><ul><li>Fixed: Form submission for GET requests.<br>(<a href="https://github.com/MoOx/pjax/pull/129" target="_blank" rel="noopener">#129</a> - @robinnorth)</li><li>Fixed: Refactor <code>loadUrl()</code> to make manually calling simpler.<br>(<a href="https://github.com/MoOx/pjax/pull/134" target="_blank" rel="noopener">#134</a> - @robinnorth)</li><li>Fixed: Support multiple select fields in form submissions.<br>(<a href="https://github.com/MoOx/pjax/pull/147" target="_blank" rel="noopener">#147</a> - @robinnorth)</li><li>Fixed: Use the same options object in <code>handle-response</code> as in <code>send-request</code>. This way, <code>pjax.state.options</code> will also have the request options.<br>(<a href="https://github.com/MoOx/pjax/pull/148" target="_blank" rel="noopener">#148</a> - @BehindTheMath)</li><li>Added: Move the XHR callback to a separate method, and trigger an error event if the response cannot be parsed.<br>(<a href="https://github.com/MoOx/pjax/pull/137" target="_blank" rel="noopener">#137</a> - @BehindTheMath)</li><li>Added: TypeScript definitions.<br>(<a href="https://github.com/MoOx/pjax/pull/138" target="_blank" rel="noopener">#138</a> - @BehindTheMath)</li><li>Added: <code>replaceNode</code> switch, as an alternative to the <code>outerHTML</code> switch.<br>(<a href="https://github.com/MoOx/pjax/pull/141" target="_blank" rel="noopener">#141</a> - @BehindTheMath)</li><li>Added: <code>X-PJAX-Selectors</code> HTTP header. This is a serialized JSON array of selectors, taken from <code>options.selectors</code>. You can use this to send back only the elements that Pjax will use to switch, instead of sending the whole page.<br>(<a href="https://github.com/MoOx/pjax/pull/144" target="_blank" rel="noopener">#144</a> - @BehindTheMath)</li><li>Added: An option to use <code>FormData</code> to submit forms.<br>(<a href="https://github.com/MoOx/pjax/pull/153" target="_blank" rel="noopener">#153</a> - @BehindTheMath)</li><li>Added: Tests.<br>(<a href="https://github.com/MoOx/pjax/commit/f98f2dd63b48113ff91b6bd8808257bfc723ef6b" target="_blank" rel="noopener">f98f2dd</a>, <a href="https://github.com/MoOx/pjax/pull/145" target="_blank" rel="noopener">#145</a> - @robinnorth, @BehindTheMath)</li></ul><h1 id="0-2-5-2018-02-02"><a href="#0-2-5-2018-02-02" class="headerlink" title="0.2.5 - 2018-02-02"></a>0.2.5 - 2018-02-02</h1><ul><li>Fixed: Async switch functions now work correctly, because the DOM is now parsed after all the switches finish.<br>(<a href="https://github.com/MoOx/pjax/pull/79" target="_blank" rel="noopener">#79</a>, <a href="https://github.com/MoOx/pjax/pull/110" target="_blank" rel="noopener">#110</a> - @oskarrough, @BehindTheMath, @robinnorth)</li><li>Fixed: Bug on IE11 preventing AJAX page refresh.<br>(<a href="https://github.com/MoOx/pjax/pull/81" target="_blank" rel="noopener">#81</a> - @CPTechnikVX)</li><li>Fixed: Default switches are now available as <code>Pjax.switches</code>.<br>(<a href="https://github.com/MoOx/pjax/pull/92" target="_blank" rel="noopener">#92</a> - @BehindTheMath)</li><li>Fixed: An error that was caused by a missing <code>switchElementsAlt</code>.<br>(<a href="https://github.com/MoOx/pjax/pull/93" target="_blank" rel="noopener">#93</a>, <a href="https://github.com/MoOx/pjax/pull/104" target="_blank" rel="noopener">#104</a> - @BehindTheMath, @robinnorth)</li><li>Fixed: Incorrect <code>main</code> field in npm package<br>(<a href="https://github.com/MoOx/pjax/pull/105" target="_blank" rel="noopener">#105</a> - @robinnorth)</li><li>Fixed: A pending XHR is now aborted if the user navigates somewhere else before the request is finished.<br>(<a href="https://github.com/MoOx/pjax/pull/114" target="_blank" rel="noopener">#114</a> - @robinnorth)</li><li>Fixed: When rendering new content, focus will now be removed only from elements within one of the containers manipulated by Pjax.<br>(<a href="https://github.com/MoOx/pjax/pull/116" target="_blank" rel="noopener">#116</a> - @BehindTheMath)</li><li>Fixed: Stop dispatching extraneous <code>pjax:complete</code> events when external scripts load<br>(<a href="https://github.com/MoOx/pjax/pull/118" target="_blank" rel="noopener">#118</a> - @robinnorth)</li><li>Added: Send the <code>X-PJAX</code> header with XHR requests.<br>(<a href="https://github.com/MoOx/pjax/pull/80" target="_blank" rel="noopener">#80</a> - @bram1028)</li><li>Added: Direct download link for script tags. (@MoOx)</li><li>Added: Pass the element that triggered Pjax to the <code>pjax:send</code> event.<br>(<a href="https://github.com/MoOx/pjax/pull/94" target="_blank" rel="noopener">#94</a> - @BehindTheMath)</li><li>Added: An option to set a timeout for XHR requests.<br>(<a href="https://github.com/MoOx/pjax/pull/95" target="_blank" rel="noopener">#95</a> - @BehindTheMath)</li><li>Added: Checks for XHR redirects<br>(<a href="https://github.com/MoOx/pjax/pull/101" target="_blank" rel="noopener">#101</a> - @BehindTheMath)</li><li>Added: Save scroll position with history, and restore when navigating backwards or forwards.<br>(<a href="https://github.com/MoOx/pjax/pull/110" target="_blank" rel="noopener">#110</a>, <a href="https://github.com/MoOx/pjax/pull/119" target="_blank" rel="noopener">#119</a> - @BehindTheMath, @robinnorth)</li><li>Added: Scroll to element position when URL contains a hash<br>(<a href="https://github.com/MoOx/pjax/pull/110" target="_blank" rel="noopener">#110</a> - @BehindTheMath)</li><li>Added: Minified version of the Pjax bundle.<br>(<a href="https://github.com/MoOx/pjax/pull/115" target="_blank" rel="noopener">#115</a> - @BehindTheMath)</li><li>Changed: Miscellaneous code and tests cleanup.<br>(<a href="https://github.com/MoOx/pjax/pull/96" target="_blank" rel="noopener">#96</a>, <a href="https://github.com/MoOx/pjax/pull/98" target="_blank" rel="noopener">#98</a>, <a href="https://github.com/MoOx/pjax/pull/99" target="_blank" rel="noopener">#99</a>, <a href="https://github.com/MoOx/pjax/pull/1070" target="_blank" rel="noopener">#100</a>, <a href="https://github.com/MoOx/pjax/pull/107" target="_blank" rel="noopener">#107</a>, <a href="https://github.com/MoOx/pjax/pull/113" target="_blank" rel="noopener">#113</a>, <a href="https://github.com/MoOx/pjax/pull/120" target="_blank" rel="noopener">#120</a> - @BehindTheMath, @MoOx, @robinnorth)</li></ul><h1 id="0-2-4-2016-06-28"><a href="#0-2-4-2016-06-28" class="headerlink" title="0.2.4 - 2016-06-28"></a>0.2.4 - 2016-06-28</h1><ul><li>Fixed: <code>refresh</code> should now work (use <code>this.parseDOM</code> for refresh)<br>(<a href="https://github.com/MoOx/pjax/pull/67" target="_blank" rel="noopener">#67</a> - @compressed)</li><li>Fixed: Some attributes, such as <code>itemscope</code> have no corresponding value.<br>This change allows them to still be set.<br>(<a href="https://github.com/MoOx/pjax/pull/67" target="_blank" rel="noopener">#67</a> - @compressed)</li><li>Added: <code>cacheBust</code> option<br>(<a href="https://github.com/MoOx/pjax/pull/71" target="_blank" rel="noopener">#71</a> - @tremby)</li></ul><h1 id="0-2-3-2016-03-24"><a href="#0-2-3-2016-03-24" class="headerlink" title="0.2.3 - 2016-03-24"></a>0.2.3 - 2016-03-24</h1><ul><li>Fixed: <code>currentUrlFullReload</code> option now works</li><li>Fixed: <code>this.reload</code> is now a Function<br>(<a href="https://github.com/MoOx/pjax/issues/65" target="_blank" rel="noopener">#65</a>)</li></ul><h1 id="0-2-2-2016-03-12"><a href="#0-2-2-2016-03-12" class="headerlink" title="0.2.2 - 2016-03-12"></a>0.2.2 - 2016-03-12</h1><ul><li>Fixed: added back standalone version in <code>./pjax.js</code><br>(<a href="https://github.com/MoOx/pjax/issues/57" target="_blank" rel="noopener">#57</a></li><li>Fixed: error when using pjax with google analytics (<code>options</code> was undefined)<br>(<a href="https://github.com/MoOx/pjax/pull/59" target="_blank" rel="noopener">#59</a>)</li><li>Fixed: HierarchyRequestError error<br>(<a href="https://github.com/MoOx/pjax/pull/49" target="_blank" rel="noopener">#49</a>)</li><li>Fixed: <code>TypeError: Pjax.forEachEls is not a function</code><br>(<a href="https://github.com/MoOx/pjax/pull/52" target="_blank" rel="noopener">#52</a>)</li><li>Fixed: <code>TypeError: Pjax.executeScripts is not a function</code><br>(<a href="https://github.com/MoOx/pjax/pull/52" target="_blank" rel="noopener">#52</a>)</li><li>Fixed: <code>TypeError: Pjax.clone is not a function</code><br>(<a href="https://github.com/MoOx/pjax/pull/52" target="_blank" rel="noopener">#52</a>)</li><li>Added: Ignore events with prevented defaults<br>(<a href="https://github.com/MoOx/pjax/pull/50" target="_blank" rel="noopener">#50</a>)</li></ul><h1 id="0-2-1-2015-02-04"><a href="#0-2-1-2015-02-04" class="headerlink" title="0.2.1 - 2015-02-04"></a>0.2.1 - 2015-02-04</h1><ul><li>Fixed: it’s better when a release have actual files.</li></ul><h1 id="0-2-0-2015-02-04"><a href="#0-2-0-2015-02-04" class="headerlink" title="0.2.0 - 2015-02-04"></a>0.2.0 - 2015-02-04</h1><ul><li>Fixed: prevent scrollTo from being converted from false to 0 (<a href="https://github.com/MoOx/pjax/pull/33" target="_blank" rel="noopener">#33</a>)</li><li>Changed: code exploded in commonjs style</li><li>Added: lots of tests</li><li>Added: <code>refresh</code> method to force update a DOM element (<a href="https://github.com/MoOx/pjax/pull/36" target="_blank" rel="noopener">#36</a>)</li></ul><h1 id="0-1-4-2014-10-14"><a href="#0-1-4-2014-10-14" class="headerlink" title="0.1.4 - 2014-10-14"></a>0.1.4 - 2014-10-14</h1><ul><li>Fixed: allow to load pages without any attributes on <code>&lt;html&gt;</code> element (fix <a href="https://github.com/MoOx/pjax/issues/6" target="_blank" rel="noopener">#6</a>)</li><li>Fixed: make <code>Pjax.switches.sideBySide</code> method usable (fix <a href="https://github.com/MoOx/pjax/issues/13" target="_blank" rel="noopener">#13</a>)</li></ul><h1 id="0-1-3-2014-09-16"><a href="#0-1-3-2014-09-16" class="headerlink" title="0.1.3 - 2014-09-16"></a>0.1.3 - 2014-09-16</h1><ul><li>Fixed: clicking on the current url somewhere does not produce a full reload by default (see option <code>currentUrlFullReload</code>)</li><li>Fixed: <code>document.implementation.createHTMLDocument</code> error (in IE10, ref <a href="https://github.com/MoOx/pjax/pull/16" target="_blank" rel="noopener">#16</a>)</li></ul><h1 id="0-1-2-2014-04-03"><a href="#0-1-2-2014-04-03" class="headerlink" title="0.1.2 - 2014-04-03"></a>0.1.2 - 2014-04-03</h1><ul><li>Changed: <code>pjax.js</code> relocated in <code>src/</code></li><li>Fixed: <code>&lt;html&gt;</code> attributes of pjaxified document are now available</li></ul><h1 id="0-1-1-2014-04-02"><a href="#0-1-1-2014-04-02" class="headerlink" title="0.1.1 - 2014-04-02"></a>0.1.1 - 2014-04-02</h1><ul><li>Fixed: safer UMD wrapper (fix concat issue)</li></ul><h1 id="0-1-0-2014-03-24"><a href="#0-1-0-2014-03-24" class="headerlink" title="0.1.0 - 2014-03-24"></a>0.1.0 - 2014-03-24</h1><p>✨ Initial release</p>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/pjax.min.js"/>
      <url>/lib/pjax/pjax.min.js</url>
      
        <content type="html"><![CDATA[(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Pjax=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){var executescripts="require("./lib/execute-scripts");var" foreachels="require("./lib/foreach-els");var" parseoptions="require("./lib/parse-options");var" switches="require("./lib/switches");var" newuid="require("./lib/uniqueid");var" on="require("./lib/events/on");var" trigger="require("./lib/events/trigger");var" clone="require("./lib/util/clone");var" contains="require("./lib/util/contains");var" extend="require("./lib/util/extend");var" noop="require("./lib/util/noop");var" pjax="function(options){this.state={numPendingSwitches:0,href:null,options:null};this.options=parseOptions(options);this.log("Pjax" options",this.options);if(this.options.scrollrestoration&&"scrollrestoration"in history){history.scrollrestoration="manual" }this.maxuid="this.lastUid=newUid();this.parseDOM(document);on(window,"popstate",function(st){if(st.state){var" opt="clone(this.options);opt.url=st.state.url;opt.title=st.state.title;opt.history=false;opt.scrollPos=st.state.scrollPos;if(st.state.uid<this.lastUid){opt.backward=true}else{opt.forward=true}this.lastUid=st.state.uid;this.loadUrl(st.state.url,opt)}}.bind(this))};Pjax.switches=switches;Pjax.prototype={log:require("./lib/proto/log"),getElements:function(el){return" el.queryselectorall(this.options.elements)},parsedom:function(el){var parseelement="require("./lib/proto/parse-element");forEachEls(this.getElements(el),parseElement,this)},refresh:function(el){this.parseDOM(el||document)},reload:function(){window.location.reload()},attachLink:require("./lib/proto/attach-link"),attachForm:require("./lib/proto/attach-form"),forEachSelectors:function(cb,context,DOMcontext){return" require(". lib foreach-selectors").bind(this)(this.options.selectors,cb,context,domcontext)},switchselectors:function(selectors,fromel,toel,options){return switches-selectors").bind(this)(this.options.switches,this.options.switchesoptions,selectors,fromel,toel,options)},latestchance:function(href){window.location="href},onSwitch:function(){trigger(window,"resize" scroll");this.state.numpendingswitches--;if(this.state.numpendingswitches="==0){this.afterAllSwitches()}},loadContent:function(html,options){if(typeof" html!="="string"){trigger(document,"pjax:complete" pjax:error",options);return}var tmpel="document.implementation.createHTMLDocument("pjax");var" htmlregex="/<html[^">]+>/gi;var htmlAttribsRegex=/\s?[a-z:]+(?:=['"][^'">]+['"])*/gi;var matches=html.match(htmlRegex);if(matches&&matches.length){matches=matches[0].match(htmlAttribsRegex);if(matches.length){matches.shift();matches.forEach(function(htmlAttrib){var attr=htmlAttrib.trim().split("=");if(attr.length===1){tmpEl.documentElement.setAttribute(attr[0],true)}else{tmpEl.documentElement.setAttribute(attr[0],attr[1].slice(1,-1))}})}}tmpEl.documentElement.innerHTML=html;this.log("load content",tmpEl.documentElement.attributes,tmpEl.documentElement.innerHTML.length);if(document.activeElement&&contains(document,this.options.selectors,document.activeElement)){try{document.activeElement.blur()}catch(e){}}this.switchSelectors(this.options.selectors,tmpEl,document,options)},abortRequest:require("./lib/abort-request"),doRequest:require("./lib/send-request"),handleResponse:require("./lib/proto/handle-response"),loadUrl:function(href,options){options=typeof options==="object"?extend({},this.options,options):clone(this.options);this.log("load href",href,options);this.abortRequest(this.request);trigger(document,"pjax:send",options);this.request=this.doRequest(href,options,this.handleResponse.bind(this))},afterAllSwitches:function(){var autofocusEl=Array.prototype.slice.call(document.querySelectorAll("[autofocus]")).pop();if(autofocusEl&&document.activeElement!==autofocusEl){autofocusEl.focus()}this.options.selectors.forEach(function(selector){forEachEls(document.querySelectorAll(selector),function(el){})});var state=this.state;if(state.options.history){if(!window.history.state){this.lastUid=this.maxUid=newUid();window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid,scrollPos:[0,0]},document.title)}this.lastUid=this.maxUid=newUid();window.history.pushState({url:state.href,title:state.options.title,uid:this.maxUid,scrollPos:[0,0]},state.options.title,state.href)}this.forEachSelectors(function(el){this.parseDOM(el)},this);trigger(document,"pjax:complete pjax:success",state.options);if(typeof state.options.analytics==="function"){state.options.analytics()}if(state.options.history){var a=document.createElement("a");a.href=this.state.href;if(a.hash){var name=a.hash.slice(1);name=decodeURIComponent(name);var curtop=0;var target=document.getElementById(name)||document.getElementsByName(name)[0];if(target){if(target.offsetParent){do{curtop+=target.offsetTop;target=target.offsetParent}while(target)}}window.scrollTo(0,curtop)}else if(state.options.scrollTo!==false){if(state.options.scrollTo.length>1){window.scrollTo(state.options.scrollTo[0],state.options.scrollTo[1])}else{window.scrollTo(0,state.options.scrollTo)}}}else if(state.options.scrollRestoration&&state.options.scrollPos){window.scrollTo(state.options.scrollPos[0],state.options.scrollPos[1])}this.state={numPendingSwitches:0,href:null,options:null}}};Pjax.isSupported=require("./lib/is-supported");if(Pjax.isSupported()){module.exports=Pjax}else{var stupidPjax=noop;for(var key in Pjax.prototype){if(Pjax.prototype.hasOwnProperty(key)&&typeof Pjax.prototype[key]==="function"){stupidPjax[key]=noop}}module.exports=stupidPjax}},{"./lib/abort-request":2,"./lib/events/on":4,"./lib/events/trigger":5,"./lib/execute-scripts":6,"./lib/foreach-els":7,"./lib/foreach-selectors":8,"./lib/is-supported":9,"./lib/parse-options":10,"./lib/proto/attach-form":11,"./lib/proto/attach-link":12,"./lib/proto/handle-response":13,"./lib/proto/log":14,"./lib/proto/parse-element":15,"./lib/send-request":16,"./lib/switches":18,"./lib/switches-selectors":17,"./lib/uniqueid":19,"./lib/util/clone":20,"./lib/util/contains":21,"./lib/util/extend":22,"./lib/util/noop":23}],2:[function(require,module,exports){var noop=require("./util/noop");module.exports=function(request){if(request&&request.readyState<4){request.onreadystatechange=noop;request.abort()}}},{". util noop":23}],3:[function(require,module,exports){module.exports="function(el){var" code="el.text||el.textContent||el.innerHTML||"";var" src="el.src||"";var" parent="el.parentNode||document.querySelector("head")||document.documentElement;var" script="document.createElement("script");if(code.match("document.write")){if(console&&console.log){console.log("Script" contains document.write. can’t be executed correctly. skipped ",el)}return false}script.type="text/javascript" ;script.id="el.id;if(src!==""){script.src=src;script.async=false}if(code!==""){try{script.appendChild(document.createTextNode(code))}catch(e){script.text=code}}parent.appendChild(script);if((parent" instanceof htmlheadelement||parent htmlbodyelement)&&parent.contains(script)){parent.removechild(script)}return true}},{}],4:[function(require,module,exports){var foreachels="require("../foreach-els");module.exports=function(els,events,listener,useCapture){events=typeof" events="=="string"?events.split("" "):events;events.foreach(function(e){foreachels(els,function(el){el.addeventlistener(e,listener,usecapture)})})}},{".. foreach-els":7}],5:[function(require,module,exports){var "):events;events.foreach(function(e){var event;event="document.createEvent("HTMLEvents");event.initEvent(e,true,true);event.eventName=e;if(opts){Object.keys(opts).forEach(function(key){event[key]=opts[key]})}forEachEls(els,function(el){var" domfix="false;if(!el.parentNode&&el!==document&&el!==window){domFix=true;document.body.appendChild(el)}el.dispatchEvent(event);if(domFix){el.parentNode.removeChild(el)}})})}},{"../foreach-els":7}],6:[function(require,module,exports){var" evalscript="require("./eval-script");module.exports=function(el){if(el.tagName.toLowerCase()==="script"){evalScript(el)}forEachEls(el.querySelectorAll("script"),function(script){if(!script.type||script.type.toLowerCase()==="text/javascript"){if(script.parentNode){script.parentNode.removeChild(script)}evalScript(script)}})}},{"./eval-script":3,"./foreach-els":7}],7:[function(require,module,exports){module.exports=function(els,fn,context){if(els" htmlcollection||els nodelist||els array){return array.prototype.foreach.call(els,fn,context)}return fn.call(context,els)}},{}],8:[function(require,module,exports){var window.history&&window.history.pushstate&&window.history.replacestate&&!navigator.useragent.match( ((ipod|iphone|ipad).+\bos\s+[1-4]\d|webapps\ .+cfnetwork) )}},{}],10:[function(require,module,exports){var defaultswitches="require("./switches");module.exports=function(options){options=options||{};options.elements=options.elements||"a[href]," form[action]";options.selectors="options.selectors||["title",".js-Pjax"];options.switches=options.switches||{};options.switchesOptions=options.switchesOptions||{};options.history=typeof" options.history="=="undefined"?true:options.history;options.analytics=typeof" options.analytics="=="function"||options.analytics===false?options.analytics:defaultAnalytics;options.scrollTo=typeof" options.scrollto="=="undefined"?0:options.scrollTo;options.scrollRestoration=typeof" options.scrollrestoration!="="undefined"?options.scrollRestoration:true;options.cacheBust=typeof" options.cachebust="=="undefined"?true:options.cacheBust;options.debug=options.debug||false;options.timeout=options.timeout||0;options.currentUrlFullReload=typeof" options.currenturlfullreload="=="undefined"?false:options.currentUrlFullReload;if(!options.switches.head){options.switches.head=defaultSwitches.switchElementsAlt}if(!options.switches.body){options.switches.body=defaultSwitches.switchElementsAlt}return" options};function defaultanalytics(){if(window._gaq){_gaq.push(["_trackpageview"])}if(window.ga){ga("send","pageview",{page:location.pathname,title:document.title})}}},{". switches":18}],11:[function(require,module,exports){var on="require("../events/on");var" clone="require("../util/clone");var" attrstate="data-pjax-state" ;var formaction="function(el,event){if(isDefaultPrevented(event)){return}var" options="clone(this.options);options.requestOptions={requestUrl:el.getAttribute("action")||window.location.href,requestMethod:el.getAttribute("method")||"GET"};var" virtlinkelement="document.createElement("a");virtLinkElement.setAttribute("href",options.requestOptions.requestUrl);var" attrvalue="checkIfShouldAbort(virtLinkElement,options);if(attrValue){el.setAttribute(attrState,attrValue);return}event.preventDefault();if(el.enctype==="multipart/form-data"){options.requestOptions.formData=new" formdata(el)}else{options.requestoptions.requestparams="parseFormElements(el)}el.setAttribute(attrState,"submit");options.triggerElement=el;this.loadUrl(virtLinkElement.href,options)};function" parseformelements(el){var requestparams="[];var" formelements="el.elements;for(var" i="0;i<formElements.length;i++){var" element="formElements[i];var" tagname="element.tagName.toLowerCase();if(!!element.name&&element.attributes!==undefined&&tagName!=="button"){var" type="element.attributes.type;if(!type||type.value!=="checkbox"&&type.value!=="radio"||element.checked){var" values="[];if(tagName==="select"){var" opt;for(var j="0;j<element.options.length;j++){opt=element.options[j];if(opt.selected&&!opt.disabled){values.push(opt.hasAttribute("value")?opt.value:opt.text)}}}else{values.push(element.value)}for(var" k="0;k<values.length;k++){requestParams.push({name:encodeURIComponent(element.name),value:encodeURIComponent(values[k])})}}}}return" requestparams}function checkifshouldabort(virtlinkelement,options){if(virtlinkelement.protocol!="=window.location.protocol||virtLinkElement.host!==window.location.host){return"external"}if(virtLinkElement.hash&&virtLinkElement.href.replace(virtLinkElement.hash,"")===window.location.href.replace(location.hash,"")){return"anchor"}if(virtLinkElement.href===window.location.href.split("#")[0]+"#"){return"anchor-empty"}if(options.currentUrlFullReload&&virtLinkElement.href===window.location.href.split("#")[0]){return"reload"}}var" isdefaultprevented="function(event){return" event.defaultprevented||event.returnvalue="==false};module.exports=function(el){var" that="this;el.setAttribute(attrState,"");on(el,"submit",function(event){formAction.call(that,el,event)})}},{"../events/on":4,"../util/clone":20}],12:[function(require,module,exports){var" linkaction="function(el,event){if(isDefaultPrevented(event)){return}var" checkifshouldabort(el,event){if(event.which>1||event.metaKey||event.ctrlKey||event.shiftKey||event.altKey){return"modifier"}if(el.protocol!==window.location.protocol||el.host!==window.location.host){return"external"}if(el.hash&&el.href.replace(el.hash,"")===window.location.href.replace(location.hash,"")){return"anchor"}if(el.href===window.location.href.split("#")[0]+"#"){return"anchor-empty"}}var isDefaultPrevented=function(event){return event.defaultPrevented||event.returnValue===false};module.exports=function(el){var that=this;el.setAttribute(attrState,"");on(el,"click",function(event){linkAction.call(that,el,event)});on(el,"keyup",function(event){if(event.keyCode===13){linkAction.call(that,el,event)}}.bind(this))}},{"../events/on":4,"../util/clone":20}],13:[function(require,module,exports){var clone=require("../util/clone");var newUid=require("../uniqueid");var trigger=require("../events/trigger");module.exports=function(responseText,request,href,options){options=clone(options||this.options);options.request=request;if(responseText===false){trigger(document,"pjax:complete pjax:error",options);return}var currentState=window.history.state||{};window.history.replaceState({url:currentState.url||window.location.href,title:currentState.title||document.title,uid:currentState.uid||newUid(),scrollPos:[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop]},document.title,window.location.href);var oldHref=href;if(request.responseURL){if(href!==request.responseURL){href=request.responseURL}}else if(request.getResponseHeader("X-PJAX-URL")){href=request.getResponseHeader("X-PJAX-URL")}else if(request.getResponseHeader("X-XHR-Redirected-To")){href=request.getResponseHeader("X-XHR-Redirected-To")}var a=document.createElement("a");a.href=oldHref;var oldHash=a.hash;a.href=href;if(oldHash&&!a.hash){a.hash=oldHash;href=a.href}this.state.href=href;this.state.options=options;try{this.loadContent(responseText,options)}catch(e){trigger(document,"pjax:error",options);if(!this.options.debug){if(console&&console.error){console.error("Pjax switch fail: ",e)}return this.latestChance(href)}else{throw e}}}},{"../events/trigger":5,"../uniqueid":19,"../util/clone":20}],14:[function(require,module,exports){module.exports=function(){if(this.options.debug&&console){if(typeof console.log==="function"){console.log.apply(console,arguments)}else if(console.log){console.log(arguments)}}}},{}],15:[function(require,module,exports){var attrState="data-pjax-state";module.exports=function(el){switch(el.tagName.toLowerCase()){case"a":if(!el.hasAttribute(attrState)){this.attachLink(el)}break;case"form":if(!el.hasAttribute(attrState)){this.attachForm(el)}break;default:throw"Pjax can only be applied on <a> or <form> submit"}}},{}],16:[function(require,module,exports){var updateQueryString=require("./util/update-query-string");module.exports=function(location,options,callback){options=options||{};var queryString;var requestOptions=options.requestOptions||{};var requestMethod=(requestOptions.requestMethod||"GET").toUpperCase();var requestParams=requestOptions.requestParams||null;var formData=requestOptions.formData||null;var requestPayload=null;var request=new XMLHttpRequest;var timeout=options.timeout||0;request.onreadystatechange=function(){if(request.readyState===4){if(request.status===200){callback(request.responseText,request,location,options)}else if(request.status!==0){callback(null,request,location,options)}}};request.onerror=function(e){console.log(e);callback(null,request,location,options)};request.ontimeout=function(){callback(null,request,location,options)};if(requestParams&&requestParams.length){queryString=requestParams.map(function(param){return param.name+"="+param.value}).join("&");switch(requestMethod){case"GET":location=location.split("?")[0];location+="?"+queryString;break;case"POST":requestPayload=queryString;break}}else if(formData){requestPayload=formData}if(options.cacheBust){location=updateQueryString(location,"t",Date.now())}request.open(requestMethod,location,true);request.timeout=timeout;request.setRequestHeader("X-Requested-With","XMLHttpRequest");request.setRequestHeader("X-PJAX","true");request.setRequestHeader("X-PJAX-Selectors",JSON.stringify(options.selectors));if(requestPayload&&requestMethod==="POST"&&!formData){request.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}request.send(requestPayload);return request}},{"./util/update-query-string":24}],17:[function(require,module,exports){var forEachEls=require("./foreach-els");var defaultSwitches=require("./switches");module.exports=function(switches,switchesOptions,selectors,fromEl,toEl,options){var switchesQueue=[];selectors.forEach(function(selector){var newEls=fromEl.querySelectorAll(selector);var oldEls=toEl.querySelectorAll(selector);if(this.log){this.log("Pjax switch",selector,newEls,oldEls)}if(newEls.length!==oldEls.length){throw"DOM doesn’t look the same on new loaded page: ’"+selector+"’ - new "+newEls.length+", old "+oldEls.length}forEachEls(newEls,function(newEl,i){var oldEl=oldEls[i];if(this.log){this.log("newEl",newEl,"oldEl",oldEl)}var callback=switches[selector]?switches[selector].bind(this,oldEl,newEl,options,switchesOptions[selector]):defaultSwitches.outerHTML.bind(this,oldEl,newEl,options);switchesQueue.push(callback)},this)},this);this.state.numPendingSwitches=switchesQueue.length;switchesQueue.forEach(function(queuedSwitch){queuedSwitch()})}},{"./foreach-els":7,"./switches":18}],18:[function(require,module,exports){var on=require("./events/on");module.exports={outerHTML:function(oldEl,newEl){oldEl.outerHTML=newEl.outerHTML;this.onSwitch()},innerHTML:function(oldEl,newEl){oldEl.innerHTML=newEl.innerHTML;if(newEl.className===""){oldEl.removeAttribute("class")}else{}this.onSwitch()},switchElementsAlt:function(oldEl,newEl){oldEl.innerHTML=newEl.innerHTML;if(newEl.hasAttributes()){var attrs=newEl.attributes;for(var i=0;i</form></a></4){request.onreadystatechange=noop;request.abort()}}},{".></t.length;i++)o(t[i]);return>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/example/index.html"/>
      <url>/lib/pjax/example/index.html</url>
      
        <content type="html"><![CDATA[<!doctype html><html>  <head><meta name="generator" content="Hexo 3.9.0">    <meta charset="utf-8">    <title>Hello</title>    <script src="../pjax.js"></script>    <script src="example.js"></script>  </head>  <body>    <div class="body">      <h1>Index</h1>      Hello.      Go to <a href="page2.html" class="js-Pjax">Page 2</a> or <a href="page3.html" class="js-Pjax">Page 3</a> and view your console to see Pjax events.      Clicking on <a href="index.html">this page</a> will do nothing.      <h2>Manual URL loading</h2>      You can use Pjax's <i>loadUrl</i> method to manually load a URL. Click the buttons below to try it out!<br><br>      <button data-manual-trigger>loadUrl with current options</button><br><br>      <button data-manual-trigger data-manual-trigger-override="true">loadUrl with overridden options (no cache busting)</button>      <h2>Forms</h2>      You can submit GET or POST forms with Pjax! Go to the <a href="forms.html">form examples</a> to try it out.    </div>  </body></html>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/example/page2.html"/>
      <url>/lib/pjax/example/page2.html</url>
      
        <content type="html"><![CDATA[<!doctype html><html>  <head><meta name="generator" content="Hexo 3.9.0">    <meta charset="utf-8">    <title>Page 2</title>    <script src="../pjax.js"></script>    <script src="example.js"></script>  </head>  <body>    <div class="body">      <h1>Page 2</h1>      Hello. Go to <a href="index.html" class="js-Pjax">Index</a>.    </div>  </body></html>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/example/example.js"/>
      <url>/lib/pjax/example/example.js</url>
      
        <content type="html"><![CDATA[/* global Pjax */var pjax;var initButtons = function() {  var buttons = document.querySelectorAll("button[data-manual-trigger]");  if (!buttons) {    return;  }  // jshint -W083  for (var i = 0; i < buttons.length; i++) {    buttons[i].addEventListener("click", function(e) {      var el = e.currentTarget;      if (el.getAttribute("data-manual-trigger-override") === "true") {        // Manually load URL with overridden Pjax instance options        pjax.loadUrl("/example/page2.html", { cacheBust: false });      } else {        // Manually load URL with current Pjax instance options        pjax.loadUrl("/example/page2.html");      }    });  }  // jshint +W083};console.log("Document initialized:", window.location.href);document.addEventListener("pjax:send", function() {  console.log("Event: pjax:send", arguments);});document.addEventListener("pjax:complete", function() {  console.log("Event: pjax:complete", arguments);});document.addEventListener("pjax:error", function() {  console.log("Event: pjax:error", arguments);});document.addEventListener("pjax:success", function() {  console.log("Event: pjax:success", arguments);  // Init page content  initButtons();});document.addEventListener("DOMContentLoaded", function() {  // Init Pjax instance  pjax = new Pjax({    elements: [".js-Pjax"],    selectors: [".body", "title"],    cacheBust: true  });  console.log("Pjax initialized.", pjax);  // Init page content  initButtons();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/example/page3.html"/>
      <url>/lib/pjax/example/page3.html</url>
      
        <content type="html"><![CDATA[<!doctype html><html>  <head><meta name="generator" content="Hexo 3.9.0">    <meta charset="utf-8">    <title>Page 3</title>    <script src="../pjax.js"></script>    <script src="example.js"></script>  </head>  <body>    <div class="body">      <h1>Page 3</h1>      Hello. Go to <a href="index.html" class="js-Pjax">Index</a>.    </div>  </body></html>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/example/forms.html"/>
      <url>/lib/pjax/example/forms.html</url>
      
        <content type="html"><![CDATA[<!doctype html><html>  <head><meta name="generator" content="Hexo 3.9.0">    <meta charset="utf-8">    <title>Forms</title>    <script src="../pjax.js"></script>    <script src="example.js"></script>  </head>  <body>    <div class="body">      <h1>Forms</h1>      Hello. Try out the examples below and inspect the results in your browser's developer tools, or go to the <a href="index.html" class="js-Pjax">Index</a>.      <h3>GET form</h3>      <form action method="get" class="js-Pjax" id="get-form">        <label for="get-form-text">Text input:</label>        <input type="text" name="textInput" id="get-form-text" value="Foobar">        <br>        <br>        <label for="get-form-number">Number input:</label>        <input type="number" name="numberInput" id="get-form-number" value="1">        <br>        <br>        <label for="get-form-email">Email input:</label>        <input type="email" name="emailInput" id="get-form-email" value="example@example.com">        <br>        <br>        <label for="get-form-textarea">Textarea:</label>        <textarea name="textarea" id="get-form-textarea">This is some text</textarea>        <br>        <br>        <fieldset>          <label for="get-form-radio-1">Radio input:</label>          <input type="radio" name="radioInput" value="radio-1" checked id="get-form-radio-1">          <label for="get-form-radio-2">Radio input alt:</label>          <input type="radio" name="radioInput" value="radio-2" id="get-form-radio-2">        </fieldset>        <br>        <br>        <label for="get-form-checkbox">Checkbox input:</label>        <input type="checkbox" name="checkboxInput" checked id="get-form-checkbox">        <br>        <br>        <label for="get-form-select">Select list:</label>        <select multiple name="select" id="get-form-select">          <option>            Option 1          </option>          <option>            Option 2          </option>        </select>        <br>        <br>        <input type="submit" value="Submit">      </form>      <br>      <br>      <h3>POST form</h3>      <form action method="post" class="js-Pjax" id="post-form">        <label for="post-form-text">Text input:</label>        <input type="text" name="textInput" id="post-form-text" value="Foobar">        <br>        <br>        <label for="post-form-number">Number input:</label>        <input type="number" name="numberInput" id="post-form-number" value="1">        <br>        <br>        <label for="post-form-email">Email input:</label>        <input type="email" name="emailInput" id="post-form-email" value="example@example.com">        <br>        <br>        <label for="post-form-textarea">Textarea:</label>        <textarea name="textarea" id="post-form-textarea">This is some text</textarea>        <br>        <br>        <fieldset>          <label for="post-form-radio-1">Radio input:</label>          <input type="radio" name="radioInput" value="radio-1" checked id="post-form-radio-1">          <label for="post-form-radio-2">Radio input alt:</label>          <input type="radio" name="radioInput" value="radio-2" id="post-form-radio-2">        </fieldset>        <br>        <br>        <label for="post-form-checkbox">Checkbox input:</label>        <input type="checkbox" name="checkboxInput" checked id="post-form-checkbox">        <br>        <br>        <label for="post-form-select">Select list:</label>        <select multiple name="select" id="post-form-select">          <option>            Option 1          </option>          <option>            Option 2          </option>        </select>        <br>        <br>        <input type="submit" value="Submit">      </form>    </div>  </body></html>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/abort-request.js"/>
      <url>/lib/pjax/lib/abort-request.js</url>
      
        <content type="html"><![CDATA[var noop = require("./util/noop");module.exports = function(request) {  if (request && request.readyState < 4) {    request.onreadystatechange = noop;    request.abort();  }};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/eval-script.js"/>
      <url>/lib/pjax/lib/eval-script.js</url>
      
        <content type="html"><![CDATA[module.exports = function(el) {  var code = el.text || el.textContent || el.innerHTML || "";  var src = el.src || "";  var parent =    el.parentNode || document.querySelector("head") || document.documentElement;  var script = document.createElement("script");  if (code.match("document.write")) {    if (console && console.log) {      console.log(        "Script contains document.write. Can’t be executed correctly. Code skipped ",        el      );    }    return false;  }  script.type = "text/javascript";  script.id = el.id;  /* istanbul ignore if */  if (src !== "") {    script.src = src;    script.async = false; // force synchronous loading of peripheral JS  }  if (code !== "") {    try {      script.appendChild(document.createTextNode(code));    } catch (e) {      /* istanbul ignore next */      // old IEs have funky script nodes      script.text = code;    }  }  // execute  parent.appendChild(script);  // avoid pollution only in head or body tags  if (    (parent instanceof HTMLHeadElement || parent instanceof HTMLBodyElement) &&    parent.contains(script)  ) {    parent.removeChild(script);  }  return true;};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/execute-scripts.js"/>
      <url>/lib/pjax/lib/execute-scripts.js</url>
      
        <content type="html"><![CDATA[var forEachEls = require("./foreach-els");var evalScript = require("./eval-script");// Finds and executes scripts (used for newly added elements)// Needed since innerHTML does not run scriptsmodule.exports = function(el) {  if (el.tagName.toLowerCase() === "script") {    evalScript(el);  }  forEachEls(el.querySelectorAll("script"), function(script) {    if (!script.type || script.type.toLowerCase() === "text/javascript") {      if (script.parentNode) {        script.parentNode.removeChild(script);      }      evalScript(script);    }  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/foreach-selectors.js"/>
      <url>/lib/pjax/lib/foreach-selectors.js</url>
      
        <content type="html"><![CDATA[var forEachEls = require("./foreach-els");module.exports = function(selectors, cb, context, DOMcontext) {  DOMcontext = DOMcontext || document;  selectors.forEach(function(selector) {    forEachEls(DOMcontext.querySelectorAll(selector), cb, context);  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/foreach-els.js"/>
      <url>/lib/pjax/lib/foreach-els.js</url>
      
        <content type="html"><![CDATA[/* global HTMLCollection: true */module.exports = function(els, fn, context) {  if (    els instanceof HTMLCollection ||    els instanceof NodeList ||    els instanceof Array  ) {    return Array.prototype.forEach.call(els, fn, context);  }  // assume simple DOM element  return fn.call(context, els);};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/is-supported.js"/>
      <url>/lib/pjax/lib/is-supported.js</url>
      
        <content type="html"><![CDATA[module.exports = function() {  // Borrowed wholesale from https://github.com/defunkt/jquery-pjax  return (    window.history &&    window.history.pushState &&    window.history.replaceState &&    // pushState isn’t reliable on iOS until 5.    !navigator.userAgent.match(      /((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/    )  );};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/parse-options.js"/>
      <url>/lib/pjax/lib/parse-options.js</url>
      
        <content type="html"><![CDATA[/* global _gaq: true, ga: true */var defaultSwitches = require("./switches");module.exports = function(options) {  options = options || {};  options.elements = options.elements || "a[href], form[action]";  options.selectors = options.selectors || ["title", ".js-Pjax"];  options.switches = options.switches || {};  options.switchesOptions = options.switchesOptions || {};  options.history =    typeof options.history === "undefined" ? true : options.history;  options.analytics =    typeof options.analytics === "function" || options.analytics === false      ? options.analytics      : defaultAnalytics;  options.scrollTo =    typeof options.scrollTo === "undefined" ? 0 : options.scrollTo;  options.scrollRestoration =    typeof options.scrollRestoration !== "undefined"      ? options.scrollRestoration      : true;  options.cacheBust =    typeof options.cacheBust === "undefined" ? true : options.cacheBust;  options.debug = options.debug || false;  options.timeout = options.timeout || 0;  options.currentUrlFullReload =    typeof options.currentUrlFullReload === "undefined"      ? false      : options.currentUrlFullReload;  // We can’t replace body.outerHTML or head.outerHTML.  // It creates a bug where a new body or head are created in the DOM.  // If you set head.outerHTML, a new body tag is appended, so the DOM has 2 body nodes, and vice versa  if (!options.switches.head) {    options.switches.head = defaultSwitches.switchElementsAlt;  }  if (!options.switches.body) {    options.switches.body = defaultSwitches.switchElementsAlt;  }  return options;};/* istanbul ignore next */function defaultAnalytics() {  if (window._gaq) {    _gaq.push(["_trackPageview"]);  }  if (window.ga) {    ga("send", "pageview", { page: location.pathname, title: document.title });  }}]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/send-request.js"/>
      <url>/lib/pjax/lib/send-request.js</url>
      
        <content type="html"><![CDATA[var updateQueryString = require("./util/update-query-string");module.exports = function(location, options, callback) {  options = options || {};  var queryString;  var requestOptions = options.requestOptions || {};  var requestMethod = (requestOptions.requestMethod || "GET").toUpperCase();  var requestParams = requestOptions.requestParams || null;  var formData = requestOptions.formData || null;  var requestPayload = null;  var request = new XMLHttpRequest();  var timeout = options.timeout || 0;  request.onreadystatechange = function() {    if (request.readyState === 4) {      if (request.status === 200) {        callback(request.responseText, request, location, options);      } else if (request.status !== 0) {        callback(null, request, location, options);      }    }  };  request.onerror = function(e) {    console.log(e);    callback(null, request, location, options);  };  request.ontimeout = function() {    callback(null, request, location, options);  };  // Prepare the request payload for forms, if available  if (requestParams && requestParams.length) {    // Build query string    queryString = requestParams      .map(function(param) {        return param.name + "=" + param.value;      })      .join("&");    switch (requestMethod) {      case "GET":        // Reset query string to avoid an issue with repeat submissions where checkboxes that were        // previously checked are incorrectly preserved        location = location.split("?")[0];        // Append new query string        location += "?" + queryString;        break;      case "POST":        // Send query string as request payload        requestPayload = queryString;        break;    }  } else if (formData) {    requestPayload = formData;  }  // Add a timestamp as part of the query string if cache busting is enabled  if (options.cacheBust) {    location = updateQueryString(location, "t", Date.now());  }  request.open(requestMethod, location, true);  request.timeout = timeout;  request.setRequestHeader("X-Requested-With", "XMLHttpRequest");  request.setRequestHeader("X-PJAX", "true");  request.setRequestHeader(    "X-PJAX-Selectors",    JSON.stringify(options.selectors)  );  // Send the proper header information for POST forms  if (requestPayload && requestMethod === "POST" && !formData) {    request.setRequestHeader(      "Content-Type",      "application/x-www-form-urlencoded"    );  }  request.send(requestPayload);  return request;};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/switches-selectors.js"/>
      <url>/lib/pjax/lib/switches-selectors.js</url>
      
        <content type="html"><![CDATA[var forEachEls = require("./foreach-els");var defaultSwitches = require("./switches");module.exports = function(  switches,  switchesOptions,  selectors,  fromEl,  toEl,  options) {  var switchesQueue = [];  selectors.forEach(function(selector) {    var newEls = fromEl.querySelectorAll(selector);    var oldEls = toEl.querySelectorAll(selector);    if (this.log) {      this.log("Pjax switch", selector, newEls, oldEls);    }    if (newEls.length !== oldEls.length) {      throw "DOM doesn’t look the same on new loaded page: ’" +        selector +        "’ - new " +        newEls.length +        ", old " +        oldEls.length;    }    forEachEls(      newEls,      function(newEl, i) {        var oldEl = oldEls[i];        if (this.log) {          this.log("newEl", newEl, "oldEl", oldEl);        }        var callback = switches[selector]          ? switches[selector].bind(              this,              oldEl,              newEl,              options,              switchesOptions[selector]            )          : defaultSwitches.outerHTML.bind(this, oldEl, newEl, options);        switchesQueue.push(callback);      },      this    );  }, this);  this.state.numPendingSwitches = switchesQueue.length;  switchesQueue.forEach(function(queuedSwitch) {    queuedSwitch();  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/uniqueid.js"/>
      <url>/lib/pjax/lib/uniqueid.js</url>
      
        <content type="html"><![CDATA[module.exports = (function() {  var counter = 0;  return function() {    var id = "pjax" + new Date().getTime() + "_" + counter;    counter++;    return id;  };})();]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/switches.js"/>
      <url>/lib/pjax/lib/switches.js</url>
      
        <content type="html"><![CDATA[var on = require("./events/on");module.exports = {  outerHTML: function(oldEl, newEl) {    oldEl.outerHTML = newEl.outerHTML;    this.onSwitch();  },  innerHTML: function(oldEl, newEl) {    oldEl.innerHTML = newEl.innerHTML;    if (newEl.className === "") {      oldEl.removeAttribute("class");    } else {      //oldEl.className = newEl.className;    }    this.onSwitch();  },  switchElementsAlt: function(oldEl, newEl) {    oldEl.innerHTML = newEl.innerHTML;    // Copy attributes from the new element to the old one    if (newEl.hasAttributes()) {      var attrs = newEl.attributes;      for (var i = 0; i < attrs.length; i++) {        oldEl.attributes.setNamedItem(attrs[i].cloneNode());      }    }    this.onSwitch();  },  // Equivalent to outerHTML(), but doesn't require switchElementsAlt() for <head> and </head><body>  replaceNode: function(oldEl, newEl) {    oldEl.parentNode.replaceChild(newEl, oldEl);    this.onSwitch();  },  sideBySide: function(oldEl, newEl, options, switchOptions) {    var forEach = Array.prototype.forEach;    var elsToRemove = [];    var elsToAdd = [];    var fragToAppend = document.createDocumentFragment();    var animationEventNames =      "animationend webkitAnimationEnd MSAnimationEnd oanimationend";    var animatedElsNumber = 0;    var sexyAnimationEnd = function(e) {      if (e.target !== e.currentTarget) {        // end triggered by an animation on a child        return;      }      animatedElsNumber--;      if (animatedElsNumber </body>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/setup.js"/>
      <url>/lib/pjax/tests/setup.js</url>
      
        <content type="html"><![CDATA[var jsdomOptions = {  url: "https://example.org/",  runScripts: "dangerously"};require("jsdom-global")("", jsdomOptions);]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/pjax.js"/>
      <url>/lib/pjax/pjax.js</url>
      
        <content type="html"><![CDATA[(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Pjax = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){ var executescripts="require("./lib/execute-scripts");" foreachels="require("./lib/foreach-els");" parseoptions="require("./lib/parse-options");" switches="require("./lib/switches");" newuid="require("./lib/uniqueid");" on="require("./lib/events/on");" trigger="require("./lib/events/trigger");" clone="require("./lib/util/clone");" contains="require("./lib/util/contains");" extend="require("./lib/util/extend");" noop="require("./lib/util/noop");" pjax="function(options)" { this.state="{" numpendingswitches: 0, href: null, options: null }; this.options="parseOptions(options);" this.log("pjax options", this.options); if (this.options.scrollrestoration && "scrollrestoration" in history) history.scrollrestoration="manual" ; } this.maxuid="this.lastUid" = newuid(); this.parsedom(document); on( window, "popstate", function(st) (st.state) opt="clone(this.options);" opt.url="st.state.url;" opt.title="st.state.title;" since state already exists, prevent it from being pushed again opt.history="false;" opt.scrollpos="st.state.scrollPos;" (st.state.uid < this.lastuid) opt.backward="true;" else opt.forward="true;" this.lastuid="st.state.uid;" @todo implement history cache here, based uid this.loadurl(st.state.url, opt); }.bind(this) ); pjax.switches="switches;" pjax.prototype="{" log: require(". lib proto log"), getelements: function(el) return el.queryselectorall(this.options.elements); }, parsedom: parseelement="require("./lib/proto/parse-element");" foreachels(this.getelements(el), parseelement, this); refresh: this.parsedom(el || document); reload: function() window.location.reload(); attachlink: attach-link"), attachform: attach-form"), foreachselectors: function(cb, context, domcontext) foreach-selectors").bind(this)( this.options.selectors, cb, domcontext switchselectors: function(selectors, fromel, toel, options) switches-selectors").bind(this)( this.options.switches, this.options.switchesoptions, selectors, options latestchance: function(href) window.location="href;" onswitch: trigger(window, "resize scroll"); this.state.numpendingswitches--; debounce calls, so we only run this once after all are finished. (this.state.numpendingswitches="==" 0) this.afterallswitches(); loadcontent: function(html, (typeof html !="=" "string") trigger(document, "pjax:complete pjax:error", options); return; tmpel="document.implementation.createHTMLDocument("pjax");" parse attributes to copy them forced use documentelement.innerhtml (outerhtml can't be used for <html>)    var htmlRegex = /<html[^>]+>/gi;    var htmlAttribsRegex = /\s?[a-z:]+(?:=['"][^'">]+['"])*/gi;    var matches = html.match(htmlRegex);    if (matches && matches.length) {      matches = matches[0].match(htmlAttribsRegex);      if (matches.length) {        matches.shift();        matches.forEach(function(htmlAttrib) {          var attr = htmlAttrib.trim().split("=");          if (attr.length === 1) {            tmpEl.documentElement.setAttribute(attr[0], true);          } else {            tmpEl.documentElement.setAttribute(attr[0], attr[1].slice(1, -1));          }        });      }    }    tmpEl.documentElement.innerHTML = html;    this.log(      "load content",      tmpEl.documentElement.attributes,      tmpEl.documentElement.innerHTML.length    );    // Clear out any focused controls before inserting new page contents.    if (      document.activeElement &&      contains(document, this.options.selectors, document.activeElement)    ) {      try {        document.activeElement.blur();      } catch (e) {} // eslint-disable-line no-empty    }    this.switchSelectors(this.options.selectors, tmpEl, document, options);  },  abortRequest: require("./lib/abort-request"),  doRequest: require("./lib/send-request"),  handleResponse: require("./lib/proto/handle-response"),  loadUrl: function(href, options) {    options =      typeof options === "object"        ? extend({}, this.options, options)        : clone(this.options);    this.log("load href", href, options);    // Abort any previous request    this.abortRequest(this.request);    trigger(document, "pjax:send", options);    // Do the request    this.request = this.doRequest(      href,      options,      this.handleResponse.bind(this)    );  },  afterAllSwitches: function() {    // FF bug: Won’t autofocus fields that are inserted via JS.    // This behavior is incorrect. So if theres no current focus, autofocus    // the last field.    //    // http://www.w3.org/html/wg/drafts/html/master/forms.html    var autofocusEl = Array.prototype.slice      .call(document.querySelectorAll("[autofocus]"))      .pop();    if (autofocusEl && document.activeElement !== autofocusEl) {      autofocusEl.focus();    }    // execute scripts when DOM have been completely updated    this.options.selectors.forEach(function(selector) {      forEachEls(document.querySelectorAll(selector), function(el) {        //executeScripts(el);      });    });    var state = this.state;    if (state.options.history) {      if (!window.history.state) {        this.lastUid = this.maxUid = newUid();        window.history.replaceState(          {            url: window.location.href,            title: document.title,            uid: this.maxUid,            scrollPos: [0, 0]          },          document.title        );      }      // Update browser history      this.lastUid = this.maxUid = newUid();      window.history.pushState(        {          url: state.href,          title: state.options.title,          uid: this.maxUid,          scrollPos: [0, 0]        },        state.options.title,        state.href      );    }    this.forEachSelectors(function(el) {      this.parseDOM(el);    }, this);    // Fire Events    trigger(document, "pjax:complete pjax:success", state.options);    if (typeof state.options.analytics === "function") {      state.options.analytics();    }    if (state.options.history) {      // First parse url and check for hash to override scroll      var a = document.createElement("a");      a.href = this.state.href;      if (a.hash) {        var name = a.hash.slice(1);        name = decodeURIComponent(name);        var curtop = 0;        var target =          document.getElementById(name) || document.getElementsByName(name)[0];        if (target) {          // http://stackoverflow.com/questions/8111094/cross-browser-javascript-function-to-find-actual-position-of-an-element-in-page          if (target.offsetParent) {            do {              curtop += target.offsetTop;              target = target.offsetParent;            } while (target);          }        }        window.scrollTo(0, curtop);      } else if (state.options.scrollTo !== false) {        // Scroll page to top on new page load        if (state.options.scrollTo.length > 1) {          window.scrollTo(state.options.scrollTo[0], state.options.scrollTo[1]);        } else {          window.scrollTo(0, state.options.scrollTo);        }      }    } else if (state.options.scrollRestoration && state.options.scrollPos) {      window.scrollTo(state.options.scrollPos[0], state.options.scrollPos[1]);    }    this.state = {      numPendingSwitches: 0,      href: null,      options: null    };  }};Pjax.isSupported = require("./lib/is-supported");// arguably could do `if( require("./lib/is-supported")()) {` but that might be a little to simpleif (Pjax.isSupported()) {  module.exports = Pjax;}// if there isn’t required browser functions, returning stupid apielse {  var stupidPjax = noop;  for (var key in Pjax.prototype) {    if (      Pjax.prototype.hasOwnProperty(key) &&      typeof Pjax.prototype[key] === "function"    ) {      stupidPjax[key] = noop;    }  }  module.exports = stupidPjax;}},{"./lib/abort-request":2,"./lib/events/on":4,"./lib/events/trigger":5,"./lib/execute-scripts":6,"./lib/foreach-els":7,"./lib/foreach-selectors":8,"./lib/is-supported":9,"./lib/parse-options":10,"./lib/proto/attach-form":11,"./lib/proto/attach-link":12,"./lib/proto/handle-response":13,"./lib/proto/log":14,"./lib/proto/parse-element":15,"./lib/send-request":16,"./lib/switches":18,"./lib/switches-selectors":17,"./lib/uniqueid":19,"./lib/util/clone":20,"./lib/util/contains":21,"./lib/util/extend":22,"./lib/util/noop":23}],2:[function(require,module,exports){var noop = require("./util/noop");module.exports = function(request) {  if (request && request.readyState < 4) {    request.onreadystatechange = noop;    request.abort();  }};},{"./util/noop":23}],3:[function(require,module,exports){module.exports = function(el) {  var code = el.text || el.textContent || el.innerHTML || "";  var src = el.src || "";  var parent =    el.parentNode || document.querySelector("head") || document.documentElement;  var script = document.createElement("script");  if (code.match("document.write")) {    if (console && console.log) {      console.log(        "Script contains document.write. Can’t be executed correctly. Code skipped ",        el      );    }    return false;  }  script.type = "text/javascript";  script.id = el.id;  /* istanbul ignore if */  if (src !== "") {    script.src = src;    script.async = false; // force synchronous loading of peripheral JS  }  if (code !== "") {    try {      script.appendChild(document.createTextNode(code));    } catch (e) {      /* istanbul ignore next */      // old IEs have funky script nodes      script.text = code;    }  }  // execute  parent.appendChild(script);  // avoid pollution only in head or body tags  if (    (parent instanceof HTMLHeadElement || parent instanceof HTMLBodyElement) &&    parent.contains(script)  ) {    parent.removeChild(script);  }  return true;};},{}],4:[function(require,module,exports){var forEachEls = require("../foreach-els");module.exports = function(els, events, listener, useCapture) {  events = typeof events === "string" ? events.split(" ") : events;  events.forEach(function(e) {    forEachEls(els, function(el) {      el.addEventListener(e, listener, useCapture);    });  });};},{"../foreach-els":7}],5:[function(require,module,exports){var forEachEls = require("../foreach-els");module.exports = function(els, events, opts) {  events = typeof events === "string" ? events.split(" ") : events;  events.forEach(function(e) {    var event;    event = document.createEvent("HTMLEvents");    event.initEvent(e, true, true);    event.eventName = e;    if (opts) {      Object.keys(opts).forEach(function(key) {        event[key] = opts[key];      });    }    forEachEls(els, function(el) {      var domFix = false;      if (!el.parentNode && el !== document && el !== window) {        // THANK YOU IE (9/10/11)        // dispatchEvent doesn't work if the element is not in the DOM        domFix = true;        document.body.appendChild(el);      }      el.dispatchEvent(event);      if (domFix) {        el.parentNode.removeChild(el);      }    });  });};},{"../foreach-els":7}],6:[function(require,module,exports){var forEachEls = require("./foreach-els");var evalScript = require("./eval-script");// Finds and executes scripts (used for newly added elements)// Needed since innerHTML does not run scriptsmodule.exports = function(el) {  if (el.tagName.toLowerCase() === "script") {    evalScript(el);  }  forEachEls(el.querySelectorAll("script"), function(script) {    if (!script.type || script.type.toLowerCase() === "text/javascript") {      if (script.parentNode) {        script.parentNode.removeChild(script);      }      evalScript(script);    }  });};},{"./eval-script":3,"./foreach-els":7}],7:[function(require,module,exports){/* global HTMLCollection: true */module.exports = function(els, fn, context) {  if (    els instanceof HTMLCollection ||    els instanceof NodeList ||    els instanceof Array  ) {    return Array.prototype.forEach.call(els, fn, context);  }  // assume simple DOM element  return fn.call(context, els);};},{}],8:[function(require,module,exports){var forEachEls = require("./foreach-els");module.exports = function(selectors, cb, context, DOMcontext) {  DOMcontext = DOMcontext || document;  selectors.forEach(function(selector) {    forEachEls(DOMcontext.querySelectorAll(selector), cb, context);  });};},{"./foreach-els":7}],9:[function(require,module,exports){module.exports = function() {  // Borrowed wholesale from https://github.com/defunkt/jquery-pjax  return (    window.history &&    window.history.pushState &&    window.history.replaceState &&    // pushState isn’t reliable on iOS until 5.    !navigator.userAgent.match(      /((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/    )  );};},{}],10:[function(require,module,exports){/* global _gaq: true, ga: true */var defaultSwitches = require("./switches");module.exports = function(options) {  options = options || {};  options.elements = options.elements || "a[href], form[action]";  options.selectors = options.selectors || ["title", ".js-Pjax"];  options.switches = options.switches || {};  options.switchesOptions = options.switchesOptions || {};  options.history =    typeof options.history === "undefined" ? true : options.history;  options.analytics =    typeof options.analytics === "function" || options.analytics === false      ? options.analytics      : defaultAnalytics;  options.scrollTo =    typeof options.scrollTo === "undefined" ? 0 : options.scrollTo;  options.scrollRestoration =    typeof options.scrollRestoration !== "undefined"      ? options.scrollRestoration      : true;  options.cacheBust =    typeof options.cacheBust === "undefined" ? true : options.cacheBust;  options.debug = options.debug || false;  options.timeout = options.timeout || 0;  options.currentUrlFullReload =    typeof options.currentUrlFullReload === "undefined"      ? false      : options.currentUrlFullReload;  // We can’t replace body.outerHTML or head.outerHTML.  // It creates a bug where a new body or head are created in the DOM.  // If you set head.outerHTML, a new body tag is appended, so the DOM has 2 body nodes, and vice versa  if (!options.switches.head) {    options.switches.head = defaultSwitches.switchElementsAlt;  }  if (!options.switches.body) {    options.switches.body = defaultSwitches.switchElementsAlt;  }  return options;};/* istanbul ignore next */function defaultAnalytics() {  if (window._gaq) {    _gaq.push(["_trackPageview"]);  }  if (window.ga) {    ga("send", "pageview", { page: location.pathname, title: document.title });  }}},{"./switches":18}],11:[function(require,module,exports){var on = require("../events/on");var clone = require("../util/clone");var attrState = "data-pjax-state";var formAction = function(el, event) {  if (isDefaultPrevented(event)) {    return;  }  // Since loadUrl modifies options and we may add our own modifications below,  // clone it so the changes don't persist  var options = clone(this.options);  // Initialize requestOptions  options.requestOptions = {    requestUrl: el.getAttribute("action") || window.location.href,    requestMethod: el.getAttribute("method") || "GET"  };  // create a testable virtual link of the form action  var virtLinkElement = document.createElement("a");  virtLinkElement.setAttribute("href", options.requestOptions.requestUrl);  var attrValue = checkIfShouldAbort(virtLinkElement, options);  if (attrValue) {    el.setAttribute(attrState, attrValue);    return;  }  event.preventDefault();  if (el.enctype === "multipart/form-data") {    options.requestOptions.formData = new FormData(el);  } else {    options.requestOptions.requestParams = parseFormElements(el);  }  el.setAttribute(attrState, "submit");  options.triggerElement = el;  this.loadUrl(virtLinkElement.href, options);};function parseFormElements(el) {  var requestParams = [];  var formElements = el.elements;  for (var i = 0; i < formElements.length; i++) {    var element = formElements[i];    var tagName = element.tagName.toLowerCase();    // jscs:disable disallowImplicitTypeConversion    if (      !!element.name &&      element.attributes !== undefined &&      tagName !== "button"    ) {      // jscs:enable disallowImplicitTypeConversion      var type = element.attributes.type;      if (        !type ||        (type.value !== "checkbox" && type.value !== "radio") ||        element.checked      ) {        // Build array of values to submit        var values = [];        if (tagName === "select") {          var opt;          for (var j = 0; j < element.options.length; j++) {            opt = element.options[j];            if (opt.selected && !opt.disabled) {              values.push(opt.hasAttribute("value") ? opt.value : opt.text);            }          }        } else {          values.push(element.value);        }        for (var k = 0; k < values.length; k++) {          requestParams.push({            name: encodeURIComponent(element.name),            value: encodeURIComponent(values[k])          });        }      }    }  }  return requestParams;}function checkIfShouldAbort(virtLinkElement, options) {  // Ignore external links.  if (    virtLinkElement.protocol !== window.location.protocol ||    virtLinkElement.host !== window.location.host  ) {    return "external";  }  // Ignore click if we are on an anchor on the same page  if (    virtLinkElement.hash &&    virtLinkElement.href.replace(virtLinkElement.hash, "") ===      window.location.href.replace(location.hash, "")  ) {    return "anchor";  }  // Ignore empty anchor "foo.html#"  if (virtLinkElement.href === window.location.href.split("#")[0] + "#") {    return "anchor-empty";  }  // if declared as a full reload, just normally submit the form  if (    options.currentUrlFullReload &&    virtLinkElement.href === window.location.href.split("#")[0]  ) {    return "reload";  }}var isDefaultPrevented = function(event) {  return event.defaultPrevented || event.returnValue === false;};module.exports = function(el) {  var that = this;  el.setAttribute(attrState, "");  on(el, "submit", function(event) {    formAction.call(that, el, event);  });};},{"../events/on":4,"../util/clone":20}],12:[function(require,module,exports){var on = require("../events/on");var clone = require("../util/clone");var attrState = "data-pjax-state";var linkAction = function(el, event) {  if (isDefaultPrevented(event)) {    return;  }  // Since loadUrl modifies options and we may add our own modifications below,  // clone it so the changes don't persist  var options = clone(this.options);  var attrValue = checkIfShouldAbort(el, event);  if (attrValue) {    el.setAttribute(attrState, attrValue);    return;  }  event.preventDefault();  // don’t do "nothing" if user try to reload the page by clicking the same link twice  if (    this.options.currentUrlFullReload &&    el.href === window.location.href.split("#")[0]  ) {    el.setAttribute(attrState, "reload");    this.reload();    return;  }  el.setAttribute(attrState, "load");  options.triggerElement = el;  this.loadUrl(el.href, options);};function checkIfShouldAbort(el, event) {  // Don’t break browser special behavior on links (like page in new window)  if (    event.which > 1 ||    event.metaKey ||    event.ctrlKey ||    event.shiftKey ||    event.altKey  ) {    return "modifier";  }  // we do test on href now to prevent unexpected behavior if for some reason  // user have href that can be dynamically updated  // Ignore external links.  if (    el.protocol !== window.location.protocol ||    el.host !== window.location.host  ) {    return "external";  }  // Ignore anchors on the same page (keep native behavior)  if (    el.hash &&    el.href.replace(el.hash, "") ===      window.location.href.replace(location.hash, "")  ) {    return "anchor";  }  // Ignore empty anchor "foo.html#"  if (el.href === window.location.href.split("#")[0] + "#") {    return "anchor-empty";  }}var isDefaultPrevented = function(event) {  return event.defaultPrevented || event.returnValue === false;};module.exports = function(el) {  var that = this;  el.setAttribute(attrState, "");  on(el, "click", function(event) {    linkAction.call(that, el, event);  });  on(    el,    "keyup",    function(event) {      if (event.keyCode === 13) {        linkAction.call(that, el, event);      }    }.bind(this)  );};},{"../events/on":4,"../util/clone":20}],13:[function(require,module,exports){var clone = require("../util/clone");var newUid = require("../uniqueid");var trigger = require("../events/trigger");module.exports = function(responseText, request, href, options) {  options = clone(options || this.options);  options.request = request;  // Fail if unable to load HTML via AJAX  if (responseText === false) {    trigger(document, "pjax:complete pjax:error", options);    return;  }  // push scroll position to history  var currentState = window.history.state || {};  window.history.replaceState(    {      url: currentState.url || window.location.href,      title: currentState.title || document.title,      uid: currentState.uid || newUid(),      scrollPos: [        document.documentElement.scrollLeft || document.body.scrollLeft,        document.documentElement.scrollTop || document.body.scrollTop      ]    },    document.title,    window.location.href  );  // Check for redirects  var oldHref = href;  if (request.responseURL) {    if (href !== request.responseURL) {      href = request.responseURL;    }  } else if (request.getResponseHeader("X-PJAX-URL")) {    href = request.getResponseHeader("X-PJAX-URL");  } else if (request.getResponseHeader("X-XHR-Redirected-To")) {    href = request.getResponseHeader("X-XHR-Redirected-To");  }  // Add back the hash if it was removed  var a = document.createElement("a");  a.href = oldHref;  var oldHash = a.hash;  a.href = href;  if (oldHash && !a.hash) {    a.hash = oldHash;    href = a.href;  }  this.state.href = href;  this.state.options = options;  try {    this.loadContent(responseText, options);  } catch (e) {    trigger(document, "pjax:error", options);    if (!this.options.debug) {      if (console && console.error) {        console.error("Pjax switch fail: ", e);      }      return this.latestChance(href);    } else {      throw e;    }  }};},{"../events/trigger":5,"../uniqueid":19,"../util/clone":20}],14:[function(require,module,exports){module.exports = function() {  if (this.options.debug && console) {    if (typeof console.log === "function") {      console.log.apply(console, arguments);    }    // IE is weird    else if (console.log) {      console.log(arguments);    }  }};},{}],15:[function(require,module,exports){var attrState = "data-pjax-state";module.exports = function(el) {  switch (el.tagName.toLowerCase()) {    case "a":      // only attach link if el does not already have link attached      if (!el.hasAttribute(attrState)) {        this.attachLink(el);      }      break;    case "form":      // only attach link if el does not already have link attached      if (!el.hasAttribute(attrState)) {        this.attachForm(el);      }      break;    default:      throw "Pjax can only be applied on <a> or <form> submit";  }};},{}],16:[function(require,module,exports){var updateQueryString = require("./util/update-query-string");module.exports = function(location, options, callback) {  options = options || {};  var queryString;  var requestOptions = options.requestOptions || {};  var requestMethod = (requestOptions.requestMethod || "GET").toUpperCase();  var requestParams = requestOptions.requestParams || null;  var formData = requestOptions.formData || null;  var requestPayload = null;  var request = new XMLHttpRequest();  var timeout = options.timeout || 0;  request.onreadystatechange = function() {    if (request.readyState === 4) {      if (request.status === 200) {        callback(request.responseText, request, location, options);      } else if (request.status !== 0) {        callback(null, request, location, options);      }    }  };  request.onerror = function(e) {    console.log(e);    callback(null, request, location, options);  };  request.ontimeout = function() {    callback(null, request, location, options);  };  // Prepare the request payload for forms, if available  if (requestParams && requestParams.length) {    // Build query string    queryString = requestParams      .map(function(param) {        return param.name + "=" + param.value;      })      .join("&");    switch (requestMethod) {      case "GET":        // Reset query string to avoid an issue with repeat submissions where checkboxes that were        // previously checked are incorrectly preserved        location = location.split("?")[0];        // Append new query string        location += "?" + queryString;        break;      case "POST":        // Send query string as request payload        requestPayload = queryString;        break;    }  } else if (formData) {    requestPayload = formData;  }  // Add a timestamp as part of the query string if cache busting is enabled  if (options.cacheBust) {    location = updateQueryString(location, "t", Date.now());  }  request.open(requestMethod, location, true);  request.timeout = timeout;  request.setRequestHeader("X-Requested-With", "XMLHttpRequest");  request.setRequestHeader("X-PJAX", "true");  request.setRequestHeader(    "X-PJAX-Selectors",    JSON.stringify(options.selectors)  );  // Send the proper header information for POST forms  if (requestPayload && requestMethod === "POST" && !formData) {    request.setRequestHeader(      "Content-Type",      "application/x-www-form-urlencoded"    );  }  request.send(requestPayload);  return request;};},{"./util/update-query-string":24}],17:[function(require,module,exports){var forEachEls = require("./foreach-els");var defaultSwitches = require("./switches");module.exports = function(  switches,  switchesOptions,  selectors,  fromEl,  toEl,  options) {  var switchesQueue = [];  selectors.forEach(function(selector) {    var newEls = fromEl.querySelectorAll(selector);    var oldEls = toEl.querySelectorAll(selector);    if (this.log) {      this.log("Pjax switch", selector, newEls, oldEls);    }    if (newEls.length !== oldEls.length) {      throw "DOM doesn’t look the same on new loaded page: ’" +        selector +        "’ - new " +        newEls.length +        ", old " +        oldEls.length;    }    forEachEls(      newEls,      function(newEl, i) {        var oldEl = oldEls[i];        if (this.log) {          this.log("newEl", newEl, "oldEl", oldEl);        }        var callback = switches[selector]          ? switches[selector].bind(              this,              oldEl,              newEl,              options,              switchesOptions[selector]            )          : defaultSwitches.outerHTML.bind(this, oldEl, newEl, options);        switchesQueue.push(callback);      },      this    );  }, this);  this.state.numPendingSwitches = switchesQueue.length;  switchesQueue.forEach(function(queuedSwitch) {    queuedSwitch();  });};},{"./foreach-els":7,"./switches":18}],18:[function(require,module,exports){var on = require("./events/on");module.exports = {  outerHTML: function(oldEl, newEl) {    oldEl.outerHTML = newEl.outerHTML;    this.onSwitch();  },  innerHTML: function(oldEl, newEl) {    oldEl.innerHTML = newEl.innerHTML;    if (newEl.className === "") {      oldEl.removeAttribute("class");    } else {      //oldEl.className = newEl.className;    }    this.onSwitch();  },  switchElementsAlt: function(oldEl, newEl) {    oldEl.innerHTML = newEl.innerHTML;    // Copy attributes from the new element to the old one    if (newEl.hasAttributes()) {      var attrs = newEl.attributes;      for (var i = 0; i < attrs.length; i++) {        oldEl.attributes.setNamedItem(attrs[i].cloneNode());      }    }    this.onSwitch();  },  // Equivalent to outerHTML(), but doesn't require switchElementsAlt() for <head> and </head><body>  replaceNode: function(oldEl, newEl) {    oldEl.parentNode.replaceChild(newEl, oldEl);    this.onSwitch();  },  sideBySide: function(oldEl, newEl, options, switchOptions) {    var forEach = Array.prototype.forEach;    var elsToRemove = [];    var elsToAdd = [];    var fragToAppend = document.createDocumentFragment();    var animationEventNames =      "animationend webkitAnimationEnd MSAnimationEnd oanimationend";    var animatedElsNumber = 0;    var sexyAnimationEnd = function(e) {      if (e.target !== e.currentTarget) {        // end triggered by an animation on a child        return;      }      animatedElsNumber--;      if (animatedElsNumber </body></form></a></html[^></t.length;i++)o(t[i]);return>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/events/on.js"/>
      <url>/lib/pjax/lib/events/on.js</url>
      
        <content type="html"><![CDATA[var forEachEls = require("../foreach-els");module.exports = function(els, events, listener, useCapture) {  events = typeof events === "string" ? events.split(" ") : events;  events.forEach(function(e) {    forEachEls(els, function(el) {      el.addEventListener(e, listener, useCapture);    });  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/events/off.js"/>
      <url>/lib/pjax/lib/events/off.js</url>
      
        <content type="html"><![CDATA[var forEachEls = require("../foreach-els");module.exports = function(els, events, listener, useCapture) {  events = typeof events === "string" ? events.split(" ") : events;  events.forEach(function(e) {    forEachEls(els, function(el) {      el.removeEventListener(e, listener, useCapture);    });  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/events/trigger.js"/>
      <url>/lib/pjax/lib/events/trigger.js</url>
      
        <content type="html"><![CDATA[var forEachEls = require("../foreach-els");module.exports = function(els, events, opts) {  events = typeof events === "string" ? events.split(" ") : events;  events.forEach(function(e) {    var event;    event = document.createEvent("HTMLEvents");    event.initEvent(e, true, true);    event.eventName = e;    if (opts) {      Object.keys(opts).forEach(function(key) {        event[key] = opts[key];      });    }    forEachEls(els, function(el) {      var domFix = false;      if (!el.parentNode && el !== document && el !== window) {        // THANK YOU IE (9/10/11)        // dispatchEvent doesn't work if the element is not in the DOM        domFix = true;        document.body.appendChild(el);      }      el.dispatchEvent(event);      if (domFix) {        el.parentNode.removeChild(el);      }    });  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/proto/attach-form.js"/>
      <url>/lib/pjax/lib/proto/attach-form.js</url>
      
        <content type="html"><![CDATA[var on = require("../events/on");var clone = require("../util/clone");var attrState = "data-pjax-state";var formAction = function(el, event) {  if (isDefaultPrevented(event)) {    return;  }  // Since loadUrl modifies options and we may add our own modifications below,  // clone it so the changes don't persist  var options = clone(this.options);  // Initialize requestOptions  options.requestOptions = {    requestUrl: el.getAttribute("action") || window.location.href,    requestMethod: el.getAttribute("method") || "GET"  };  // create a testable virtual link of the form action  var virtLinkElement = document.createElement("a");  virtLinkElement.setAttribute("href", options.requestOptions.requestUrl);  var attrValue = checkIfShouldAbort(virtLinkElement, options);  if (attrValue) {    el.setAttribute(attrState, attrValue);    return;  }  event.preventDefault();  if (el.enctype === "multipart/form-data") {    options.requestOptions.formData = new FormData(el);  } else {    options.requestOptions.requestParams = parseFormElements(el);  }  el.setAttribute(attrState, "submit");  options.triggerElement = el;  this.loadUrl(virtLinkElement.href, options);};function parseFormElements(el) {  var requestParams = [];  var formElements = el.elements;  for (var i = 0; i < formElements.length; i++) {    var element = formElements[i];    var tagName = element.tagName.toLowerCase();    // jscs:disable disallowImplicitTypeConversion    if (      !!element.name &&      element.attributes !== undefined &&      tagName !== "button"    ) {      // jscs:enable disallowImplicitTypeConversion      var type = element.attributes.type;      if (        !type ||        (type.value !== "checkbox" && type.value !== "radio") ||        element.checked      ) {        // Build array of values to submit        var values = [];        if (tagName === "select") {          var opt;          for (var j = 0; j < element.options.length; j++) {            opt = element.options[j];            if (opt.selected && !opt.disabled) {              values.push(opt.hasAttribute("value") ? opt.value : opt.text);            }          }        } else {          values.push(element.value);        }        for (var k = 0; k < values.length; k++) {          requestParams.push({            name: encodeURIComponent(element.name),            value: encodeURIComponent(values[k])          });        }      }    }  }  return requestParams;}function checkIfShouldAbort(virtLinkElement, options) {  // Ignore external links.  if (    virtLinkElement.protocol !== window.location.protocol ||    virtLinkElement.host !== window.location.host  ) {    return "external";  }  // Ignore click if we are on an anchor on the same page  if (    virtLinkElement.hash &&    virtLinkElement.href.replace(virtLinkElement.hash, "") ===      window.location.href.replace(location.hash, "")  ) {    return "anchor";  }  // Ignore empty anchor "foo.html#"  if (virtLinkElement.href === window.location.href.split("#")[0] + "#") {    return "anchor-empty";  }  // if declared as a full reload, just normally submit the form  if (    options.currentUrlFullReload &&    virtLinkElement.href === window.location.href.split("#")[0]  ) {    return "reload";  }}var isDefaultPrevented = function(event) {  return event.defaultPrevented || event.returnValue === false;};module.exports = function(el) {  var that = this;  el.setAttribute(attrState, "");  on(el, "submit", function(event) {    formAction.call(that, el, event);  });};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/proto/handle-response.js"/>
      <url>/lib/pjax/lib/proto/handle-response.js</url>
      
        <content type="html"><![CDATA[var clone = require("../util/clone");var newUid = require("../uniqueid");var trigger = require("../events/trigger");module.exports = function(responseText, request, href, options) {  options = clone(options || this.options);  options.request = request;  // Fail if unable to load HTML via AJAX  if (responseText === false) {    trigger(document, "pjax:complete pjax:error", options);    return;  }  // push scroll position to history  var currentState = window.history.state || {};  window.history.replaceState(    {      url: currentState.url || window.location.href,      title: currentState.title || document.title,      uid: currentState.uid || newUid(),      scrollPos: [        document.documentElement.scrollLeft || document.body.scrollLeft,        document.documentElement.scrollTop || document.body.scrollTop      ]    },    document.title,    window.location.href  );  // Check for redirects  var oldHref = href;  if (request.responseURL) {    if (href !== request.responseURL) {      href = request.responseURL;    }  } else if (request.getResponseHeader("X-PJAX-URL")) {    href = request.getResponseHeader("X-PJAX-URL");  } else if (request.getResponseHeader("X-XHR-Redirected-To")) {    href = request.getResponseHeader("X-XHR-Redirected-To");  }  // Add back the hash if it was removed  var a = document.createElement("a");  a.href = oldHref;  var oldHash = a.hash;  a.href = href;  if (oldHash && !a.hash) {    a.hash = oldHash;    href = a.href;  }  this.state.href = href;  this.state.options = options;  try {    this.loadContent(responseText, options);  } catch (e) {    trigger(document, "pjax:error", options);    if (!this.options.debug) {      if (console && console.error) {        console.error("Pjax switch fail: ", e);      }      return this.latestChance(href);    } else {      throw e;    }  }};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/proto/log.js"/>
      <url>/lib/pjax/lib/proto/log.js</url>
      
        <content type="html"><![CDATA[module.exports = function() {  if (this.options.debug && console) {    if (typeof console.log === "function") {      console.log.apply(console, arguments);    }    // IE is weird    else if (console.log) {      console.log(arguments);    }  }};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/proto/attach-link.js"/>
      <url>/lib/pjax/lib/proto/attach-link.js</url>
      
        <content type="html"><![CDATA[var on = require("../events/on");var clone = require("../util/clone");var attrState = "data-pjax-state";var linkAction = function(el, event) {  if (isDefaultPrevented(event)) {    return;  }  // Since loadUrl modifies options and we may add our own modifications below,  // clone it so the changes don't persist  var options = clone(this.options);  var attrValue = checkIfShouldAbort(el, event);  if (attrValue) {    el.setAttribute(attrState, attrValue);    return;  }  event.preventDefault();  // don’t do "nothing" if user try to reload the page by clicking the same link twice  if (    this.options.currentUrlFullReload &&    el.href === window.location.href.split("#")[0]  ) {    el.setAttribute(attrState, "reload");    this.reload();    return;  }  el.setAttribute(attrState, "load");  options.triggerElement = el;  this.loadUrl(el.href, options);};function checkIfShouldAbort(el, event) {  // Don’t break browser special behavior on links (like page in new window)  if (    event.which > 1 ||    event.metaKey ||    event.ctrlKey ||    event.shiftKey ||    event.altKey  ) {    return "modifier";  }  // we do test on href now to prevent unexpected behavior if for some reason  // user have href that can be dynamically updated  // Ignore external links.  if (    el.protocol !== window.location.protocol ||    el.host !== window.location.host  ) {    return "external";  }  // Ignore anchors on the same page (keep native behavior)  if (    el.hash &&    el.href.replace(el.hash, "") ===      window.location.href.replace(location.hash, "")  ) {    return "anchor";  }  // Ignore empty anchor "foo.html#"  if (el.href === window.location.href.split("#")[0] + "#") {    return "anchor-empty";  }}var isDefaultPrevented = function(event) {  return event.defaultPrevented || event.returnValue === false;};module.exports = function(el) {  var that = this;  el.setAttribute(attrState, "");  on(el, "click", function(event) {    linkAction.call(that, el, event);  });  on(    el,    "keyup",    function(event) {      if (event.keyCode === 13) {        linkAction.call(that, el, event);      }    }.bind(this)  );};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/util/clone.js"/>
      <url>/lib/pjax/lib/util/clone.js</url>
      
        <content type="html"><![CDATA[module.exports = function(obj) {  /* istanbul ignore if */  if (null === obj || "object" !== typeof obj) {    return obj;  }  var copy = obj.constructor();  for (var attr in obj) {    if (obj.hasOwnProperty(attr)) {      copy[attr] = obj[attr];    }  }  return copy;};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/proto/parse-element.js"/>
      <url>/lib/pjax/lib/proto/parse-element.js</url>
      
        <content type="html"><![CDATA[var attrState = "data-pjax-state";module.exports = function(el) {  switch (el.tagName.toLowerCase()) {    case "a":      // only attach link if el does not already have link attached      if (!el.hasAttribute(attrState)) {        this.attachLink(el);      }      break;    case "form":      // only attach link if el does not already have link attached      if (!el.hasAttribute(attrState)) {        this.attachForm(el);      }      break;    default:      throw "Pjax can only be applied on <a> or <form> submit";  }};</form></a>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/util/extend.js"/>
      <url>/lib/pjax/lib/util/extend.js</url>
      
        <content type="html"><![CDATA[module.exports = function(target) {  if (target == null) {    return null;  }  var to = Object(target);  for (var i = 1; i < arguments.length; i++) {    var source = arguments[i];    if (source != null) {      for (var key in source) {        // Avoid bugs when hasOwnProperty is shadowed        if (Object.prototype.hasOwnProperty.call(source, key)) {          to[key] = source[key];        }      }    }  }  return to;};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/util/contains.js"/>
      <url>/lib/pjax/lib/util/contains.js</url>
      
        <content type="html"><![CDATA[module.exports = function contains(doc, selectors, el) {  for (var i = 0; i < selectors.length; i++) {    var selectedEls = doc.querySelectorAll(selectors[i]);    for (var j = 0; j < selectedEls.length; j++) {      if (selectedEls[j].contains(el)) {        return true;      }    }  }  return false;};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/util/noop.js"/>
      <url>/lib/pjax/lib/util/noop.js</url>
      
        <content type="html"><![CDATA[module.exports = function() {};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/lib/util/update-query-string.js"/>
      <url>/lib/pjax/lib/util/update-query-string.js</url>
      
        <content type="html"><![CDATA[module.exports = function(uri, key, value) {  var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");  var separator = uri.indexOf("?") !== -1 ? "&" : "?";  if (uri.match(re)) {    return uri.replace(re, "$1" + key + "=" + value + "$2");  } else {    return uri + separator + key + "=" + value;  }};]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/eval-scripts.js"/>
      <url>/lib/pjax/tests/lib/eval-scripts.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var evalScript = require("../../lib/eval-script");tape("test evalScript method", function(t) {  document.body.className = "";  var script = document.createElement("script");  script.innerHTML = "document.body.className = 'executed'";  t.equal(document.body.className, "", "script hasn't been executed yet");  evalScript(script);  t.equal(    document.body.className,    "executed",    "script has been properly executed"  );  script.innerHTML = "document.write('failure')";  var bodyText = "document.write hasn't been executed";  document.body.text = bodyText;  evalScript(script);  t.equal(document.body.text, bodyText, "document.write hasn't been executed");  t.end();});tape(  "evalScript should not throw an error if the script removed itself",  function(t) {    var script = document.createElement("script");    script.id = "myScript";    script.innerHTML =      "const script = document.querySelector('#myScript');" +      "script.parentNode.removeChild(script);";    try {      evalScript(script);      t.pass("Missing script tested successfully");    } catch (e) {      console.error(e);      t.fail("Attempted to remove missing script");    }    t.end();  });]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/abort-request.js"/>
      <url>/lib/pjax/tests/lib/abort-request.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var abortRequest = require("../../lib/abort-request.js");var sendRequest = require("../../lib/send-request.js");// Polyfill responseURL property into XMLHttpRequest if it doesn't exist,// just for the purposes of this test// This polyfill is not complete; it won't show the updated location if a// redirection occurred, but it's fine for our purposes.if (!("responseURL" in XMLHttpRequest.prototype)) {  var nativeOpen = XMLHttpRequest.prototype.open;  XMLHttpRequest.prototype.open = function(method, url) {    this.responseURL = url;    return nativeOpen.apply(this, arguments);  };}tape("test aborting xhr request", function(t) {  var requestCacheBust = sendRequest.bind({    options: {      cacheBust: true    }  });  t.test("- pending request is aborted", function(t) {    var r = requestCacheBust("https://httpbin.org/delay/10", {}, function() {      t.fail("xhr was not aborted");    });    t.equal(r.readyState, 1, "xhr readyState is '1' (SENT)");    abortRequest(r);    t.equal(r.readyState, 0, "xhr readyState is '0' (ABORTED)");    t.equal(r.status, 0, "xhr HTTP status is '0' (ABORTED)");    t.equal(r.responseText, "", "xhr response is empty");    t.end();  });  t.test("- request is not aborted if it has already completed", function(t) {    var r = requestCacheBust("https://httpbin.org/get", {}, function() {      abortRequest(r);      t.equal(r.readyState, 4, "xhr readyState is '4' (DONE)");      t.equal(r.status, 200, "xhr HTTP status is '200' (OK)");      t.end();    });  });  t.test("- request is not aborted if it is undefined", function(t) {    var r;    try {      abortRequest(r);    } catch (e) {      t.fail("aborting an undefined request threw an error");    }    t.equal(typeof r, "undefined", "undefined xhr was ignored");    t.end();  });  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/execute-scripts.js"/>
      <url>/lib/pjax/tests/lib/execute-scripts.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var executeScripts = require("../../lib/execute-scripts");tape(  "test executeScripts method when the script tag is inside a container",  function(t) {    document.body.className = "";    var container = document.createElement("div");    container.innerHTML =      "<" + "script" ">document.body.className = 'executed';</"><" + "script" ">document.body.className += ' correctly';</">";    t.equal(document.body.className, "", "script hasn't been executed yet");    executeScripts(container);    t.equal(      document.body.className,      "executed correctly",      "script has been properly executed"    );    t.end();  });tape("test executeScripts method with just a script tag", function(t) {  document.body.className = "";  var script = document.createElement("script");  script.innerHTML = "document.body.className = 'executed correctly';";  t.equal(document.body.className, "", "script hasn't been executed yet");  executeScripts(script);  t.equal(    document.body.className,    "executed correctly",    "script has been properly executed"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/foreach-els.js"/>
      <url>/lib/pjax/tests/lib/foreach-els.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var forEachEls = require("../../lib/foreach-els.js");var div = document.createElement("div");var span = document.createElement("span");var cb = function(el) {  el.innerHTML = "boom";};tape("test forEachEls on one element", function(t) {  div.innerHTML = "div tag";  forEachEls(div, cb);  t.equal(div.innerHTML, "boom", "works correctly on one element");  t.end();});tape("test forEachEls on an array", function(t) {  div.innerHTML = "div tag";  span.innerHTML = "span tag";  forEachEls([div, span], cb);  t.equal(    div.innerHTML,    "boom",    "works correctly on the first element of the array"  );  t.equal(    span.innerHTML,    "boom",    "works correctly on the last element of the array"  );  t.end();});tape("test forEachEls on a NodeList", function(t) {  div.innerHTML = "div tag";  span.innerHTML = "span tag";  var frag = document.createDocumentFragment();  frag.appendChild(div);  frag.appendChild(span);  forEachEls(frag.childNodes, cb);  t.equal(    div.innerHTML,    "boom",    "works correctly on the first element of the document fragment"  );  t.equal(    span.innerHTML,    "boom",    "works correctly on the last element of the document fragment"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/is-supported.js"/>
      <url>/lib/pjax/tests/lib/is-supported.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var isSupported = require("../../lib/is-supported.js");tape("test isSupported method", function(t) {  t.true(    isSupported(),    "well, we run test on supported browser, so it should be ok here"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/events.js"/>
      <url>/lib/pjax/tests/lib/events.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var on = require("../../lib/events/on");var off = require("../../lib/events/off");var trigger = require("../../lib/events/trigger");var el = document.createElement("div");var el2 = document.createElement("span");var els = [el, el2];var classCb = function() {  this.className += "on";};var attrCb = function() {  this.setAttribute("data-state", this.getAttribute("data-state") + "ON");};tape("test events on/off/trigger for one element, one event", function(t) {  el.className = "";  on(el, "click", classCb);  trigger(el, "click");  t.equal(el.className, "on", "attached callback has been fired properly");  el.className = "off";  off(el, "click", classCb);  trigger(el, "click");  t.equal(el.className, "off", "triggered event didn't fire detached callback");  t.end();});tape("test events on/off/trigger for multiple elements, one event", function(  t) {  el.className = "";  el2.className = "";  on(els, "click", classCb);  trigger(els, "click");  t.equal(    el.className,    "on",    "attached callback has been fired properly on the first element"  );  t.equal(    el2.className,    "on",    "attached callback has been fired properly on the second element"  );  el.className = "off";  el2.className = "off";  off(els, "click", classCb);  trigger(els, "click");  t.equal(    el.className,    "off",    "triggered event didn't fire detached callback on the first element"  );  t.equal(    el2.className,    "off",    "triggered event didn't fire detached callback on the second element"  );  t.end();});tape("test events on/off/trigger for one element, multiple events", function(  t) {  el.className = "";  on(el, "click mouseover", classCb);  trigger(el, "click mouseover");  t.equal(el.className, "onon", "attached callbacks have been fired properly");  el.className = "off";  off(el, "click mouseover", classCb);  trigger(el, "click mouseover");  t.equal(    el.className,    "off",    "triggered events didn't fire detached callback"  );  t.end();});tape(  "test events on/off/trigger for multiple elements, multiple events",  function(t) {    el.className = "";    el2.className = "";    el.setAttribute("data-state", "");    el2.setAttribute("data-state", "");    on(els, "click mouseover", classCb);    on(els, "resize scroll", attrCb);    trigger(els, "click mouseover resize scroll");    t.equal(      el.className,      "onon",      "attached callbacks has been fired properly on the first element"    );    t.equal(      el.getAttribute("data-state"),      "ONON",      "attached callbacks has been fired properly on the first element"    );    t.equal(      el2.className,      "onon",      "attached callbacks has been fired properly on the second element"    );    t.equal(      el2.getAttribute("data-state"),      "ONON",      "attached callbacks has been fired properly on the second element"    );    el.className = "off";    el2.className = "off";    el.setAttribute("data-state", "off");    el2.setAttribute("data-state", "off");    off(els, "click mouseover", classCb);    off(els, "resize scroll", attrCb);    trigger(els, "click mouseover resize scroll");    t.equal(      el.className,      "off",      "triggered events didn't fire detached callbacks on the first element"    );    t.equal(      el.getAttribute("data-state"),      "off",      "triggered events didn't fire detached callbacks on the first element"    );    t.equal(      el2.className,      "off",      "triggered events didn't fire detached callbacks on the first element"    );    t.equal(      el2.getAttribute("data-state"),      "off",      "triggered events didn't fire detached callbacks on the first element"    );    t.end();  });tape("test events on top level elements", function(t) {  var el = document;  el.className = "";  on(el, "click", classCb);  trigger(el, "click");  t.equal(    el.className,    "on",    "attached callback has been fired properly on document"  );  el = window;  el.className = "";  // With jsdom, the default this is global, not window, so we need to explicitly bind to window.  on(el, "click", classCb.bind(window));  trigger(el, "click");  t.equal(    el.className,    "on",    "attached callback has been fired properly on window"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/foreach-selectors.js"/>
      <url>/lib/pjax/tests/lib/foreach-selectors.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var forEachEls = require("../../lib/foreach-selectors.js");var cb = function(el) {  el.className = "modified";};tape("test forEachSelector", function(t) {  forEachEls(["html", "body"], cb);  t.equal(    document.documentElement.className,    "modified",    "callback has been executed on first selector"  );  t.equal(    document.body.className,    "modified",    "callback has been executed on first selector"  );  document.documentElement.className = "";  document.body.className = "";  forEachEls(["html", "body"], cb, null, document.documentElement);  t.equal(    document.documentElement.className,    "",    "callback has not been executed on first selector when context is used"  );  t.equal(    document.body.className,    "modified",    "callback has been executed on first selector when context is used"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/send-request.js"/>
      <url>/lib/pjax/tests/lib/send-request.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var sendRequest = require("../../lib/send-request.js");// Polyfill responseURL property into XMLHttpRequest if it doesn't exist,// just for the purposes of this test// This polyfill is not complete; it won't show the updated location if a// redirection occurred, but it's fine for our purposes.if (!("responseURL" in XMLHttpRequest.prototype)) {  var nativeOpen = XMLHttpRequest.prototype.open;  XMLHttpRequest.prototype.open = function(method, url) {    this.responseURL = url;    return nativeOpen.apply(this, arguments);  };}tape("test xhr request", function(t) {  var url = "https://httpbin.org/get";  t.test("- request is made, gets a result, and is cache-busted", function(t) {    var r = sendRequest(url, { cacheBust: true }, function(result) {      t.equal(        r.responseURL.indexOf("?"),        url.length,        "XHR URL is cache-busted when configured to be"      );      try {        result = JSON.parse(result);      } catch (e) {        t.fail("xhr doesn't get a JSON response");      }      t.same(typeof result, "object", "xhr request get a result");      t.end();    });  });  t.test("- request is not cache-busted when configured not to be", function(    t  ) {    var r = sendRequest(url, {}, function() {      t.equal(r.responseURL, url, "XHR URL is left untouched");      t.end();    });  });  t.end();});tape("request headers are sent properly", function(t) {  var url = "https://httpbin.org/headers";  var options = {    selectors: ["div.pjax", "div.container"]  };  sendRequest(url, options, function(responseText) {    var headers = JSON.parse(responseText).headers;    t.equals(      headers["X-Requested-With"],      "XMLHttpRequest",      "X-Requested-With header is set correctly"    );    // Httpbin.org changes the case to 'X-Pjax'    t.equals(headers["X-Pjax"], "true", "X-PJAX header is set correctly");    t.equals(      headers["X-Pjax-Selectors"],      '["div.pjax","div.container"]',      "X-PJAX-Selectors header is set correctly"    );    t.end();  });});tape("HTTP status codes other than 200 are handled properly", function(t) {  var url = "https://httpbin.org/status/400";  sendRequest(url, {}, function(responseText, request) {    t.equals(responseText, null, "responseText is null");    t.equals(request.status, 400, "HTTP status code is correct");    t.end();  });});tape.skip("XHR error is handled properly", function(t) {  var url = "https://encrypted.google.com/foobar";  sendRequest(url, {}, function(responseText) {    t.equals(responseText, null, "responseText is null");    t.end();  });});tape("POST body data is sent properly", function(t) {  var url = "https://httpbin.org/post";  var params = [    {      name: "test",      value: "1"    }  ];  var options = {    requestOptions: {      requestMethod: "POST",      requestParams: params    }  };  sendRequest(url, options, function(responseText) {    var response = JSON.parse(responseText);    t.same(      response.form[params[0].name],      params[0].value,      "requestParams were sent properly"    );    t.equals(      response.headers["Content-Type"],      "application/x-www-form-urlencoded",      "Content-Type header was set properly"    );    t.end();  });});tape("GET query data is sent properly", function(t) {  var url = "https://httpbin.org/get";  var params = [    {      name: "test",      value: "1"    }  ];  var options = {    requestOptions: {      requestParams: params    }  };  sendRequest(url, options, function(responseText) {    var response = JSON.parse(responseText);    t.same(      response.args[params[0].name],      params[0].value,      "requestParams were sent properly"    );    t.end();  });});tape("XHR timeout is handled properly", function(t) {  var url = "https://httpbin.org/delay/5";  var options = {    timeout: 1000  };  sendRequest(url, options, function(responseText) {    t.equals(responseText, null, "responseText is null");    t.end();  });});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/switches.js"/>
      <url>/lib/pjax/tests/lib/switches.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var switches = require("../../lib/switches");var noop = require("../../lib/util/noop");tape("test outerHTML switch", function(t) {  var outerHTML = switches.outerHTML;  var doc = document.implementation.createHTMLDocument();  var container = doc.createElement("div");  container.innerHTML = "<p id="p">Original Text</p>";  doc.body.appendChild(container);  var p = doc.createElement("p");  p.innerHTML = "New Text";  outerHTML.bind({    onSwitch: noop  })(doc.querySelector("p"), p);  t.equals(    doc.querySelector("p").innerHTML,    "New Text",    "Elements correctly switched"  );  t.notEquals(    doc.querySelector("p").id,    "p",    "other attributes overwritten correctly"  );  t.end();});tape("test innerHTML switch", function(t) {  var innerHTML = switches.innerHTML;  var doc = document.implementation.createHTMLDocument();  var container = doc.createElement("div");  container.innerHTML = "<p id="p">Original Text</p>";  doc.body.appendChild(container);  var p = doc.createElement("p");  p.innerHTML = "New Text";  p.className = "p";  innerHTML.bind({    onSwitch: noop  })(doc.querySelector("p"), p);  t.equals(    doc.querySelector("p").innerHTML,    "New Text",    "Elements correctly switched"  );  t.equals(doc.querySelector("p").className, "p", "classname set correctly");  t.equals(doc.querySelector("p").id, "p", "other attributes set correctly");  p.removeAttribute("class");  innerHTML.bind({    onSwitch: noop  })(doc.querySelector("p"), p);  t.equals(doc.querySelector("p").className, "", "classname set correctly");  t.end();});tape("test replaceNode switch", function(t) {  var replaceNode = switches.replaceNode;  var doc = document.implementation.createHTMLDocument();  var container = doc.createElement("div");  container.innerHTML = "<p>Original Text</p>";  doc.body.appendChild(container);  var p = doc.createElement("p");  p.innerHTML = "New Text";  replaceNode.bind({    onSwitch: noop  })(doc.querySelector("p"), p);  t.equals(    doc.querySelector("div").innerHTML,    "<p>New Text</p>",    "Elements correctly switched"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/switch-selectors.js"/>
      <url>/lib/pjax/tests/lib/switch-selectors.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var switchesSelectors = require("../../lib/switches-selectors.js");var noop = require("../../lib/util/noop");var pjax = {  onSwitch: function() {    console.log("Switched");  },  state: {},  log: noop};// @author darylteotape("test switchesSelectors", function(t) {  // switchesSelectors relies on a higher level function callback  // should really be passed in instead so I'll leave it here as a TODO:  var tmpEl = document.implementation.createHTMLDocument();  // a div container is used because swapping the containers  // will generate a new element, so things get weird  // using "body" generates a lot of testling cruft that I don't  // want so let's avoid that  var container = document.createElement("div");  container.innerHTML = "<p>Original Text</p><span>No Change</span>";  document.body.appendChild(container);  var container2 = tmpEl.createElement("div");  container2.innerHTML = "<p>New Text</p><span>New Span</span>";  tmpEl.body.appendChild(container2);  switchesSelectors.bind(pjax)(    {}, // switches    {}, // switchesOptions    ["p"], // selectors,    tmpEl, // fromEl    document, // toEl,    {} // options  );  t.equals(    container.innerHTML,    "<p>New Text</p><span>No Change</span>",    "Elements correctly switched"  );  t.end();});tape("test switchesSelectors when number of elements don't match", function(t) {  var newTempDoc = document.implementation.createHTMLDocument();  var originalTempDoc = document.implementation.createHTMLDocument();  // a div container is used because swapping the containers  // will generate a new element, so things get weird  // using "body" generates a lot of testling cruft that I don't  // want so let's avoid that  var container = originalTempDoc.createElement("div");  container.innerHTML = "<p>Original text</p><span>No change</span>";  originalTempDoc.body.appendChild(container);  var container2 = newTempDoc.createElement("div");  container2.innerHTML =    "<p>New text</p><p>More new text</p><span>New span</span>";  newTempDoc.body.appendChild(container2);  var switchSelectorsFn = switchesSelectors.bind(    pjax,    {}, // switches    {}, // switchesOptions    ["p"], // selectors,    newTempDoc, // fromEl    originalTempDoc, // toEl,    {} // options  );  t.throws(    switchSelectorsFn,    null,    "error was thrown properly since number of elements don't match"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/parse-options.js"/>
      <url>/lib/pjax/tests/lib/parse-options.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var parseOptions = require("../../lib/parse-options.js");tape("test parse initalization options function", function(t) {  t.test("- default options", function(t) {    var pjax = {};    pjax.options = parseOptions({});    t.equal(pjax.options.elements, "a[href], form[action]");    t.equal(pjax.options.selectors.length, 2, "selectors length");    t.equal(pjax.options.selectors[0], "title");    t.equal(pjax.options.selectors[1], ".js-Pjax");    t.equal(typeof pjax.options.switches, "object");    t.equal(Object.keys(pjax.options.switches).length, 2); // head and body    t.equal(typeof pjax.options.switchesOptions, "object");    t.equal(Object.keys(pjax.options.switchesOptions).length, 0);    t.equal(pjax.options.history, true);    t.equal(typeof pjax.options.analytics, "function");    t.equal(pjax.options.scrollTo, 0);    t.equal(pjax.options.scrollRestoration, true);    t.equal(pjax.options.cacheBust, true);    t.equal(pjax.options.debug, false);    t.equal(pjax.options.currentUrlFullReload, false);    t.end();  });  // verify analytics always ends up as a function even when passed not a function  t.test("- analytics is a function", function(t) {    var pjax = {};    pjax.options = parseOptions({ analytics: "some string" });    t.deepEqual(typeof pjax.options.analytics, "function");    t.end();  });  // verify that the value false for scrollTo is not squashed  t.test("- scrollTo remains false", function(t) {    var pjax = {};    pjax.options = parseOptions({ scrollTo: false });    t.deepEqual(pjax.options.scrollTo, false);    t.end();  });  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/uniqueid.js"/>
      <url>/lib/pjax/tests/lib/uniqueid.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var uniqueid = require("../../lib/uniqueid.js");tape("test uniqueid", function(t) {  var a = uniqueid();  var b = uniqueid();  t.notEqual(a, b, "Two calls to uniqueid produce different values");  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/proto/attach-form.js"/>
      <url>/lib/pjax/tests/lib/proto/attach-form.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var on = require("../../../lib/events/on");var trigger = require("../../../lib/events/trigger");var attachForm = require("../../../lib/proto/attach-form");var attr = "data-pjax-state";tape("test attach form prototype method", function(t) {  var form = document.createElement("form");  var loadUrlCalled = false;  attachForm.call(    {      options: {        currentUrlFullReload: true      },      loadUrl: function() {        loadUrlCalled = true;      }    },    form  );  var internalUri =    window.location.protocol +    "//" +    window.location.host +    window.location.pathname +    window.location.search;  form.action = "http://external.com/";  trigger(form, "submit");  t.equal(form.getAttribute(attr), "external", "external url stop behavior");  form.action = internalUri + "#anchor";  trigger(form, "submit");  t.equal(form.getAttribute(attr), "anchor", "internal anchor stop behavior");  window.location.hash = "#anchor";  form.action = internalUri + "#another-anchor";  trigger(form, "submit");  t.equal(form.getAttribute(attr), "anchor", "different anchors stop behavior");  window.location.hash = "";  form.action = internalUri + "#";  trigger(form, "submit");  t.equal(    form.getAttribute(attr),    "anchor-empty",    "empty anchor stop behavior"  );  form.action = window.location.href;  trigger(form, "submit");  t.equal(    form.getAttribute(attr),    "reload",    "submitting when currentUrlFullReload is true will submit normally, without XHR"  );  t.equal(loadUrlCalled, false, "loadUrl() not called");  form.action =    window.location.protocol + "//" + window.location.host + "/internal";  form.method = "POST";  trigger(form, "submit");  t.equal(    form.getAttribute(attr),    "submit",    "triggering a POST request to the next page"  );  t.equal(loadUrlCalled, true, "loadUrl() called correctly");  loadUrlCalled = false;  form.setAttribute(attr, "");  form.action =    window.location.protocol + "//" + window.location.host + "/internal";  form.method = "GET";  trigger(form, "submit");  t.equal(    form.getAttribute(attr),    "submit",    "triggering a GET request to the next page"  );  t.equal(loadUrlCalled, true, "loadUrl() called correctly");  t.end();});tape("test attach form preventDefaulted events", function(t) {  var loadUrlCalled = false;  var form = document.createElement("form");  // This needs to be before the call to attachForm()  on(form, "submit", function(event) {    event.preventDefault();  });  attachForm.call(    {      options: {},      loadUrl: function() {        loadUrlCalled = true;      }    },    form  );  form.action = "#";  trigger(form, "submit");  t.equal(    loadUrlCalled,    false,    "events that are preventDefaulted should not fire callback"  );  t.end();});tape("test options are not modified by attachForm", function(t) {  var form = document.createElement("form");  var options = { foo: "bar" };  var loadUrl = function() {};  attachForm.call({ options: options, loadUrl: loadUrl }, form);  form.action =    window.location.protocol +    "//" +    window.location.host +    window.location.pathname +    window.location.search;  form.method = "GET";  trigger(form, "submit");  t.equal(    1,    Object.keys(options).length,    "options object that is passed in should not be modified"  );  t.equal(    "bar",    options.foo,    "options object that is passed in should not be modified"  );  t.end();});tape("test form elements parsed correctly", function(t) {  t.plan(1);  var form = document.createElement("form");  var input = document.createElement("input");  input.name = "input";  input.value = "value";  form.appendChild(input);  var params = [    {      name: "input",      value: "value"    }  ];  var pjax = {    options: {},    loadUrl: function(href, options) {      t.same(        options.requestOptions.requestParams,        params,        "form elements parsed correctly"      );    }  };  attachForm.call(pjax, form);  form.action =    window.location.protocol + "//" + window.location.host + "/internal";  trigger(form, "submit");  // see loadUrl defined above  t.end();});tape('test form.enctype="multipart/form-data"', function(t) {  t.plan(4);  var form = document.createElement("form");  form.enctype = "multipart/form-data";  var input = document.createElement("input");  input.name = "input";  input.value = "value";  form.appendChild(input);  var pjax = {    options: {},    loadUrl: function(href, options) {      t.equals(        options.requestOptions.requestParams,        undefined,        "form elements not parsed manually"      );      t.true(        options.requestOptions.formData instanceof FormData,        "requestOptions.formData is a FormData"      );      t.equals(        Array.from(options.requestOptions.formData.entries()).length,        1,        "correct number of FormData elements"      );      t.equals(        options.requestOptions.formData.get("input"),        "value",        "FormData element value set correctly"      );    }  };  attachForm.call(pjax, form);  form.action =    window.location.protocol + "//" + window.location.host + "/internal";  trigger(form, "submit");  // see loadUrl defined above  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/proto/parse-element.js"/>
      <url>/lib/pjax/tests/lib/proto/parse-element.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var parseElement = require("../../../lib/proto/parse-element");var pjax = {  attachLink: function() {    return true;  },  attachForm: function() {    return true;  }};tape("test parse element prototype method", function(t) {  t.doesNotThrow(function() {    var a = document.createElement("a");    parseElement.call(pjax, a);  }, "<a> element can be parsed");  t.doesNotThrow(function() {    var form = document.createElement("form");    parseElement.call(pjax, form);  }, "<form> element can be parsed");  t.throws(function() {    var el = document.createElement("div");    parseElement.call(pjax, el);  }, "<div> element cannot be parsed");  t.end();});</div></form></a>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/proto/attach-link.js"/>
      <url>/lib/pjax/tests/lib/proto/attach-link.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var on = require("../../../lib/events/on");var trigger = require("../../../lib/events/trigger");var attachLink = require("../../../lib/proto/attach-link");var attr = "data-pjax-state";tape("test attach link prototype method", function(t) {  var a = document.createElement("a");  var loadUrlCalled = false;  attachLink.call(    {      options: {},      loadUrl: function() {        loadUrlCalled = true;      }    },    a  );  var internalUri =    window.location.protocol +    "//" +    window.location.host +    window.location.pathname +    window.location.search;  a.href = internalUri;  trigger(a, "click", { metaKey: true });  t.equal(a.getAttribute(attr), "modifier", "event key modifier stop behavior");  a.href = "http://external.com/";  trigger(a, "click");  t.equal(a.getAttribute(attr), "external", "external url stop behavior");  window.location.hash = "#anchor";  a.href = internalUri + "#anchor";  trigger(a, "click");  t.equal(a.getAttribute(attr), "anchor", "internal anchor stop behavior");  a.href = internalUri + "#another-anchor";  trigger(a, "click");  t.equal(a.getAttribute(attr), "anchor", "different anchors stop behavior");  window.location.hash = "";  a.href = internalUri + "#";  trigger(a, "click");  t.equal(a.getAttribute(attr), "anchor-empty", "empty anchor stop behavior");  a.href = window.location.protocol + "//" + window.location.host + "/internal";  trigger(a, "click");  t.equals(    a.getAttribute(attr),    "load",    "triggering an internal link sets the state attribute to 'load'"  );  t.equals(    loadUrlCalled,    true,    "triggering an internal link actually loads the page"  );  t.end();});tape("test attach link preventDefaulted events", function(t) {  var loadUrlCalled = false;  var a = document.createElement("a");  // This needs to be before the call to attachLink()  on(a, "click", function(event) {    event.preventDefault();  });  attachLink.call(    {      options: {},      loadUrl: function() {        loadUrlCalled = true;      }    },    a  );  a.href = "#";  trigger(a, "click");  t.equal(    loadUrlCalled,    false,    "events that are preventDefaulted should not fire callback"  );  t.end();});tape("test options are not modified by attachLink", function(t) {  var a = document.createElement("a");  var options = { foo: "bar" };  var loadUrl = function() {};  attachLink.call({ options: options, loadUrl: loadUrl }, a);  a.href =    window.location.protocol +    "//" +    window.location.host +    window.location.pathname +    window.location.search;  trigger(a, "click");  t.equal(    1,    Object.keys(options).length,    "options object that is passed in should not be modified"  );  t.equal(    "bar",    options.foo,    "options object that is passed in should not be modified"  );  t.end();});tape("test link triggered by keyboard", function(t) {  var a = document.createElement("a");  var pjax = {    options: {},    loadUrl: function() {      t.equal(        a.getAttribute(attr),        "load",        "triggering a internal link actually loads the page"      );    }  };  t.plan(3);  attachLink.call(pjax, a);  a.href = window.location.protocol + "//" + window.location.host + "/internal";  trigger(a, "keyup", { keyCode: 14 });  t.equal(    a.getAttribute(attr),    "",    "keycode other than 13 doesn't trigger anything"  );  trigger(a, "keyup", { keyCode: 13, metaKey: true });  t.equal(a.getAttribute(attr), "modifier", "event key modifier stop behavior");  trigger(a, "keyup", { keyCode: 13 });  // see loadUrl defined above  t.end();});tape(  "test link with the same URL as the current one, when currentUrlFullReload set to true",  function(t) {    var a = document.createElement("a");    var pjax = {      options: {        currentUrlFullReload: true      },      reload: function() {        t.pass("this.reload() was called correctly");      },      loadUrl: function() {        t.fail("loadUrl() was called wrongly");      }    };    t.plan(2);    attachLink.call(pjax, a);    a.href = window.location.href;    trigger(a, "click");    t.equal(a.getAttribute(attr), "reload", "reload stop behavior");    t.end();  });]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/proto/handle-response.js"/>
      <url>/lib/pjax/tests/lib/proto/handle-response.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var handleResponse = require("../../../lib/proto/handle-response");var noop = require("../../../lib/util/noop");var loadContent = require("../../../index").prototype.loadContent;var href = "https://example.org/";var storeEventHandler;var pjaxErrorEventTriggerTest;tape("test events triggered when handleResponse(false) is called", function(t) {  t.plan(3);  var pjax = {    options: {      test: 1    }  };  var events = [];  storeEventHandler = function(e) {    events.push(e.type);    t.equal(e.test, 1);  };  document.addEventListener("pjax:complete", storeEventHandler);  document.addEventListener("pjax:error", storeEventHandler);  handleResponse.bind(pjax)(false, null);  t.same(    events,    ["pjax:complete", "pjax:error"],    "calling handleResponse(false) triggers 'pjax:complete' and 'pjax:error'"  );  document.removeEventListener("pjax:complete", storeEventHandler);  document.removeEventListener("pjax:error", storeEventHandler);  t.end();});tape("test when handleResponse() is called normally", function(t) {  var pjax = {    options: {      test: 1    },    loadContent: noop,    state: {}  };  var request = {    getResponseHeader: noop  };  handleResponse.bind(pjax)("", request, "href");  delete window.history.state.uid;  t.same(    window.history.state,    {      url: href,      title: "",      scrollPos: [0, 0]    },    "window.history.state is set correctly"  );  t.equals(pjax.state.href, "href", "this.state.href is set correctly");  t.equals(    Object.keys(pjax.state.options).length,    2,    "this.state.options is set correctly"  );  t.same(    pjax.state.options.request,    request,    "this.state.options is set correctly"  );  t.equals(pjax.state.options.test, 1, "this.state.options is set correctly");  t.end();});tape(  "test when handleResponse() is called normally with request.responseURL",  function(t) {    var pjax = {      options: {},      loadContent: noop,      state: {}    };    var request = {      responseURL: href + "1",      getResponseHeader: noop    };    handleResponse.bind(pjax)("", request, "");    t.equals(      pjax.state.href,      request.responseURL,      "this.state.href is set correctly"    );    t.end();  });tape("test when handleResponse() is called normally with X-PJAX-URL", function(  t) {  var pjax = {    options: {},    loadContent: noop,    state: {}  };  var request = {    getResponseHeader: function(header) {      if (header === "X-PJAX-URL") {        return href + "2";      }    }  };  handleResponse.bind(pjax)("", request, "");  t.equals(pjax.state.href, href + "2", "this.state.href is set correctly");  t.end();});tape(  "test when handleResponse() is called normally with X-XHR-Redirected-To",  function(t) {    var pjax = {      options: {},      loadContent: noop,      state: {}    };    var request = {      getResponseHeader: function(header) {        if (header === "X-XHR-Redirected-To") {          return href + "3";        }      }    };    handleResponse.bind(pjax)("", request, "");    t.equals(pjax.state.href, href + "3", "this.state.href is set correctly");    t.end();  });tape("test when handleResponse() is called normally with a hash", function(t) {  var pjax = {    options: {},    loadContent: noop,    state: {}  };  var request = {    responseURL: href + "2",    getResponseHeader: noop  };  handleResponse.bind(pjax)("", request, href + "1#test");  t.equals(    pjax.state.href,    href + "2#test",    "this.state.href is set correctly"  );  t.end();});tape("test try...catch for loadContent() when options.debug is true", function(  t) {  t.plan(2);  var pjax = {    options: {},    loadContent: noop,    state: {}  };  var request = {    getResponseHeader: noop  };  pjax.loadContent = function() {    throw new Error();  };  pjax.options.debug = true;  document.removeEventListener("pjax:error", storeEventHandler);  pjaxErrorEventTriggerTest = function() {    t.pass("pjax:error event triggered");  };  document.addEventListener("pjax:error", pjaxErrorEventTriggerTest);  t.throws(    function() {      handleResponse.bind(pjax)("", request, "");    },    Error,    "error is rethrown"  );  t.end();});tape("test try...catch for loadContent()", function(t) {  t.plan(2);  var pjax = {    options: {},    loadContent: noop,    state: {}  };  var request = {    getResponseHeader: noop  };  pjax.loadContent = function() {    throw new Error();  };  pjax.latestChance = function() {    return true;  };  pjax.options.debug = false;  document.removeEventListener("pjax:error", pjaxErrorEventTriggerTest);  t.doesNotThrow(    function() {      t.equals(        handleResponse.bind(pjax)("", request, ""),        true,        "this.latestChance() is called"      );    },    Error,    "error is not thrown"  );  t.end();});tape(  "test events triggered when loadContent() is called with a non-string html argument",  function(t) {    t.plan(3);    var options = {      test: 1    };    var events = [];    storeEventHandler = function(e) {      events.push(e.type);      t.equal(e.test, 1);    };    document.addEventListener("pjax:complete", storeEventHandler);    document.addEventListener("pjax:error", storeEventHandler);    loadContent(null, options);    t.same(      events,      ["pjax:complete", "pjax:error"],      "calling loadContent() with a non-string html argument triggers 'pjax:complete' and 'pjax:error'"    );    document.removeEventListener("pjax:complete", storeEventHandler);    document.removeEventListener("pjax:error", storeEventHandler);    t.end();  });]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/util/clone.js"/>
      <url>/lib/pjax/tests/lib/util/clone.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var clone = require("../../../lib/util/clone");tape("test clone method", function(t) {  var obj = { one: 1, two: 2 };  var cloned = clone(obj);  t.notEqual(obj, cloned, "cloned object isn't the original object");  t.same(obj, cloned, "cloned object has the same values as original object");  cloned.three = 3;  t.notSame(    obj,    cloned,    "modified cloned object doesn't have the same values as original object"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/util/contains.js"/>
      <url>/lib/pjax/tests/lib/util/contains.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var contains = require("../../../lib/util/contains.js");tape("test contains function", function(t) {  var tempDoc = document.implementation.createHTMLDocument();  tempDoc.body.innerHTML =    "<div><p id="el" class="js-Pjax"></p></div><span></span>";  var selectors = ["div"];  var el = tempDoc.body.querySelector("#el");  t.equal(    contains(tempDoc, selectors, el),    true,    "contains() returns true when a selector contains the element"  );  selectors = ["span"];  t.equal(    contains(tempDoc, selectors, el),    false,    "contains() returns false when the selectors do not contain the element"  );  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/util/extend.js"/>
      <url>/lib/pjax/tests/lib/util/extend.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var extend = require("../../../lib/util/extend");tape("test extend method", function(t) {  var obj = { one: 1, two: 2 };  var extended = extend({}, obj, { two: "two", three: 3 });  t.notEqual(obj, extended, "extended object isn't the original object");  t.notSame(    obj,    extended,    "extended object doesn't have the same values as original object"  );  t.notSame(    obj.two,    extended.two,    "extended object value overwrites value from original object"  );  extended = extend(null);  t.equals(extended, null, "passing null returns null");  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/util/noop.js"/>
      <url>/lib/pjax/tests/lib/util/noop.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var noop = require("../../../lib/util/noop");tape("test noop function", function(t) {  t.equal(typeof noop, "function", "noop is a function");  t.equal(noop(), undefined, "noop() returns nothing");  t.end();});]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/lib/pjax/tests/lib/util/update-query-string.js"/>
      <url>/lib/pjax/tests/lib/util/update-query-string.js</url>
      
        <content type="html"><![CDATA[var tape = require("tape");var updateQueryString = require("../../../lib/util/update-query-string");tape("test update query string method", function(t) {  var url = "http://example.com";  var updatedUrl = updateQueryString(url, "foo", "bar");  t.notEqual(url, updatedUrl, "update query string modifies URL");  t.equal(    updatedUrl,    url + "?foo=bar",    "update query string creates new query string when no query string params are set"  );  updatedUrl = updateQueryString(updatedUrl, "foo", "baz");  t.equal(    updatedUrl,    url + "?foo=baz",    "update query string updates existing query string param"  );  updatedUrl = updateQueryString(updatedUrl, "bar", "");  t.equal(    updatedUrl,    url + "?foo=baz&bar=",    "update query string appends to existing query string"  );  t.end();});]]></content>
      
    </entry>
    
    
  
</search>
